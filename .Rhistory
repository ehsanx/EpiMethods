regmedint_results <- data.frame(
Method = "regmedint (no survey design)",
TE  = te_or_reg,
NDE = tnde_or_reg,
NIE = tnie_or_reg,
PM  = pm_reg
)
regmedint_results
summary(fit_reg)$mediation
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(regmedint)
# Load the CCHS based dataset
load("cchs123pain.RData")
# Create 0/1 numeric variables for the mediation analysis
analytic.miss$mediator <- ifelse(analytic.miss$painmed == "Yes", 1, 0)   # pain medication (M)
analytic.miss$exposure <- ifelse(analytic.miss$OA == "OA", 1, 0)         # osteoarthritis (A)
analytic.miss$outcome  <- ifelse(analytic.miss$CVD == "event", 1, 0)     # CVD (Y)
# List of baseline covariates (C)
varlist <- c("age", "sex", "income", "race", "bmi", "edu",
"phyact", "smoke", "fruit", "diab")
# Restrict to complete cases as in the course material
analysis_data <- subset(analytic.miss, miss == 0)
nrow(analysis_data)
# This corresponds to A* = A for all rows when we fit the mediator model
analysis_data$exposureTemp <- analysis_data$exposure
d1 <- d2 <- analysis_data
# Factual copy: A* = A
d1$exposure.counterfactual <- d1$exposure
# Counterfactual copy: A* = 1 - A
d2$exposure.counterfactual <- 1 - d2$exposure
# Stack rows to form an expanded dataset
newd <- rbind(d1, d2)
nrow(analysis_data); nrow(newd)
# Build mediator model formula: M ~ A + C
covariates_formula <- paste(varlist, collapse = " + ")
mediator_formula_str <- paste("mediator ~ exposureTemp +", covariates_formula)
mediator_formula <- as.formula(mediator_formula_str)
# Fit mediator model on complete cases
fit_mediator <- glm(mediator_formula,
data   = analysis_data,
family = binomial)
summary(fit_mediator)$coefficients["exposureTemp", ]
# Step 3b: compute P(M | A, C)
newd$exposureTemp <- newd$exposure
p_M_given_A <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_A <- ifelse(newd$mediator == 1, p_M_given_A, 1 - p_M_given_A)
# Step 3b: compute P(M | A*, C)
newd$exposureTemp <- newd$exposure.counterfactual
p_M_given_Astar <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_Astar <- ifelse(newd$mediator == 1, p_M_given_Astar, 1 - p_M_given_Astar)
# Mediator weights W^M = P(M | A*, C) / P(M | A, C)
newd$W.mediator <- prob_M_given_Astar / prob_M_given_A
summary(newd$W.mediator)
outcome_formula_str <- paste("outcome ~ exposure + exposure.counterfactual +",
covariates_formula)
outcome_formula <- as.formula(outcome_formula_str)
fit_outcome <- glm(outcome_formula,
data   = newd,
family = binomial,
weights = W.mediator)
summary(fit_outcome)$coefficients[c("exposure", "exposure.counterfactual"), ]
coefs <- summary(fit_outcome)$coefficients
nde_log_or <- coefs["exposure", "Estimate"]
nie_log_or <- coefs["exposure.counterfactual", "Estimate"]
nde_or <- exp(nde_log_or)
nie_or <- exp(nie_log_or)
te_or  <- exp(nde_log_or + nie_log_or)
pm_manual <- nie_log_or / (nde_log_or + nie_log_or)
manual_results <- data.frame(
Method = "Manual IPW (weights, no survey design)",
TE  = te_or,
NDE = nde_or,
NIE = nie_or,
PM  = pm_manual
)
manual_results
analysis_data$age_num <- as.numeric(analysis_data$age)
analysis_data$sex_num <- as.numeric(analysis_data$sex)
analysis_data$income_num <- as.numeric(analysis_data$income)
analysis_data$race_num <- as.numeric(analysis_data$race)
analysis_data$bmi_num <- as.numeric(analysis_data$bmi)
analysis_data$edu_num <- as.numeric(analysis_data$edu)
analysis_data$phyact_num <- as.numeric(analysis_data$phyact)
analysis_data$smoke_num <- as.numeric(analysis_data$smoke)
analysis_data$fruit_num <- as.numeric(analysis_data$fruit)
analysis_data$diab_num <- as.numeric(analysis_data$diab)
cvar_num <- c("age_num","sex_num","income_num","race_num","bmi_num",
"edu_num","phyact_num","smoke_num","fruit_num","diab_num")
c_cond_vec <- colMeans(analysis_data[, cvar_num])
c_cond_vec
fit_reg <- regmedint(
data   = analysis_data,
yvar   = "outcome",
avar   = "exposure",
mvar   = "mediator",
cvar   = cvar_num,
yreg   = "logistic",
mreg   = "logistic",
interaction = FALSE,
a0 = 0,
a1 = 1,
m_cde = 0,
c_cond = c_cond_vec
)
summary(fit_reg)
# compute effects using est_fun()
est <- fit_reg$myreg$est_fun(
a0    = 0,
a1    = 1,
m_cde = 0,
c_cond = c(3.049976, 1.481868, 2.584708, 1.884701,
2.489037, 3.031565, 1.996485, 2.123303,
1.973063, 1.043085)
)
tnde_or_reg <- exp(est["tnde"])
tnie_or_reg <- exp(est["tnie"])
te_or_reg   <- exp(est["te"])
pm_reg      <- est["pm"]
regmedint_results <- data.frame(
Method = "regmedint (no survey design)",
TE  = te_or_reg,
NDE = tnde_or_reg,
NIE = tnie_or_reg,
PM  = pm_reg
)
regmedint_results
est <- fit_reg$myreg$est_fun(a0, a1, m_cde, c_cond_vec)
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(regmedint)
# Load the CCHS based dataset
load("cchs123pain.RData")
# Create 0/1 numeric variables for the mediation analysis
analytic.miss$mediator <- ifelse(analytic.miss$painmed == "Yes", 1, 0)   # pain medication (M)
analytic.miss$exposure <- ifelse(analytic.miss$OA == "OA", 1, 0)         # osteoarthritis (A)
analytic.miss$outcome  <- ifelse(analytic.miss$CVD == "event", 1, 0)     # CVD (Y)
# List of baseline covariates (C)
varlist <- c("age", "sex", "income", "race", "bmi", "edu",
"phyact", "smoke", "fruit", "diab")
# Restrict to complete cases as in the course material
analysis_data <- subset(analytic.miss, miss == 0)
nrow(analysis_data)
# This corresponds to A* = A for all rows when we fit the mediator model
analysis_data$exposureTemp <- analysis_data$exposure
d1 <- d2 <- analysis_data
# Factual copy: A* = A
d1$exposure.counterfactual <- d1$exposure
# Counterfactual copy: A* = 1 - A
d2$exposure.counterfactual <- 1 - d2$exposure
# Stack rows to form an expanded dataset
newd <- rbind(d1, d2)
nrow(analysis_data); nrow(newd)
# Build mediator model formula: M ~ A + C
covariates_formula <- paste(varlist, collapse = " + ")
mediator_formula_str <- paste("mediator ~ exposureTemp +", covariates_formula)
mediator_formula <- as.formula(mediator_formula_str)
# Fit mediator model on complete cases
fit_mediator <- glm(mediator_formula,
data   = analysis_data,
family = binomial)
summary(fit_mediator)$coefficients["exposureTemp", ]
# Step 3b: compute P(M | A, C)
newd$exposureTemp <- newd$exposure
p_M_given_A <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_A <- ifelse(newd$mediator == 1, p_M_given_A, 1 - p_M_given_A)
# Step 3b: compute P(M | A*, C)
newd$exposureTemp <- newd$exposure.counterfactual
p_M_given_Astar <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_Astar <- ifelse(newd$mediator == 1, p_M_given_Astar, 1 - p_M_given_Astar)
# Mediator weights W^M = P(M | A*, C) / P(M | A, C)
newd$W.mediator <- prob_M_given_Astar / prob_M_given_A
summary(newd$W.mediator)
outcome_formula_str <- paste("outcome ~ exposure + exposure.counterfactual +",
covariates_formula)
outcome_formula <- as.formula(outcome_formula_str)
fit_outcome <- glm(outcome_formula,
data   = newd,
family = binomial,
weights = W.mediator)
summary(fit_outcome)$coefficients[c("exposure", "exposure.counterfactual"), ]
coefs <- summary(fit_outcome)$coefficients
nde_log_or <- coefs["exposure", "Estimate"]
nie_log_or <- coefs["exposure.counterfactual", "Estimate"]
nde_or <- exp(nde_log_or)
nie_or <- exp(nie_log_or)
te_or  <- exp(nde_log_or + nie_log_or)
pm_manual <- nie_log_or / (nde_log_or + nie_log_or)
manual_results <- data.frame(
Method = "Manual IPW (weights, no survey design)",
TE  = te_or,
NDE = nde_or,
NIE = nie_or,
PM  = pm_manual
)
manual_results
analysis_data$age_num <- as.numeric(analysis_data$age)
analysis_data$sex_num <- as.numeric(analysis_data$sex)
analysis_data$income_num <- as.numeric(analysis_data$income)
analysis_data$race_num <- as.numeric(analysis_data$race)
analysis_data$bmi_num <- as.numeric(analysis_data$bmi)
analysis_data$edu_num <- as.numeric(analysis_data$edu)
analysis_data$phyact_num <- as.numeric(analysis_data$phyact)
analysis_data$smoke_num <- as.numeric(analysis_data$smoke)
analysis_data$fruit_num <- as.numeric(analysis_data$fruit)
analysis_data$diab_num <- as.numeric(analysis_data$diab)
cvar_num <- c("age_num","sex_num","income_num","race_num","bmi_num",
"edu_num","phyact_num","smoke_num","fruit_num","diab_num")
c_cond_vec <- colMeans(analysis_data[, cvar_num])
c_cond_vec
m_cde_vec <- 0
fit_reg <- regmedint(
data   = analysis_data,
yvar   = "outcome",
avar   = "exposure",
mvar   = "mediator",
cvar   = cvar_num,
yreg   = "logistic",
mreg   = "logistic",
interaction = FALSE,
a0 = 0,
a1 = 1,
m_cde = m_cde_vec,
c_cond = c_cond_vec
)
summary(fit_reg)
# compute effects using est_fun()
tnde_or_reg <- exp(est["tnde"])
tnie_or_reg <- exp(est["tnie"])
te_or_reg   <- exp(est["te"])
pm_reg      <- est["pm"]
regmedint_results <- data.frame(
Method = "regmedint (no survey design)",
TE  = te_or_reg,
NDE = tnde_or_reg,
NIE = tnie_or_reg,
PM  = pm_reg
)
regmedint_results
est <- fit_reg$myreg$est_fun(a0, a1, m_cde_vec, c_cond_vec)
fit_reg$myreg$est_fun(a0, a1, m_cde_vec, c_cond_vec)
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(regmedint)
# Load the CCHS based dataset
load("cchs123pain.RData")
# Create 0/1 numeric variables for the mediation analysis
analytic.miss$mediator <- ifelse(analytic.miss$painmed == "Yes", 1, 0)   # pain medication (M)
analytic.miss$exposure <- ifelse(analytic.miss$OA == "OA", 1, 0)         # osteoarthritis (A)
analytic.miss$outcome  <- ifelse(analytic.miss$CVD == "event", 1, 0)     # CVD (Y)
# List of baseline covariates (C)
varlist <- c("age", "sex", "income", "race", "bmi", "edu",
"phyact", "smoke", "fruit", "diab")
# Restrict to complete cases as in the course material
analysis_data <- subset(analytic.miss, miss == 0)
nrow(analysis_data)
# This corresponds to A* = A for all rows when we fit the mediator model
analysis_data$exposureTemp <- analysis_data$exposure
d1 <- d2 <- analysis_data
# Factual copy: A* = A
d1$exposure.counterfactual <- d1$exposure
# Counterfactual copy: A* = 1 - A
d2$exposure.counterfactual <- 1 - d2$exposure
# Stack rows to form an expanded dataset
newd <- rbind(d1, d2)
nrow(analysis_data); nrow(newd)
# Build mediator model formula: M ~ A + C
covariates_formula <- paste(varlist, collapse = " + ")
mediator_formula_str <- paste("mediator ~ exposureTemp +", covariates_formula)
mediator_formula <- as.formula(mediator_formula_str)
# Fit mediator model on complete cases
fit_mediator <- glm(mediator_formula,
data   = analysis_data,
family = binomial)
summary(fit_mediator)$coefficients["exposureTemp", ]
# Step 3b: compute P(M | A, C)
newd$exposureTemp <- newd$exposure
p_M_given_A <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_A <- ifelse(newd$mediator == 1, p_M_given_A, 1 - p_M_given_A)
# Step 3b: compute P(M | A*, C)
newd$exposureTemp <- newd$exposure.counterfactual
p_M_given_Astar <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_Astar <- ifelse(newd$mediator == 1, p_M_given_Astar, 1 - p_M_given_Astar)
# Mediator weights W^M = P(M | A*, C) / P(M | A, C)
newd$W.mediator <- prob_M_given_Astar / prob_M_given_A
summary(newd$W.mediator)
outcome_formula_str <- paste("outcome ~ exposure + exposure.counterfactual +",
covariates_formula)
outcome_formula <- as.formula(outcome_formula_str)
fit_outcome <- glm(outcome_formula,
data   = newd,
family = binomial,
weights = W.mediator)
summary(fit_outcome)$coefficients[c("exposure", "exposure.counterfactual"), ]
coefs <- summary(fit_outcome)$coefficients
nde_log_or <- coefs["exposure", "Estimate"]
nie_log_or <- coefs["exposure.counterfactual", "Estimate"]
nde_or <- exp(nde_log_or)
nie_or <- exp(nie_log_or)
te_or  <- exp(nde_log_or + nie_log_or)
pm_manual <- nie_log_or / (nde_log_or + nie_log_or)
manual_results <- data.frame(
Method = "Manual IPW (weights, no survey design)",
TE  = te_or,
NDE = nde_or,
NIE = nie_or,
PM  = pm_manual
)
manual_results
analysis_data$age_num <- as.numeric(analysis_data$age)
analysis_data$sex_num <- as.numeric(analysis_data$sex)
analysis_data$income_num <- as.numeric(analysis_data$income)
analysis_data$race_num <- as.numeric(analysis_data$race)
analysis_data$bmi_num <- as.numeric(analysis_data$bmi)
analysis_data$edu_num <- as.numeric(analysis_data$edu)
analysis_data$phyact_num <- as.numeric(analysis_data$phyact)
analysis_data$smoke_num <- as.numeric(analysis_data$smoke)
analysis_data$fruit_num <- as.numeric(analysis_data$fruit)
analysis_data$diab_num <- as.numeric(analysis_data$diab)
cvar_num <- c("age_num","sex_num","income_num","race_num","bmi_num",
"edu_num","phyact_num","smoke_num","fruit_num","diab_num")
c_cond_vec <- colMeans(analysis_data[, cvar_num])
c_cond_vec
m_cde_vec <- 0
a0_vec <- 0
a1_vec <- 1
fit_reg <- regmedint(
data   = analysis_data,
yvar   = "outcome",
avar   = "exposure",
mvar   = "mediator",
cvar   = cvar_num,
yreg   = "logistic",
mreg   = "logistic",
interaction = FALSE,
a0 = a0_vec,
a1 = a1_vec,
m_cde = m_cde_vec,
c_cond = c_cond_vec
)
summary(fit_reg)
# compute effects using est_fun()
tnde_or_reg <- exp(est["tnde"])
tnie_or_reg <- exp(est["tnie"])
te_or_reg   <- exp(est["te"])
pm_reg      <- est["pm"]
regmedint_results <- data.frame(
Method = "regmedint (no survey design)",
TE  = te_or_reg,
NDE = tnde_or_reg,
NIE = tnie_or_reg,
PM  = pm_reg
)
regmedint_results
est <- fit_reg$myreg$est_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)
se <- fit_reg$myreg$se_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)
reg_raw <- data.frame(
effect = names(est),
est = as.numeric(est),
se = as.numeric(se)
)
reg_raw$lower <- reg_raw$est - 1.96 * reg_raw$se
reg_raw$upper <- reg_raw$est + 1.96 * reg_raw$se
reg_or <- subset(reg_raw, effect %in% c("te","tnde","tnie"))
reg_or$OR <- exp(reg_or$est)
reg_or$OR_L <- exp(reg_or$lower)
reg_or$OR_U <- exp(reg_or$upper)
reg_or
compare <- rbind(
manual_results,
regmedint_results
)
rownames(compare) <- NULL
library(kableExtra)
kable(compare, digits = 2, caption = "Comparison of natural effects") %>%
kable_styling(full_width = FALSE, bootstrap_options = c("striped", "condensed"))
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(regmedint)
# Load the CCHS based dataset
load("cchs123pain.RData")
# Create 0/1 numeric variables for the mediation analysis
analytic.miss$mediator <- ifelse(analytic.miss$painmed == "Yes", 1, 0)   # pain medication (M)
analytic.miss$exposure <- ifelse(analytic.miss$OA == "OA", 1, 0)         # osteoarthritis (A)
analytic.miss$outcome  <- ifelse(analytic.miss$CVD == "event", 1, 0)     # CVD (Y)
# List of baseline covariates (C)
varlist <- c("age", "sex", "income", "race", "bmi", "edu",
"phyact", "smoke", "fruit", "diab")
# Restrict to complete cases as in the course material
analysis_data <- subset(analytic.miss, miss == 0)
nrow(analysis_data)
# This corresponds to A* = A for all rows when we fit the mediator model
analysis_data$exposureTemp <- analysis_data$exposure
d1 <- d2 <- analysis_data
# Factual copy: A* = A
d1$exposure.counterfactual <- d1$exposure
# Counterfactual copy: A* = 1 - A
d2$exposure.counterfactual <- 1 - d2$exposure
# Stack rows to form an expanded dataset
newd <- rbind(d1, d2)
nrow(analysis_data); nrow(newd)
# Build mediator model formula: M ~ A + C
covariates_formula <- paste(varlist, collapse = " + ")
mediator_formula_str <- paste("mediator ~ exposureTemp +", covariates_formula)
mediator_formula <- as.formula(mediator_formula_str)
# Fit mediator model on complete cases
fit_mediator <- glm(mediator_formula,
data   = analysis_data,
family = binomial)
summary(fit_mediator)$coefficients["exposureTemp", ]
# Step 3b: compute P(M | A, C)
newd$exposureTemp <- newd$exposure
p_M_given_A <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_A <- ifelse(newd$mediator == 1, p_M_given_A, 1 - p_M_given_A)
# Step 3b: compute P(M | A*, C)
newd$exposureTemp <- newd$exposure.counterfactual
p_M_given_Astar <- predict(fit_mediator, newdata = newd, type = "response")
prob_M_given_Astar <- ifelse(newd$mediator == 1, p_M_given_Astar, 1 - p_M_given_Astar)
# Mediator weights W^M = P(M | A*, C) / P(M | A, C)
newd$W.mediator <- prob_M_given_Astar / prob_M_given_A
summary(newd$W.mediator)
outcome_formula_str <- paste("outcome ~ exposure + exposure.counterfactual +",
covariates_formula)
outcome_formula <- as.formula(outcome_formula_str)
fit_outcome <- glm(outcome_formula,
data   = newd,
family = binomial,
weights = W.mediator)
summary(fit_outcome)$coefficients[c("exposure", "exposure.counterfactual"), ]
coefs <- summary(fit_outcome)$coefficients
nde_log_or <- coefs["exposure", "Estimate"]
nie_log_or <- coefs["exposure.counterfactual", "Estimate"]
nde_or <- exp(nde_log_or)
nie_or <- exp(nie_log_or)
te_or  <- exp(nde_log_or + nie_log_or)
pm_manual <- nie_log_or / (nde_log_or + nie_log_or)
manual_results <- data.frame(
Method = "Manual IPW (weights, no survey design)",
TE  = te_or,
NDE = nde_or,
NIE = nie_or,
PM  = pm_manual
)
manual_results
analysis_data$age_num <- as.numeric(analysis_data$age)
analysis_data$sex_num <- as.numeric(analysis_data$sex)
analysis_data$income_num <- as.numeric(analysis_data$income)
analysis_data$race_num <- as.numeric(analysis_data$race)
analysis_data$bmi_num <- as.numeric(analysis_data$bmi)
analysis_data$edu_num <- as.numeric(analysis_data$edu)
analysis_data$phyact_num <- as.numeric(analysis_data$phyact)
analysis_data$smoke_num <- as.numeric(analysis_data$smoke)
analysis_data$fruit_num <- as.numeric(analysis_data$fruit)
analysis_data$diab_num <- as.numeric(analysis_data$diab)
cvar_num <- c("age_num","sex_num","income_num","race_num","bmi_num",
"edu_num","phyact_num","smoke_num","fruit_num","diab_num")
c_cond_vec <- colMeans(analysis_data[, cvar_num])
c_cond_vec
m_cde_vec <- 0
a0_vec <- 0
a1_vec <- 1
fit_reg <- regmedint(
data   = analysis_data,
yvar   = "outcome",
avar   = "exposure",
mvar   = "mediator",
cvar   = cvar_num,
yreg   = "logistic",
mreg   = "logistic",
interaction = FALSE,
a0 = a0_vec,
a1 = a1_vec,
m_cde = m_cde_vec,
c_cond = c_cond_vec
)
summary(fit_reg)
# compute effects using est_fun()
tnde_or_reg <- exp(est["tnde"])
fit_reg$myreg$est_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)
# compute effects using est_fun()
# tnde_or_reg <- exp(est["tnde"])
# tnie_or_reg <- exp(est["tnie"])
# te_or_reg   <- exp(est["te"])
# pm_reg      <- est["pm"]
#
# regmedint_results <- data.frame(
#   Method = "regmedint (no survey design)",
#   TE  = te_or_reg,
#   NDE = tnde_or_reg,
#   NIE = tnie_or_reg,
#   PM  = pm_reg
# )
#
# regmedint_results
est <- fit_reg$myreg$est_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)
se <- fit_reg$myreg$se_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)
reg_raw <- data.frame(
effect = names(est),
est = as.numeric(est),
se = as.numeric(se)
)
reg_raw$lower <- reg_raw$est - 1.96 * reg_raw$se
reg_raw$upper <- reg_raw$est + 1.96 * reg_raw$se
reg_or <- subset(reg_raw, effect %in% c("te","tnde","tnie"))
reg_or$OR <- exp(reg_or$est)
reg_or$OR_L <- exp(reg_or$lower)
reg_or$OR_U <- exp(reg_or$upper)
reg_or
reg_or$est
reg_or$effect
reg_or$or
reg_or$OR
