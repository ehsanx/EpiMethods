{
  "hash": "43b8cf8a5f44535adc44253314c7ef0e",
  "result": {
    "markdown": "## PSW with multiple tx {.unnumbered}\n\n\n\n\n\n### Problem\n\nIn this chapter, we will use **propensity score weighting (PSW)** for **multiple treatment categories**. We will use CCHS data that was used in the [previous chapter](propensityscore1.html) on exact matching with CCHS.\n\n### Load data\n\nLet us import the dataset:\n\n\n::: {.cell hash='propensityscore9_cache/html/load_ec015f43b4773124df4c836b35f42f10'}\n\n```{.r .cell-code}\nrm(list = ls())\nload(\"Data/propensityscore/cchs123b.RData\")\nls()\n#> [1] \"analytic.miss\" \"analytic2\"\n```\n:::\n\n\n-   `analytic.miss`: Full dataset of 397,173 participants from CCHS cycles 1.1, 2.1, and 3.1 with missing values in some covariates\n-   `analytic2`: Analytic dataset of 185,613 participants without missing in the covariates.\n\n### Pre-processing\n\nLet us create the full and analytic datasets for only CCHS 3.1.\n\n\n::: {.cell hash='propensityscore9_cache/html/cchs31_065087e501926311aba4274393eb33bb'}\n\n```{.r .cell-code}\n# Full dataset with missing\ndat.full <- subset(analytic.miss, cycle == \"31\")\ndim(dat.full)\n#> [1] 132221     22\n\n# Analytic dataset without missing\ndat.analytic <- subset(analytic2, cycle == \"31\")\ndim(dat.analytic)\n#> [1] 39634    22\n```\n:::\n\n\nWe will use the analytic dataset (`dat.analytic`) to run our PSW analysis with the following variables: - Outcome: CVD - Exposure: phyact (3-level physical activity) - Covariates: age, sex, married (marital status), race, edu (education), income, bmi (body mass index), doctor (whether visited to a doctor), stress, smoke, drink (drink alcohol or not), fruit (fruit consumption), bp (blood pressure), diab (diabetes), OA (osteoarthritis), immigrate (immigrant or not)\\\n- Sampling weight: weight\n\n\n::: {.cell hash='propensityscore9_cache/html/datahead_82d8ce43c0bed180d52d743e84707dbc'}\n\n```{.r .cell-code}\n# Is there any character variable?\nstr(dat.analytic) \n#> 'data.frame':\t39634 obs. of  22 variables:\n#>  $ CVD      : chr  \"no event\" \"no event\" \"no event\" \"no event\" ...\n#>  $ age      : chr  \"20-29 years\" \"65 years and over\" \"20-29 years\" \"20-29 years\" ...\n#>  $ sex      : chr  \"Male\" \"Female\" \"Male\" \"Female\" ...\n#>  $ married  : chr  \"not single\" \"single\" \"single\" \"single\" ...\n#>  $ race     : chr  \"White\" \"White\" \"White\" \"White\" ...\n#>  $ edu      : chr  \"2nd grad.\" \"Post-2nd grad.\" \"2nd grad.\" \"Other 2nd grad.\" ...\n#>  $ income   : chr  \"$50,000-$79,999\" \"$29,999 or less\" \"$29,999 or less\" \"$50,000-$79,999\" ...\n#>  $ bmi      : Factor w/ 3 levels \"Underweight\",..: 3 2 2 2 2 3 2 3 3 2 ...\n#>  $ phyact   : chr  \"Inactive\" \"Moderate\" \"Active\" \"Moderate\" ...\n#>  $ doctor   : chr  \"Yes\" \"Yes\" \"Yes\" \"No\" ...\n#>  $ stress   : chr  \"Not too stressed\" \"Not too stressed\" \"Not too stressed\" \"Not too stressed\" ...\n#>  $ smoke    : chr  \"Former smoker\" \"Never smoker\" \"Never smoker\" \"Never smoker\" ...\n#>  $ drink    : chr  \"Current drinker\" \"Former driker\" \"Never drank\" \"Current drinker\" ...\n#>  $ fruit    : Factor w/ 3 levels \"0-3 daily serving\",..: 2 2 1 1 3 2 2 2 2 3 ...\n#>  $ bp       : chr  \"No\" \"No\" \"No\" \"No\" ...\n#>  $ diab     : chr  \"No\" \"No\" \"No\" \"No\" ...\n#>  $ province : chr  \"South\" \"South\" \"South\" \"South\" ...\n#>  $ weight   : num  93.5 111.4 120.4 328.2 810.6 ...\n#>  $ cycle    : Factor w/ 3 levels \"11\",\"21\",\"31\": 3 3 3 3 3 3 3 3 3 3 ...\n#>  $ ID       : int  264953 264954 264961 264962 264963 264964 264969 264971 264975 264976 ...\n#>  $ OA       : chr  \"Control\" \"OA\" \"Control\" \"Control\" ...\n#>  $ immigrate: chr  \"not immigrant\" \"not immigrant\" \"not immigrant\" \"not immigrant\" ...\n\n# Make all variables (except for ID and weight) as factor\nvar.names <- c(\"CVD\", \"phyact\", \"age\", \"sex\", \"married\", \"race\", \"edu\", \"income\", \"bmi\", \"doctor\", \n               \"stress\", \"smoke\", \"drink\", \"fruit\", \"bp\", \"diab\", \"province\", \"OA\", \"immigrate\")\ndat.full[var.names] <- lapply(dat.full[var.names] , factor)\ndat.analytic[var.names] <- lapply(dat.analytic[var.names], factor)\n\n# Outcome - CVD\ntable(dat.analytic$CVD, useNA = \"always\")\n#> \n#>    event no event     <NA> \n#>     1931    37703        0\ndat.full$CVD <- car::recode(dat.full$CVD, \"'no event' = 'No'; 'event' = 'Yes'; else = NA \")\ndat.full$CVD <- factor(dat.full$CVD, levels = c(\"No\", \"Yes\"))\n\ndat.analytic$CVD <- car::recode(dat.analytic$CVD, \"'no event' = 'No'; 'event' = 'Yes'; else = NA \")\ndat.analytic$CVD <- factor(dat.analytic$CVD, levels = c(\"No\", \"Yes\"))\ntable(dat.analytic$CVD, useNA = \"always\")\n#> \n#>    No   Yes  <NA> \n#> 37703  1931     0\n\n# Exposure - physical activity\ntable(dat.analytic$phyact, useNA = \"always\")\n#> \n#>   Active Inactive Moderate     <NA> \n#>    11508    17569    10557        0\ndat.full$phyact <- factor(dat.full$phyact, levels = c(\"Inactive\", \"Moderate\", \"Active\"))\ndat.analytic$phyact <- factor(dat.analytic$phyact, levels = c(\"Inactive\", \"Moderate\", \"Active\"))\n\n# Table 1\nvars <- c(\"age\", \"sex\", \"married\", \"race\", \"edu\", \"income\", \"bmi\", \"doctor\", \"stress\", \n          \"smoke\", \"drink\", \"fruit\", \"bp\", \"diab\", \"OA\", \"immigrate\")\ntab1 <- CreateTableOne(vars = vars, strata = \"phyact\", data = dat.analytic, test = F)\nprint(tab1, smd = T, showAllLevels = T)\n#>                Stratified by phyact\n#>                 level             Inactive      Moderate      Active       \n#>   n                               17569         10557         11508        \n#>   age (%)       20-29 years        2537 (14.4)   1709 (16.2)   2316 (20.1) \n#>                 30-39 years        3526 (20.1)   2265 (21.5)   2276 (19.8) \n#>                 40-49 years        3270 (18.6)   1939 (18.4)   2037 (17.7) \n#>                 50-59 years        2901 (16.5)   1659 (15.7)   1480 (12.9) \n#>                 60-64 years        1130 ( 6.4)    665 ( 6.3)    570 ( 5.0) \n#>                 65 years and over  3310 (18.8)   1568 (14.9)   1183 (10.3) \n#>                 teen                895 ( 5.1)    752 ( 7.1)   1646 (14.3) \n#>   sex (%)       Female             9403 (53.5)   5709 (54.1)   5526 (48.0) \n#>                 Male               8166 (46.5)   4848 (45.9)   5982 (52.0) \n#>   married (%)   not single         9600 (54.6)   5920 (56.1)   5637 (49.0) \n#>                 single             7969 (45.4)   4637 (43.9)   5871 (51.0) \n#>   race (%)      Non-white          1757 (10.0)    886 ( 8.4)   1066 ( 9.3) \n#>                 White             15812 (90.0)   9671 (91.6)  10442 (90.7) \n#>   edu (%)       < 2ndary           3690 (21.0)   1635 (15.5)   2039 (17.7) \n#>                 2nd grad.          3246 (18.5)   1749 (16.6)   1845 (16.0) \n#>                 Other 2nd grad.    1566 ( 8.9)    969 ( 9.2)   1150 (10.0) \n#>                 Post-2nd grad.     9067 (51.6)   6204 (58.8)   6474 (56.3) \n#>   income (%)    $29,999 or less    4480 (25.5)   1929 (18.3)   1906 (16.6) \n#>                 $30,000-$49,999    4018 (22.9)   2059 (19.5)   2097 (18.2) \n#>                 $50,000-$79,999    4512 (25.7)   2974 (28.2)   3095 (26.9) \n#>                 $80,000 or more    4559 (25.9)   3595 (34.1)   4410 (38.3) \n#>   bmi (%)       Underweight         532 ( 3.0)    243 ( 2.3)    340 ( 3.0) \n#>                 healthy weight     7349 (41.8)   5023 (47.6)   6233 (54.2) \n#>                 Overweight         9688 (55.1)   5291 (50.1)   4935 (42.9) \n#>   doctor (%)    No                 2322 (13.2)   1272 (12.0)   1520 (13.2) \n#>                 Yes               15247 (86.8)   9285 (88.0)   9988 (86.8) \n#>   stress (%)    Not too stressed  13544 (77.1)   8371 (79.3)   9314 (80.9) \n#>                 stressed           4025 (22.9)   2186 (20.7)   2194 (19.1) \n#>   smoke (%)     Current smoker     5032 (28.6)   2386 (22.6)   2488 (21.6) \n#>                 Former smoker      6900 (39.3)   4562 (43.2)   4672 (40.6) \n#>                 Never smoker       5637 (32.1)   3609 (34.2)   4348 (37.8) \n#>   drink (%)     Current drinker   13913 (79.2)   9016 (85.4)   9863 (85.7) \n#>                 Former driker      2582 (14.7)   1102 (10.4)   1063 ( 9.2) \n#>                 Never drank        1074 ( 6.1)    439 ( 4.2)    582 ( 5.1) \n#>   fruit (%)     0-3 daily serving  5610 (31.9)   2270 (21.5)   1902 (16.5) \n#>                 4-6 daily serving  8827 (50.2)   5445 (51.6)   5481 (47.6) \n#>                 6+ daily serving   3132 (17.8)   2842 (26.9)   4125 (35.8) \n#>   bp (%)        No                14188 (80.8)   8976 (85.0)  10349 (89.9) \n#>                 Yes                3381 (19.2)   1581 (15.0)   1159 (10.1) \n#>   diab (%)      No                16393 (93.3)  10114 (95.8)  11165 (97.0) \n#>                 Yes                1176 ( 6.7)    443 ( 4.2)    343 ( 3.0) \n#>   OA (%)        Control           14864 (84.6)   9310 (88.2)  10565 (91.8) \n#>                 OA                 2705 (15.4)   1247 (11.8)    943 ( 8.2) \n#>   immigrate (%) not immigrant     16557 (94.2)  10150 (96.1)  11098 (96.4) \n#>                 recent             1012 ( 5.8)    407 ( 3.9)    410 ( 3.6) \n#>                Stratified by phyact\n#>                 SMD   \n#>   n                   \n#>   age (%)        0.285\n#>                       \n#>                       \n#>                       \n#>                       \n#>                       \n#>                       \n#>   sex (%)        0.081\n#>                       \n#>   married (%)    0.095\n#>                       \n#>   race (%)       0.037\n#>                       \n#>   edu (%)        0.119\n#>                       \n#>                       \n#>                       \n#>   income (%)     0.213\n#>                       \n#>                       \n#>                       \n#>   bmi (%)        0.173\n#>                       \n#>                       \n#>   doctor (%)     0.023\n#>                       \n#>   stress (%)     0.063\n#>                       \n#>   smoke (%)      0.129\n#>                       \n#>                       \n#>   drink (%)      0.133\n#>                       \n#>                       \n#>   fruit (%)      0.323\n#>                       \n#>                       \n#>   bp (%)         0.175\n#>                       \n#>   diab (%)       0.116\n#>                       \n#>   OA (%)         0.150\n#>                       \n#>   immigrate (%)  0.070\n#> \n```\n:::\n\n\n### PSW for multiple tx\n\n#### Nominal categories (option 1)\n\nFor this part (option 1), we consider physical activity as a nominal variable.\n\n##### Estimating Propensity score\n\nLet us fit the PS model by considering physical activity as a nominal variable and estimate the propensity scores:\n\n\n::: {.cell hash='propensityscore9_cache/html/nominalfit_938008f9a3e432ea003e40922de10ce3'}\n\n```{.r .cell-code}\n# Formula\nps.formula <- formula(phyact ~ age + sex + married + race + edu + income + bmi + \n                        doctor + stress + smoke + drink + fruit + bp + diab + \n                        OA + immigrate)\n\n# PS model\nlibrary(VGAM)\n#> Loading required package: stats4\n#> Loading required package: splines\n#> \n#> Attaching package: 'VGAM'\n#> The following object is masked from 'package:survey':\n#> \n#>     calibrate\nps.fit <- vglm(ps.formula, weights = weight, data = dat.analytic, \n               family = multinomial(parallel = FALSE))\n\n# Propensity scores\nps <- data.frame(fitted(ps.fit))\nhead(ps)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Inactive\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Moderate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Active\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.3900550\",\"2\":\"0.2804855\",\"3\":\"0.3294594\",\"_rn_\":\"264953\"},{\"1\":\"0.5338171\",\"2\":\"0.2648206\",\"3\":\"0.2013623\",\"_rn_\":\"264954\"},{\"1\":\"0.5551982\",\"2\":\"0.1896430\",\"3\":\"0.2551587\",\"_rn_\":\"264961\"},{\"1\":\"0.4833593\",\"2\":\"0.2686506\",\"3\":\"0.2479901\",\"_rn_\":\"264962\"},{\"1\":\"0.1292879\",\"2\":\"0.1853738\",\"3\":\"0.6853383\",\"_rn_\":\"264963\"},{\"1\":\"0.4475880\",\"2\":\"0.2660046\",\"3\":\"0.2864074\",\"_rn_\":\"264964\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Summary\napply(ps, 2, summary)\n#>           Inactive   Moderate    Active\n#> Min.    0.06879258 0.07957314 0.0285961\n#> 1st Qu. 0.34233334 0.23371928 0.1867680\n#> Median  0.44756388 0.27020295 0.2634537\n#> Mean    0.44778510 0.26768926 0.2845256\n#> 3rd Qu. 0.55452938 0.30446807 0.3616572\n#> Max.    0.89058237 0.39864744 0.7524817\n```\n:::\n\n\n##### Creating weights\n\nLet us create PS weights. For subject $i$, PS weight is calculated as\n\n$$w_i = \\frac{1}{P(A_i = a|L)}, $$ where $A$ is the exposure with levels $a$ (Inactive, Moderate, and Active in our case), and $L$ is the list of covariates.\n\n\n::: {.cell hash='propensityscore9_cache/html/nominalwgt_08b1e7bb82a0099679a8801fede6b6c9'}\n\n```{.r .cell-code}\n# IPW\ndat.analytic$ipw <- ifelse(dat.analytic$phyact==\"Active\", 1/ps$Active, \n                           ifelse(dat.analytic$phyact==\"Moderate\", 1/ps$Moderate, \n                                  1/ps$Inactive))\nwith(dat.analytic, by(ipw, phyact, summary))\n#> phyact: Inactive\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.123   1.671   1.994   2.233   2.505  14.536 \n#> ------------------------------------------------------------ \n#> phyact: Moderate\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   2.508   3.206   3.576   3.743   4.087  11.695 \n#> ------------------------------------------------------------ \n#> phyact: Active\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.329   2.310   3.086   3.534   4.225  25.049\n```\n:::\n\n\n##### Balance checking\n\nNow, we will check the balance in terms of SMD:\n\n\n::: {.cell hash='propensityscore9_cache/html/nominalbalance_f505c417634c97708e0e12bf86319fc3'}\n\n```{.r .cell-code}\nlibrary(survey)\nvars <- c(\"age\", \"sex\", \"married\", \"race\", \"edu\", \"income\", \"bmi\", \"doctor\", \"stress\", \n          \"smoke\", \"drink\", \"fruit\", \"bp\", \"diab\", \"OA\", \"immigrate\")\n\n# Design\nw.design <- svydesign(id = ~1, weights = ~ipw, data = dat.analytic)\n\n# Table 1\ntabw <- svyCreateTableOne(vars = vars, strata = \"phyact\", data = w.design, test = F)\nprint(tabw, smd = T, showAllLevels = T)\n#>                Stratified by phyact\n#>                 level             Inactive        Moderate       \n#>   n                               39231.2         39519.8        \n#>   age (%)       20-29 years        6477.4 (16.5)   6856.1 (17.3) \n#>                 30-39 years        7706.8 (19.6)   8174.8 (20.7) \n#>                 40-49 years        7098.2 (18.1)   7163.0 (18.1) \n#>                 50-59 years        5922.4 (15.1)   5901.2 (14.9) \n#>                 60-64 years        2414.8 ( 6.2)   2265.4 ( 5.7) \n#>                 65 years and over  6187.1 (15.8)   5843.8 (14.8) \n#>                 teen               3424.6 ( 8.7)   3315.4 ( 8.4) \n#>   sex (%)       Female            20188.3 (51.5)  20693.4 (52.4) \n#>                 Male              19042.9 (48.5)  18826.3 (47.6) \n#>   married (%)   not single        20665.9 (52.7)  20907.0 (52.9) \n#>                 single            18565.3 (47.3)  18612.8 (47.1) \n#>   race (%)      Non-white          3471.9 ( 8.8)   4095.5 (10.4) \n#>                 White             35759.3 (91.2)  35424.2 (89.6) \n#>   edu (%)       < 2ndary           7267.3 (18.5)   7288.2 (18.4) \n#>                 2nd grad.          6902.6 (17.6)   6901.3 (17.5) \n#>                 Other 2nd grad.    3783.0 ( 9.6)   3671.6 ( 9.3) \n#>                 Post-2nd grad.    21278.3 (54.2)  21658.7 (54.8) \n#>   income (%)    $29,999 or less    8432.3 (21.5)   8425.7 (21.3) \n#>                 $30,000-$49,999    8115.6 (20.7)   8109.8 (20.5) \n#>                 $50,000-$79,999   10169.1 (25.9)  10602.5 (26.8) \n#>                 $80,000 or more   12514.2 (31.9)  12381.9 (31.3) \n#>   bmi (%)       Underweight        1092.7 ( 2.8)   1110.6 ( 2.8) \n#>                 healthy weight    18191.1 (46.4)  18613.7 (47.1) \n#>                 Overweight        19947.4 (50.8)  19795.5 (50.1) \n#>   doctor (%)    No                 5073.1 (12.9)   5127.6 (13.0) \n#>                 Yes               34158.1 (87.1)  34392.2 (87.0) \n#>   stress (%)    Not too stressed  30921.0 (78.8)  31245.6 (79.1) \n#>                 stressed           8310.3 (21.2)   8274.2 (20.9) \n#>   smoke (%)     Current smoker    10018.8 (25.5)  10121.1 (25.6) \n#>                 Former smoker     15860.1 (40.4)  15737.2 (39.8) \n#>                 Never smoker      13352.4 (34.0)  13661.5 (34.6) \n#>   drink (%)     Current drinker   32257.4 (82.2)  32836.4 (83.1) \n#>                 Former driker      4857.5 (12.4)   4621.5 (11.7) \n#>                 Never drank        2116.4 ( 5.4)   2061.9 ( 5.2) \n#>   fruit (%)     0-3 daily serving  9738.2 (24.8)   9786.2 (24.8) \n#>                 4-6 daily serving 19523.6 (49.8)  19803.8 (50.1) \n#>                 6+ daily serving   9969.4 (25.4)   9929.8 (25.1) \n#>   bp (%)        No                33045.9 (84.2)  33662.1 (85.2) \n#>                 Yes                6185.3 (15.8)   5857.7 (14.8) \n#>   diab (%)      No                37227.0 (94.9)  37572.5 (95.1) \n#>                 Yes                2004.2 ( 5.1)   1947.3 ( 4.9) \n#>   OA (%)        Control           34297.7 (87.4)  34835.2 (88.1) \n#>                 OA                 4933.5 (12.6)   4684.6 (11.9) \n#>   immigrate (%) not immigrant     37503.8 (95.6)  37532.8 (95.0) \n#>                 recent             1727.4 ( 4.4)   1987.0 ( 5.0) \n#>                Stratified by phyact\n#>                 Active          SMD   \n#>   n             40667.9               \n#>   age (%)        6467.5 (15.9)   0.046\n#>                  8588.7 (21.1)        \n#>                  7538.2 (18.5)        \n#>                  6327.6 (15.6)        \n#>                  2420.1 ( 6.0)        \n#>                  5989.1 (14.7)        \n#>                  3336.8 ( 8.2)        \n#>   sex (%)       21026.2 (51.7)   0.012\n#>                 19641.7 (48.3)        \n#>   married (%)   22651.2 (55.7)   0.040\n#>                 18016.8 (44.3)        \n#>   race (%)       3834.0 ( 9.4)   0.034\n#>                 36834.0 (90.6)        \n#>   edu (%)        7395.4 (18.2)   0.023\n#>                  6825.8 (16.8)        \n#>                  3765.2 ( 9.3)        \n#>                 22681.6 (55.8)        \n#>   income (%)     8029.8 (19.7)   0.041\n#>                  8544.1 (21.0)        \n#>                 11407.3 (28.0)        \n#>                 12686.7 (31.2)        \n#>   bmi (%)        1241.6 ( 3.1)   0.017\n#>                 19120.5 (47.0)        \n#>                 20305.8 (49.9)        \n#>   doctor (%)     5272.7 (13.0)   0.001\n#>                 35395.3 (87.0)        \n#>   stress (%)    32100.6 (78.9)   0.004\n#>                  8567.4 (21.1)        \n#>   smoke (%)      9760.6 (24.0)   0.032\n#>                 17024.0 (41.9)        \n#>                 13883.4 (34.1)        \n#>   drink (%)     33927.5 (83.4)   0.022\n#>                  4634.1 (11.4)        \n#>                  2106.3 ( 5.2)        \n#>   fruit (%)     10170.0 (25.0)   0.007\n#>                 20200.6 (49.7)        \n#>                 10297.3 (25.3)        \n#>   bp (%)        34372.4 (84.5)   0.017\n#>                  6295.6 (15.5)        \n#>   diab (%)      38850.3 (95.5)   0.020\n#>                  1817.7 ( 4.5)        \n#>   OA (%)        35666.9 (87.7)   0.015\n#>                  5001.1 (12.3)        \n#>   immigrate (%) 38662.6 (95.1)   0.020\n#>                  2005.4 ( 4.9)\n```\n:::\n\n\nAll covariates are balanced in terms of SMD (SMD $\\le$ 0.20).\n\n##### Outcome analysis\n\nNow, we will fit the outcome model. To get the correct estimate of the standard error, we will set up the design with full data and subset the design.\n\n\n::: {.cell hash='propensityscore9_cache/html/nominaloutcome_c98b74a73316124c20d4eecf650e49ca'}\n\n```{.r .cell-code}\n# Create an indicator variable in the full dataset\ndat.full$ind <- 0\ndat.full$ind[dat.full$ID %in% dat.analytic$ID] <- 1\n\n# New weight = IPW * survey weight\ndat.analytic$ATEweight <- with(dat.analytic, ipw * weight)\n\n# New weight variable in the full dataset\ndat.full$ATEweight <- 0\ndat.full$ATEweight[dat.full$ID %in% dat.analytic$ID] <- dat.analytic$ATEweight\n\n# Survey setup with full data \nw.design0 <- svydesign(id = ~1, weights = ~ATEweight, data = dat.full)\n\n# Subset the design for analytic sample\nw.design1 <- subset(w.design0, ind == 1)\n\n# Weighted proportion\nw.prop <- svyby(formula = ~CVD, by = ~phyact, design = w.design1, FUN = svymean)\nw.prop\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"CVDNo\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CVDYes\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDNo\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDYes\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Inactive\",\"2\":\"0.9665973\",\"3\":\"0.03340275\",\"4\":\"0.001503366\",\"5\":\"0.001503366\",\"_rn_\":\"Inactive\"},{\"1\":\"Moderate\",\"2\":\"0.9683972\",\"3\":\"0.03160284\",\"4\":\"0.002382517\",\"5\":\"0.002382517\",\"_rn_\":\"Moderate\"},{\"1\":\"Active\",\"2\":\"0.9720610\",\"3\":\"0.02793902\",\"4\":\"0.002312340\",\"5\":\"0.002312340\",\"_rn_\":\"Active\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Outcome model\nfit <- svyglm(CVD ~ phyact, design = w.design1, family = binomial)\npublish(fit, confint.method = \"robust\", pvalue.method = \"robust\")\n#>  Variable    Units OddsRatio       CI.95  p-value \n#>    phyact Inactive       Ref                      \n#>           Moderate      0.94 [0.64;1.38]   0.7693 \n#>             Active      0.83 [0.53;1.29]   0.4133\n```\n:::\n\n\n#### Ordinal categories (for comparison)\n\nFor comparison, let us consider physical activity as a ordinal variable (option 2).\n\n##### Define ordinal variable\n\n\n::: {.cell hash='propensityscore9_cache/html/ordinalvar_53be675ce42a1b74edbb8010161fc984'}\n\n```{.r .cell-code}\n# Exposure - ordinal physical activity\ndat.full$phyact.ord <- factor(dat.full$phyact, levels = c(\"Inactive\", \"Moderate\", \"Active\"), \n                              ordered = T)\ndat.analytic$phyact.ord <- factor(dat.analytic$phyact, \n                                  levels = c(\"Inactive\", \"Moderate\", \"Active\"), ordered = T)\nhead(dat.analytic$phyact.ord)\n#> [1] Inactive Moderate Active   Moderate Active   Active  \n#> Levels: Inactive < Moderate < Active\n```\n:::\n\n\n##### Estimating Propensity score\n\n\n::: {.cell hash='propensityscore9_cache/html/ordinalfit_e20c8e8158e66ba6fa6d09ed8d6c3d45'}\n\n```{.r .cell-code}\n# Formula\nps.formula2 <- formula(phyact.ord ~ age + sex + married + race + edu + income + bmi + \n                        doctor + stress + smoke + drink + fruit + bp + diab + \n                        OA + immigrate)\n\n# PS model\nlibrary(VGAM)\nps.fit2 <- vglm(ps.formula2, weights = weight, data = dat.analytic, family = propodds)\n\n# Propensity scores\nps2 <- data.frame(fitted(ps.fit2))\nhead(ps2)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Inactive\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Moderate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Active\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.3766661\",\"2\":\"0.2984630\",\"3\":\"0.3248709\",\"_rn_\":\"264953\"},{\"1\":\"0.5350844\",\"2\":\"0.2632260\",\"3\":\"0.2016896\",\"_rn_\":\"264954\"},{\"1\":\"0.5119910\",\"2\":\"0.2709983\",\"3\":\"0.2170107\",\"_rn_\":\"264961\"},{\"1\":\"0.4731775\",\"2\":\"0.2822563\",\"3\":\"0.2445662\",\"_rn_\":\"264962\"},{\"1\":\"0.1277460\",\"2\":\"0.2072136\",\"3\":\"0.6650404\",\"_rn_\":\"264963\"},{\"1\":\"0.4335105\",\"2\":\"0.2911417\",\"3\":\"0.2753478\",\"_rn_\":\"264964\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Summary\napply(ps2, 2, summary)\n#>           Inactive   Moderate     Active\n#> Min.    0.07517679 0.07505615 0.03456101\n#> 1st Qu. 0.34108922 0.25002048 0.18907940\n#> Median  0.44711595 0.28026693 0.26446898\n#> Mean    0.44780744 0.26682382 0.28536874\n#> 3rd Qu. 0.55497781 0.29473347 0.35967960\n#> Max.    0.89038285 0.29934482 0.78152250\n```\n:::\n\n\n##### Creating weights\n\nLet us create PS weights:\n\n\n::: {.cell hash='propensityscore9_cache/html/ordinalwgt_a6b8607ef5e6a0d4fb2b7b10b1c677fd'}\n\n```{.r .cell-code}\n# IPW\ndat.analytic$ipw2 <- ifelse(dat.analytic$phyact==\"Active\", 1/ps2$Active, \n                           ifelse(dat.analytic$phyact==\"Moderate\", 1/ps2$Moderate, \n                                  1/ps2$Inactive))\nwith(dat.analytic, by(ipw2, phyact.ord, summary))\n#> phyact.ord: Inactive\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.123   1.668   2.001   2.237   2.516  13.302 \n#> ------------------------------------------------------------ \n#> phyact.ord: Moderate\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   3.341   3.382   3.525   3.748   3.875  11.248 \n#> ------------------------------------------------------------ \n#> phyact.ord: Active\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.280   2.319   3.073   3.504   4.211  19.768\n```\n:::\n\n\n##### Balance checking\n\nNow, we will check the balance in terms of SMD:\n\n\n::: {.cell hash='propensityscore9_cache/html/ordinalbalance_c0af5e185d8298f6b4a63a4d3e58a78f'}\n\n```{.r .cell-code}\nlibrary(survey)\nvars <- c(\"age\", \"sex\", \"married\", \"race\", \"edu\", \"income\", \"bmi\", \"doctor\", \"stress\", \n          \"smoke\", \"drink\", \"fruit\", \"bp\", \"diab\", \"OA\", \"immigrate\")\n\n# Design\nw.design <- svydesign(id = ~1, weights = ~ipw2, data = dat.analytic)\n\n# Table 1\ntabw2 <- svyCreateTableOne(vars = vars, strata = \"phyact\", data = w.design, test = F)\nprint(tabw2, smd = T, showAllLevels = T)\n#>                Stratified by phyact\n#>                 level             Inactive        Moderate       \n#>   n                               39305.5         39566.3        \n#>   age (%)       20-29 years        6679.4 (17.0)   6125.6 (15.5) \n#>                 30-39 years        7635.7 (19.4)   8357.8 (21.1) \n#>                 40-49 years        7085.9 (18.0)   7124.1 (18.0) \n#>                 50-59 years        5820.8 (14.8)   6307.9 (15.9) \n#>                 60-64 years        2339.1 ( 6.0)   2494.0 ( 6.3) \n#>                 65 years and over  6108.9 (15.5)   6264.9 (15.8) \n#>                 teen               3635.8 ( 9.3)   2892.0 ( 7.3) \n#>   sex (%)       Female            19987.1 (50.9)  21622.5 (54.6) \n#>                 Male              19318.4 (49.1)  17943.8 (45.4) \n#>   married (%)   not single        20342.7 (51.8)  22151.4 (56.0) \n#>                 single            18962.9 (48.2)  17414.9 (44.0) \n#>   race (%)      Non-white          3595.2 ( 9.1)   3507.2 ( 8.9) \n#>                 White             35710.4 (90.9)  36059.1 (91.1) \n#>   edu (%)       < 2ndary           7467.4 (19.0)   6739.9 (17.0) \n#>                 2nd grad.          7027.3 (17.9)   6644.2 (16.8) \n#>                 Other 2nd grad.    3815.2 ( 9.7)   3628.7 ( 9.2) \n#>                 Post-2nd grad.    20995.6 (53.4)  22553.5 (57.0) \n#>   income (%)    $29,999 or less    8596.0 (21.9)   7724.2 (19.5) \n#>                 $30,000-$49,999    8182.3 (20.8)   7888.9 (19.9) \n#>                 $50,000-$79,999   10126.1 (25.8)  11034.9 (27.9) \n#>                 $80,000 or more   12401.1 (31.6)  12918.3 (32.6) \n#>   bmi (%)       Underweight        1134.1 ( 2.9)    960.4 ( 2.4) \n#>                 healthy weight    18284.0 (46.5)  18426.4 (46.6) \n#>                 Overweight        19887.4 (50.6)  20179.5 (51.0) \n#>   doctor (%)    No                 5183.0 (13.2)   4741.2 (12.0) \n#>                 Yes               34122.5 (86.8)  34825.0 (88.0) \n#>   stress (%)    Not too stressed  31032.0 (79.0)  31233.5 (78.9) \n#>                 stressed           8273.6 (21.0)   8332.8 (21.1) \n#>   smoke (%)     Current smoker    10263.8 (26.1)   9253.9 (23.4) \n#>                 Former smoker     15572.0 (39.6)  16822.9 (42.5) \n#>                 Never smoker      13469.8 (34.3)  13489.4 (34.1) \n#>   drink (%)     Current drinker   32206.8 (81.9)  33304.9 (84.2) \n#>                 Former driker      4898.9 (12.5)   4438.8 (11.2) \n#>                 Never drank        2199.8 ( 5.6)   1822.5 ( 4.6) \n#>   fruit (%)     0-3 daily serving  9841.8 (25.0)   9509.3 (24.0) \n#>                 4-6 daily serving 19586.3 (49.8)  19922.3 (50.4) \n#>                 6+ daily serving   9877.5 (25.1)  10134.7 (25.6) \n#>   bp (%)        No                33233.3 (84.6)  33115.0 (83.7) \n#>                 Yes                6072.2 (15.4)   6451.2 (16.3) \n#>   diab (%)      No                37292.2 (94.9)  37648.3 (95.2) \n#>                 Yes                2013.4 ( 5.1)   1918.0 ( 4.8) \n#>   OA (%)        Control           34458.3 (87.7)  34493.7 (87.2) \n#>                 OA                 4847.3 (12.3)   5072.6 (12.8) \n#>   immigrate (%) not immigrant     37534.6 (95.5)  37816.7 (95.6) \n#>                 recent             1770.9 ( 4.5)   1749.5 ( 4.4) \n#>                Stratified by phyact\n#>                 Active          SMD   \n#>   n             40328.5               \n#>   age (%)        6789.1 (16.8)   0.080\n#>                  8504.7 (21.1)        \n#>                  7562.1 (18.8)        \n#>                  6079.6 (15.1)        \n#>                  2283.6 ( 5.7)        \n#>                  5614.4 (13.9)        \n#>                  3495.0 ( 8.7)        \n#>   sex (%)       20379.8 (50.5)   0.055\n#>                 19948.8 (49.5)        \n#>   married (%)   21840.5 (54.2)   0.057\n#>                 18488.0 (45.8)        \n#>   race (%)       4125.6 (10.2)   0.031\n#>                 36202.9 (89.8)        \n#>   edu (%)        7564.8 (18.8)   0.052\n#>                  6886.8 (17.1)        \n#>                  3777.5 ( 9.4)        \n#>                 22099.4 (54.8)        \n#>   income (%)     8371.7 (20.8)   0.056\n#>                  8581.4 (21.3)        \n#>                 11013.7 (27.3)        \n#>                 12361.7 (30.7)        \n#>   bmi (%)        1294.7 ( 3.2)   0.037\n#>                 19134.4 (47.4)        \n#>                 19899.5 (49.3)        \n#>   doctor (%)     5467.9 (13.6)   0.031\n#>                 34860.6 (86.4)        \n#>   stress (%)    31816.9 (78.9)   0.001\n#>                  8511.6 (21.1)        \n#>   smoke (%)     10153.3 (25.2)   0.048\n#>                 16300.6 (40.4)        \n#>                 13874.6 (34.4)        \n#>   drink (%)     33415.6 (82.9)   0.043\n#>                  4714.1 (11.7)        \n#>                  2198.9 ( 5.5)        \n#>   fruit (%)     10190.6 (25.3)   0.020\n#>                 19953.3 (49.5)        \n#>                 10184.6 (25.3)        \n#>   bp (%)        34557.1 (85.7)   0.037\n#>                  5771.5 (14.3)        \n#>   diab (%)      38519.4 (95.5)   0.020\n#>                  1809.1 ( 4.5)        \n#>   OA (%)        35641.0 (88.4)   0.024\n#>                  4687.5 (11.6)        \n#>   immigrate (%) 38153.4 (94.6)   0.030\n#>                  2175.2 ( 5.4)\n```\n:::\n\n\nAgain, all covariates are balanced in terms of SMD.\n\n##### Outcome analysis\n\nNow, we will fit the outcome model:\n\n\n::: {.cell hash='propensityscore9_cache/html/ordinaloutcome_7c426b33ddb3afe55734e2b04c51e1cf'}\n\n```{.r .cell-code}\n# Create an indicator variable in the full dataset\ndat.full$ind <- 0\ndat.full$ind[dat.full$ID %in% dat.analytic$ID] <- 1\n\n# New weight = IPW * survey weight\ndat.analytic$ATEweight2 <- with(dat.analytic, ipw2 * weight)\n\n# New weight variable in the full dataset\ndat.full$ATEweight2 <- 0\ndat.full$ATEweight2[dat.full$ID %in% dat.analytic$ID] <- dat.analytic$ATEweight2\n\n# Survey setup with full data \nw.design0 <- svydesign(id = ~1, weights = ~ATEweight2, data = dat.full)\n\n# Subset the design for analytic sample\nw.design1 <- subset(w.design0, ind == 1)\n\n# Weighted proportion\nw.prop2 <- svyby(formula = ~CVD, by = ~phyact, design = w.design1, FUN = svymean)\nw.prop2\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"CVDNo\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CVDYes\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDNo\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDYes\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Inactive\",\"2\":\"0.9670906\",\"3\":\"0.03290938\",\"4\":\"0.001472275\",\"5\":\"0.001472275\",\"_rn_\":\"Inactive\"},{\"1\":\"Moderate\",\"2\":\"0.9669294\",\"3\":\"0.03307061\",\"4\":\"0.002382617\",\"5\":\"0.002382617\",\"_rn_\":\"Moderate\"},{\"1\":\"Active\",\"2\":\"0.9730239\",\"3\":\"0.02697612\",\"4\":\"0.002265397\",\"5\":\"0.002265397\",\"_rn_\":\"Active\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Outcome model\nfit2 <- svyglm(CVD ~ phyact, design = w.design1, family = binomial)\npublish(fit2, confint.method = \"robust\", pvalue.method = \"robust\")\n#>  Variable    Units OddsRatio       CI.95  p-value \n#>    phyact Inactive       Ref                      \n#>           Moderate      1.01 [0.71;1.43]   0.9775 \n#>             Active      0.81 [0.52;1.27]   0.3645\n```\n:::\n\n\n#### Machine learning / GBM (option 3)\n\nIn this part, we will use [Gradient Boosting](https://en.wikipedia.org/wiki/Gradient_boosting) as one of the machine learning techniques to estimate the propensity scores.\n\n##### Estimating Propensity score\n\n\n::: {.cell hash='propensityscore9_cache/html/gbmfit1_5cb6712f39c5ae2a0171013b3518eb74'}\n\n```{.r .cell-code}\n# Formula\nps.formula3 <- formula(phyact.ord ~ age + sex + married + race + edu + income + bmi + \n                        doctor + stress + smoke + drink + fruit + bp + diab + \n                        OA + immigrate)\n\n# PS model\npacman::p_load(twang)\nset.seed(123)\nps.fit3 <- mnps(ps.formula3, data = dat.analytic, estimand = \"ATE\", verbose = FALSE,\n                stop.method = c(\"es.max\"), n.trees = 200, sampw = dat.analytic$weight)\nsummary(ps.fit3)\n#> Summary of pairwise comparisons:\n#>   max.std.eff.sz min.p max.ks min.ks.pval stop.method\n#> 1      0.4134866     0      1           0         unw\n#> 2      0.1880231     0      1           0      es.max\n#> \n#> Sample sizes and effective sample sizes:\n#>   treatment     n ESS:es.max\n#> 1  Inactive 17569   7361.137\n#> 2  Moderate 10557   4875.807\n#> 3    Active 11508   5376.500\n```\n:::\n\n::: {.cell hash='propensityscore9_cache/html/gbmfit2_7a894db6feef0aeb839e70bf7f2354e5'}\n\n```{.r .cell-code}\n# Propensity scores\nps3 <- data.frame(Active = ps.fit3$psList$Active$ps,\n                 Moderate = ps.fit3$psList$Moderate$ps,\n                 Inactive = ps.fit3$psList$Inactive$ps)\nnames(ps3) <- c(\"Active\",\"Moderate\",\"Inactive\")\nhead(ps3)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"Active\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Moderate\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"Inactive\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.3040098\",\"2\":\"0.2675876\",\"3\":\"0.4020112\",\"_rn_\":\"1\"},{\"1\":\"0.2418255\",\"2\":\"0.2600676\",\"3\":\"0.4910122\",\"_rn_\":\"2\"},{\"1\":\"0.2784937\",\"2\":\"0.2296143\",\"3\":\"0.5104120\",\"_rn_\":\"3\"},{\"1\":\"0.2664345\",\"2\":\"0.2569280\",\"3\":\"0.4827570\",\"_rn_\":\"4\"},{\"1\":\"0.5330670\",\"2\":\"0.2407481\",\"3\":\"0.2759573\",\"_rn_\":\"5\"},{\"1\":\"0.2911926\",\"2\":\"0.2671368\",\"3\":\"0.4080280\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Summary\napply(ps3, 2, summary)\n#>            Active  Moderate  Inactive\n#> Min.    0.1827539 0.1884745 0.2759573\n#> 1st Qu. 0.2316300 0.2478217 0.3726945\n#> Median  0.2664345 0.2666218 0.4485734\n#> Mean    0.2894693 0.2679683 0.4420585\n#> 3rd Qu. 0.3343953 0.2859762 0.5015505\n#> Max.    0.5330670 0.3255325 0.6389846\n```\n:::\n\n\n##### Creating weights\n\nLet us create PS weights:\n\n\n::: {.cell hash='propensityscore9_cache/html/gbmwgt_87131c18ad297a6f7acd6f4633db2ddd'}\n\n```{.r .cell-code}\n# IPW\ndat.analytic$ipw3 <- ifelse(dat.analytic$phyact==\"Active\", 1/ps3$Active, \n                           ifelse(dat.analytic$phyact==\"Moderate\", 1/ps3$Moderate, \n                                  1/ps3$Inactive))\nwith(dat.analytic, by(ipw3, phyact, summary))\n#> phyact: Inactive\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.565   1.877   2.086   2.206   2.484   3.624 \n#> ------------------------------------------------------------ \n#> phyact: Moderate\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   3.072   3.415   3.652   3.709   3.947   5.306 \n#> ------------------------------------------------------------ \n#> phyact: Active\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   1.876   2.716   3.229   3.320   3.952   5.465\n```\n:::\n\n\nWeights are not large compared to options 1 and 2.\n\n##### Balance checking\n\nNow, we will check the balance in terms of SMD:\n\n\n::: {.cell hash='propensityscore9_cache/html/gbmbalance_dae68e420682380a064cc40370951d31'}\n\n```{.r .cell-code}\nlibrary(survey)\nvars <- c(\"age\", \"sex\", \"married\", \"race\", \"edu\", \"income\", \"bmi\", \"doctor\", \"stress\", \n          \"smoke\", \"drink\", \"fruit\", \"bp\", \"diab\", \"OA\", \"immigrate\")\n\n# Design\nw.design <- svydesign(id = ~1, weights = ~ipw3, data = dat.analytic)\n\n# Table 1\ntabw <- svyCreateTableOne(vars = vars, strata = \"phyact\", data = w.design, test = F)\nprint(tabw, smd = T, showAllLevels = T)\n#>                Stratified by phyact\n#>                 level             Inactive        Moderate       \n#>   n                               38763.2         39159.6        \n#>   age (%)       20-29 years        6086.5 (15.7)   6641.5 (17.0) \n#>                 30-39 years        7624.6 (19.7)   8171.6 (20.9) \n#>                 40-49 years        7057.4 (18.2)   7073.0 (18.1) \n#>                 50-59 years        6267.5 (16.2)   5894.9 (15.1) \n#>                 60-64 years        2399.6 ( 6.2)   2390.7 ( 6.1) \n#>                 65 years and over  6883.8 (17.8)   5859.8 (15.0) \n#>                 teen               2443.7 ( 6.3)   3128.1 ( 8.0) \n#>   sex (%)       Female            20928.4 (54.0)  21097.6 (53.9) \n#>                 Male              17834.8 (46.0)  18062.0 (46.1) \n#>   married (%)   not single        21244.6 (54.8)  21279.5 (54.3) \n#>                 single            17518.5 (45.2)  17880.1 (45.7) \n#>   race (%)      Non-white          3683.4 ( 9.5)   3666.8 ( 9.4) \n#>                 White             35079.7 (90.5)  35492.8 (90.6) \n#>   edu (%)       < 2ndary           7610.9 (19.6)   6692.3 (17.1) \n#>                 2nd grad.          7088.9 (18.3)   6693.3 (17.1) \n#>                 Other 2nd grad.    3558.1 ( 9.2)   3619.6 ( 9.2) \n#>                 Post-2nd grad.    20505.3 (52.9)  22154.2 (56.6) \n#>   income (%)    $29,999 or less    9138.3 (23.6)   7750.6 (19.8) \n#>                 $30,000-$49,999    8400.8 (21.7)   7956.3 (20.3) \n#>                 $50,000-$79,999    9946.0 (25.7)  10696.8 (27.3) \n#>                 $80,000 or more   11278.0 (29.1)  12755.9 (32.6) \n#>   bmi (%)       Underweight        1195.7 ( 3.1)    967.7 ( 2.5) \n#>                 healthy weight    16766.4 (43.3)  18791.6 (48.0) \n#>                 Overweight        20801.0 (53.7)  19400.2 (49.5) \n#>   doctor (%)    No                 5070.5 (13.1)   4827.3 (12.3) \n#>                 Yes               33692.7 (86.9)  34332.3 (87.7) \n#>   stress (%)    Not too stressed  29885.7 (77.1)  31099.5 (79.4) \n#>                 stressed           8877.5 (22.9)   8060.0 (20.6) \n#>   smoke (%)     Current smoker    10737.3 (27.7)   9401.4 (24.0) \n#>                 Former smoker     15204.3 (39.2)  16211.3 (41.4) \n#>                 Never smoker      12821.5 (33.1)  13546.9 (34.6) \n#>   drink (%)     Current drinker   31123.7 (80.3)  33043.2 (84.4) \n#>                 Former driker      5322.0 (13.7)   4301.7 (11.0) \n#>                 Never drank        2317.5 ( 6.0)   1814.6 ( 4.6) \n#>   fruit (%)     0-3 daily serving 10529.0 (27.2)   8996.8 (23.0) \n#>                 4-6 daily serving 19466.5 (50.2)  19851.5 (50.7) \n#>                 6+ daily serving   8767.6 (22.6)  10311.3 (26.3) \n#>   bp (%)        No                31712.5 (81.8)  33335.5 (85.1) \n#>                 Yes                7050.7 (18.2)   5824.1 (14.9) \n#>   diab (%)      No                36326.4 (93.7)  37499.3 (95.8) \n#>                 Yes                2436.8 ( 6.3)   1660.2 ( 4.2) \n#>   OA (%)        Control           33060.8 (85.3)  34579.5 (88.3) \n#>                 OA                 5702.3 (14.7)   4580.0 (11.7) \n#>   immigrate (%) not immigrant     36812.8 (95.0)  37425.9 (95.6) \n#>                 recent             1950.3 ( 5.0)   1733.7 ( 4.4) \n#>                Stratified by phyact\n#>                 Active          SMD   \n#>   n             38211.2               \n#>   age (%)        6567.9 (17.2)   0.145\n#>                  8208.6 (21.5)        \n#>                  7313.3 (19.1)        \n#>                  5555.3 (14.5)        \n#>                  2186.9 ( 5.7)        \n#>                  4539.2 (11.9)        \n#>                  3840.0 (10.0)        \n#>   sex (%)       18441.4 (48.3)   0.077\n#>                 19769.8 (51.7)        \n#>   married (%)   20012.7 (52.4)   0.033\n#>                 18198.5 (47.6)        \n#>   race (%)       3397.2 ( 8.9)   0.014\n#>                 34814.0 (91.1)        \n#>   edu (%)        6186.6 (16.2)   0.081\n#>                  6159.6 (16.1)        \n#>                  3630.7 ( 9.5)        \n#>                 22234.2 (58.2)        \n#>   income (%)     6758.9 (17.7)   0.120\n#>                  7420.8 (19.4)        \n#>                 10612.9 (27.8)        \n#>                 13418.7 (35.1)        \n#>   bmi (%)        1041.5 ( 2.7)   0.112\n#>                 19648.4 (51.4)        \n#>                 17521.2 (45.9)        \n#>   doctor (%)     5001.8 (13.1)   0.015\n#>                 33209.4 (86.9)        \n#>   stress (%)    30845.7 (80.7)   0.059\n#>                  7365.5 (19.3)        \n#>   smoke (%)      8531.3 (22.3)   0.083\n#>                 16200.7 (42.4)        \n#>                 13479.2 (35.3)        \n#>   drink (%)     32817.1 (85.9)   0.101\n#>                  3703.9 ( 9.7)        \n#>                  1690.1 ( 4.4)        \n#>   fruit (%)      7924.2 (20.7)   0.120\n#>                 19284.4 (50.5)        \n#>                 11002.5 (28.8)        \n#>   bp (%)        33698.1 (88.2)   0.120\n#>                  4513.1 (11.8)        \n#>   diab (%)      36930.8 (96.6)   0.092\n#>                  1280.4 ( 3.4)        \n#>   OA (%)        34640.5 (90.7)   0.110\n#>                  3570.7 ( 9.3)        \n#>   immigrate (%) 36764.3 (96.2)   0.040\n#>                  1446.8 ( 3.8)\n```\n:::\n\n\nAll covariates are balanced in terms of SMD.\n\n\n::: {.cell hash='propensityscore9_cache/html/gbmbalance2_6b76371feabd5b6ce9c5cc160a520f6b'}\n\n```{.r .cell-code}\nplot(ps.fit3, color = TRUE, plots = 2, figureRows = 1)\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance2-1.png){width=672}\n:::\n\n```\n#> [[1]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance2-2.png){width=672}\n:::\n\n```\n#> \n#> [[2]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance2-3.png){width=672}\n:::\n\n```\n#> \n#> [[3]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance2-4.png){width=672}\n:::\n:::\n\n::: {.cell hash='propensityscore9_cache/html/gbmbalance3_8415b176b0ca9c0fdd45e26d3bb2e442'}\n\n```{.r .cell-code}\nplot(ps.fit3, plots = 3, color=TRUE, pairwiseMax = FALSE)\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance3-1.png){width=672}\n:::\n\n```\n#> [[1]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance3-2.png){width=672}\n:::\n\n```\n#> \n#> [[2]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance3-3.png){width=672}\n:::\n\n```\n#> \n#> [[3]]\n```\n\n::: {.cell-output-display}\n![](propensityscore9_files/figure-html/gbmbalance3-4.png){width=672}\n:::\n:::\n\n\n##### Outcome analysis\n\nNow, we will fit the outcome model:\n\n\n::: {.cell hash='propensityscore9_cache/html/gbmloutcome_a9b804936b307c80a37a97725fd7ebc2'}\n\n```{.r .cell-code}\n# Create an indicator variable in the full dataset\ndat.full$ind <- 0\ndat.full$ind[dat.full$ID %in% dat.analytic$ID] <- 1\n\n# New weight = IPW * survey weight\ndat.analytic$ATEweight3 <- with(dat.analytic, ipw3 * weight)\n\n# New weight variable in the full dataset\ndat.full$ATEweight3 <- 0\ndat.full$ATEweight3[dat.full$ID %in% dat.analytic$ID] <- dat.analytic$ATEweight3\n\n# Survey setup with full data \nw.design0 <- svydesign(id = ~1, weights = ~ATEweight3, data = dat.full)\n\n# Subset the design for analytic sample\nw.design1 <- subset(w.design0, ind == 1)\n\n# Weighted proportion\nw.prop <- svyby(formula = ~CVD, by = ~phyact, design = w.design1, FUN = svymean)\nw.prop\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"CVDNo\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CVDYes\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDNo\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se.CVDYes\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Inactive\",\"2\":\"0.9620985\",\"3\":\"0.03790148\",\"4\":\"0.001627655\",\"5\":\"0.001627655\",\"_rn_\":\"Inactive\"},{\"1\":\"Moderate\",\"2\":\"0.9685547\",\"3\":\"0.03144532\",\"4\":\"0.002361135\",\"5\":\"0.002361135\",\"_rn_\":\"Moderate\"},{\"1\":\"Active\",\"2\":\"0.9748839\",\"3\":\"0.02511610\",\"4\":\"0.002074074\",\"5\":\"0.002074074\",\"_rn_\":\"Active\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Outcome model\nfit3 <- svyglm(CVD ~ phyact, design = w.design1, family = binomial)\npublish(fit3, confint.method = \"robust\", pvalue.method = \"robust\")\n#>  Variable    Units OddsRatio       CI.95   p-value \n#>    phyact Inactive       Ref                       \n#>           Moderate      0.82 [0.56;1.21]   0.32241 \n#>             Active      0.65 [0.44;0.96]   0.03203\n```\n:::\n\n\n#### Other approches for multiple treatments\n\nNot covered here, but possible to do in a multiple treatments context:\n\n-   Propensity score matching\n-   Propensity score stratification\n-   Marginal mean weighting\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}