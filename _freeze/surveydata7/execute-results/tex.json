{
  "hash": "cf7a9afe9fd033b1b644610d67acf932",
  "result": {
    "markdown": "## NHANES: Cholesterol {.unnumbered}\n\n\n\n::: {.cell hash='surveydata7_cache/pdf/setup_220d6cf01d32cb8a3ae026dd376f9fd6'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(survey)\nlibrary(Publish)\nlibrary(tableone)\nlibrary(ROCR)\nlibrary(WeightedROC)\nlibrary(jtools)\nlibrary(dplyr)\n```\n:::\n\n\n\n### Preprocessing\n\n#### Analytic data set\n\nWe will use `cholesterolNHANES15part1.RData` in this prediction goal question (predicting cholesterol in adults).\n\nFor this exercise, we are assuming that:\n\n-   outcome: cholesterol\n\n-   predictors:\n\n    -   gender\n    -   whether born in US\n    -   race\n    -   education\n    -   whether married\n    -   income level\n    -   BMI\n    -   whether has diabetes\n\n-   survey features:\n\n    -   survey weights\n    -   strata\n    -   cluster/PSU; where strata is nested within clusters\n\n    -- restrict to those participants who are of 18 years of age or older\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"Data/surveydata/cholesterolNHANES15part1.rdata\") #Loading the dataset\nls()\n#>  [1] \"analytic\"           \"analytic.with.miss\" \"analytic1\"         \n#>  [4] \"analytic2\"          \"analytic2b\"         \"analytic3\"         \n#>  [7] \"collinearity\"       \"correlationMatrix\"  \"diff.boot\"         \n#> [10] \"extract.boot.fun\"   \"extract.fit\"        \"extract.lm.fun\"    \n#> [13] \"fictitious.data\"    \"fit0\"               \"fit1\"              \n#> [16] \"fit2\"               \"fit3\"               \"fit4\"              \n#> [19] \"fit5\"               \"formula0\"           \"formula1\"          \n#> [22] \"formula2\"           \"formula3\"           \"formula4\"          \n#> [25] \"formula5\"           \"has_annotations\"    \"k.folds\"           \n#> [28] \"numeric.names\"      \"perform\"            \"pred.y\"            \n#> [31] \"rocobj\"             \"sel.names\"          \"var.cluster\"       \n#> [34] \"var.summ\"           \"var.summ2\"\n```\n:::\n\n\n\n#### Retaining only useful variables\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Data dimensions\ndim(analytic)\n#> [1] 1267   33\n\n# Variable names\nnames(analytic)\n#>  [1] \"ID\"                    \"gender\"                \"age\"                  \n#>  [4] \"born\"                  \"race\"                  \"education\"            \n#>  [7] \"married\"               \"income\"                \"weight\"               \n#> [10] \"psu\"                   \"strata\"                \"diastolicBP\"          \n#> [13] \"systolicBP\"            \"bodyweight\"            \"bodyheight\"           \n#> [16] \"bmi\"                   \"waist\"                 \"smoke\"                \n#> [19] \"alcohol\"               \"cholesterol\"           \"cholesterolM2\"        \n#> [22] \"triglycerides\"         \"uric.acid\"             \"protein\"              \n#> [25] \"bilirubin\"             \"phosphorus\"            \"sodium\"               \n#> [28] \"potassium\"             \"globulin\"              \"calcium\"              \n#> [31] \"physical.work\"         \"physical.recreational\" \"diabetes\"\n\n#Subsetting dataset with variables needed:\nrequire(dplyr)\nanadata <- select(analytic, \n                  cholesterol, #outcome\n                  gender, age, born, race, education, married, income, bmi, diabetes, #predictors\n                  weight, psu, strata) #survey features\n\n# new data sizes\ndim(anadata)\n#> [1] 1267   13\n\n# retained variable names\nnames(anadata)\n#>  [1] \"cholesterol\" \"gender\"      \"age\"         \"born\"        \"race\"       \n#>  [6] \"education\"   \"married\"     \"income\"      \"bmi\"         \"diabetes\"   \n#> [11] \"weight\"      \"psu\"         \"strata\"\n\n#Restricting to participants who are 18 or older\nsummary(anadata$age) #The age range is already 20-80\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>   20.00   36.00   51.00   49.91   63.00   80.00\n\n#Recoding the born variable\ntable(anadata$born, useNA = \"always\")\n#> \n#> Born in 50 US states or Washingt                           Others \n#>                              991                              276 \n#>                             <NA> \n#>                                0\nlevels(anadata$born)\n#> NULL\nanadata$born <- car::recode(anadata$born,\n                            \"'Born in 50 US states or Washingt' = 'Born.in.US';\n                            'Others' = 'Others';\n                            else=NA\")\ntable(anadata$born, useNA = \"always\")\n#> \n#> Born.in.US     Others       <NA> \n#>        991        276          0\n```\n:::\n\n\n\n#### Checking the data for missing\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(DataExplorer)\nplot_missing(anadata) #no missing data\n```\n\n::: {.cell-output-display}\n![](surveydata7_files/figure-pdf/miss0-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n#### Preparing factor and continuous variables appropriately\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvars = c(\"cholesterol\", \"gender\", \"born\", \"race\", \"education\", \n         \"married\", \"income\", \"bmi\", \"diabetes\")\nnumeric.names <- c(\"cholesterol\", \"bmi\")\nfactor.names <- vars[!vars %in% numeric.names] \n\nanadata[factor.names] <- apply(X = anadata[factor.names],\n                               MARGIN = 2, FUN = as.factor)\n\nanadata[numeric.names] <- apply(X = anadata[numeric.names],\n                                MARGIN = 2, FUN =function (x) \n                                  as.numeric(as.character(x)))\n```\n:::\n\n\n\n#### Table 1\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tableone)\ntab1 <- CreateTableOne(data = anadata, includeNA = TRUE, vars = vars)\nprint(tab1, showAllLevels = TRUE,  varLabels = TRUE)\n#>                          \n#>                           level              Overall       \n#>   n                                            1267        \n#>   cholesterol (mean (SD))                    193.10 (43.22)\n#>   gender (%)              Female                496 (39.1) \n#>                           Male                  771 (60.9) \n#>   born (%)                Born.in.US            991 (78.2) \n#>                           Others                276 (21.8) \n#>   race (%)                Black                 246 (19.4) \n#>                           Hispanic              337 (26.6) \n#>                           Other                 132 (10.4) \n#>                           White                 552 (43.6) \n#>   education (%)           College               648 (51.1) \n#>                           High.School           523 (41.3) \n#>                           School                 96 ( 7.6) \n#>   married (%)             Married               751 (59.3) \n#>                           Never.married         226 (17.8) \n#>                           Previously.married    290 (22.9) \n#>   income (%)              <25k                  344 (27.2) \n#>                           Between.25kto54k      435 (34.3) \n#>                           Between.55kto99k      297 (23.4) \n#>                           Over100k              191 (15.1) \n#>   bmi (mean (SD))                             29.58 (6.84) \n#>   diabetes (%)            No                   1064 (84.0) \n#>                           Yes                   203 (16.0)\n```\n:::\n\n\n\n### Linear regression when cholesterol is continuous\n\nFit a linear regression, and report the VIFs.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Fitting initial regression\n\nfit0 <- lm(cholesterol ~ gender + born + race + education +\n              married + income + bmi + diabetes,\n            data = anadata)\n\nlibrary(Publish)\npublish(fit0)\n#>     Variable              Units Coefficient           CI.95    p-value \n#>  (Intercept)                         198.90 [184.82;212.97]    < 1e-04 \n#>       gender             Female         Ref                            \n#>                            Male       -6.82  [-11.76;-1.89]   0.006854 \n#>         born         Born.in.US         Ref                            \n#>                          Others       15.65    [8.54;22.75]    < 1e-04 \n#>         race              Black         Ref                            \n#>                        Hispanic       -2.75   [-10.61;5.10]   0.492333 \n#>                           Other       -3.95   [-13.61;5.72]   0.423740 \n#>                           White        5.36   [-1.20;11.92]   0.109403 \n#>    education            College         Ref                            \n#>                     High.School        3.51    [-1.61;8.63]   0.179871 \n#>                          School        0.31   [-9.63;10.24]   0.951841 \n#>      married            Married         Ref                            \n#>                   Never.married      -11.05  [-17.67;-4.44]   0.001082 \n#>              Previously.married        4.72   [-1.43;10.86]   0.132468 \n#>       income               <25k         Ref                            \n#>                Between.25kto54k       -0.48    [-6.72;5.75]   0.879480 \n#>                Between.55kto99k        3.41   [-3.60;10.43]   0.340491 \n#>                        Over100k        2.24   [-6.02;10.51]   0.595131 \n#>          bmi                          -0.21    [-0.56;0.15]   0.257105 \n#>     diabetes                 No         Ref                            \n#>                             Yes      -10.61  [-17.21;-4.02]   0.001652\n\n#Checking VIFs\ncar::vif(fit0) \n#>               GVIF Df GVIF^(1/(2*Df))\n#> gender    1.065810  1        1.032381\n#> born      1.578258  1        1.256288\n#> race      1.684064  3        1.090753\n#> education 1.280113  2        1.063683\n#> married   1.225520  2        1.052156\n#> income    1.277005  3        1.041595\n#> bmi       1.086953  1        1.042570\n#> diabetes  1.073619  1        1.036156\n```\n:::\n\n\n\nAll VIFs are small.\n\n### Test of association when cholesterol is binary\n\nDichotomize the outcome such that cholesterol\\<200 is labeled as 'healthy'; otherwise label it as 'unhealthy', and name it 'cholesterol.bin'. Test the association between this binary variable and gender.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Creating binary variable for cholesterol\nanadata$cholesterol.bin <- ifelse(anadata$cholesterol <200, \"healthy\", \"unhealthy\")\n#If cholesterol is <200, then \"healthy\", if not, \"unhealthy\"\n\ntable(anadata$cholesterol.bin)\n#> \n#>   healthy unhealthy \n#>       738       529\nanadata$cholesterol.bin <- as.factor(anadata$cholesterol.bin)\nanadata$cholesterol.bin <- relevel(anadata$cholesterol.bin, ref = \"unhealthy\")\n```\n:::\n\n\n\n#### Test of association between cholesterol and gender (no survey features)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Simple Chi-square testing\nchisq.chol.gen <- chisq.test(anadata$cholesterol.bin, anadata$gender)\nchisq.chol.gen\n#> \n#> \tPearson's Chi-squared test with Yates' continuity correction\n#> \n#> data:  anadata$cholesterol.bin and anadata$gender\n#> X-squared = 5.1321, df = 1, p-value = 0.02349\n```\n:::\n\n\n\n#### Setting up survey design\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(survey)\nsummary(anadata$weight)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>    5470   19540   30335   48904   63822  224892\nw.design <- svydesign(id = ~psu, weights = ~weight, strata = ~strata,\n                      nest = TRUE, data = anadata)\nsummary(weights(w.design))\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>    5470   19540   30335   48904   63822  224892\n```\n:::\n\n\n\n#### Test of association accounting for survey design\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Rao-Scott modifications (chi-sq)\nsvychisq(~cholesterol.bin + gender, design = w.design, statistic = \"Chisq\")\n#> \n#> \tPearson's X^2: Rao & Scott adjustment\n#> \n#> data:  svychisq(~cholesterol.bin + gender, design = w.design, statistic = \"Chisq\")\n#> X-squared = 11.092, df = 1, p-value = 0.02365\n\n#Thomas-Rao modifications (F)\nsvychisq(~cholesterol.bin + gender, design = w.design, statistic = \"F\") \n#> \n#> \tPearson's X^2: Rao & Scott adjustment\n#> \n#> data:  svychisq(~cholesterol.bin + gender, design = w.design, statistic = \"F\")\n#> F = 5.1205, ndf = 1, ddf = 15, p-value = 0.03891\n```\n:::\n\n\n\nAll three tests indicate strong evidence to reject the H0. There seems to be an association between gender and cholesterol level (healthy/unhealthy)\n\n### Table 1\n\nCreate a Table 1 (summarizing the covariates) stratified by the binary outcome: cholesterol.bin, utilizing the above survey features.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Creating Table 1 stratified by binary outcome (cholesterol)\n# Using the survey features\n\nvars2 = c(\"gender\", \"born\", \"race\", \"education\", \n         \"married\", \"income\", \"bmi\", \"diabetes\")\n\n\nkableone <- function(x, ...) {\n  capture.output(x <- print(x, showAllLevels= TRUE, padColnames = TRUE, insertLevel = TRUE))\n  knitr::kable(x, ...)\n}\nkableone(svyCreateTableOne(var = vars2, strata= \"cholesterol.bin\", data=w.design, test = TRUE)) \n```\n\n::: {.cell-output-display}\n|                |       level       |     unhealthy    |      healthy     |   p  |test |\n|:---------------|:------------------|:-----------------|:-----------------|:-----|:----|\n|n               |                   |27369732.3        |34591444.0        |      |     |\n|gender (%)      |Female             |13573865.5 (49.6) |13917447.5 (40.2) |0.039 |     |\n|                |Male               |13795866.8 (50.4) |20673996.5 (59.8) |      |     |\n|born (%)        |Born.in.US         |23772751.7 (86.9) |31532673.3 (91.2) |0.028 |     |\n|                |Others             |3596980.6 (13.1)  |3058770.7 ( 8.8)  |      |     |\n|race (%)        |Black              |1832118.3 ( 6.7)  |3696893.4 (10.7)  |0.015 |     |\n|                |Hispanic           |3263992.3 (11.9)  |3921344.6 (11.3)  |      |     |\n|                |Other              |1887156.6 ( 6.9)  |2601870.3 ( 7.5)  |      |     |\n|                |White              |20386465.2 (74.5) |24371335.7 (70.5) |      |     |\n|education (%)   |College            |15855712.5 (57.9) |20945710.7 (60.6) |0.522 |     |\n|                |High.School        |10615218.7 (38.8) |12434827.2 (35.9) |      |     |\n|                |School             |898801.1 ( 3.3)   |1210906.1 ( 3.5)  |      |     |\n|married (%)     |Married            |17489306.2 (63.9) |21170020.0 (61.2) |0.005 |     |\n|                |Never.married      |3086474.4 (11.3)  |7175237.2 (20.7)  |      |     |\n|                |Previously.married |6793951.8 (24.8)  |6246186.8 (18.1)  |      |     |\n|income (%)      |<25k               |4760281.8 (17.4)  |6364208.6 (18.4)  |0.915 |     |\n|                |Between.25kto54k   |8682481.6 (31.7)  |10786198.6 (31.2) |      |     |\n|                |Between.55kto99k   |6939847.0 (25.4)  |9190388.2 (26.6)  |      |     |\n|                |Over100k           |6987121.9 (25.5)  |8250648.6 (23.9)  |      |     |\n|bmi (mean (SD)) |                   |29.35 (6.13)      |29.64 (7.05)      |0.593 |     |\n|diabetes (%)    |No                 |25080412.0 (91.6) |30006523.6 (86.7) |0.012 |     |\n|                |Yes                |2289320.3 ( 8.4)  |4584920.4 (13.3)  |      |     |\n:::\n:::\n\n\n\n### Logistic regression model\n\nRun a logistic regression model using the same variables, utilizing the survey features. Report the corresponding odds ratios and the 95% confidence intervals.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nformula1 <- as.formula(I(cholesterol.bin==\"unhealthy\") ~ gender + born +\n                         race + education + married + income + bmi +\n                         diabetes)\n\nfit1 <- svyglm(formula1,\n               design = w.design, \n               family = binomial(link = \"logit\"))\n\npublish(fit1)\n#>   Variable              Units OddsRatio       CI.95  p-value \n#>     gender             Female       Ref                      \n#>                          Male      0.70 [0.49;0.98]   0.2866 \n#>       born         Born.in.US       Ref                      \n#>                        Others      2.10 [1.41;3.13]   0.1707 \n#>       race              Black       Ref                      \n#>                      Hispanic      1.15 [0.80;1.67]   0.5871 \n#>                         Other      1.11 [0.69;1.80]   0.7406 \n#>                         White      1.46 [1.00;2.14]   0.3003 \n#>  education            College       Ref                      \n#>                   High.School      1.21 [0.96;1.52]   0.3563 \n#>                        School      0.86 [0.52;1.43]   0.6712 \n#>    married            Married       Ref                      \n#>                 Never.married      0.54 [0.32;0.90]   0.2526 \n#>            Previously.married      1.31 [0.92;1.87]   0.3704 \n#>     income               <25k       Ref                      \n#>              Between.25kto54k      1.03 [0.61;1.73]   0.9408 \n#>              Between.55kto99k      1.02 [0.66;1.56]   0.9525 \n#>                      Over100k      1.12 [0.73;1.72]   0.6920 \n#>        bmi                         1.00 [0.97;1.03]   0.9361 \n#>   diabetes                 No       Ref                      \n#>                           Yes      0.62 [0.41;0.95]   0.2720\n```\n:::\n\n\n\n### Wald test (survey version)\n\nPerform a Wald test (survey version) to test the null hypothesis that all coefficients associated with the income variable are zero, and interpret.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Testing the H0 that all coefficients associated with the income variable are zero\nregTermTest(fit1, ~income)\n#> Wald test for income\n#>  in svyglm(formula = formula1, design = w.design, family = binomial(link = \"logit\"))\n#> F =  0.1050099  on  3  and  1  df: p= 0.94611\n```\n:::\n\n\n\nThe Wald test here gives a large p-value; We do not have evidence to reject the H0 of coefficient being 0. If the coefficient for income variable is 0, this means that the outcome in the model (cholesterol) is not affected by income. This suggests that removing income from the model does not statistically improve the model fit. So we can remove income variable from the model.\n\n### Backward elimination\n\nRun a backward elimination (using the AIC criteria) on the above logistic regression fit (keeping important variables gender, race, bmi, diabetes in the model), and report the odds ratios and the 95% confidence intervals from the resulting final logistic regression fit.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Running backward elimination based on AIC\nrequire(MASS)\nscope <- list(upper = ~ gender + born + race + education + \n                married + income + bmi + diabetes,\n              lower = ~ gender + race + bmi + diabetes)\n\nfit3 <- step(fit1, scope = scope, trace = FALSE,\n                k = 2, direction = \"backward\")\n\n#Odds Ratios\npublish(fit3)\n#>  Variable              Units OddsRatio       CI.95   p-value \n#>    gender             Female       Ref                       \n#>                         Male      0.71 [0.51;0.98]   0.08558 \n#>      born         Born.in.US       Ref                       \n#>                       Others      2.01 [1.37;2.96]   0.01184 \n#>      race              Black       Ref                       \n#>                     Hispanic      1.15 [0.81;1.65]   0.46785 \n#>                        Other      1.11 [0.68;1.81]   0.69539 \n#>                        White      1.46 [0.99;2.17]   0.10469 \n#>   married            Married       Ref                       \n#>                Never.married      0.54 [0.32;0.90]   0.05770 \n#>           Previously.married      1.30 [0.93;1.80]   0.17125 \n#>       bmi                         1.00 [0.97;1.03]   0.95146 \n#>  diabetes                 No       Ref                       \n#>                          Yes      0.61 [0.40;0.91]   0.05445\n```\n:::\n\n\n\nBorn and married are also found to be useful on top of gender + race + bmi + diabetes.\n\n### Interaction terms\n\nChecking interaction terms\n\n-- gender and whether married\n\n-- gender and whether born in the US\n\n-- gender and diabetes\n\n-- whether married and diabetes\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#gender and married\nfit4 <- update(fit3, .~. + interaction(gender, married))\nanova(fit3, fit4)\n#> Working (Rao-Scott+F) LRT for interaction(gender, married)\n#>  in svyglm(formula = I(cholesterol.bin == \"unhealthy\") ~ gender + \n#>     born + race + married + bmi + diabetes + interaction(gender, \n#>     married), design = w.design, family = binomial(link = \"logit\"))\n#> Working 2logLR =  0.7461308 p= 0.70903 \n#> (scale factors:  1.1 0.93 );  denominator df= 4\n```\n:::\n\n\n\nDo not include interaction term\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#gender and born in us\nfit5 <- update(fit3, .~. + interaction(gender, born))\nanova(fit3, fit5)\n#> Working (Rao-Scott+F) LRT for interaction(gender, born)\n#>  in svyglm(formula = I(cholesterol.bin == \"unhealthy\") ~ gender + \n#>     born + race + married + bmi + diabetes + interaction(gender, \n#>     born), design = w.design, family = binomial(link = \"logit\"))\n#> Working 2logLR =  0.4635299 p= 0.52441 \n#> df=1;  denominator df= 5\n```\n:::\n\n\n\nDo not include interaction term\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#gender and diabetes\nfit6 <- update(fit3, .~. + interaction(gender, diabetes))\nanova(fit3, fit6)\n#> Working (Rao-Scott+F) LRT for interaction(gender, diabetes)\n#>  in svyglm(formula = I(cholesterol.bin == \"unhealthy\") ~ gender + \n#>     born + race + married + bmi + diabetes + interaction(gender, \n#>     diabetes), design = w.design, family = binomial(link = \"logit\"))\n#> Working 2logLR =  1.222596 p= 0.32211 \n#> df=1;  denominator df= 5\n```\n:::\n\n\n\nDo not include interaction term\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#married and diabetes\nfit7 <- update(fit3, .~. + interaction(married, diabetes))\nanova(fit3, fit7)\n#> Working (Rao-Scott+F) LRT for interaction(married, diabetes)\n#>  in svyglm(formula = I(cholesterol.bin == \"unhealthy\") ~ gender + \n#>     born + race + married + bmi + diabetes + interaction(married, \n#>     diabetes), design = w.design, family = binomial(link = \"logit\"))\n#> Working 2logLR =  0.3207507 p= 0.84547 \n#> (scale factors:  1.4 0.62 );  denominator df= 4\n```\n:::\n\n\n\nDo not include interaction term\n\nNone of the interaction terms are improving the model fit.\n\n### AUC\n\nReport AUC of the final model (only using weight argument) and interpret.\n\nAUC of the final model (only using weight argument) and interpret\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrequire(ROCR)\n# WeightedROC may not be on cran for all R versions\n# devtools::install_github(\"tdhock/WeightedROC\")\n\nlibrary(WeightedROC)\nsvyROCw <- function(fit = fit3, outcome = anadata$cholesterol.bin == \"unhealthy\", weight = anadata$weight){\n  if (is.null(weight)){ # require(ROCR)\n    prob <- predict(fit, type = \"response\")\n  pred <- prediction(as.vector(prob), outcome)\n  perf <- performance(pred, \"tpr\", \"fpr\")\n  auc <- performance(pred, measure = \"auc\")\n  auc <- auc@y.values[[1]]\n  roc.data <- data.frame(fpr = unlist(perf@x.values), tpr = unlist(perf@y.values), \n      model = \"Logistic\")\n  with(data = roc.data,plot(fpr, tpr, type=\"l\", xlim=c(0,1), ylim=c(0,1), lwd=1,\n     xlab=\"1 - specificity\", ylab=\"Sensitivity\",\n     main = paste(\"AUC = \", round(auc,3))))\n  mtext(\"Unweighted ROC\")\n  abline(0,1, lty=2)\n  } else { \n    outcome <- as.numeric(outcome)\n  pred <- predict(fit, type = \"response\")\n  tp.fp <- WeightedROC(pred, outcome, weight)\n  auc <- WeightedAUC(tp.fp)\n  with(data = tp.fp,plot(FPR, TPR, type=\"l\", xlim=c(0,1), ylim=c(0,1), lwd=1,\n     xlab=\"1 - specificity\", ylab=\"Sensitivity\",\n     main = paste(\"AUC = \", round(auc,3))))\n  abline(0,1, lty=2)\n  mtext(\"Weighted ROC\")\n  }\n}\nsvyROCw(fit = fit3, outcome = anadata$cholesterol.bin == \"unhealthy\", weight = anadata$weight)\n```\n\n::: {.cell-output-display}\n![](surveydata7_files/figure-pdf/auc-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\nThe area under the curve in the final model is 0.611, using the survey weighted ROC. The AUC of 0.611 indicates that this model has poor discrimination.\n\n### Archer-Lemeshow Goodness of fit\n\nReport Archer-Lemeshow Goodness of fit test and interpret (utilizing all the survey features).\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#Archer-Lemeshow Goodness of fit test utilizing all survey features\nAL.gof2 <- function(fit = fit3, data = anadata, \n                   weight = \"weight\", psu = \"psu\", strata = \"strata\"){\n  r <- residuals(fit, type = \"response\") \n  f<-fitted(fit) \n  breaks.g <- c(-Inf, quantile(f, (1:9)/10), Inf)\n  breaks.g <- breaks.g + seq_along(breaks.g) * .Machine$double.eps\n  g<- cut(f, breaks.g)\n  data2g <- cbind(data,r,g)\n  newdesign <- svydesign(id=as.formula(paste0(\"~\",psu)),\n                         strata=as.formula(paste0(\"~\",strata)),\n                         weights=as.formula(paste0(\"~\",weight)), \n                         data=data2g, nest = TRUE)\n  decilemodel <- svyglm(r~g, design=newdesign) \n  res <- regTermTest(decilemodel, ~g)\n  return(res) \n}\n\nAL.gof2(fit3, anadata, weight = \"weight\", psu = \"psu\", strata = \"strata\")\n#> Wald test for g\n#>  in svyglm(formula = r ~ g, design = newdesign)\n#> F =  0.7569326  on  9  and  6  df: p= 0.66075\n```\n:::\n\n\n\nArcher and Lemeshow GoF test was used to test the fit of this model. The p-value of 0.3043, which is greater than 0.05. This means that there is no evidence of lack of fit to this model.\n\n### Add `age` as a predictor for linear regression\n\nFit another logistic regression (similar to Q1) with the above-mentioned predictors (as obtained in Q7) and age, utilizing the survey features. What difference do you see from the previous fit results?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naic.int.model <- eval(fit3$call[[2]])\naic.int.model\n#> I(cholesterol.bin == \"unhealthy\") ~ gender + born + race + married + \n#>     bmi + diabetes\n\nformula3 <- as.formula(cholesterol.bin ~ gender + born + race + married + bmi + diabetes + age)\nfit9 <- svyglm(formula3,\n               design = w.design,\n               family = binomial(link=\"logit\"))\nsummary(fit9)\n#> \n#> Call:\n#> svyglm(formula = formula3, design = w.design, family = binomial(link = \"logit\"))\n#> \n#> Survey design:\n#> svydesign(id = ~psu, weights = ~weight, strata = ~strata, nest = TRUE, \n#>     data = anadata)\n#> \n#> Coefficients:\n#>                             Estimate Std. Error t value Pr(>|t|)  \n#> (Intercept)                1.0657919  0.6260889   1.702   0.1494  \n#> genderMale                 0.3821902  0.1703394   2.244   0.0749 .\n#> bornOthers                -0.6912102  0.2026407  -3.411   0.0190 *\n#> raceHispanic              -0.2442019  0.1823190  -1.339   0.2381  \n#> raceOther                 -0.1570271  0.2306208  -0.681   0.5262  \n#> raceWhite                 -0.3638735  0.2029676  -1.793   0.1330  \n#> marriedNever.married       0.4029107  0.2637962   1.527   0.1872  \n#> marriedPreviously.married -0.2096009  0.1620478  -1.293   0.2524  \n#> bmi                       -0.0002237  0.0134117  -0.017   0.9873  \n#> diabetesYes                0.6534019  0.2456333   2.660   0.0449 *\n#> age                       -0.0151364  0.0042038  -3.601   0.0155 *\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1.000456)\n#> \n#> Number of Fisher Scoring iterations: 4\npublish(fit9)\n#>  Variable              Units OddsRatio       CI.95   p-value \n#>    gender             Female       Ref                       \n#>                         Male      1.47 [1.05;2.05]   0.07487 \n#>      born         Born.in.US       Ref                       \n#>                       Others      0.50 [0.34;0.75]   0.01902 \n#>      race              Black       Ref                       \n#>                     Hispanic      0.78 [0.55;1.12]   0.23809 \n#>                        Other      0.85 [0.54;1.34]   0.52619 \n#>                        White      0.69 [0.47;1.03]   0.13299 \n#>   married            Married       Ref                       \n#>                Never.married      1.50 [0.89;2.51]   0.18721 \n#>           Previously.married      0.81 [0.59;1.11]   0.25238 \n#>       bmi                         1.00 [0.97;1.03]   0.98734 \n#>  diabetes                 No       Ref                       \n#>                          Yes      1.92 [1.19;3.11]   0.04488 \n#>       age                         0.98 [0.98;0.99]   0.01553\n```\n:::\n\n\n\n### Comparing with previous model fit\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npublish(fit3)\n#>  Variable              Units OddsRatio       CI.95   p-value \n#>    gender             Female       Ref                       \n#>                         Male      0.71 [0.51;0.98]   0.08558 \n#>      born         Born.in.US       Ref                       \n#>                       Others      2.01 [1.37;2.96]   0.01184 \n#>      race              Black       Ref                       \n#>                     Hispanic      1.15 [0.81;1.65]   0.46785 \n#>                        Other      1.11 [0.68;1.81]   0.69539 \n#>                        White      1.46 [0.99;2.17]   0.10469 \n#>   married            Married       Ref                       \n#>                Never.married      0.54 [0.32;0.90]   0.05770 \n#>           Previously.married      1.30 [0.93;1.80]   0.17125 \n#>       bmi                         1.00 [0.97;1.03]   0.95146 \n#>  diabetes                 No       Ref                       \n#>                          Yes      0.61 [0.40;0.91]   0.05445\npublish(fit9)\n#>  Variable              Units OddsRatio       CI.95   p-value \n#>    gender             Female       Ref                       \n#>                         Male      1.47 [1.05;2.05]   0.07487 \n#>      born         Born.in.US       Ref                       \n#>                       Others      0.50 [0.34;0.75]   0.01902 \n#>      race              Black       Ref                       \n#>                     Hispanic      0.78 [0.55;1.12]   0.23809 \n#>                        Other      0.85 [0.54;1.34]   0.52619 \n#>                        White      0.69 [0.47;1.03]   0.13299 \n#>   married            Married       Ref                       \n#>                Never.married      1.50 [0.89;2.51]   0.18721 \n#>           Previously.married      0.81 [0.59;1.11]   0.25238 \n#>       bmi                         1.00 [0.97;1.03]   0.98734 \n#>  diabetes                 No       Ref                       \n#>                          Yes      1.92 [1.19;3.11]   0.04488 \n#>       age                         0.98 [0.98;0.99]   0.01553\nAIC(fit3)\n#>       eff.p         AIC    deltabar \n#>   11.121795 1706.792543    1.235755\nAIC(fit9)\n#>      eff.p        AIC   deltabar \n#>   12.14310 1694.15974    1.21431\n```\n:::\n\n\n\n### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/78EHsUZDePc\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}