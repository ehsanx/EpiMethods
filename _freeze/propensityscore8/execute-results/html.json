{
  "hash": "1fe8ed5b13ee2f98febeec15af556974",
  "result": {
    "markdown": "## PSW with MI in subset {.unnumbered}\n\n\n\n\n\n### Problem\n\nIn this chapter, we will use **propensity score (PS) weighting** with **multiple imputation (MI)**, focusing on specific subpopulations defined by the study's eligibility criteria. Similar to the previous chapter on [PSM with MI for subpopulation](propensityscore7.html), the modified dataset from NHANES 2017- 2018, will be used.\n\n### Load data\n\nLet us import the dataset:\n\n\n::: {.cell hash='propensityscore8_cache/html/load_28917463273e6c543001f8fb89b55abe'}\n\n```{.r .cell-code}\nrm(list = ls())\nload(\"Data/propensityscore/analytic_imputed.RData\")\nls()\n#> [1] \"dat.analytic\"  \"dat.analytic2\" \"dat.full\"      \"imputation\"\n```\n:::\n\n\n-   `dat.full`: Full dataset of 9,254 subjects\n-   `dat.analytic` and `dat.analytic2`: Analytic dataset of 4,191 participants with only missing in the covariates. There are no missing values for the exposure or outcomes.\n-   `imputation`: m = 5 imputed datasets from `dat.analytic2` using MI.\n\nThe **general strategy of solution** to implement PS weighting with MI is as follows:\n\n-   We will build the imputation model on 4,191 eligible subjects.\n-   Apply PS weghting on each of the imputed datasets, where we will utilize survey features for population-level estimate\n-   Pool the estimates using Rubin's rule\n\n### Dealing with missing values in covariates\n\n#### Step 1: Imputing missing values using mice for eligible subjects\n\nWe already completed this step in the [previous chapter](propensityscore7.html), where we imputed m = 5 datasets using MI.\n\nNow we will combine 5 datasets and create a stacked dataset. This dataset should contain 5\\*4,191 = 20,955 rows.\n\n\n::: {.cell hash='propensityscore8_cache/html/step1b_94b6182499798eca1208c8ad79ecf468'}\n\n```{.r .cell-code}\n# Stacked imputed dataset\nimpdata <- mice::complete(imputation, action=\"long\")\ndim(impdata)\n#> [1] 20955    17\n\n#Remove .id variable from the model as it was created in an intermediate step\nimpdata$.id <- NULL\n\n# Missing after imputation\nDataExplorer::plot_missing(impdata)\n```\n\n::: {.cell-output-display}\n![](propensityscore8_files/figure-html/step1b-1.png){width=672}\n:::\n:::\n\n\n#### Step 2: PS weighting steps 1-3 by DuGoff et al. (2014)\n\nOur next step is to use steps 1-3 of the PS weighting analysis:\n\n-   Step 2.1: Fit the PS model by considering survey features as covariates.\n-   Step 2.2: Calculate PS weights\n-   Step 2.3: Balance checking using SMD. Consider SMD \\<0.2 as a good covariate balancing.\n\n##### Step 2.1: PS model specification\n\n\n::: {.cell hash='propensityscore8_cache/html/duGstep1_dec0e63607dd630e41a9fb8165d34efd'}\n\n```{.r .cell-code}\n# Specify the PS model to estimate propensity scores\nps.formula <- as.formula(I(arthritis == \"Rheumatoid arthritis\") ~ age.cat + sex + \n                           education + race + income + bmi + smoking + htn + \n                           diabetes + psu + strata + survey.weight)\n```\n:::\n\n\n##### Step 2.2: Estimating PS and calculating weights\n\n\n::: {.cell hash='propensityscore8_cache/html/duGstep2_f229a27a3c39cc0b17e3a7a86b1f03fe'}\n\n```{.r .cell-code}\ndat.ps <- list(NULL)\n\nm <- 5 # 5 imputed dataset\n\n# PS weighting on each of the imputed datasets\nfor (ii in 1:m) {\n  # Imputed dataset\n  dat.imputed <- subset(impdata, .imp == ii)\n  \n  # Propensity scores\n  ps.fit <- glm(ps.formula, data = dat.imputed, family = binomial(\"logit\"))\n  dat.imputed$ps <- fitted(ps.fit)\n  \n  # Stabilized weight\n  dat.imputed$sweight <- with(dat.imputed, \n                              ifelse(I(arthritis == \"Rheumatoid arthritis\"), \n                                     mean(I(arthritis == \"Rheumatoid arthritis\"))/ps, \n                                     (1-mean(I(arthritis == \"Rheumatoid arthritis\")))/(1-ps)))\n\n  # Dataset\n  dat.ps[[ii]] <- dat.imputed\n}\n\n# Weight summary\npurrr::map_df(dat.ps, function(df){summary(df$sweight)})\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Min.\"],\"name\":[1],\"type\":[\"table[1d]\"],\"align\":[\"right\"]},{\"label\":[\"1st Qu.\"],\"name\":[2],\"type\":[\"table[1d]\"],\"align\":[\"right\"]},{\"label\":[\"Median\"],\"name\":[3],\"type\":[\"table[1d]\"],\"align\":[\"right\"]},{\"label\":[\"Mean\"],\"name\":[4],\"type\":[\"table[1d]\"],\"align\":[\"right\"]},{\"label\":[\"3rd Qu.\"],\"name\":[5],\"type\":[\"table[1d]\"],\"align\":[\"right\"]},{\"label\":[\"Max.\"],\"name\":[6],\"type\":[\"table[1d]\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.1062664\",\"2\":\"0.9335713\",\"3\":\"0.9497695\",\"4\":\"0.9955417\",\"5\":\"1.028579\",\"6\":\"10.24382\"},{\"1\":\"0.1104828\",\"2\":\"0.9337916\",\"3\":\"0.9496215\",\"4\":\"0.9957575\",\"5\":\"1.030514\",\"6\":\"10.28014\"},{\"1\":\"0.1051711\",\"2\":\"0.9334763\",\"3\":\"0.9497249\",\"4\":\"0.9950616\",\"5\":\"1.028141\",\"6\":\"10.16236\"},{\"1\":\"0.1090101\",\"2\":\"0.9336934\",\"3\":\"0.9492613\",\"4\":\"0.9947763\",\"5\":\"1.029242\",\"6\":\"10.22359\"},{\"1\":\"0.1068490\",\"2\":\"0.9338469\",\"3\":\"0.9494168\",\"4\":\"0.9955889\",\"5\":\"1.029760\",\"6\":\"10.21509\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n::: {.cell hash='propensityscore8_cache/html/duGstep2b_35333da121fd93fb7139a9f132964fc6'}\n\n```{.r .cell-code}\n# Dimension of each of the imputed dataset\nlapply(dat.ps, dim)\n#> [[1]]\n#> [1] 4191   18\n#> \n#> [[2]]\n#> [1] 4191   18\n#> \n#> [[3]]\n#> [1] 4191   18\n#> \n#> [[4]]\n#> [1] 4191   18\n#> \n#> [[5]]\n#> [1] 4191   18\n```\n:::\n\n\n##### Step 2.3: Balance checking for each imputed dataset\n\nNow we will check balance in terms of SMD on each dataset.\n\n\n::: {.cell hash='propensityscore8_cache/html/duGstep3_af4bd53c83c91a3a3eff6d50369ab1b1'}\n\n```{.r .cell-code}\ntab1m <- list(NULL)\nfor (ii in 1:m) {\n  # PS weighted imputed data\n  dat <- dat.ps[[ii]]\n  \n  # Covariates\n  vars <- c(\"age.cat\", \"sex\", \"education\", \"race\", \"income\", \"bmi\", \"smoking\", \n            \"htn\", \"diabetes\")\n  \n  # Design with truncated stabilized weight\n  wdesign <- svydesign(ids = ~studyid, weights = ~sweight, data = dat)\n  \n  # Balance checking \n  tab1m[[ii]] <- svyCreateTableOne(vars = vars, strata = \"arthritis\", data = wdesign,\n                                   test = F)\n}\nprint(tab1m, smd = TRUE)\n#> [[1]]\n#>                               Stratified by arthritis\n#>                                No arthritis    Rheumatoid arthritis SMD   \n#>   n                             3856.0          316.3                     \n#>   age.cat (%)                                                        0.077\n#>      20-49                      2096.4 (54.4)   159.8 (50.5)              \n#>      50-64                      1010.5 (26.2)    89.2 (28.2)              \n#>      65+                         749.1 (19.4)    67.3 (21.3)              \n#>   sex = Female (%)              1900.0 (49.3)   144.1 (45.6)         0.075\n#>   education (%)                                                      0.053\n#>      Less than high school       764.6 (19.8)    60.9 (19.3)              \n#>      High school                2109.7 (54.7)   180.9 (57.2)              \n#>      College graduate or above   981.8 (25.5)    74.4 (23.5)              \n#>   race (%)                                                           0.074\n#>      White                      1173.6 (30.4)   107.0 (33.8)              \n#>      Black                       917.9 (23.8)    70.1 (22.2)              \n#>      Hispanic                    933.5 (24.2)    73.4 (23.2)              \n#>      Others                      831.0 (21.6)    65.8 (20.8)              \n#>   income (%)                                                         0.045\n#>      less than $20,000           685.9 (17.8)    59.3 (18.7)              \n#>      $20,000 to $74,999         2015.6 (52.3)   158.2 (50.0)              \n#>      $75,000 and Over           1154.5 (29.9)    98.8 (31.3)              \n#>   bmi (mean (SD))                29.34 (7.29)   29.93 (6.90)         0.082\n#>   smoking (%)                                                        0.211\n#>      Never smoker               2362.5 (61.3)   162.7 (51.4)              \n#>      Previous smoker             814.5 (21.1)    91.9 (29.1)              \n#>      Current smoker              679.1 (17.6)    61.6 (19.5)              \n#>   htn = Yes (%)                 2403.5 (62.3)   211.4 (66.8)         0.094\n#>   diabetes = Yes (%)             523.3 (13.6)    50.9 (16.1)         0.071\n#> \n#> [[2]]\n#>                               Stratified by arthritis\n#>                                No arthritis    Rheumatoid arthritis SMD   \n#>   n                             3855.7          317.6                     \n#>   age.cat (%)                                                        0.079\n#>      20-49                      2096.4 (54.4)   160.2 (50.4)              \n#>      50-64                      1010.3 (26.2)    89.8 (28.3)              \n#>      65+                         749.0 (19.4)    67.6 (21.3)              \n#>   sex = Female (%)              1899.4 (49.3)   144.0 (45.3)         0.079\n#>   education (%)                                                      0.050\n#>      Less than high school       765.1 (19.8)    61.3 (19.3)              \n#>      High school                2113.3 (54.8)   181.6 (57.2)              \n#>      College graduate or above   977.2 (25.3)    74.7 (23.5)              \n#>   race (%)                                                           0.076\n#>      White                      1173.6 (30.4)   107.8 (33.9)              \n#>      Black                       917.9 (23.8)    71.0 (22.4)              \n#>      Hispanic                    933.2 (24.2)    72.0 (22.7)              \n#>      Others                      831.0 (21.6)    66.8 (21.0)              \n#>   income (%)                                                         0.039\n#>      less than $20,000           688.0 (17.8)    57.8 (18.2)              \n#>      $20,000 to $74,999         2015.9 (52.3)   160.1 (50.4)              \n#>      $75,000 and Over           1151.8 (29.9)    99.7 (31.4)              \n#>   bmi (mean (SD))                29.33 (7.22)   29.90 (6.95)         0.081\n#>   smoking (%)                                                        0.213\n#>      Never smoker               2362.4 (61.3)   162.6 (51.2)              \n#>      Previous smoker             813.9 (21.1)    91.7 (28.9)              \n#>      Current smoker              679.3 (17.6)    63.3 (19.9)              \n#>   htn = Yes (%)                 2394.0 (62.1)   213.6 (67.3)         0.108\n#>   diabetes = Yes (%)             522.8 (13.6)    50.3 (15.8)         0.065\n#> \n#> [[3]]\n#>                               Stratified by arthritis\n#>                                No arthritis    Rheumatoid arthritis SMD   \n#>   n                             3856.6          313.7                     \n#>   age.cat (%)                                                        0.088\n#>      20-49                      2096.4 (54.4)   156.9 (50.0)              \n#>      50-64                      1010.1 (26.2)    88.9 (28.3)              \n#>      65+                         750.1 (19.4)    67.9 (21.6)              \n#>   sex = Female (%)              1900.1 (49.3)   142.2 (45.3)         0.079\n#>   education (%)                                                      0.069\n#>      Less than high school       765.0 (19.8)    57.8 (18.4)              \n#>      High school                2112.6 (54.8)   182.5 (58.2)              \n#>      College graduate or above   979.0 (25.4)    73.4 (23.4)              \n#>   race (%)                                                           0.082\n#>      White                      1174.1 (30.4)   106.8 (34.1)              \n#>      Black                       918.2 (23.8)    69.9 (22.3)              \n#>      Hispanic                    933.4 (24.2)    69.8 (22.2)              \n#>      Others                      830.9 (21.5)    67.2 (21.4)              \n#>   income (%)                                                         0.095\n#>      less than $20,000           698.8 (18.1)    63.2 (20.1)              \n#>      $20,000 to $74,999         2003.2 (51.9)   148.1 (47.2)              \n#>      $75,000 and Over           1154.6 (29.9)   102.4 (32.7)              \n#>   bmi (mean (SD))                29.29 (7.21)   29.80 (6.97)         0.072\n#>   smoking (%)                                                        0.216\n#>      Never smoker               2362.7 (61.3)   160.3 (51.1)              \n#>      Previous smoker             814.6 (21.1)    91.0 (29.0)              \n#>      Current smoker              679.2 (17.6)    62.5 (19.9)              \n#>   htn = Yes (%)                 2398.6 (62.2)   206.3 (65.8)         0.074\n#>   diabetes = Yes (%)             523.7 (13.6)    50.9 (16.2)         0.075\n#> \n#> [[4]]\n#>                               Stratified by arthritis\n#>                                No arthritis    Rheumatoid arthritis SMD   \n#>   n                             3856.2          312.9                     \n#>   age.cat (%)                                                        0.098\n#>      20-49                      2096.3 (54.4)   154.7 (49.5)              \n#>      50-64                      1010.8 (26.2)    91.2 (29.1)              \n#>      65+                         749.1 (19.4)    67.0 (21.4)              \n#>   sex = Female (%)              1900.1 (49.3)   144.4 (46.2)         0.063\n#>   education (%)                                                      0.064\n#>      Less than high school       763.7 (19.8)    58.4 (18.7)              \n#>      High school                2115.2 (54.9)   181.5 (58.0)              \n#>      College graduate or above   977.2 (25.3)    72.9 (23.3)              \n#>   race (%)                                                           0.078\n#>      White                      1173.7 (30.4)   106.5 (34.0)              \n#>      Black                       918.0 (23.8)    70.1 (22.4)              \n#>      Hispanic                    933.5 (24.2)    71.2 (22.8)              \n#>      Others                      831.0 (21.5)    65.0 (20.8)              \n#>   income (%)                                                         0.096\n#>      less than $20,000           694.1 (18.0)    63.9 (20.4)              \n#>      $20,000 to $74,999         2009.3 (52.1)   148.3 (47.4)              \n#>      $75,000 and Over           1152.9 (29.9)   100.7 (32.2)              \n#>   bmi (mean (SD))                29.28 (7.21)   29.86 (7.13)         0.081\n#>   smoking (%)                                                        0.209\n#>      Never smoker               2362.7 (61.3)   161.3 (51.6)              \n#>      Previous smoker             813.8 (21.1)    90.7 (29.0)              \n#>      Current smoker              679.7 (17.6)    60.9 (19.5)              \n#>   htn = Yes (%)                 2394.5 (62.1)   206.6 (66.0)         0.082\n#>   diabetes = Yes (%)             523.0 (13.6)    50.2 (16.0)         0.069\n#> \n#> [[5]]\n#>                               Stratified by arthritis\n#>                                No arthritis    Rheumatoid arthritis SMD   \n#>   n                             3855.7          316.8                     \n#>   age.cat (%)                                                        0.080\n#>      20-49                      2096.4 (54.4)   159.6 (50.4)              \n#>      50-64                      1010.3 (26.2)    89.8 (28.4)              \n#>      65+                         749.1 (19.4)    67.4 (21.3)              \n#>   sex = Female (%)              1899.6 (49.3)   143.9 (45.4)         0.077\n#>   education (%)                                                      0.060\n#>      Less than high school       767.4 (19.9)    62.1 (19.6)              \n#>      High school                2110.3 (54.7)   181.8 (57.4)              \n#>      College graduate or above   978.0 (25.4)    72.9 (23.0)              \n#>   race (%)                                                           0.074\n#>      White                      1173.5 (30.4)   107.1 (33.8)              \n#>      Black                       917.9 (23.8)    70.1 (22.1)              \n#>      Hispanic                    933.4 (24.2)    73.1 (23.1)              \n#>      Others                      830.9 (21.5)    66.5 (21.0)              \n#>   income (%)                                                         0.047\n#>      less than $20,000           685.0 (17.8)    60.6 (19.1)              \n#>      $20,000 to $74,999         2022.6 (52.5)   159.2 (50.3)              \n#>      $75,000 and Over           1148.1 (29.8)    97.0 (30.6)              \n#>   bmi (mean (SD))                29.31 (7.20)   29.77 (7.04)         0.064\n#>   smoking (%)                                                        0.206\n#>      Never smoker               2362.7 (61.3)   163.1 (51.5)              \n#>      Previous smoker             813.3 (21.1)    90.0 (28.4)              \n#>      Current smoker              679.7 (17.6)    63.6 (20.1)              \n#>   htn = Yes (%)                 2409.4 (62.5)   210.2 (66.3)         0.080\n#>   diabetes = Yes (%)             522.5 (13.6)    50.3 (15.9)         0.066\n```\n:::\n\n\nFor each of the datasets, all SMDs except for smoking are less than our specified cut-point of 0.2. We will adjust our outcome model for smoking.\n\n#### Step 3: Outcome modelling\n\nOur next step is to fit the outcome model on each of the imputed dataset. Note that, we must utilize survey features to correctly estimate the standard error. For this step, we will multiply PS weight and survey weight and create a `new weight` variable.\n\n##### 3.1 Calculating new weights\n\n\n::: {.cell hash='propensityscore8_cache/html/step3aWgt_0e777cfbbaff702c5f6049e9fb44abcf'}\n\n```{.r .cell-code}\ndat.ps2 <- list(NULL)\n\nfor (ii in 1:m) {\n  # PS weighted imputed data\n  dat <- dat.ps[[ii]]\n  \n  # New weight = survey weight * PS weight \n  dat$new_weight <- with(dat, survey.weight * sweight)\n  \n  dat.ps2[[ii]] <- dat\n}\n```\n:::\n\n\n##### 3.2 Preparing dataset for ineligible subjects\n\nNow we will add the **ineligible subjects**(ineligible by study restriction) with the PS weighted datasets, so that we can set up the survey design on the full dataset and then subset the design.\n\nLet us subset the data for ineligible subjects:\n\n\n::: {.cell hash='propensityscore8_cache/html/step3a_75213a96b696e8d0979aa0311dcfaddc'}\n\n```{.r .cell-code}\n# Subset for ineligible\ndat.ineligible <- list(NULL)\n\nfor(ii in 1:m){\n  # Matched dataset\n  dat <- dat.ps[[ii]]\n  \n  # Create an indicator variable in the full dataset\n  dat.full$ineligible <- 1\n  dat.full$ineligible[dat.full$studyid %in% dat$studyid] <- 0\n  \n  # Subset for ineligible\n  dat.ineligible[[ii]] <- subset(dat.full, ineligible == 1)\n  \n  # Create the .imp variable on each dataset with .imp 1 to m = 5\n  dat.ineligible[[ii]]$.imp <- ii\n}\n\n# Dimension of each dataset\nlapply(dat.ineligible, dim)\n#> [[1]]\n#> [1] 5063   19\n#> \n#> [[2]]\n#> [1] 5063   19\n#> \n#> [[3]]\n#> [1] 5063   19\n#> \n#> [[4]]\n#> [1] 5063   19\n#> \n#> [[5]]\n#> [1] 5063   19\n```\n:::\n\n\nThe next step is combining matched and ineligible datasets. Before merging, we must ensure the variable names are the same.\n\n\n::: {.cell hash='propensityscore8_cache/html/step3b_1451f4467d116ee279e751d2d9c1d9a0'}\n\n```{.r .cell-code}\n# Variables in the matched datasets\nnames(dat.ps2[[3]])\n#>  [1] \".imp\"          \"studyid\"       \"survey.weight\" \"psu\"          \n#>  [5] \"strata\"        \"cvd\"           \"arthritis\"     \"age.cat\"      \n#>  [9] \"sex\"           \"education\"     \"race\"          \"income\"       \n#> [13] \"bmi\"           \"smoking\"       \"htn\"           \"diabetes\"     \n#> [17] \"ps\"            \"sweight\"       \"new_weight\"\n\n# Variables in the ineligible datasets\nnames(dat.ineligible[[3]])\n#>  [1] \"studyid\"       \"survey.weight\" \"psu\"           \"strata\"       \n#>  [5] \"cvd\"           \"rheumatoid\"    \"age\"           \"sex\"          \n#>  [9] \"education\"     \"race\"          \"income\"        \"bmi\"          \n#> [13] \"smoking\"       \"htn\"           \"diabetes\"      \"age.cat\"      \n#> [17] \"arthritis\"     \"ineligible\"    \".imp\"\n```\n:::\n\n::: {.cell hash='propensityscore8_cache/html/step3c_bad82a4c203aeba7ea7af262840710a2'}\n\n```{.r .cell-code}\ndat.ineligible2 <- list(NULL)\n\nfor (ii in 1:m) {\n  dat <- dat.ineligible[[ii]]\n  \n  # Drop the ineligible variable from the dataset\n  dat$ineligible <- NULL\n  \n  # Create ps and sweight\n  dat$ps <- NA\n  dat$sweight <- NA\n  dat$new_weight <- NA\n  \n  # Keep only those variables available in the matched dataset\n  vars <- names(dat.ps2[[1]])\n  dat <- dat[,vars]\n  \n  # Ineligible datasets in list format\n  dat.ineligible2[[ii]] <- dat\n}\n```\n:::\n\n\n##### 3.2 Combining eligible (imputed and PS weighted) and ineligible (unimputed) subjects\n\nNow, we will merge imputed eligible and unimputed ineligible subjects. We should have m = 5 copies of the full dataset with 9,254 subjects on each.\n\n\n::: {.cell hash='propensityscore8_cache/html/step3d_3647f0bd81765f89e348672c975ca546'}\n\n```{.r .cell-code}\ndat.full2 <- list(NULL)\n\nfor (ii in 1:m) {\n  # Eligible\n  d1 <- data.frame(dat.ps2[[ii]])\n  d1$eligible <- 1\n  \n  # Ineligible\n  d2 <- data.frame(dat.ineligible2[[ii]])\n  d2$eligible <- 0\n  \n  # Full data\n  d3 <- rbind(d1, d2)\n  \n  #  New weight variable in the full dataset\n  d3$new_weight <- 0\n  d3$new_weight[d3$studyid %in% d1$studyid] <- d1$new_weight\n  \n  # Full data in list format\n  dat.full2[[ii]] <- d3\n}\nlapply(dat.full2, dim)\n#> [[1]]\n#> [1] 9254   20\n#> \n#> [[2]]\n#> [1] 9254   20\n#> \n#> [[3]]\n#> [1] 9254   20\n#> \n#> [[4]]\n#> [1] 9254   20\n#> \n#> [[5]]\n#> [1] 9254   20\n\n# Stacked dataset\ndat.stacked <- rbindlist(dat.full2)\ndim(dat.stacked)\n#> [1] 46270    20\n```\n:::\n\n\n##### 3.3 Prepating Survey design and subpopulation of eligible\n\nThe next step is to create the design on the combined dataset. Make sure to use the `new weight` variable that combines survey weights and PS weights.\n\n\n::: {.cell hash='propensityscore8_cache/html/step33_0b49ca05c6125783e18d46742fc72717'}\n\n```{.r .cell-code}\nallImputations <- imputationList(lapply(1:m, function(n) subset(dat.stacked, subset=.imp==n)))\n\n# Design on full data\nw.design0 <- svydesign(ids = ~psu, \n                       weights = ~new_weight, \n                       strata = ~strata,\n                      data = allImputations, \n                      nest = TRUE) \n\n# Subset the design\nw.design <- subset(w.design0, eligible == 1) \n```\n:::\n\n\nWe can see the length of the subsetted design:\n\n\n::: {.cell hash='propensityscore8_cache/html/step33b_b31b767e7e30270de09c1ca29a42d4a6'}\n\n```{.r .cell-code}\nlapply(w.design$designs, dim)\n#> [[1]]\n#> [1] 4191   20\n#> \n#> [[2]]\n#> [1] 4191   20\n#> \n#> [[3]]\n#> [1] 4191   20\n#> \n#> [[4]]\n#> [1] 4191   20\n#> \n#> [[5]]\n#> [1] 4191   20\n```\n:::\n\n\nNow we will run the design-adjusted logistic regression, adjusting for smoking since smoking was not balanced in terms of SMD.\n\n##### Step 3.4: Design adjusted regression analysis\n\n\n::: {.cell hash='propensityscore8_cache/html/step34_6935f694840b6fbe1b2d85d537e0c86f'}\n\n```{.r .cell-code}\n# Design-adjusted logistic regression\nfit <- with(w.design, svyglm(I(cvd == \"Yes\") ~ arthritis + smoking, family = quasibinomial))\nres <- exp(as.data.frame(cbind(coef(fit[[1]]),\n                               coef(fit[[2]]),\n                               coef(fit[[3]]),\n                               coef(fit[[4]]),\n                               coef(fit[[5]]))))\nnames(res) <- paste(\"OR from m =\", 1:m)\nround(t(res),2)\n#>               (Intercept) arthritisRheumatoid arthritis smokingPrevious smoker\n#> OR from m = 1        0.04                          1.21                   2.93\n#> OR from m = 2        0.04                          1.24                   2.93\n#> OR from m = 3        0.04                          1.23                   2.93\n#> OR from m = 4        0.04                          1.22                   2.92\n#> OR from m = 5        0.04                          1.22                   2.92\n#>               smokingCurrent smoker\n#> OR from m = 1                  1.55\n#> OR from m = 2                  1.56\n#> OR from m = 3                  1.54\n#> OR from m = 4                  1.55\n#> OR from m = 5                  1.55\n```\n:::\n\n\n##### Step 3.5: Pooling estimates\n\nNow, we will pool the estimate using Rubin's rule:\n\n\n::: {.cell hash='propensityscore8_cache/html/step35_e13ab2de1f7b0dcb326101e4259c577d'}\n\n```{.r .cell-code}\n# Pooled estimate\npooled.estimates <- MIcombine(fit)\nOR <- round(exp(pooled.estimates$coefficients), 2)\nOR <- as.data.frame(OR)\nCI <- round(exp(confint(pooled.estimates)), 2)\nOR <- cbind(OR, CI)\nOR\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OR\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"2.5 %\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"97.5 %\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.04\",\"2\":\"0.03\",\"3\":\"0.05\",\"_rn_\":\"(Intercept)\"},{\"1\":\"1.22\",\"2\":\"0.67\",\"3\":\"2.24\",\"_rn_\":\"arthritisRheumatoid arthritis\"},{\"1\":\"2.92\",\"2\":\"2.24\",\"3\":\"3.82\",\"_rn_\":\"smokingPrevious smoker\"},{\"1\":\"1.55\",\"2\":\"1.14\",\"3\":\"2.11\",\"_rn_\":\"smokingCurrent smoker\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n##### Double adjustment\n\n\n::: {.cell hash='propensityscore8_cache/html/Ausdoubleadj_a3d7df74b9db03757ce0607de92d6c9a'}\n\n```{.r .cell-code}\n# Outcome model with covariates adjustment\nfit2 <- with(w.design, svyglm(I(cvd == \"Yes\") ~ arthritis + age.cat + sex + education + \n                               race + income + bmi + smoking + htn + diabetes, \n                             family = quasibinomial))\n\n# Pooled estimate\npooled.estimates <- MIcombine(fit2)\nOR <- round(exp(pooled.estimates$coefficients), 2)\nOR <- as.data.frame(OR)\nCI <- round(exp(confint(pooled.estimates)), 2)\nOR <- cbind(OR, CI)\nOR\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OR\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"2.5 %\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"97.5 %\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.02\",\"2\":\"0.01\",\"3\":\"0.05\",\"_rn_\":\"(Intercept)\"},{\"1\":\"1.70\",\"2\":\"1.07\",\"3\":\"2.70\",\"_rn_\":\"arthritisRheumatoid arthritis\"},{\"1\":\"4.45\",\"2\":\"2.32\",\"3\":\"8.51\",\"_rn_\":\"age.cat50-64\"},{\"1\":\"11.88\",\"2\":\"7.13\",\"3\":\"19.80\",\"_rn_\":\"age.cat65+\"},{\"1\":\"0.47\",\"2\":\"0.35\",\"3\":\"0.64\",\"_rn_\":\"sexFemale\"},{\"1\":\"0.66\",\"2\":\"0.36\",\"3\":\"1.20\",\"_rn_\":\"educationHigh school\"},{\"1\":\"0.63\",\"2\":\"0.34\",\"3\":\"1.17\",\"_rn_\":\"educationCollege graduate or above\"},{\"1\":\"0.97\",\"2\":\"0.65\",\"3\":\"1.44\",\"_rn_\":\"raceBlack\"},{\"1\":\"0.50\",\"2\":\"0.26\",\"3\":\"0.98\",\"_rn_\":\"raceHispanic\"},{\"1\":\"0.86\",\"2\":\"0.42\",\"3\":\"1.78\",\"_rn_\":\"raceOthers\"},{\"1\":\"0.49\",\"2\":\"0.34\",\"3\":\"0.70\",\"_rn_\":\"income$20,000 to $74,999\"},{\"1\":\"0.31\",\"2\":\"0.18\",\"3\":\"0.53\",\"_rn_\":\"income$75,000 and Over\"},{\"1\":\"1.02\",\"2\":\"0.99\",\"3\":\"1.06\",\"_rn_\":\"bmi\"},{\"1\":\"1.51\",\"2\":\"1.17\",\"3\":\"1.96\",\"_rn_\":\"smokingPrevious smoker\"},{\"1\":\"1.47\",\"2\":\"1.01\",\"3\":\"2.12\",\"_rn_\":\"smokingCurrent smoker\"},{\"1\":\"1.57\",\"2\":\"0.84\",\"3\":\"2.91\",\"_rn_\":\"htnYes\"},{\"1\":\"2.91\",\"2\":\"1.82\",\"3\":\"4.67\",\"_rn_\":\"diabetesYes\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}