{
  "hash": "3636da72f78a30151824b8d37d89889b",
  "result": {
    "engine": "knitr",
    "markdown": "## Exercise 1 solution (S) {.unnumbered}\n\n\n\nWe will use the article by [Moon et al. (2021)](https://doi.org/10.1002/nau.24711). We will reproduce some results from the article. The authors aggregated 4 NHANES cycles 2005-12 to create their analytic dataset. The full dataset contains 40,790 subjects with the following relevant variables for this exercise:\n\n**Survey information**\n\n-   SEQN: Respondent sequence number\n-   strata: Masked pseudo strata (strata is nested within PSU)\n-   psu: Masked pseudo PSU\n-   survey.weight: Full sample 8 year interview weight divided by 4\n-   survey.cycle: NHANES cycle\n\n**Outcome variable**\n\n-   cvd: Cardiovascular disease\n\n**Exposure**\n\n-   nocturia: Binary nocturia\n\n**Confounders and other variables**\n\n-   age: Age in years at screening\n-   gender: Gender\n-   race: Race/Ethnicity\n-   smoking: 100+ cigarettes in life\n-   alcohol: Alcohol consumption (12+ drinks in 1 year)\n-   sleep: Sleep duration, h\n-   bmi: Body Mass Index in kg/m$^2$\n-   systolic: Systolic blood pressure, mmHg\n-   diastolic: Diastolic blood pressure, mmHg\n-   tcholesterol: Total cholesterol, mg/dl\n-   triglycerides: Triglycerides, mg/dl\n-   hdl: HDLâ€cholesterol, mg/dl\n-   diabetes: Diabetes mellitus\n-   hypertension: Hypertension\n\nTwo important **warnings** before we start:\n\n-   In this paper, there is insufficient information to create the analytic dataset. This is mainly because of not sufficiently defining the covariates and not explicitly explaining the inclusion/exclusion criteria.\n\n-   The authors did not consider survey features. Since we will utilize survey features in our analysis, our results will likely be different than the results shown by the authors in Table 2.\n\n## Problem 1: \n\n### 1(a) Importing dataset\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(file = \"Data/propensityscore/Moon2021.RData\")\nls()\n#> [1] \"dat.full\"\n```\n:::\n\n\n### 1(b) Subsetting according to eligibility\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Age 20+\ndat.analytic <- dat.full[complete.cases(dat.full$age),]\n\n# Complete outcome and exposure information\ndat.analytic <- dat.analytic[complete.cases(dat.analytic$cvd),] \ndat.analytic <- dat.analytic[complete.cases(dat.analytic$nocturia),] \n\n# Keep important variables only\nvars <- c(\n  # Survey features\n  \"SEQN\", \"strata\", \"psu\", \"survey.weight\", \n  \n  # Survey cycle\n  \"survey.cycle\", \n  \n  # Binary exposure\n  \"nocturia\",\n  \n  # Outcome\n  \"cvd\",\n  \n  # Covariates\n  \"age\", \"gender\", \"race\" , \"smoking\", \"alcohol\", \"sleep\", \"bmi\", \"diabetes\", \n  \"hypertension\", \"tcholesterol\", \"triglycerides\", \"hdl\", \"systolic\", \"diastolic\")\n\ndat.analytic <- dat.analytic[,vars]\n\n# Complete case\ndat.analytic <- na.omit(dat.analytic) #  N = 15,404 (numbers do not match with Fig 1)\ndim(dat.analytic)\n#> [1] 15404    21\n```\n:::\n\n\n### 1(c) Run the design-adjusted logistic regression\n\nCreate the first column of Table 2 of the article, i.e., explore the relationship between binary nocturia and CVD among adults aged 20 years and more. Adjust the model for the following covariates: age, gender, race, body mass index, smoking status, alcohol consumption, sleep duration, total cholesterol, triglycerides, HDL-cholesterol, hypertension, diabetes mellitus, and survey cycles.\n\nNote:\n\n-   The authors did not utilize the survey features (e.g., strata, psu, survey weights). But you should utilize the survey features to answer this question.\n\n-   You must create your design on the full data and then subset the design.\n\n-   Report the odds ratio with the 95% CI.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create an indicator variable in the full data\ndat.full$indicator <- 1\ndat.full$indicator[dat.full$SEQN %in% dat.analytic$SEQN] <- 0\n\n# Design setup\nsvy.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight,\n                         data = dat.full, nest = TRUE)\n\n# Subset the design\nsvy.design <- subset(svy.design0, indicator == 0)\n\n# Design-adjusted logistic\nfit.logit <- svyglm(I(cvd == \"Yes\") ~ nocturia + age + gender + race + bmi + \n                      smoking + alcohol + sleep + tcholesterol + triglycerides + \n                      hdl + hypertension + diabetes + survey.cycle, \n                    family = binomial, design = svy.design)\npublish(fit.logit)\n#>       Variable              Units OddsRatio         CI.95     p-value \n#>       nocturia                 <2       Ref                           \n#>                                2+      1.44   [1.21;1.71]   0.0001496 \n#>            age            [20,40)       Ref                           \n#>                           [40,60)      4.21   [3.05;5.82]     < 1e-04 \n#>                           [60,80)     11.46  [7.89;16.64]     < 1e-04 \n#>                          [80,Inf)     25.28 [17.51;36.50]     < 1e-04 \n#>         gender               Male       Ref                           \n#>                            Female      0.68   [0.58;0.79]     < 1e-04 \n#>           race          Hispanics       Ref                           \n#>                Non-Hispanic White      1.32   [1.10;1.57]   0.0036168 \n#>                Non-Hispanic Black      1.15   [0.92;1.44]   0.2362499 \n#>                       Other races      1.55   [1.05;2.30]   0.0319116 \n#>            bmi                         1.02   [1.01;1.03]   0.0003273 \n#>        smoking                 No       Ref                           \n#>                               Yes      1.74   [1.46;2.07]     < 1e-04 \n#>        alcohol                 No       Ref                           \n#>                               Yes      0.92   [0.59;1.45]   0.7273627 \n#>          sleep                         0.96   [0.90;1.01]   0.1146287 \n#>   tcholesterol                         0.99   [0.99;0.99]     < 1e-04 \n#>  triglycerides                         1.00   [1.00;1.00]   0.4801803 \n#>            hdl                         0.99   [0.98;1.00]   0.0416900 \n#>   hypertension                 No       Ref                           \n#>                               Yes      2.73   [2.27;3.29]     < 1e-04 \n#>       diabetes                 No       Ref                           \n#>                               Yes      1.83   [1.51;2.22]     < 1e-04 \n#>   survey.cycle            2005-06       Ref                           \n#>                           2007-08      0.84   [0.65;1.07]   0.1644272 \n#>                           2009-10      0.91   [0.73;1.12]   0.3793696 \n#>                           2011-11      0.82   [0.68;0.99]   0.0398975\n```\n:::\n\n\n## Problem 2: Propensity score matching by DuGoff et al. (2014) \n\n### 2(a): 1:1 matching\n\nCreate the second column of Table 2 (exploring the relationship between binary nocturia and CVD; the same exposure and outcome used in Problem 1) using the propensity score **1:1 matching** analysis as per [DuGoff et al. (2014)](https://pubmed.ncbi.nlm.nih.gov/23855598/) recommendations.\n\nYou should consider all four steps in the propensity score (PS) analysis:\n\n-   Step 1: Fit the PS model by considering survey features as covariates. Other covariates for the PS model are the covariates used in 1(c).\n\n-   Step 2: Match an exposed subject (nocturia $\\ge2$ times) with a control subject (nocturia \\<2 times) without replacement within the caliper of 0.2 times the standard deviation of the logit of PS. Set your seed to 123.\n\n-   Step 3: Balance checking using SMD. Consider SMD \\<0.1 as a good covariate balancing.\n\n-   Step 4: Fit the outcome model on the matched data. If needed, adjust for imbalanced covariates in the outcome model. Report the odds ratio with the 95% CI. You should utilize the survey feature as the design (NOT covariates).\n\n#### Step 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Specify the PS model to estimate propensity scores\nps.formula <- as.formula(I(nocturia==\"2+\") ~ age + gender + race + bmi + smoking + \n                           alcohol + sleep + tcholesterol + triglycerides + hdl + \n                           hypertension + diabetes + survey.cycle + \n                           psu + strata + survey.weight)\n\n## Fit the PS model\nps.fit <- glm(ps.formula, data = dat.analytic, family = binomial(\"logit\"))\ndat.analytic$PS <- predict(ps.fit, type = \"response\")\n#summary(dat.analytic$PS)\n\n## Caliper: 0.2*sd(logit of PS)\ncaliper <- 0.2*sd(log(dat.analytic$PS/(1-dat.analytic$PS)))\n#caliper\n```\n:::\n\n\n#### Step 2\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Match exposed and unexposed subjects \nset.seed(123)\nmatch.obj <- matchit(ps.formula, \n                     data = dat.analytic,\n                     distance = dat.analytic$PS, \n                     method = \"nearest\", \n                     replace = FALSE,\n                     caliper = caliper, \n                     ratio = 1)\ndat.analytic$PS <- match.obj$distance\n#summary(match.obj$distance)\n\n## See how many matched\n#match.obj\n\n## Extract matched data\nmatched.data <- match.data(match.obj) \n```\n:::\n\n\n#### Step 3\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Summary of PS by the exposure\n#tapply(matched.data$distance, matched.data$nocturia, summary)\n\n## Balance checking\nvars <- c(\"age\", \"gender\", \"race\", \"bmi\", \"smoking\", \"alcohol\", \"sleep\", \"tcholesterol\",\n         \"triglycerides\", \"hdl\", \"hypertension\", \"diabetes\", \"survey.cycle\")\n\n\ntab1m <- CreateTableOne(vars = vars, strata = \"nocturia\", data = matched.data, \n                           test = F, includeNA = F)\nprint(tab1m, smd = TRUE, format = \"p\") # All SMDs <0.1\n#>                            Stratified by nocturia\n#>                             <2              2+              SMD   \n#>   n                           4502            4502                \n#>   age (%)                                                    0.047\n#>      [20,40)                  19.5            20.2                \n#>      [40,60)                  32.9            31.7                \n#>      [60,80)                  39.2            38.7                \n#>      [80,Inf)                  8.4             9.5                \n#>   gender = Female (%)         50.7            49.8           0.017\n#>   race (%)                                                   0.020\n#>      Hispanics                24.4            24.3                \n#>      Non-Hispanic White       46.0            45.3                \n#>      Non-Hispanic Black       25.4            26.0                \n#>      Other races               4.2             4.4                \n#>   bmi (mean (SD))            29.96 (7.07)    30.18 (7.06)    0.031\n#>   smoking = Yes (%)           57.5            57.0           0.009\n#>   alcohol = Yes (%)            4.0             3.5           0.022\n#>   sleep (mean (SD))           6.77 (1.39)     6.73 (1.60)    0.024\n#>   tcholesterol (mean (SD))  199.01 (42.48)  197.51 (44.94)   0.034\n#>   triglycerides (mean (SD)) 163.55 (140.06) 164.00 (144.94)  0.003\n#>   hdl (mean (SD))            53.44 (16.85)   53.20 (16.81)   0.014\n#>   hypertension = Yes (%)      47.3            48.7           0.029\n#>   diabetes = Yes (%)          15.3            17.4           0.058\n#>   survey.cycle (%)                                           0.030\n#>      2005-06                  22.8            22.0                \n#>      2007-08                  27.5            27.3                \n#>      2009-10                  28.2            28.0                \n#>      2011-11                  21.6            22.8\n```\n:::\n\n\n#### Step 4\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Setup the design with survey features\ndat.full$matched <- 0\ndat.full$matched[dat.full$SEQN %in% matched.data$SEQN] <- 1\n\n## Survey setup for full data \nw.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight, \n                      data = dat.full, nest = TRUE)\n\n## Subset matched data\nw.design.m <- subset(w.design0, matched == 1)\n\n## Outcome model\nfit.psm <- svyglm(I(cvd == \"Yes\") ~ nocturia, design = w.design.m, family = binomial)\npublish(fit.psm)\n#>  Variable Units OddsRatio       CI.95     p-value \n#>  nocturia    <2       Ref                         \n#>              2+      1.33 [1.14;1.57]   0.0007554\n```\n:::\n\n\n### 2(b): Interpretation\n\nCompare your results with the results reported by the authors. \\[Expected answer: 1-2 sentences\\]\n\nIn the US population aged 20 years or more, the odds of CVD was 33% higher among adults with $\\ge 2$ times nocturia compared to PS matched controls with \\<2 nocturia. Unlike the results shown by the authors in Table 2, this odds ratio of 1.33 is a population-level estimate (i.e., the estimate is PATT).\n\n## Problem 3: Propensity score matching by Austin et al. (2018) \n\n### 3(a): 1:4 matching\n\nRepeat Problem 2(a), i.e., create the second column of Table 2 (exploring the relationship between binary nocturia and CVD), but using the propensity score **1:4 matching** analysis as per [Austin et al. (2018)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5843030/) recommendations.\n\nYou should consider all four steps in the propensity score (PS) analysis:\n\n-   Step 1: Fit the PS model by considering survey features as design, i.e., fit the design-adjusted PS model. Other covariates for the PS model are the covariates used in 1(c).\n\n-   Step 2: Match an exposed subject (nocturia $\\ge2$ times) with 4 control subjects (nocturia \\<2 times) with replacement within the caliper of 0.2 times the standard deviation of the logit of PS. Set your seed to 123.\n\n-   Step 3: Balance checking using SMD. Consider SMD \\<0.1 as a good covariate balancing. Remember, you need to consider matching weights in checking the covariate balance.\n\n-   Step 4: Fit the outcome model on the matched data. If needed, adjust for imbalanced covariates in the outcome model. Report the odds ratio with the 95% CI. You should utilize the survey feature as the design (NOT covariates).\n\n**Note**:\n\n-   For step 4, you need to multiply matching weights and survey weights when creating your design. After creating the design with the new weight, subset the design for the matched sample. This step is required to get survey-based estimates.\n\n#### Step 1\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Specify the PS model to estimate propensity scores\nps.formula3 <- as.formula(I(nocturia==\"2+\") ~ age + gender + race + bmi + smoking + \n                           alcohol + sleep + tcholesterol + triglycerides + hdl + \n                           hypertension + diabetes + survey.cycle)\n\nps.design <- svydesign(id = ~psu, weights = ~survey.weight, strata = ~strata,\n                       data = dat.analytic, nest = TRUE)\n\n## Fit the PS model\nps.fit3 <- svyglm(ps.formula3, design = ps.design, family = binomial)\ndat.analytic$PS3 <- predict(ps.fit3, type = \"response\")\n#summary(dat.analytic$PS3)\n\n## Caliper: 0.2*sd(logit of PS)\ncaliper3 <- 0.2*sd(log(dat.analytic$PS3/(1-dat.analytic$PS3)))\n#caliper3\n```\n:::\n\n\n#### Step 2\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Match exposed and unexposed subjects \nset.seed(123)\nmatch.obj3 <- matchit(ps.formula3, \n                      data = dat.analytic,\n                      distance = dat.analytic$PS3, \n                      method = \"nearest\", \n                      replace = TRUE,\n                      caliper = caliper3, \n                      ratio = 4)\ndat.analytic$PS3 <- match.obj$distance\n#summary(match.obj$distance)\n\n## See how many matched\n#match.obj3\n\n## Extract matched data\nmatched.data3 <- match.data(match.obj3) \n```\n:::\n\n\n#### Step 3\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Summary of PS by the exposure\n#tapply(matched.data3$distance, matched.data3$nocturia, summary)\n\n## Balance checking\nvars <- c(\"age\", \"gender\", \"race\", \"bmi\", \"smoking\", \"alcohol\", \"sleep\", \"tcholesterol\",\n         \"triglycerides\", \"hdl\", \"hypertension\", \"diabetes\", \"survey.cycle\")\n\n## Setup the design with survey features\ndat.full$matched <- 0\ndat.full$matched[dat.full$SEQN %in% matched.data3$SEQN] <- 1\n\n## Merging PS weights in full data\ndat.full$psweight <- 0\ndat.full$psweight[dat.full$SEQN %in% matched.data3$SEQN] <- matched.data3$weights\n\n## Survey setup for full data with ps weights - for balance checking\nw.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~psweight, \n                      data = dat.full, nest = TRUE)\n\n## Subset matched data\nw.design.m <- subset(w.design0, matched == 1)\n\ntab13m <- svyCreateTableOne(vars = vars, strata = \"nocturia\", data = w.design.m, \n                           test = F, includeNA = F)\nprint(tab13m, smd = TRUE, format = \"p\") # All SMDs <0.1\n#>                            Stratified by nocturia\n#>                             <2               2+               SMD   \n#>   n                          7185.0           4544.0                \n#>   age (%)                                                      0.053\n#>      [20,40)                   18.4             20.0                \n#>      [40,60)                   33.3             31.4                \n#>      [60,80)                   39.3             38.9                \n#>      [80,Inf)                   9.1              9.7                \n#>   gender = Female (%)          51.8             49.9           0.038\n#>   race (%)                                                     0.015\n#>      Hispanics                 24.3             24.1                \n#>      Non-Hispanic White        44.6             45.1                \n#>      Non-Hispanic Black        26.9             26.5                \n#>      Other races                4.2              4.4                \n#>   bmi (mean (SD))             29.97 (7.09)     30.21 (7.08)    0.035\n#>   smoking = Yes (%)            58.3             57.2           0.022\n#>   alcohol = Yes (%)             4.0              3.6           0.023\n#>   sleep (mean (SD))            6.73 (1.38)      6.73 (1.60)    0.004\n#>   tcholesterol (mean (SD))   197.49 (42.18)   197.44 (45.02)   0.001\n#>   triglycerides (mean (SD))  159.71 (129.75)  163.66 (144.57)  0.029\n#>   hdl (mean (SD))             53.27 (16.71)    53.25 (16.82)   0.001\n#>   hypertension = Yes (%)       47.6             49.2           0.031\n#>   diabetes = Yes (%)           16.9             18.0           0.028\n#>   survey.cycle (%)                                             0.016\n#>      2005-06                   21.4             22.0                \n#>      2007-08                   27.7             27.2                \n#>      2009-10                   28.0             27.8                \n#>      2011-11                   23.0             23.0\n```\n:::\n\n\n#### Step 4\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Survey setup for full data with new weight = survey weights * ps weights\nw.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight*psweight, \n                      data = dat.full, nest = TRUE)\n\n## Subset matched data\nw.design.m <- subset(w.design0, matched == 1)\n\n## Outcome model\nfit.psm <- svyglm(I(cvd == \"Yes\") ~ nocturia, design = w.design.m, family = binomial)\npublish(fit.psm)\n#>  Variable Units OddsRatio       CI.95     p-value \n#>  nocturia    <2       Ref                         \n#>              2+      1.33 [1.14;1.54]   0.0005248\n```\n:::\n\n\n### 3(b): Interpretation\n\nCompare the results with Problem 2. What's the overall conclusion? \\[Expected answer: 2-3 sentences\\]\n\nIn this exercise, we observed that the association between nocturia and CVD is approximately the same using DuGoff et al.'s 1:1 matching and Austin et al.'s 1:4 matching. At the population-level, we observed 33% higher odds of CVD among adults with $\\ge 2$ times nocturia than PS matched controls with \\<2 nocturia.\n\n",
    "supporting": [
      "propensityscoreEsolution_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}