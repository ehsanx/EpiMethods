{
  "hash": "3c38a15340ea9534e233c98eee6f3653",
  "result": {
    "markdown": "## PSM in OA-CVD (CCHS) {.unnumbered}\n\nThis tutorial is a comprehensive guide on implementing Propensity Score Matching (PSM) using R, particularly focusing on a OA - CVD health study from the Canadian Community Health Survey (CCHS). This PSM method is used to reduce bias due to confounding variables in observational studies by matching treated and control units with similar propensity scores. The tutorial illustrates that PSM is an iterative process, where researchers may need to refine their matching strategy to achieve satisfactory balance in the matched sample. Different strategies for estimating the treatment effect in the matched sample are explored, each with its own assumptions and implications.\n\n### Load packages\n\nAt first, various R packages are loaded to utilize their functions for data manipulation, statistical analysis, and visualization.\n\n\n::: {.cell hash='propensityscore2_cache/html/setup_78e69958c3b650f17a1d01fd64072433'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(MatchIt)\nrequire(tableone)\nrequire(survey)\nrequire(cobalt)\nrequire(Publish)\nrequire(optmatch)\n```\n:::\n\n\n### Load data\n\nThe dataset is loaded into the R environment. Variables are renamed to avoid conflicts in subsequent analyses.\n\n\n::: {.cell hash='propensityscore2_cache/html/data_da13ad48a85630840a9306527c028fa0'}\n\n```{.r .cell-code}\nload(file=\"Data/propensityscore/cchs123c.RData\")\nhead(analytic11n)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"weight\"],\"name\":[18],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"cycle\"],\"name\":[19],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[20],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[21],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[22],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"single\",\"5\":\"Non-white\",\"6\":\"Other 2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"healthy weight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"20.66\",\"19\":\"11\",\"20\":\"17838\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17838\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"healthy weight\",\"9\":\"Moderate\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"15.06\",\"19\":\"11\",\"20\":\"17839\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17839\"},{\"1\":\"event\",\"2\":\"50-59 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$80,000 or more\",\"8\":\"healthy weight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Never drank\",\"14\":\"6+ daily serving\",\"15\":\"Yes\",\"16\":\"No\",\"17\":\"North\",\"18\":\"74.04\",\"19\":\"11\",\"20\":\"17842\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17842\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"Post-2nd grad.\",\"7\":\"$80,000 or more\",\"8\":\"healthy weight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Former smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"30.47\",\"19\":\"11\",\"20\":\"17844\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17844\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"12.10\",\"19\":\"11\",\"20\":\"17846\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"6+ daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"16.90\",\"19\":\"11\",\"20\":\"17847\",\"21\":\"0\",\"22\":\"not immigrant\",\"23\":\"0\",\"_rn_\":\"17847\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# later we will create another variable called weights\n# hence to avoid any conflict/ambiguity,\n# renaming weight variable to survey.weight\nanalytic.miss$survey.weight <- analytic.miss$weight\nanalytic11n$survey.weight <- analytic11n$weight\nanalytic.miss$weight <- analytic11n$weight <- NULL\n```\n:::\n\n\n### Analysis\n\nWe are going to apply propensity score analysis (Matching) in our OA - CVD problem from CCHS. For computation considerations, we will only work with cycle 1.1, and the people from Northern provinces in Canada (`analytic11n` data).\n\n### Step 1\n\n#### Specify PS\n\nA logistic regression model formula is specified to calculate the propensity scores (PS), which is the probability of receiving the treatment given the observed covariates.\n\n\n::: {.cell hash='propensityscore2_cache/html/step1_825e1a95c18df6b1abbf7e559f78b549'}\n\n```{.r .cell-code}\nps.formula <- as.formula(\"OA ~ age + sex + stress + married + \n                         income + race + bmi + phyact + smoke +\n                        doctor + drink + bp + \n                         immigrate + fruit + diab + edu\")\nvar.names <- c(\"age\", \"sex\", \"stress\", \"married\", \n               \"income\", \"race\", \"bmi\", \"phyact\", \"smoke\", \n               \"doctor\", \"drink\", \"bp\", \n               \"immigrate\", \"fruit\", \"diab\", \"edu\")\n```\n:::\n\n\n#### Fit model\n\nThe software fits the PS model using a logistic regression by default. This package actually performs step 1 and 2 with one command `matchit`.\n\nLook at the website for arguments of matchit [@Matchit]\\]. It looks like this\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmatchit(formula, data, model=\"logit\", discard=0, reestimate=FALSE, nearest=TRUE,\n                 replace=FALSE, m.order=2, ratio=1, caliper=0, calclosest=FALSE,\n                 subclass=0, sub.by=\"treat\", mahvars=NULL, exact=FALSE, counter=TRUE, full=FALSE, full.options=list(),...)\n```\n:::\n\n\n::: callout-tip\n**Nearest-Neighbor Matching**:\n\nNearest-neighbor matching is a widely used technique in PSM to pair treated and control units based on the proximity of their propensity scores. It is straightforward and computationally efficient, making it a popular choice in many applications of PSM. Nearest-neighbor matching is often termed a \"greedy\" algorithm because it matches units in order, without considering the global distribution of propensity scores. Once a match is made, it is not revisited, even if a later unit would have been a better match. The method seeks to minimize bias by creating closely matched pairs but can increase variance if the pool of potential matches is reduced too much (e.g., using a very narrow caliper). It is essential to ensure that there is a common support region where the distributions of propensity scores for treated and control units overlap, ensuring comparability.\n:::\n\n### Step 2\n\n#### Match subjects by PS\n\nWe are going to match using a Nearest neighbor algorithm. This is a greedy matching algorithm. Note that we are not even defining any caliper.\n\n::: callout-tip\n**Caliper**:\n\nIn the context of PSM, a caliper is a predefined maximum allowable difference between the propensity scores of matched units. Essentially, it sets a threshold for how dissimilar matched units can be in terms of their propensity scores. When a caliper is used, a treated unit is only matched with a control unit if the absolute difference in their propensity scores is less than or equal to the specified caliper width. The caliper is used to avoid bad matches and thereby minimize bias in the estimated treatment effect. The size of the caliper is crucial. Too wide a caliper may allow poor matches, while too narrow a caliper may result in many units going unmatched. Implementing a caliper involves a trade-off between bias and efficiency. Using a caliper reduces bias by avoiding poor matches but may increase variance by reducing the number of matched pairs available for analysis. Therefore, the use of a caliper in PSM is a strategic decision to enhance the quality of matches and thereby improve the validity of causal inferences drawn from observational data. It is a practical tool to ensure that matched units are sufficiently similar in terms of their propensity scores, reducing the likelihood of bias due to poor matches.\n:::\n\n\n::: {.cell hash='propensityscore2_cache/html/step2_85121a023dd35d299383b3349c2f6444'}\n\n```{.r .cell-code}\n# set seed\nset.seed(123)\n# match\nmatching.obj <- matchit(ps.formula,\n                        data = analytic11n,\n                        method = \"nearest\",\n                        ratio = 1)\n#> Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\n# see how many matched\nmatching.obj\n#> A `matchit` object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: Propensity score\n#>              - estimated with logistic regression\n#>  - number of obs.: 1424 (original), 134 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu\n# create the \"matched\"\" data\nOACVD.match <- match.data(matching.obj)\n# see the dimension\ndim(analytic11n)\n#> [1] 1424   23\ndim(OACVD.match)\n#> [1] 134  26\n```\n:::\n\n\nLet's try to understand how this is working.\n\n#### Extract matched IDs\n\n\n::: {.cell hash='propensityscore2_cache/html/matchitstrata2_21b60af3150d7a4efa97f2249f122e20'}\n\n```{.r .cell-code}\nm.mat<-matching.obj$match.matrix\nhead(m.mat)\n#>       [,1]    \n#> 17864 \"96719\" \n#> 17921 \"17846\" \n#> 18191 \"97168\" \n#> 18256 \"111999\"\n#> 18264 \"17989\" \n#> 18383 \"108197\"\n```\n:::\n\n\n#### Extract the matched treated IDs\n\n\n::: {.cell hash='propensityscore2_cache/html/step2b_6032f5a051ff8c20c1ba97f275cf977d'}\n\n```{.r .cell-code}\ntreated.id<-as.numeric(row.names(m.mat))\ntreated.id # basically row names\n#>  [1]  17864  17921  18191  18256  18264  18383  18389  18475  39105  96344\n#> [11]  96364  96407  96424  96460  96484  96571  96582  96625  96632  96641\n#> [21]  96657  96686  96693  96696  96705  96734  96795  96840  96913  97027\n#> [31]  97065  97125 108178 108183 108185 108192 111809 111813 111856 111859\n#> [41] 111895 111896 111920 111942 112014 112026 112046 112083 112086 112114\n#> [51] 112122 112151 112167 112189 112197 112215 112232 112245 112275 112284\n#> [61] 112289 112290 112300 112325 112375 126477 126522\n```\n:::\n\n\n#### Extract the matched untreated IDs\n\n\n::: {.cell hash='propensityscore2_cache/html/step2c_7d895c21fff176a3b99a14b8b43fe3c3'}\n\n```{.r .cell-code}\nuntreated.id <- as.numeric(m.mat)\nuntreated.id # basically row names\n#>  [1]  96719  17846  97168 111999  17989 108197 112384  17909 126561 111880\n#> [11] 112184  18117  96865  18120  97023 112379  97017 126562  96356 126470\n#> [21] 126385  96374  18203  18262  96972 111924  96354  96983  18235  96882\n#> [31] 112054  18321 112349  18426  38996 126516 111814 112087  96569 111932\n#> [41] 126539  18315  96665  18225 112052 112324 112165  18329  96609 126376\n#> [51]  96474 126570 126547 126343  96680  96558 111931  96718  96533 111823\n#> [61] 112177  17953  17904 111908 111962  96644  96576\n```\n:::\n\n\n#### Extract the matched treated data\n\n\n::: {.cell hash='propensityscore2_cache/html/step2d_2025044e9a20f66eeb70f1081d245813'}\n\n```{.r .cell-code}\ntx <- analytic11n[rownames(analytic11n) %in% treated.id,]\nhead(tx[c(\"OA\", \"CVD\", \"sex\", \"age\", \"race\", \"edu\")])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OA\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CVD\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"40-49 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"17864\"},{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"30-39 years\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"_rn_\":\"17921\"},{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"40-49 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"18191\"},{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Male\",\"4\":\"30-39 years\",\"5\":\"Non-white\",\"6\":\"Post-2nd grad.\",\"_rn_\":\"18256\"},{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Male\",\"4\":\"20-29 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"18264\"},{\"1\":\"1\",\"2\":\"no event\",\"3\":\"Male\",\"4\":\"30-39 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"18383\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n#### Extract the matched untreated data\n\n\n::: {.cell hash='propensityscore2_cache/html/step2e_a6468aa10098c44e84b8ec23361601e9'}\n\n```{.r .cell-code}\nutx <- analytic11n[rownames(analytic11n) %in% untreated.id,]\nhead(utx[c(\"OA\", \"CVD\", \"sex\", \"age\", \"race\", \"edu\")])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OA\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"CVD\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"0\",\"2\":\"no event\",\"3\":\"Male\",\"4\":\"30-39 years\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"_rn_\":\"17846\"},{\"1\":\"0\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"40-49 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"17904\"},{\"1\":\"0\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"20-29 years\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"_rn_\":\"17909\"},{\"1\":\"0\",\"2\":\"no event\",\"3\":\"Male\",\"4\":\"20-29 years\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"_rn_\":\"17953\"},{\"1\":\"0\",\"2\":\"event\",\"3\":\"Male\",\"4\":\"30-39 years\",\"5\":\"Non-white\",\"6\":\"2nd grad.\",\"_rn_\":\"17989\"},{\"1\":\"0\",\"2\":\"no event\",\"3\":\"Female\",\"4\":\"60-64 years\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"_rn_\":\"18117\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n#### Extract the matched data altogether\n\nSimply using `match.data` is enough (as done earlier).\n\n\n::: {.cell hash='propensityscore2_cache/html/step2f_e3890cdcc045feaed8986895f0272adb'}\n\n```{.r .cell-code}\nOACVD.match <- match.data(matching.obj)\n```\n:::\n\n\n#### Assign match ID\n\n\n::: {.cell hash='propensityscore2_cache/html/step2g_5118c1b2c27cdec72e165beab6af163d'}\n\n```{.r .cell-code}\nOACVD.match$match.ID <- NA\nOACVD.match$match.ID[rownames(OACVD.match) %in% treated.id] <- 1:length(treated.id)\nOACVD.match$match.ID[rownames(OACVD.match) %in% untreated.id] <- 1:length(untreated.id)\ntable(OACVD.match$match.ID)\n#> \n#>  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \n#>  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 \n#> 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 \n#>  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 \n#> 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 \n#>  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2\n```\n:::\n\n\nTake a look at individual matches for the first match\n\n\n::: {.cell hash='propensityscore2_cache/html/step2h_b6fdd7bc4070060585cc2d70a5fef72f'}\n\n```{.r .cell-code}\nna.omit(OACVD.match[OACVD.match$match.ID == 1,])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"subclass\"],\"name\":[26],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"match.ID\"],\"name\":[27],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17846\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.10\",\"24\":\"0.01854076\",\"25\":\"1\",\"26\":\"2\",\"27\":\"1\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17864\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"38.23\",\"24\":\"0.18190027\",\"25\":\"1\",\"26\":\"1\",\"27\":\"1\",\"_rn_\":\"17864\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nTake a look at individual matches for the second match\n\n\n::: {.cell hash='propensityscore2_cache/html/step2i_a7d91fc8aa57c30f501bda6195c7c96a'}\n\n```{.r .cell-code}\nna.omit(OACVD.match[OACVD.match$match.ID == 2,])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"subclass\"],\"name\":[26],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"match.ID\"],\"name\":[27],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Former driker\",\"14\":\"0-3 daily serving\",\"15\":\"Yes\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17904\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"52.04\",\"24\":\"0.06783228\",\"25\":\"1\",\"26\":\"63\",\"27\":\"2\",\"_rn_\":\"17904\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$29,999 or less\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17921\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"15.88\",\"24\":\"0.01857417\",\"25\":\"1\",\"26\":\"2\",\"27\":\"2\",\"_rn_\":\"17921\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Step 3\n\nBoth graphical and numerical methods are used to assess the quality of the matches and the balance of covariates in the matched sample.\n\n#### Examining PS graphically\n\nVisually inspect the PS and assess the balance of covariates in the matched sample. Various plots are generated to visualize the distribution of PS across treatment groups and to check the balance of covariates before and after matching.\n\n#### matchit package\n\n\n::: {.cell hash='propensityscore2_cache/html/step3_8788e70f297154a41dcdd9fbab2e2766'}\n\n```{.r .cell-code}\n# plot(matching.obj) # covariate balance\nplot(matching.obj, type = \"jitter\") # propensity score locations\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3-1.png){width=672}\n:::\n\n```\n#> To identify the units, use first mouse button; to stop, use second.\nplot(matching.obj, type = \"hist\") #check matched treated vs matched control\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3-2.png){width=672}\n:::\n\n```{.r .cell-code}\nsummrize.output <- summary(matching.obj, standardize = TRUE)\nplot(summrize.output)\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3-3.png){width=672}\n:::\n:::\n\n\n#### Overalp check\n\n\n::: {.cell hash='propensityscore2_cache/html/step3b_83bc5de14b1c4f741ac123815ae92adf'}\n\n```{.r .cell-code}\n# plot propensity scores by exposure group\nplot(density(OACVD.match$distance[OACVD.match$OA==1]), \n     col = \"red\", main = \"\")\nlines(density(OACVD.match$distance[OACVD.match$OA==0]), \n      col = \"blue\", lty = 2)\nlegend(\"topright\", c(\"Non-arthritis\",\"OA\"), \n       col = c(\"red\", \"blue\"), lty=1:2)\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3b-1.png){width=672}\n:::\n:::\n\n\n#### cobalt package\n\nOverlap check in a more convenient way\n\n\n::: {.cell hash='propensityscore2_cache/html/step3c_2dc417201e7aa21709ff469277596597'}\n\n```{.r .cell-code}\n# different badwidth\nbal.plot(matching.obj, var.name = \"distance\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3c-1.png){width=672}\n:::\n:::\n\n\n#### Look at the data\n\n\n::: {.cell hash='propensityscore2_cache/html/step3d_43e4f5689321a30bd619dd7c23a23013'}\n\n```{.r .cell-code}\n# what is distance variable here?\nhead(OACVD.match)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"subclass\"],\"name\":[26],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"match.ID\"],\"name\":[27],\"type\":[\"int\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17846\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.10\",\"24\":\"0.01854076\",\"25\":\"1\",\"26\":\"2\",\"27\":\"1\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17864\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"38.23\",\"24\":\"0.18190027\",\"25\":\"1\",\"26\":\"1\",\"27\":\"1\",\"_rn_\":\"17864\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Former driker\",\"14\":\"0-3 daily serving\",\"15\":\"Yes\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17904\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"52.04\",\"24\":\"0.06783228\",\"25\":\"1\",\"26\":\"63\",\"27\":\"2\",\"_rn_\":\"17904\"},{\"1\":\"no event\",\"2\":\"20-29 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$80,000 or more\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17909\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"33.23\",\"24\":\"0.03126371\",\"25\":\"1\",\"26\":\"8\",\"27\":\"3\",\"_rn_\":\"17909\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$29,999 or less\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17921\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"15.88\",\"24\":\"0.01857417\",\"25\":\"1\",\"26\":\"2\",\"27\":\"2\",\"_rn_\":\"17921\"},{\"1\":\"no event\",\"2\":\"20-29 years\",\"3\":\"Male\",\"4\":\"not single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Moderate\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17953\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"26.91\",\"24\":\"0.00467081\",\"25\":\"1\",\"26\":\"62\",\"27\":\"4\",\"_rn_\":\"17953\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n#### Numerical values of PS\n\n\n::: {.cell hash='propensityscore2_cache/html/step3e_88a762c80d2bec31db8d9f4ca1db40c9'}\n\n```{.r .cell-code}\nsummary(OACVD.match$distance)\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.044834 0.099094 0.138969 0.200576 0.611166\nby(OACVD.match$distance, OACVD.match$OA, summary)\n#> OACVD.match$OA: 0\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.047344 0.099215 0.135042 0.199279 0.418206 \n#> ------------------------------------------------------------ \n#> OACVD.match$OA: 1\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.047346 0.098973 0.142897 0.198741 0.611166\n```\n:::\n\n\n#### Question for the students\n\n-   Are you happy with the matching after reviewing the plots?\n\n#### Covariate balance in matched sample\n\nCovariate balance is assessed numerically using standardized mean differences (SMD).\n\n::: callout-tip\n**Standardized mean differences**: SMD is a versatile and widely used statistical measure that facilitates the comparison of groups in research by providing a scale-free metric of difference and balance. In the context of propensity score matching, achieving low SMD values for covariates after matching is crucial to ensuring the validity of causal inferences drawn from the matched sample.\n\nBenifits:\n\n-   SMD is not influenced by the scale of the measured variable, making it suitable for comparing the balance of different variables measured on different scales.\n-   Unlike hypothesis testing, SMD is not affected by sample size, making it a reliable measure for assessing balance in matched samples.\n:::\n\n\n::: {.cell hash='propensityscore2_cache/html/step3f_a7e36855789cd31b61f76c13fc73e787'}\n\n```{.r .cell-code}\ntab1 <- CreateTableOne(strata = \"OA\", data = OACVD.match, \n                       test = FALSE, vars = var.names)\nprint(tab1, smd = TRUE)\n#>                        Stratified by OA\n#>                         0          1          SMD   \n#>   n                     67         67               \n#>   age (%)                                      0.190\n#>      20-29 years         4 ( 6.0)   4 ( 6.0)        \n#>      30-39 years        16 (23.9)  11 (16.4)        \n#>      40-49 years        16 (23.9)  18 (26.9)        \n#>      50-59 years        28 (41.8)  31 (46.3)        \n#>      60-64 years         3 ( 4.5)   3 ( 4.5)        \n#>      65 years and over   0 ( 0.0)   0 ( 0.0)        \n#>      teen                0 ( 0.0)   0 ( 0.0)        \n#>   sex = Male (%)        28 (41.8)  32 (47.8)   0.120\n#>   stress = stressed (%) 20 (29.9)  21 (31.3)   0.032\n#>   married = single (%)  22 (32.8)  23 (34.3)   0.032\n#>   income (%)                                   0.183\n#>      $29,999 or less    11 (16.4)  13 (19.4)        \n#>      $30,000-$49,999    19 (28.4)  15 (22.4)        \n#>      $50,000-$79,999    14 (20.9)  12 (17.9)        \n#>      $80,000 or more    23 (34.3)  27 (40.3)        \n#>   race = White (%)      43 (64.2)  44 (65.7)   0.031\n#>   bmi (%)                                     <0.001\n#>      Underweight         0 ( 0.0)   0 ( 0.0)        \n#>      healthy weight     18 (26.9)  18 (26.9)        \n#>      Overweight         49 (73.1)  49 (73.1)        \n#>   phyact (%)                                   0.041\n#>      Active             16 (23.9)  16 (23.9)        \n#>      Inactive           40 (59.7)  39 (58.2)        \n#>      Moderate           11 (16.4)  12 (17.9)        \n#>   smoke (%)                                    0.258\n#>      Never smoker       14 (20.9)   9 (13.4)        \n#>      Current smoker     20 (29.9)  27 (40.3)        \n#>      Former smoker      33 (49.3)  31 (46.3)        \n#>   doctor = Yes (%)      51 (76.1)  47 (70.1)   0.135\n#>   drink (%)                                    0.116\n#>      Never drank         2 ( 3.0)   2 ( 3.0)        \n#>      Current drinker    54 (80.6)  51 (76.1)        \n#>      Former driker      11 (16.4)  14 (20.9)        \n#>   bp = Yes (%)           7 (10.4)   5 ( 7.5)   0.105\n#>   immigrate (%)                                0.180\n#>      not immigrant      64 (95.5)  61 (91.0)        \n#>      > 10 years          3 ( 4.5)   6 ( 9.0)        \n#>      recent              0 ( 0.0)   0 ( 0.0)        \n#>   fruit (%)                                    0.146\n#>      0-3 daily serving  19 (28.4)  19 (28.4)        \n#>      4-6 daily serving  28 (41.8)  32 (47.8)        \n#>      6+ daily serving   20 (29.9)  16 (23.9)        \n#>   diab = Yes (%)         1 ( 1.5)   4 ( 6.0)   0.238\n#>   edu (%)                                      0.105\n#>      < 2ndary           14 (20.9)  13 (19.4)        \n#>      2nd grad.           1 ( 1.5)   2 ( 3.0)        \n#>      Other 2nd grad.     1 ( 1.5)   1 ( 1.5)        \n#>      Post-2nd grad.     51 (76.1)  51 (76.1)\n```\n:::\n\n\n#### Question for the students\n\n-   All SMD \\< 0.20?\n\n#### Other balance measures\n\n##### Individual categories\n\nIf you want to check balance at each category (not very useful in general situations). We are generally interested if the variables are balanced or not (not categories).\n\n\n::: {.cell hash='propensityscore2_cache/html/step3g_b1fb4747d63cbc03c92cbe77c267c054'}\n\n```{.r .cell-code}\nbaltab <- bal.tab(matching.obj)\nbaltab\n#> Balance Measures\n#>                             Type Diff.Adj\n#> distance                Distance   0.0597\n#> age_20-29 years           Binary   0.0000\n#> age_30-39 years           Binary  -0.0746\n#> age_40-49 years           Binary   0.0299\n#> age_50-59 years           Binary   0.0448\n#> age_60-64 years           Binary   0.0000\n#> sex_Male                  Binary   0.0597\n#> stress_stressed           Binary   0.0149\n#> married_single            Binary   0.0149\n#> income_$29,999 or less    Binary   0.0299\n#> income_$30,000-$49,999    Binary  -0.0597\n#> income_$50,000-$79,999    Binary  -0.0299\n#> income_$80,000 or more    Binary   0.0597\n#> race_White                Binary   0.0149\n#> bmi_Underweight           Binary   0.0000\n#> bmi_healthy weight        Binary   0.0000\n#> bmi_Overweight            Binary   0.0000\n#> phyact_Active             Binary   0.0000\n#> phyact_Inactive           Binary  -0.0149\n#> phyact_Moderate           Binary   0.0149\n#> smoke_Never smoker        Binary  -0.0746\n#> smoke_Current smoker      Binary   0.1045\n#> smoke_Former smoker       Binary  -0.0299\n#> doctor_Yes                Binary  -0.0597\n#> drink_Never drank         Binary   0.0000\n#> drink_Current drinker     Binary  -0.0448\n#> drink_Former driker       Binary   0.0448\n#> bp_Yes                    Binary  -0.0299\n#> immigrate_not immigrant   Binary  -0.0448\n#> immigrate_> 10 years      Binary   0.0448\n#> immigrate_recent          Binary   0.0000\n#> fruit_0-3 daily serving   Binary   0.0000\n#> fruit_4-6 daily serving   Binary   0.0597\n#> fruit_6+ daily serving    Binary  -0.0597\n#> diab_Yes                  Binary   0.0448\n#> edu_< 2ndary              Binary  -0.0149\n#> edu_2nd grad.             Binary   0.0149\n#> edu_Other 2nd grad.       Binary   0.0000\n#> edu_Post-2nd grad.        Binary   0.0000\n#> \n#> Sample sizes\n#>           Control Treated\n#> All          1357      67\n#> Matched        67      67\n#> Unmatched    1290       0\n```\n:::\n\n\n##### Individual plots\n\nYou could plot each variables individually\n\n\n::: {.cell hash='propensityscore2_cache/html/step3h_a737e427ce53ffce428e68670af91e6f'}\n\n```{.r .cell-code}\nbal.plot(matching.obj, var.name = \"income\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3h-1.png){width=672}\n:::\n\n```{.r .cell-code}\nbal.plot(matching.obj, var.name = \"age\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3h-2.png){width=672}\n:::\n\n```{.r .cell-code}\nbal.plot(matching.obj, var.name = \"race\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3h-3.png){width=672}\n:::\n\n```{.r .cell-code}\nbal.plot(matching.obj, var.name = \"diab\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3h-4.png){width=672}\n:::\n\n```{.r .cell-code}\nbal.plot(matching.obj, var.name = \"immigrate\")\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/step3h-5.png){width=672}\n:::\n:::\n\n\n##### Love plot\n\n\n::: {.cell hash='propensityscore2_cache/html/loveplot_a88c895c3f7aad31cc22911a5e23faa2'}\n\n```{.r .cell-code}\n# Individual categories again\nlove.plot(baltab, threshold = .2)\n#> Warning: Unadjusted values are missing. This can occur when `un = FALSE` and\n#> `quick = TRUE` in the original call to `bal.tab()`.\n#> Warning: Standardized mean differences and raw mean differences are present in the same plot. \n#> Use the `stars` argument to distinguish between them and appropriately label the x-axis.\n```\n\n::: {.cell-output-display}\n![](propensityscore2_files/figure-html/loveplot-1.png){width=672}\n:::\n:::\n\n\n### Repeat of Step 1-3 again\n\nCovariate balance is reassessed in each step to ensure the quality of the match.\n\n#### Add caliper\n\nThe matching process is repeated, this time introducing a caliper to ensure that matches are only made within a specified range of PS.\n\n\n::: {.cell hash='propensityscore2_cache/html/step3i_75ef8e9566e211c6776020acf960c395'}\n\n```{.r .cell-code}\nlogitPS <-  -log(1/OACVD.match$distance - 1) \n# logit of the propensity score\n.2*sd(logitPS) # suggested in the literature\n#> [1] 0.2334615\n\n\n# Step 1 and 2\nmatching.obj <- matchit(ps.formula,\n                        data = analytic11n,\n                        method = \"nearest\",\n                        ratio = 1,\n                        caliper = .2*sd(logitPS))\n#> Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\n# see how many matched\nmatching.obj\n#> A `matchit` object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: Propensity score [caliper]\n#> \n#>              - estimated with logistic regression\n#>  - caliper: <distance> (0.015)\n#>  - number of obs.: 1424 (original), 128 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu\nOACVD.match <- match.data(matching.obj)\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/step3j_8ded6f1fe7c4e49a925a4fe693a985bb'}\n\n```{.r .cell-code}\n# Step 3\nby(OACVD.match$distance, OACVD.match$OA, summary)\n#> OACVD.match$OA: 0\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.041740 0.094963 0.124665 0.184103 0.418206 \n#> ------------------------------------------------------------ \n#> OACVD.match$OA: 1\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.041694 0.095089 0.125262 0.183739 0.424895\ntab1 <- CreateTableOne(strata = \"OA\", data = OACVD.match, \n                       test = FALSE, vars = var.names)\nprint(tab1, smd = TRUE)\n#>                        Stratified by OA\n#>                         0          1          SMD   \n#>   n                     64         64               \n#>   age (%)                                      0.196\n#>      20-29 years         4 ( 6.2)   4 ( 6.2)        \n#>      30-39 years        16 (25.0)  11 (17.2)        \n#>      40-49 years        16 (25.0)  18 (28.1)        \n#>      50-59 years        25 (39.1)  28 (43.8)        \n#>      60-64 years         3 ( 4.7)   3 ( 4.7)        \n#>      65 years and over   0 ( 0.0)   0 ( 0.0)        \n#>      teen                0 ( 0.0)   0 ( 0.0)        \n#>   sex = Male (%)        27 (42.2)  30 (46.9)   0.094\n#>   stress = stressed (%) 18 (28.1)  18 (28.1)  <0.001\n#>   married = single (%)  21 (32.8)  23 (35.9)   0.066\n#>   income (%)                                   0.204\n#>      $29,999 or less    11 (17.2)  13 (20.3)        \n#>      $30,000-$49,999    19 (29.7)  14 (21.9)        \n#>      $50,000-$79,999    13 (20.3)  12 (18.8)        \n#>      $80,000 or more    21 (32.8)  25 (39.1)        \n#>   race = White (%)      40 (62.5)  42 (65.6)   0.065\n#>   bmi (%)                                     <0.001\n#>      Underweight         0 ( 0.0)   0 ( 0.0)        \n#>      healthy weight     18 (28.1)  18 (28.1)        \n#>      Overweight         46 (71.9)  46 (71.9)        \n#>   phyact (%)                                   0.096\n#>      Active             14 (21.9)  16 (25.0)        \n#>      Inactive           39 (60.9)  36 (56.2)        \n#>      Moderate           11 (17.2)  12 (18.8)        \n#>   smoke (%)                                    0.267\n#>      Never smoker       14 (21.9)   9 (14.1)        \n#>      Current smoker     19 (29.7)  26 (40.6)        \n#>      Former smoker      31 (48.4)  29 (45.3)        \n#>   doctor = Yes (%)      48 (75.0)  44 (68.8)   0.139\n#>   drink (%)                                    0.123\n#>      Never drank         2 ( 3.1)   2 ( 3.1)        \n#>      Current drinker    52 (81.2)  49 (76.6)        \n#>      Former driker      10 (15.6)  13 (20.3)        \n#>   bp = Yes (%)           7 (10.9)   5 ( 7.8)   0.107\n#>   immigrate (%)                                0.260\n#>      not immigrant      62 (96.9)  58 (90.6)        \n#>      > 10 years          2 ( 3.1)   6 ( 9.4)        \n#>      recent              0 ( 0.0)   0 ( 0.0)        \n#>   fruit (%)                                    0.116\n#>      0-3 daily serving  19 (29.7)  19 (29.7)        \n#>      4-6 daily serving  27 (42.2)  30 (46.9)        \n#>      6+ daily serving   18 (28.1)  15 (23.4)        \n#>   diab = Yes (%)         0 ( 0.0)   3 ( 4.7)   0.314\n#>   edu (%)                                      0.108\n#>      < 2ndary           14 (21.9)  13 (20.3)        \n#>      2nd grad.           1 ( 1.6)   2 ( 3.1)        \n#>      Other 2nd grad.     1 ( 1.6)   1 ( 1.6)        \n#>      Post-2nd grad.     48 (75.0)  48 (75.0)\n```\n:::\n\n\n#### Question for the students\n\n-   Did all of the SMDs decrease?\n\n#### Look at the data\n\n\n::: {.cell hash='propensityscore2_cache/html/step3k_e4329eb304962dda392f862a4184dd5d'}\n\n```{.r .cell-code}\n# what is weights variable for pair matching?\nhead(OACVD.match)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"subclass\"],\"name\":[26],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17846\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.10\",\"24\":\"0.01854076\",\"25\":\"1\",\"26\":\"2\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17864\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"38.23\",\"24\":\"0.18190027\",\"25\":\"1\",\"26\":\"1\",\"_rn_\":\"17864\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Former driker\",\"14\":\"0-3 daily serving\",\"15\":\"Yes\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17904\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"52.04\",\"24\":\"0.06783228\",\"25\":\"1\",\"26\":\"60\",\"_rn_\":\"17904\"},{\"1\":\"no event\",\"2\":\"20-29 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$80,000 or more\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17909\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"33.23\",\"24\":\"0.03126371\",\"25\":\"1\",\"26\":\"8\",\"_rn_\":\"17909\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Female\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$29,999 or less\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17921\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"15.88\",\"24\":\"0.01857417\",\"25\":\"1\",\"26\":\"2\",\"_rn_\":\"17921\"},{\"1\":\"no event\",\"2\":\"20-29 years\",\"3\":\"Male\",\"4\":\"not single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Moderate\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17953\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"26.91\",\"24\":\"0.00467081\",\"25\":\"1\",\"26\":\"59\",\"_rn_\":\"17953\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nsummary(OACVD.match$weights)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>       1       1       1       1       1       1\n```\n:::\n\n\n### Step 4\n\n#### Estimate treatment effect for matched data\n\nDifferent models (e.g., unconditional logistic regression, survey design) are fitted to estimate the treatment effect in the matched sample.\n\n#### Unconditional logistic\n\n\n::: {.cell hash='propensityscore2_cache/html/step4_41cd7ff153dbaa6608f5c2e0c73635fc'}\n\n```{.r .cell-code}\n# Wrong model for population!!\noutcome.model <- glm(CVD ~ OA, data = OACVD.match, family = binomial())\npublish(outcome.model)\n#>  Variable Units OddsRatio       CI.95  p-value \n#>        OA            0.48 [0.09;2.74]   0.4119\n```\n:::\n\n\n#### Survey design\n\n##### Convert data to design\n\nThe matched data is converted to a survey design object to account for the matched pairs in the analysis.\n\n\n::: {.cell hash='propensityscore2_cache/html/step4b_6ddd27f2e098eeaef8848218b86d4fcf'}\n\n```{.r .cell-code}\nanalytic.miss$matched <- 0\nlength(analytic.miss$ID) # full data\n#> [1] 397173\nlength(OACVD.match$ID) # matched data\n#> [1] 128\nlength(analytic.miss$ID[analytic.miss$ID %in% OACVD.match$ID])\n#> [1] 128\nanalytic.miss$matched[analytic.miss$ID %in% OACVD.match$ID] <- 1\ntable(analytic.miss$matched)\n#> \n#>      0      1 \n#> 397045    128\nw.design0 <- svydesign(id=~1, weights=~survey.weight, \n                      data=analytic.miss)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n\n##### Balance in matched population?\n\n\n::: {.cell hash='propensityscore2_cache/html/step4c_4466a5cdb410e54732862791fb633923'}\n\n```{.r .cell-code}\ntab1 <- svyCreateTableOne(strata = \"OA\", data = w.design.m, \n                       test = FALSE, vars = var.names)\nprint(tab1, smd = TRUE)\n#>                        Stratified by OA\n#>                         0              1              SMD   \n#>   n                     1783.6         2002.1               \n#>   age (%)                                              0.307\n#>      20-29 years         131.0 ( 7.3)   120.9 ( 6.0)        \n#>      30-39 years         388.0 (21.8)   237.8 (11.9)        \n#>      40-49 years         518.3 (29.1)   572.7 (28.6)        \n#>      50-59 years         680.1 (38.1)   999.3 (49.9)        \n#>      60-64 years          66.1 ( 3.7)    71.4 ( 3.6)        \n#>      65 years and over     0.0 ( 0.0)     0.0 ( 0.0)        \n#>      teen                  0.0 ( 0.0)     0.0 ( 0.0)        \n#>   sex = Male (%)         852.4 (47.8)   985.1 (49.2)   0.028\n#>   stress = stressed (%)  544.6 (30.5)   531.8 (26.6)   0.088\n#>   married = single (%)   419.8 (23.5)   427.5 (21.4)   0.052\n#>   income (%)                                           0.222\n#>      $29,999 or less     266.6 (14.9)   352.4 (17.6)        \n#>      $30,000-$49,999     462.8 (25.9)   348.8 (17.4)        \n#>      $50,000-$79,999     298.6 (16.7)   315.7 (15.8)        \n#>      $80,000 or more     755.5 (42.4)   985.2 (49.2)        \n#>   race = White (%)      1129.2 (63.3)  1364.9 (68.2)   0.103\n#>   bmi (%)                                              0.045\n#>      Underweight           0.0 ( 0.0)     0.0 ( 0.0)        \n#>      healthy weight      483.3 (27.1)   583.3 (29.1)        \n#>      Overweight         1300.2 (72.9)  1418.8 (70.9)        \n#>   phyact (%)                                           0.054\n#>      Active              448.0 (25.1)   493.9 (24.7)        \n#>      Inactive           1075.2 (60.3)  1176.6 (58.8)        \n#>      Moderate            260.3 (14.6)   331.5 (16.6)        \n#>   smoke (%)                                            0.288\n#>      Never smoker        400.2 (22.4)   265.8 (13.3)        \n#>      Current smoker      548.8 (30.8)   836.6 (41.8)        \n#>      Former smoker       834.6 (46.8)   899.6 (44.9)        \n#>   doctor = Yes (%)      1376.0 (77.1)  1430.1 (71.4)   0.131\n#>   drink (%)                                            0.194\n#>      Never drank          44.0 ( 2.5)   112.6 ( 5.6)        \n#>      Current drinker    1464.1 (82.1)  1510.6 (75.5)        \n#>      Former driker       275.4 (15.4)   378.9 (18.9)        \n#>   bp = Yes (%)           166.6 ( 9.3)   153.5 ( 7.7)   0.060\n#>   immigrate (%)                                        0.235\n#>      not immigrant      1694.8 (95.0)  1774.1 (88.6)        \n#>      > 10 years           88.8 ( 5.0)   228.0 (11.4)        \n#>      recent                0.0 ( 0.0)     0.0 ( 0.0)        \n#>   fruit (%)                                            0.293\n#>      0-3 daily serving   426.1 (23.9)   480.8 (24.0)        \n#>      4-6 daily serving   748.1 (41.9)  1082.3 (54.1)        \n#>      6+ daily serving    609.4 (34.2)   439.0 (21.9)        \n#>   diab = Yes (%)           0.0 ( 0.0)    83.6 ( 4.2)   0.295\n#>   edu (%)                                              0.172\n#>      < 2ndary            324.9 (18.2)   342.8 (17.1)        \n#>      2nd grad.            18.8 ( 1.1)    47.6 ( 2.4)        \n#>      Other 2nd grad.      15.2 ( 0.9)    52.2 ( 2.6)        \n#>      Post-2nd grad.     1424.7 (79.9)  1559.4 (77.9)\n```\n:::\n\n\n##### Outcome analysis\n\n\n::: {.cell hash='propensityscore2_cache/html/step4d_d186559f5014119c73ef96d2ae921be0'}\n\n```{.r .cell-code}\nfit.design <- svyglm(CVD ~ OA, design = w.design.m, \n       family = binomial(logit))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\npublish(fit.design)\n#>  Variable Units OddsRatio       CI.95  p-value \n#>        OA            0.50 [0.08;3.09]   0.4535\n```\n:::\n\n\n### Matched data with increase ratio\n\nThe matching process is repeated with a different ratio (e.g., 1:5) to explore how changing the ratio affects the covariate balance and treatment effect estimation.\n\n\n::: {.cell hash='propensityscore2_cache/html/ratio_cf7be5e15ab074fcbb60cbdcba2f9f07'}\n\n```{.r .cell-code}\n# Step 1 and 2\nmatching.obj <- matchit(ps.formula,\n                        data = analytic11n,\n                        method = \"nearest\",\n                        ratio = 5,\n                        caliper = 0.2)\n#> Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\n# see how many matched\nmatching.obj\n#> A `matchit` object\n#>  - method: 5:1 nearest neighbor matching without replacement\n#>  - distance: Propensity score [caliper]\n#> \n#>              - estimated with logistic regression\n#>  - caliper: <distance> (0.013)\n#>  - number of obs.: 1424 (original), 349 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu\nOACVD.match <- match.data(matching.obj)\n# Step 3\nby(OACVD.match$distance, OACVD.match$OA, summary)\n#> OACVD.match$OA: 0\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004643 0.039181 0.084421 0.101576 0.146403 0.418206 \n#> ------------------------------------------------------------ \n#> OACVD.match$OA: 1\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.041694 0.095089 0.125262 0.183739 0.424895\ntab1 <- CreateTableOne(strata = \"OA\", data = OACVD.match, \n                       test = FALSE, vars = var.names)\nprint(tab1, smd = TRUE)\n#>                        Stratified by OA\n#>                         0           1          SMD   \n#>   n                     285         64               \n#>   age (%)                                       0.217\n#>      20-29 years         24 ( 8.4)   4 ( 6.2)        \n#>      30-39 years         59 (20.7)  11 (17.2)        \n#>      40-49 years         94 (33.0)  18 (28.1)        \n#>      50-59 years         98 (34.4)  28 (43.8)        \n#>      60-64 years         10 ( 3.5)   3 ( 4.7)        \n#>      65 years and over    0 ( 0.0)   0 ( 0.0)        \n#>      teen                 0 ( 0.0)   0 ( 0.0)        \n#>   sex = Male (%)        132 (46.3)  30 (46.9)   0.011\n#>   stress = stressed (%)  81 (28.4)  18 (28.1)   0.007\n#>   married = single (%)   91 (31.9)  23 (35.9)   0.085\n#>   income (%)                                    0.065\n#>      $29,999 or less     64 (22.5)  13 (20.3)        \n#>      $30,000-$49,999     65 (22.8)  14 (21.9)        \n#>      $50,000-$79,999     51 (17.9)  12 (18.8)        \n#>      $80,000 or more    105 (36.8)  25 (39.1)        \n#>   race = White (%)      169 (59.3)  42 (65.6)   0.131\n#>   bmi (%)                                       0.097\n#>      Underweight          0 ( 0.0)   0 ( 0.0)        \n#>      healthy weight      68 (23.9)  18 (28.1)        \n#>      Overweight         217 (76.1)  46 (71.9)        \n#>   phyact (%)                                    0.136\n#>      Active              57 (20.0)  16 (25.0)        \n#>      Inactive           178 (62.5)  36 (56.2)        \n#>      Moderate            50 (17.5)  12 (18.8)        \n#>   smoke (%)                                     0.097\n#>      Never smoker        46 (16.1)   9 (14.1)        \n#>      Current smoker     123 (43.2)  26 (40.6)        \n#>      Former smoker      116 (40.7)  29 (45.3)        \n#>   doctor = Yes (%)      183 (64.2)  44 (68.8)   0.096\n#>   drink (%)                                     0.051\n#>      Never drank         10 ( 3.5)   2 ( 3.1)        \n#>      Current drinker    212 (74.4)  49 (76.6)        \n#>      Former driker       63 (22.1)  13 (20.3)        \n#>   bp = Yes (%)           22 ( 7.7)   5 ( 7.8)   0.003\n#>   immigrate (%)                                 0.100\n#>      not immigrant      266 (93.3)  58 (90.6)        \n#>      > 10 years          19 ( 6.7)   6 ( 9.4)        \n#>      recent               0 ( 0.0)   0 ( 0.0)        \n#>   fruit (%)                                     0.149\n#>      0-3 daily serving  104 (36.5)  19 (29.7)        \n#>      4-6 daily serving  124 (43.5)  30 (46.9)        \n#>      6+ daily serving    57 (20.0)  15 (23.4)        \n#>   diab = Yes (%)         12 ( 4.2)   3 ( 4.7)   0.023\n#>   edu (%)                                       0.137\n#>      < 2ndary            67 (23.5)  13 (20.3)        \n#>      2nd grad.            9 ( 3.2)   2 ( 3.1)        \n#>      Other 2nd grad.      9 ( 3.2)   1 ( 1.6)        \n#>      Post-2nd grad.     200 (70.2)  48 (75.0)\n```\n:::\n\n\n##### Question for the students\n\n-   Did all of the SMDs decrease?\n\n##### Look at the data\n\n\n::: {.cell hash='propensityscore2_cache/html/summdata_afb2241bedc06c4ad45195384d9f5684'}\n\n```{.r .cell-code}\n# what is weights variable now for 1:5 ratio?\nhead(OACVD.match)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"subclass\"],\"name\":[26],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17846\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.10\",\"24\":\"0.01854076\",\"25\":\"0.890625\",\"26\":\"2\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"6+ daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17847\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"16.90\",\"24\":\"0.05730827\",\"25\":\"0.890625\",\"26\":\"13\",\"_rn_\":\"17847\"},{\"1\":\"event\",\"2\":\"40-49 years\",\"3\":\"Male\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Active\",\"10\":\"No\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17848\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"39.28\",\"24\":\"0.08589902\",\"25\":\"0.890625\",\"26\":\"34\",\"_rn_\":\"17848\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Moderate\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Former smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17852\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.52\",\"24\":\"0.05208657\",\"25\":\"0.890625\",\"26\":\"47\",\"_rn_\":\"17852\"},{\"1\":\"no event\",\"2\":\"50-59 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$29,999 or less\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Never drank\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17863\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"34.98\",\"24\":\"0.09000168\",\"25\":\"0.890625\",\"26\":\"15\",\"_rn_\":\"17863\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17864\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"38.23\",\"24\":\"0.18190027\",\"25\":\"1.000000\",\"26\":\"1\",\"_rn_\":\"17864\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nsummary(OACVD.match$weights)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>  0.8906  0.8906  0.8906  1.0000  0.8906  4.4531\n```\n:::\n\n\n#### Combining matching weights\n\nDifferent approaches to incorporating weights (e.g., matching weights, survey weights) are explored.\n\n#### Not incorporating matching weights\n\n\n::: {.cell hash='propensityscore2_cache/html/ratio1_ea6715171e072cc6ea1cf0fb5d36542c'}\n\n```{.r .cell-code}\nanalytic.miss$matched <- 0\nlength(analytic.miss$ID) # full data\n#> [1] 397173\nlength(OACVD.match$ID) # matched data\n#> [1] 349\nlength(analytic.miss$ID[analytic.miss$ID %in% OACVD.match$ID])\n#> [1] 349\nanalytic.miss$matched[analytic.miss$ID %in% OACVD.match$ID] <- 1\ntable(analytic.miss$matched)\n#> \n#>      0      1 \n#> 396824    349\nw.design0 <- svydesign(id=~1, weights=~survey.weight, \n                      data=analytic.miss)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/ratio2_e8030f199a292269d82d1c113e2ddff8'}\n\n```{.r .cell-code}\nfit.design <- svyglm(CVD ~ OA, design = w.design.m, \n       family = binomial(logit))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\npublish(fit.design)\n#>  Variable Units OddsRatio       CI.95 p-value \n#>        OA            0.80 [0.23;2.80]   0.722\n```\n:::\n\n\n##### Incorporating matching weights\n\n\n::: {.cell hash='propensityscore2_cache/html/ratio3_3eddef4f7b4477a3de7bcc7217ab4b2e'}\n\n```{.r .cell-code}\nanalytic.miss$matched <- 0\nlength(analytic.miss$ID) # full data\n#> [1] 397173\nlength(OACVD.match$ID) # matched data\n#> [1] 349\nlength(analytic.miss$ID[analytic.miss$ID %in% OACVD.match$ID])\n#> [1] 349\nanalytic.miss$matched[analytic.miss$ID %in% OACVD.match$ID] <- 1\ntable(analytic.miss$matched)\n#> \n#>      0      1 \n#> 396824    349\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/ratio4_facea327ec448a0576658b0164855235'}\n\n```{.r .cell-code}\n# multiply with matching (ratio) weights with survey weights\nanalytic.miss$combined.weight <- 0\nanalytic.miss$combined.weight[analytic.miss$ID %in% OACVD.match$ID] <-\n  OACVD.match$weights*OACVD.match$survey.weight\nw.design0 <- svydesign(id=~1, weights=~combined.weight, \n                      data=analytic.miss)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/ratio5_b4ac35b15334b3b98908af15eec90b22'}\n\n```{.r .cell-code}\nfit.design <- svyglm(I(CVD==\"event\") ~ OA, design = w.design.m, \n       family = binomial(logit))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\npublish(fit.design)\n#>  Variable Units OddsRatio       CI.95  p-value \n#>        OA            1.14 [0.32;4.07]   0.8419\n```\n:::\n\n\n#### Matched with replacement\n\nMatching is performed with replacement, allowing control units to be used in more than one match.\n\n\n::: {.cell hash='propensityscore2_cache/html/ratio6_9ee61eb048681d73f0326a517ea73959'}\n\n```{.r .cell-code}\n# Step 1 and 2\nmatching.obj <- matchit(ps.formula,\n                        data = analytic11n,\n                        method = \"nearest\",\n                        ratio = 5,\n                        caliper = 0.2,\n                        replace = TRUE)\n#> Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred\n# see how many matched\nmatching.obj\n#> A `matchit` object\n#>  - method: 5:1 nearest neighbor matching with replacement\n#>  - distance: Propensity score [caliper]\n#> \n#>              - estimated with logistic regression\n#>  - caliper: <distance> (0.013)\n#>  - number of obs.: 1424 (original), 308 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu\nOACVD.match <- match.data(matching.obj)\n# Step 3\nby(OACVD.match$distance, OACVD.match$OA, summary)\n#> OACVD.match$OA: 0\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004643 0.034244 0.067224 0.100845 0.148958 0.418206 \n#> ------------------------------------------------------------ \n#> OACVD.match$OA: 1\n#>     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. \n#> 0.004671 0.042322 0.097877 0.129743 0.189255 0.424895\ntab1 <- CreateTableOne(strata = \"OA\", data = OACVD.match, \n                       test = FALSE, vars = var.names)\nprint(tab1, smd = TRUE)\n#>                        Stratified by OA\n#>                         0           1          SMD   \n#>   n                     243         65               \n#>   age (%)                                       0.266\n#>      20-29 years         22 ( 9.1)   4 ( 6.2)        \n#>      30-39 years         57 (23.5)  11 (16.9)        \n#>      40-49 years         74 (30.5)  18 (27.7)        \n#>      50-59 years         82 (33.7)  29 (44.6)        \n#>      60-64 years          8 ( 3.3)   3 ( 4.6)        \n#>      65 years and over    0 ( 0.0)   0 ( 0.0)        \n#>      teen                 0 ( 0.0)   0 ( 0.0)        \n#>   sex = Male (%)        113 (46.5)  31 (47.7)   0.024\n#>   stress = stressed (%)  67 (27.6)  19 (29.2)   0.037\n#>   married = single (%)   75 (30.9)  23 (35.4)   0.096\n#>   income (%)                                    0.079\n#>      $29,999 or less     53 (21.8)  13 (20.0)        \n#>      $30,000-$49,999     57 (23.5)  14 (21.5)        \n#>      $50,000-$79,999     44 (18.1)  12 (18.5)        \n#>      $80,000 or more     89 (36.6)  26 (40.0)        \n#>   race = White (%)      146 (60.1)  42 (64.6)   0.094\n#>   bmi (%)                                       0.088\n#>      Underweight          0 ( 0.0)   0 ( 0.0)        \n#>      healthy weight      58 (23.9)  18 (27.7)        \n#>      Overweight         185 (76.1)  47 (72.3)        \n#>   phyact (%)                                    0.160\n#>      Active              45 (18.5)  16 (24.6)        \n#>      Inactive           155 (63.8)  37 (56.9)        \n#>      Moderate            43 (17.7)  12 (18.5)        \n#>   smoke (%)                                     0.095\n#>      Never smoker        40 (16.5)   9 (13.8)        \n#>      Current smoker     101 (41.6)  26 (40.0)        \n#>      Former smoker      102 (42.0)  30 (46.2)        \n#>   doctor = Yes (%)      152 (62.6)  45 (69.2)   0.141\n#>   drink (%)                                     0.059\n#>      Never drank          9 ( 3.7)   2 ( 3.1)        \n#>      Current drinker    181 (74.5)  50 (76.9)        \n#>      Former driker       53 (21.8)  13 (20.0)        \n#>   bp = Yes (%)           19 ( 7.8)   5 ( 7.7)   0.005\n#>   immigrate (%)                                 0.115\n#>      not immigrant      228 (93.8)  59 (90.8)        \n#>      > 10 years          15 ( 6.2)   6 ( 9.2)        \n#>      recent               0 ( 0.0)   0 ( 0.0)        \n#>   fruit (%)                                     0.147\n#>      0-3 daily serving   87 (35.8)  19 (29.2)        \n#>      4-6 daily serving  109 (44.9)  31 (47.7)        \n#>      6+ daily serving    47 (19.3)  15 (23.1)        \n#>   diab = Yes (%)         11 ( 4.5)   3 ( 4.6)   0.004\n#>   edu (%)                                       0.175\n#>      < 2ndary            58 (23.9)  13 (20.0)        \n#>      2nd grad.            8 ( 3.3)   2 ( 3.1)        \n#>      Other 2nd grad.      9 ( 3.7)   1 ( 1.5)        \n#>      Post-2nd grad.     168 (69.1)  49 (75.4)\n```\n:::\n\n\n#### Question for the students\n\n-   Did all of the SMDs decrease?\n\n#### Look at the data\n\n\n::: {.cell hash='propensityscore2_cache/html/ratio7_f975ecc06e768472da8459f3b4aa063c'}\n\n```{.r .cell-code}\n# what is weights variable now for 1:5 ratio?\nhead(OACVD.match)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"CVD\"],\"name\":[1],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"age\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"sex\"],\"name\":[3],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"married\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"race\"],\"name\":[5],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"edu\"],\"name\":[6],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"income\"],\"name\":[7],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bmi\"],\"name\":[8],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"phyact\"],\"name\":[9],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"doctor\"],\"name\":[10],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"stress\"],\"name\":[11],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"smoke\"],\"name\":[12],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"drink\"],\"name\":[13],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"fruit\"],\"name\":[14],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"bp\"],\"name\":[15],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"diab\"],\"name\":[16],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"province\"],\"name\":[17],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"cycle\"],\"name\":[18],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"ID\"],\"name\":[19],\"type\":[\"int\"],\"align\":[\"right\"]},{\"label\":[\"OA\"],\"name\":[20],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"immigrate\"],\"name\":[21],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"miss\"],\"name\":[22],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"survey.weight\"],\"name\":[23],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"distance\"],\"name\":[24],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"weights\"],\"name\":[25],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Never smoker\",\"13\":\"Current drinker\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17846\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.10\",\"24\":\"0.01854076\",\"25\":\"0.7476923\",\"_rn_\":\"17846\"},{\"1\":\"no event\",\"2\":\"30-39 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"6+ daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17847\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"16.90\",\"24\":\"0.05730827\",\"25\":\"0.7476923\",\"_rn_\":\"17847\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Male\",\"4\":\"single\",\"5\":\"White\",\"6\":\"Post-2nd grad.\",\"7\":\"$50,000-$79,999\",\"8\":\"Overweight\",\"9\":\"Moderate\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Former smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17852\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"12.52\",\"24\":\"0.05208657\",\"25\":\"1.4953846\",\"_rn_\":\"17852\"},{\"1\":\"no event\",\"2\":\"50-59 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$29,999 or less\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"No\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Never drank\",\"14\":\"0-3 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17863\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"34.98\",\"24\":\"0.09000168\",\"25\":\"0.7476923\",\"_rn_\":\"17863\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"stressed\",\"12\":\"Current smoker\",\"13\":\"Current drinker\",\"14\":\"4-6 daily serving\",\"15\":\"No\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17864\",\"20\":\"1\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"38.23\",\"24\":\"0.18190027\",\"25\":\"1.0000000\",\"_rn_\":\"17864\"},{\"1\":\"no event\",\"2\":\"40-49 years\",\"3\":\"Female\",\"4\":\"not single\",\"5\":\"Non-white\",\"6\":\"< 2ndary\",\"7\":\"$30,000-$49,999\",\"8\":\"Overweight\",\"9\":\"Inactive\",\"10\":\"Yes\",\"11\":\"Not too stressed\",\"12\":\"Current smoker\",\"13\":\"Former driker\",\"14\":\"0-3 daily serving\",\"15\":\"Yes\",\"16\":\"No\",\"17\":\"North\",\"18\":\"11\",\"19\":\"17904\",\"20\":\"0\",\"21\":\"not immigrant\",\"22\":\"0\",\"23\":\"52.04\",\"24\":\"0.06783228\",\"25\":\"0.7476923\",\"_rn_\":\"17904\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nsummary(OACVD.match$weights)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>  0.7477  0.7477  0.7477  1.0000  1.0000  7.4769\n```\n:::\n\n\n#### Survey design\n\nThe matched data is converted into a survey design object, and the treatment effect is estimated while accounting for the complex survey design.\n\n\n::: {.cell hash='propensityscore2_cache/html/new0_0b90c496b8cd99a607a3516a287c00c3'}\n\n```{.r .cell-code}\nanalytic.miss$matched <- 0\nlength(analytic.miss$ID) # full data\n#> [1] 397173\nlength(OACVD.match$ID) # matched data\n#> [1] 308\nlength(analytic.miss$ID[analytic.miss$ID %in% OACVD.match$ID])\n#> [1] 308\nanalytic.miss$matched[analytic.miss$ID %in% OACVD.match$ID] <- 1\ntable(analytic.miss$matched)\n#> \n#>      0      1 \n#> 396865    308\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/new1_76028790418d404059c37892c1389dc6'}\n\n```{.r .cell-code}\n# multiply with matching (ratio) weights with survey weights\nanalytic.miss$combined.weight <- 0\nanalytic.miss$combined.weight[analytic.miss$ID %in% OACVD.match$ID] <-\n  OACVD.match$weights*OACVD.match$survey.weight\nw.design0 <- svydesign(id=~1, weights=~combined.weight, \n                      data=analytic.miss)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore2_cache/html/new2_4c22467151b1c03ef2cddce1c6ed0de3'}\n\n```{.r .cell-code}\nfit.design <- svyglm(I(CVD==\"event\") ~ OA, design = w.design.m, \n       family = binomial(logit))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\npublish(fit.design)\n#>  Variable Units OddsRatio       CI.95  p-value \n#>        OA            0.99 [0.26;3.72]   0.9909\n```\n:::\n\n\n### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/ONaKFZCTRfw\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}