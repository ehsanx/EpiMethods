{
  "hash": "9590667b846fee338d3c275d02623b19",
  "result": {
    "engine": "knitr",
    "markdown": "## Mediation Software {.unnumbered}\n\n\n\nIn this tutorial we:\n\n1. Walk through the weighting based mediation mechanism step by step (Steps 0 to 4).\n2. Implement the manual inverse probability weighting (IPW) approach.\n3. Fit a causal mediation model with the `regmedint` package on the same data.\n4. Compare \n  - natural direct effect (NDE), \n  - natural indirect effect (NIE), \n  - total effect (TE), and \n  - proportion mediated (PM) from the two approaches.\n\n::: callout-tip\nTo focus on mediation ideas, we **ignore the complex survey design and sampling weights** here.  \nIn a real analysis, at least the outcome model should incorporate survey features (strata, cluster, weights).\n:::\n\n---\n\n### Overall Steps\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/ssteps.png){width=100%}\n:::\n:::\n\n\n---\n\n### 1. Load data and Step 0: build analysis dataset\n\nStep 0 in the [slides](mediation0.html):  \n> Include Y, A, M in the data and necessary C.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/s0.png){width=100%}\n:::\n:::\n\n\nHere\n\n- A = osteoarthritis (OA) indicator (1 = OA, 0 = non OA)\n- M = pain medication indicator\n- Y = CVD indicator\n- C = age, sex, BMI, SES and comorbidities\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load the CCHS based dataset\nload(\"Data/mediation/cchs123pain.RData\")\n\n# Create 0/1 numeric variables for the mediation analysis\nanalytic.miss$mediator <- ifelse(analytic.miss$painmed == \"Yes\", 1, 0)   \n# pain medication (M)\nanalytic.miss$exposure <- ifelse(analytic.miss$OA == \"OA\", 1, 0)         \n# osteoarthritis (A)\nanalytic.miss$outcome  <- ifelse(analytic.miss$CVD == \"event\", 1, 0)     \n# CVD (Y)\n\n# List of baseline covariates (C)\nvarlist <- c(\"age\", \"sex\", \"income\", \"race\", \"bmi\", \"edu\",\n             \"phyact\", \"smoke\", \"fruit\", \"diab\")\n\n# Restrict to complete cases\nanalysis_data <- subset(analytic.miss, miss == 0)\n\nnrow(analysis_data)\n#> [1] 28734\n```\n:::\n\n\nShort interpretation:\n\n- We have a complete case dataset with binary exposure, mediator and outcome.\n- The covariates C will be adjusted for in both the mediator model and the outcome model.\n\n---\n\n### 2. Step 1: create auxiliary exposure A* = A (facts)\n\nStep 1 in the [slides](mediation0.html):  \n> Replicate exposure A with same exposures A* (\"facts\").\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/s1.png){width=100%}\n:::\n:::\n\n\nWe create `exposureTemp` as the exposure used in the mediator model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# This corresponds to A* = A for all rows when we fit the mediator model\nanalysis_data$exposureTemp <- analysis_data$exposure\n```\n:::\n\n\n---\n\n### 3. Step 2: duplicate data with alternative A* (alternative facts)\n\nStep 2 in the [slides](mediation0.html):  \n> Replicate exposure A with alternative exposures A* (\"alternative facts\").\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/s2.png){width=100%}\n:::\n:::\n\n\nWe create two copies of each subject:\n\n- One with A* equal to the observed exposure (factual row).\n- One with A* equal to the opposite exposure (counterfactual row).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd1 <- d2 <- analysis_data\n\n# Factual copy: A* = A\nd1$exposure.counterfactual <- d1$exposure\n\n# Counterfactual copy: A* = 1 - A\nd2$exposure.counterfactual <- 1 - d2$exposure\n\n# Stack rows to form an expanded dataset\nnewd <- rbind(d1, d2)\n\nnrow(analysis_data); nrow(newd)\n#> [1] 28734\n#> [1] 57468\n```\n:::\n\n\nInterpretation:\n\n- Each person now appears twice, once with their observed exposure and once with the opposite exposure encoded in `exposure.counterfactual`.\n- We keep the observed Y and M in both rows for now.\n\n---\n\n### 4. Step 3b: weighting via the mediator model\n\nStep 3, weighting branch (Step 3b in the [slides](mediation0.html)):\n\n1. Fit the mediator model M ~ A + C on the original data.\n2. Use that model to predict P(M | A, C) and P(M | A*, C) in the expanded data.\n3. Construct the mediator weight W^M = P(M | A*, C) / P(M | A, C).\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/s3b.png){width=100%}\n:::\n:::\n\n\nWe **ignore survey weights** here to keep the focus on the mediation mechanism.  \n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Build mediator model formula: M ~ A + C\ncovariates_formula <- paste(varlist, collapse = \" + \")\nmediator_formula_str <- paste(\"mediator ~ exposureTemp +\", covariates_formula)\nmediator_formula <- as.formula(mediator_formula_str)\n\n# Fit mediator model on complete cases\nfit_mediator <- glm(mediator_formula,\n                    data   = analysis_data,\n                    family = binomial)\n\nsummary(fit_mediator)$coefficients[\"exposureTemp\", ]\n#>     Estimate   Std. Error      z value     Pr(>|z|) \n#> 9.157724e-01 5.383572e-02 1.701050e+01 6.864990e-65\n```\n:::\n\n\nInterpretation:\n\n- The coefficient of `exposureTemp` is the log odds ratio for OA compared with non OA on pain medication use, adjusting for C.\n- A positive and significant coefficient indicates the A to M path is present in the data.\n\nNow compute the mediator weights for each row in the expanded dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 3b: compute P(M | A, C)\nnewd$exposureTemp <- newd$exposure\np_M_given_A <- predict(fit_mediator, newdata = newd, type = \"response\")\nprob_M_given_A <- ifelse(newd$mediator == 1, p_M_given_A, 1 - p_M_given_A)\n\n# Step 3b: compute P(M | A*, C)\nnewd$exposureTemp <- newd$exposure.counterfactual\np_M_given_Astar <- predict(fit_mediator, newdata = newd, type = \"response\")\nprob_M_given_Astar <- ifelse(newd$mediator == 1, p_M_given_Astar, 1 - p_M_given_Astar)\n\n# Mediator weights W^M = P(M | A*, C) / P(M | A, C)\nnewd$W.mediator <- prob_M_given_Astar / prob_M_given_A\n\nsummary(newd$W.mediator)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>  0.4339  1.0000  1.0000  1.0001  1.1404  2.2960\n```\n:::\n\n\nInterpretation:\n\n- If the mediator is more compatible with the counterfactual exposure than with the observed exposure, W.mediator > 1.\n- These weights reconstruct the counterfactual mediator distribution we need to identify natural direct and indirect effects.\n\n---\n\n### 5. Step 4b: weighted outcome model\n\nStep 4, weighting branch (Step 4b in the [slides](mediation0.html)):\n\n> Fit outcome model Y ~ A + A* + C using the mediator weights as model weights.  \n> The coefficient of A is the natural direct effect, and the coefficient of A* is the natural indirect effect.\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/s4b.png){width=100%}\n:::\n:::\n\n\nWe fit\n\nlogit P(Y = 1 | A, A*, C) = theta0 + theta1 A + theta2 A* + theta3 C\n\nwith weights W.mediator.\n\n\n::: {.cell}\n\n```{.r .cell-code}\noutcome_formula_str <- paste(\"outcome ~ exposure + exposure.counterfactual +\",\n                             covariates_formula)\noutcome_formula <- as.formula(outcome_formula_str)\n\nfit_outcome <- glm(outcome_formula,\n                   data   = newd,\n                   family = binomial,\n                   weights = W.mediator)\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n\nsummary(fit_outcome)$coefficients[c(\"exposure\", \"exposure.counterfactual\"), ]\n#>                           Estimate Std. Error  z value     Pr(>|z|)\n#> exposure                0.38200076 0.05074033 7.528543 5.130973e-14\n#> exposure.counterfactual 0.07460393 0.04211051 1.771623 7.645719e-02\n```\n:::\n\n\nInterpretation:\n\n- `exposure` coefficient (theta1) represents the natural direct effect on the log odds ratio scale, holding the mediator path fixed.\n- `exposure.counterfactual` coefficient (theta2) represents the natural indirect effect on the log odds ratio scale, comparing mediator paths while holding exposure fixed.\n\n---\n\n### 6. Natural effects and proportion mediated from the manual model\n\nFrom the fitted coefficients:\n\n- NDE log OR = coefficient of `exposure`\n- NIE log OR = coefficient of `exposure.counterfactual`\n- TE log OR  = NDE log OR + NIE log OR\n- PM = NIE log OR / TE log OR\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/spm.png){width=100%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncoefs <- summary(fit_outcome)$coefficients\n\nnde_log_or <- coefs[\"exposure\", \"Estimate\"]\nnie_log_or <- coefs[\"exposure.counterfactual\", \"Estimate\"]\n\nnde_or <- exp(nde_log_or)\nnie_or <- exp(nie_log_or)\nte_or  <- exp(nde_log_or + nie_log_or)\n\npm_manual <- nie_log_or / (nde_log_or + nie_log_or)\n\nmanual_results <- data.frame(\n  Method = \"Manual IPW (weights, no survey design)\",\n  TE  = te_or,\n  NDE = nde_or,\n  NIE = nie_or,\n  PM  = pm_manual\n)\n\nmanual_results\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"Method\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"TE\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NDE\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"NIE\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"PM\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"Manual IPW (weights, no survey design)\",\"2\":\"1.578705\",\"3\":\"1.465213\",\"4\":\"1.077457\",\"5\":\"0.1633885\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\nShort interpretation:\n\n- TE is the total effect of OA on CVD combining direct and mediated paths.\n- NDE is the effect of OA on CVD not operating through pain medication.\n- NIE is the effect of OA on CVD that is transmitted through pain medication.\n- PM is the proportion of the log odds ratio that is mediated via pain medication.\n\n---\n\n### 7. regmedint: software based mediation\n\nOne useful package is `regmedint`, which implements counterfactual mediation estimands such as NDE, NIE, and TE for generalized linear models.\n\nHere we fit a `regmedint` model using the same exposure, mediator, outcome and covariates, again ignoring the survey design to keep the comparison simple.\n\n#### 7.1 Numeric covariates and covariate profile\n\n`regmedint` expects numeric covariates and a numeric vector `c_cond` that defines the covariate profile at which effects are evaluated.\n\nWe recode factors to numeric codes and set `c_cond` equal to the mean of each numeric covariate.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanalysis_data$age_num <- as.numeric(analysis_data$age)\nanalysis_data$sex_num <- as.numeric(analysis_data$sex)\nanalysis_data$income_num <- as.numeric(analysis_data$income)\nanalysis_data$race_num <- as.numeric(analysis_data$race)\nanalysis_data$bmi_num <- as.numeric(analysis_data$bmi)\nanalysis_data$edu_num <- as.numeric(analysis_data$edu)\nanalysis_data$phyact_num <- as.numeric(analysis_data$phyact)\nanalysis_data$smoke_num <- as.numeric(analysis_data$smoke)\nanalysis_data$fruit_num <- as.numeric(analysis_data$fruit)\nanalysis_data$diab_num <- as.numeric(analysis_data$diab)\n\ncvar_num <- c(\"age_num\",\"sex_num\",\"income_num\",\"race_num\",\"bmi_num\",\n\"edu_num\",\"phyact_num\",\"smoke_num\",\"fruit_num\",\"diab_num\")\n\nc_cond_vec <- colMeans(analysis_data[, cvar_num])\nc_cond_vec\n#>    age_num    sex_num income_num   race_num    bmi_num    edu_num phyact_num \n#>   3.049976   1.481868   2.584708   1.884701   2.489037   3.031565   1.996485 \n#>  smoke_num  fruit_num   diab_num \n#>   2.123303   1.973063   1.043085\nm_cde_vec <- 0\na0_vec <- 0\na1_vec <- 1 \n```\n:::\n\n\n---\n\n#### 7.2 Fit regmedint model\n\nWe specify:\n\n- logistic regression for Y given A, M and C\n- logistic regression for M given A and C\n- no exposure by mediator interaction\n- a0 = 0 and a1 = 1 for the exposure contrast\n- mediator fixed at 0 for the controlled direct effect value\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfit_reg <- regmedint(\n  data   = analysis_data,\n  yvar   = \"outcome\",\n  avar   = \"exposure\",\n  mvar   = \"mediator\",\n  cvar   = cvar_num,\n  yreg   = \"logistic\",\n  mreg   = \"logistic\",\n  interaction = FALSE,\n  a0 = a0_vec,\n  a1 = a1_vec,\n  m_cde = m_cde_vec,\n  c_cond = c_cond_vec\n)\n\nsummary(fit_reg)\n#> ### Mediator model\n#> \n#> Call:\n#> glm(formula = mediator ~ exposure + age_num + sex_num + income_num + \n#>     race_num + bmi_num + edu_num + phyact_num + smoke_num + fruit_num + \n#>     diab_num, family = binomial(link = \"logit\"), data = data)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept)  0.12698    0.13687   0.928 0.353553    \n#> exposure     0.90432    0.05359  16.875  < 2e-16 ***\n#> age_num     -0.14602    0.00984 -14.840  < 2e-16 ***\n#> sex_num     -0.67976    0.02829 -24.026  < 2e-16 ***\n#> income_num   0.06704    0.01276   5.253 1.49e-07 ***\n#> race_num     0.58025    0.03987  14.555  < 2e-16 ***\n#> bmi_num      0.17380    0.02547   6.825 8.80e-12 ***\n#> edu_num      0.03432    0.01184   2.898 0.003761 ** \n#> phyact_num   0.06642    0.01855   3.580 0.000343 ***\n#> smoke_num    0.12872    0.01617   7.960 1.73e-15 ***\n#> fruit_num   -0.09609    0.01940  -4.952 7.35e-07 ***\n#> diab_num     0.15272    0.06827   2.237 0.025284 *  \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 34585  on 28733  degrees of freedom\n#> Residual deviance: 33109  on 28722  degrees of freedom\n#> AIC: 33133\n#> \n#> Number of Fisher Scoring iterations: 4\n#> \n#> ### Outcome model\n#> \n#> Call:\n#> glm(formula = outcome ~ exposure + mediator + age_num + sex_num + \n#>     income_num + race_num + bmi_num + edu_num + phyact_num + \n#>     smoke_num + fruit_num + diab_num, family = binomial(link = \"logit\"), \n#>     data = data)\n#> \n#> Coefficients:\n#>             Estimate Std. Error z value Pr(>|z|)    \n#> (Intercept) -7.93326    0.35098 -22.603  < 2e-16 ***\n#> exposure     0.36176    0.07276   4.972 6.63e-07 ***\n#> mediator     0.51453    0.07353   6.998 2.61e-12 ***\n#> age_num      0.68044    0.02435  27.943  < 2e-16 ***\n#> sex_num      0.35919    0.06516   5.512 3.55e-08 ***\n#> income_num  -0.19520    0.03140  -6.217 5.07e-10 ***\n#> race_num     0.25498    0.12257   2.080  0.03749 *  \n#> bmi_num      0.08491    0.05898   1.440  0.14997    \n#> edu_num     -0.07793    0.02472  -3.153  0.00162 ** \n#> phyact_num   0.04941    0.04272   1.157  0.24742    \n#> smoke_num    0.11605    0.03708   3.129  0.00175 ** \n#> fruit_num    0.04256    0.04512   0.943  0.34549    \n#> diab_num     0.72406    0.09020   8.027 9.97e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> (Dispersion parameter for binomial family taken to be 1)\n#> \n#>     Null deviance: 10460.7  on 28733  degrees of freedom\n#> Residual deviance:  8527.2  on 28721  degrees of freedom\n#> AIC: 8553.2\n#> \n#> Number of Fisher Scoring iterations: 7\n#> \n#> ### Mediation analysis \n#>             est          se        Z            p      lower     upper\n#> cde  0.36175669 0.072758891 4.971993 6.626815e-07 0.21915188 0.5043615\n#> pnde 0.36175669 0.072758891 4.971993 6.626815e-07 0.21915188 0.5043615\n#> tnie 0.06702148 0.008626136 7.769584 7.771561e-15 0.05011457 0.0839284\n#> tnde 0.36175669 0.072758891 4.971993 6.626815e-07 0.21915188 0.5043615\n#> pnie 0.06702148 0.008626136 7.769584 7.771561e-15 0.05011457 0.0839284\n#> te   0.42877817 0.072048448 5.951248 2.661058e-09 0.28756581 0.5699905\n#> pm   0.18590681 0.034462107 5.394528 6.870383e-08 0.11836232 0.2534513\n#> \n#> Evaluated at:\n#> avar: exposure\n#>  a1 (intervened value of avar) = 1\n#>  a0 (reference value of avar)  = 0\n#> mvar: mediator\n#>  m_cde (intervend value of mvar for cde) = 0\n#> cvar: age_num sex_num income_num race_num bmi_num edu_num phyact_num smoke_num fruit_num diab_num\n#>  c_cond (covariate vector value) = 3.049976 1.481868 2.584708 1.884701 2.489037 3.031565 1.996485 2.123303 1.973063 1.043085\n#> \n#> Note that effect estimates do not vary over m_cde and c_cond values when interaction = FALSE.\n```\n:::\n\n\nFrom the summary table we extract:\n\n- tnde (total natural direct effect) on the log scale\n- tnie (total natural indirect effect) on the log scale\n- te (total effect) on the log scale\n- pm (proportion mediated) as a proportion on the log odds ratio scale\n\n#### 7.3 How `regmedint` computes standard errors\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/mediation/sse.png){width=100%}\n:::\n:::\n\n\n\n`regmedint` does **not** use bootstrap resampling by default. The package computes all standard errors through the **multivariate delta method** based on the estimated covariance matrix of the outcome and mediator models.\n\nAfter fitting the outcome model (`yreg`) and mediator model (`mreg`), the package forms a joint parameter vector $\\theta = (\\beta, \\gamma)$ and obtains its covariance matrix $\\widehat{\\Sigma} = \\operatorname{Var}(\\theta)$ from the fitted GLMs (these are model-based SEs, not survey-robust).\n\nEach natural effect, such as the total natural direct effect (tnde), total natural indirect effect (tnie), total effect (te), and proportion mediated (pm), is a smooth function of all components of \\(\\theta\\).  \n`regmedint` computes their gradients internally and applies $\\operatorname{se}(\\psi) \\;=\\; \\sqrt{ G^\\top \\,\\widehat{\\Sigma}\\, G }$ where $G$ is the gradient of the effect $\\psi$ with respect to all parameters. This is implemented directly inside `se_fun()`, which evaluate the deltaâ€“method variance for each estimand.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nest <- fit_reg$myreg$est_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)\nse <- fit_reg$myreg$se_fun(a0_vec, a1_vec, m_cde_vec, c_cond_vec)\n\nreg_raw <- data.frame(\n  effect = names(est),\n  est = as.numeric(est),\n  se = as.numeric(se)\n)\n\nreg_raw$lower <- reg_raw$est - 1.96 * reg_raw$se\nreg_raw$upper <- reg_raw$est + 1.96 * reg_raw$se\n\nreg_or <- subset(reg_raw, effect %in% c(\"te\",\"tnde\",\"tnie\"))\nreg_or$OR <- exp(reg_or$est)\nreg_or$OR_L <- exp(reg_or$lower)\nreg_or$OR_U <- exp(reg_or$upper)\n\nreg_or\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"effect\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"est\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"se\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"lower\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"upper\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"OR\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"OR_L\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"OR_U\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"tnie\",\"2\":\"0.06702148\",\"3\":\"0.008626136\",\"4\":\"0.05011426\",\"5\":\"0.08392871\",\"6\":\"1.069318\",\"7\":\"1.051391\",\"8\":\"1.087551\",\"_rn_\":\"3\"},{\"1\":\"tnde\",\"2\":\"0.36175669\",\"3\":\"0.072758891\",\"4\":\"0.21914926\",\"5\":\"0.50436411\",\"6\":\"1.435850\",\"7\":\"1.245017\",\"8\":\"1.655932\",\"_rn_\":\"4\"},{\"1\":\"te\",\"2\":\"0.42877817\",\"3\":\"0.072048448\",\"4\":\"0.28756321\",\"5\":\"0.56999313\",\"6\":\"1.535380\",\"7\":\"1.333175\",\"8\":\"1.768255\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\n\n# Extract ORs from regmedint output already computed as reg_or\ntnde_or_reg <- reg_or$OR[reg_or$effect == \"tnde\"]\ntnie_or_reg <- reg_or$OR[reg_or$effect == \"tnie\"]\nte_or_reg   <- reg_or$OR[reg_or$effect == \"te\"]\npm_reg      <- est[\"pm\"]\n\n# Combine into regmedint row\nregmedint_results <- data.frame(\n  Method = \"regmedint (no survey design)\",\n  TE  = te_or_reg,\n  NDE = tnde_or_reg,\n  NIE = tnie_or_reg,\n  PM  = pm_reg\n)\n```\n:::\n\n\nInterpretation:\n\n- `regmedint` uses parametric standardisation based on the fitted outcome and mediator models.\n- Effects are evaluated at the mean covariate profile `c_cond_vec`, not over the full covariate distribution, but this is close enough for comparison with the IPW based approach.\n\n---\n\n### 8. Comparison table and brief interpretation\n\n#### 8.1 Combine and display results\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Build tidy table from manual + regmedint\n\n# 1. Expand manual results into long form with NA SE/CI\nmanual_long <- data.frame(\n  Method = \"Manual IPW (weights, no survey design)\",\n  Effect = c(\"TE\", \"NDE\", \"NIE\", \"PM\"),\n  est    = c(manual_results$TE,\n             manual_results$NDE,\n             manual_results$NIE,\n             manual_results$PM),\n  se     = NA,\n  lower  = NA,\n  upper  = NA\n)\n\n# 2. Extract regmedint effects with SE and CI\nreg_long <- rbind(\n  data.frame(Method = \"regmedint (no survey design)\",\n             Effect = \"TE\",\n             est    = reg_or$OR[reg_or$effect == \"te\"],\n             se     = reg_or$se[reg_or$effect == \"te\"],\n             lower  = reg_or$OR_L[reg_or$effect == \"te\"],\n             upper  = reg_or$OR_U[reg_or$effect == \"te\"]),\n  data.frame(Method = \"regmedint (no survey design)\",\n             Effect = \"NDE\",\n             est    = reg_or$OR[reg_or$effect == \"tnde\"],\n             se     = reg_or$se[reg_or$effect == \"tnde\"],\n             lower  = reg_or$OR_L[reg_or$effect == \"tnde\"],\n             upper  = reg_or$OR_U[reg_or$effect == \"tnde\"]),\n  data.frame(Method = \"regmedint (no survey design)\",\n             Effect = \"NIE\",\n             est    = reg_or$OR[reg_or$effect == \"tnie\"],\n             se     = reg_or$se[reg_or$effect == \"tnie\"],\n             lower  = reg_or$OR_L[reg_or$effect == \"tnie\"],\n             upper  = reg_or$OR_U[reg_or$effect == \"tnie\"]),\n  data.frame(Method = \"regmedint (no survey design)\",\n             Effect = \"PM\",\n             est    = est[\"pm\"],\n             se     = se[\"se_pm\"],\n             lower  = est[\"pm\"] - 1.96 * se[\"se_pm\"],\n             upper  = est[\"pm\"] + 1.96 * se[\"se_pm\"])\n)\n\n# 3. Combine\ncompare_full <- rbind(manual_long, reg_long)\nrownames(compare_full) <- NULL\n\n# 4. Pretty table\nlibrary(kableExtra)\nkable(compare_full, digits = 2,\n      caption = \"Comparison of natural effects with standard errors and confidence intervals\") %>%\n  kable_styling(full_width = FALSE,\n                bootstrap_options = c(\"striped\", \"condensed\"))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<caption>Comparison of natural effects with standard errors and confidence intervals</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:left;\"> Method </th>\n   <th style=\"text-align:left;\"> Effect </th>\n   <th style=\"text-align:right;\"> est </th>\n   <th style=\"text-align:right;\"> se </th>\n   <th style=\"text-align:right;\"> lower </th>\n   <th style=\"text-align:right;\"> upper </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Manual IPW (weights, no survey design) </td>\n   <td style=\"text-align:left;\"> TE </td>\n   <td style=\"text-align:right;\"> 1.58 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Manual IPW (weights, no survey design) </td>\n   <td style=\"text-align:left;\"> NDE </td>\n   <td style=\"text-align:right;\"> 1.47 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Manual IPW (weights, no survey design) </td>\n   <td style=\"text-align:left;\"> NIE </td>\n   <td style=\"text-align:right;\"> 1.08 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Manual IPW (weights, no survey design) </td>\n   <td style=\"text-align:left;\"> PM </td>\n   <td style=\"text-align:right;\"> 0.16 </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n   <td style=\"text-align:right;\"> NA </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> regmedint (no survey design) </td>\n   <td style=\"text-align:left;\"> TE </td>\n   <td style=\"text-align:right;\"> 1.54 </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n   <td style=\"text-align:right;\"> 1.33 </td>\n   <td style=\"text-align:right;\"> 1.77 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> regmedint (no survey design) </td>\n   <td style=\"text-align:left;\"> NDE </td>\n   <td style=\"text-align:right;\"> 1.44 </td>\n   <td style=\"text-align:right;\"> 0.07 </td>\n   <td style=\"text-align:right;\"> 1.25 </td>\n   <td style=\"text-align:right;\"> 1.66 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> regmedint (no survey design) </td>\n   <td style=\"text-align:left;\"> NIE </td>\n   <td style=\"text-align:right;\"> 1.07 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n   <td style=\"text-align:right;\"> 1.05 </td>\n   <td style=\"text-align:right;\"> 1.09 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> regmedint (no survey design) </td>\n   <td style=\"text-align:left;\"> PM </td>\n   <td style=\"text-align:right;\"> 0.19 </td>\n   <td style=\"text-align:right;\"> 0.03 </td>\n   <td style=\"text-align:right;\"> 0.12 </td>\n   <td style=\"text-align:right;\"> 0.25 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n#### 8.2 Plot results\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](mediation4_files/figure-html/compare-plot-1.png){width=672}\n:::\n:::\n\n\n#### 8.3 Interpretation\n\n- Both approaches agree that osteoarthritis is associated with increased odds of CVD, with a total effect odds ratio around 1.5 to 1.6.\n- The natural direct effect is larger than the natural indirect effect in both approaches, indicating that most of the effect is not mediated by pain medication.\n- The natural indirect effect is modest but greater than one in both approaches, suggesting that some of the OA to CVD association is transmitted through pain medication.\n- The proportion mediated on the log odds ratio scale is of similar magnitude across methods (roughly 15 to 20 percent).\n\nSome differences between the manual and `regmedint` estimates are expected. \n\n- The manual calculation relies on an IPW-based decomposition using fitted models that approximate counterfactual contrasts, while `regmedint` uses fully parametric standardization, integrating over the outcome and mediator models at the chosen covariate profile. \n- IPW and parametric g-formula methods target the same estimands but use different estimating equations and weighting structures, so their results will not match exactly unless models are perfectly specified. \n- `regmedint` evaluates effects at the mean covariate vector rather than averaging over the full empirical covariate distribution, which can introduce small discrepancies compared with the manual implementation.\n\n::: callout-tip\nBecause we intentionally ignore survey design features in both implementations, these results are meant primarily to illustrate the mediation mechanisms and the comparability between a manual implementation and a software package. For final substantive inference, survey design and sampling weights should be incorporated as described in the lecture notes.\n::: \n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}