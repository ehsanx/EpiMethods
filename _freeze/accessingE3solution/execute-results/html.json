{
  "hash": "9057438fb0bd019d64b019bfc4695914",
  "result": {
    "markdown": "## Exercise 3 Solution (A) {.unnumbered}\n\n\n\n\n\n### **Exercise: Phased Multi-Year NHANES Data Wrangling**\n\n**Instructions:** Use the R programming language and functions from the `tidyverse`, `nhanesA`, `tableone`, and `naniar` packages to complete this exercise. We will build up our dataset in phases, starting with a single year and expanding to multiple survey cycles.\n\nPlease knit your final R Markdown file and submit the knitted HTML or PDF document ONLY.\n\n------------------------------------------------------------------------\n\n#### **Setup: Load Packages**\n\nFirst, run the following code block to ensure the required packages are installed and loaded into your R session.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Load required packages\nif (!require(\"pacman\")) install.packages(\"pacman\")\npacman::p_load(tidyverse, nhanesA, tableone, naniar)\n```\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 1: Import and Translate Single-Year Data**\n\nDownload the **Demographic (`DEMO`)** data for the 2013-2014 NHANES cycle, using `translated = TRUE` to automatically convert coded values into text labels.\n\n\n::: {.cell hash='accessingE3solution_cache/html/import-demo-single_871be8072f3a83588c711a5976bf1a1b'}\n\n```{.r .cell-code}\n# Download and translate the 2013-2014 demographic data\nnhanes_demo_1314 <- nhanes(\"DEMO_H\", translated = TRUE)\n# Check the first few rows to see the translated values\nhead(nhanes_demo_1314[, c(\"SEQN\", \"RIAGENDR\", \"RIDAGEYR\", \"RIDRETH3\")])\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"SEQN\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"RIAGENDR\"],\"name\":[2],\"type\":[\"fct\"],\"align\":[\"left\"]},{\"label\":[\"RIDAGEYR\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"RIDRETH3\"],\"name\":[4],\"type\":[\"fct\"],\"align\":[\"left\"]}],\"data\":[{\"1\":\"73557\",\"2\":\"Male\",\"3\":\"69\",\"4\":\"Non-Hispanic Black\",\"_rn_\":\"1\"},{\"1\":\"73558\",\"2\":\"Male\",\"3\":\"54\",\"4\":\"Non-Hispanic White\",\"_rn_\":\"2\"},{\"1\":\"73559\",\"2\":\"Male\",\"3\":\"72\",\"4\":\"Non-Hispanic White\",\"_rn_\":\"3\"},{\"1\":\"73560\",\"2\":\"Male\",\"3\":\"9\",\"4\":\"Non-Hispanic White\",\"_rn_\":\"4\"},{\"1\":\"73561\",\"2\":\"Female\",\"3\":\"73\",\"4\":\"Non-Hispanic White\",\"_rn_\":\"5\"},{\"1\":\"73562\",\"2\":\"Male\",\"3\":\"56\",\"4\":\"Mexican American\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 2: Add Body Measures Data for a Single Year**\n\nDownload the **Body Measures (`BMX`)** data for the same 2013-2014 cycle and merge it with the demographic data from Problem 1.\n\n\n::: {.cell hash='accessingE3solution_cache/html/import-bmx-single_12d568cb1521c5cdf433eaa4cb43eaea'}\n\n```{.r .cell-code}\n# Download the 2013-2014 body measures data\nnhanes_bmx_1314 <- nhanes(\"BMX_H\", translated = TRUE)\n# Merge the BMX data with the DEMO data from Problem 1\nnhanes_1314_complete <- full_join(nhanes_demo_1314, nhanes_bmx_1314, by = \"SEQN\")\n# Check the dimensions of the merged dataset\ndim(nhanes_1314_complete)\n#> [1] 10175    72\n```\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 3: Import and Merge Multi-Cycle Data with Translation**\n\nExpand to multiple years, using `translated = TRUE` for all downloads. Merge both the **Demographic (`DEMO`)** and **Body Measures (`BMX`)** data for all three NHANES cycles: 2013-2014 (`H`), 2015-2016 (`I`), and 2017-2018 (`J`). Combine them into a single dataframe named `nhanes_raw`.\n\n\n::: {.cell hash='accessingE3solution_cache/html/import-data-multi_f4fe001336d3b4994f3a2dbcf0f67448'}\n\n```{.r .cell-code}\n# Define the cycles to download\ncycles <- c(\"H\", \"I\", \"J\")\n# Create a list to store data from each cycle\nall_cycles_data <- list()\n# Loop through each cycle, download with translation, and merge the data\nfor (cycle_code in cycles) {\n  demo_data <- nhanes(paste0(\"DEMO_\", cycle_code), translated = TRUE)\n  bmx_data <- nhanes(paste0(\"BMX_\", cycle_code), translated = TRUE)\n  all_cycles_data[[cycle_code]] <- full_join(demo_data, bmx_data, by = \"SEQN\")\n}\n# Combine the data from all cycles into one dataframe\nnhanes_raw <- bind_rows(all_cycles_data)\n# Check the dimensions of the final raw dataset\ndim(nhanes_raw)\n#> [1] 29400    78\n```\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 4: Data Cleaning and Filtering**\n\nUsing the `nhanes_raw` dataset, we will now create our clean dataset. This involves filtering our population to adults and then creating our analysis variables.\n\n1.  **Filter for Adults:** Keep only participants aged 20 years or older.\n2.  **Rename Variables:** `RIAGENDR` to `Sex`, `RIDAGEYR` to `Age`, `RIDRETH3` to `RaceEthnicity`, `BMXBMI` to `BMI`.\n3.  **Group `RaceEthnicity`:** Combine \"Mexican American\" and \"Other Hispanic\" into a single \"Hispanic\" category.\n4.  **Create `AgeGroup`:** Categorize `Age` into \"20-39\", \"40-59\", and \"60+\".\n5.  **Create `BMICat`:** Categorize `BMI` into \"Underweight\", \"Normal weight\", \"Overweight\", and \"Obese\".\n\n\n::: {.cell hash='accessingE3solution_cache/html/clean-data_7d68796b2d56e31478429341be9575f0'}\n\n```{.r .cell-code}\nnhanes_clean <- nhanes_raw %>%\n  # Step 1: Filter the data to include only adults\n  filter(RIDAGEYR >= 20) %>%\n  # Step 2: Rename variables\n  rename(\n    Sex = RIAGENDR,\n    Age = RIDAGEYR,\n    RaceEthnicity = RIDRETH3,\n    BMI = BMXBMI\n  ) %>%\n  # Create new variables\n  mutate(\n    # Step 3: Group the detailed race categories into broader ones\n    RaceEthnicity = case_when(\n      RaceEthnicity %in% c(\"Mexican American\", \"Other Hispanic\") ~ \"Hispanic\",\n      RaceEthnicity == \"Non-Hispanic White\" ~ \"Non-Hispanic White\",\n      RaceEthnicity == \"Non-Hispanic Black\" ~ \"Non-Hispanic Black\",\n      RaceEthnicity == \"Non-Hispanic Asian\" ~ \"Non-Hispanic Asian\",\n      TRUE ~ \"Other\" # Groups \"Other Race - Including Multi-Racial\" and any NAs\n    ),\n    # Convert the new character RaceEthnicity to a factor with the desired level order\n    RaceEthnicity = factor(RaceEthnicity,\n                           levels = c(\"Non-Hispanic White\", \"Non-Hispanic Black\", \"Hispanic\", \"Non-Hispanic Asian\", \"Other\")),\n    \n    # Step 4: Create AgeGroup (now without NAs because we filtered)\n    AgeGroup = cut(Age,\n                   breaks = c(19, 39, 59, Inf),\n                   labels = c(\"20-39\", \"40-59\", \"60+\"),\n                   right = TRUE),\n                   \n    # Step 5: Create BMICat\n    BMICat = cut(BMI,\n                 breaks = c(0, 18.5, 25, 30, Inf),\n                 labels = c(\"Underweight\", \"Normal weight\", \"Overweight\", \"Obese\"),\n                 right = FALSE)\n  )\n\n# Check the structure to confirm variables are correct\nstr(nhanes_clean[, c(\"SEQN\", \"Sex\", \"Age\", \"AgeGroup\", \"RaceEthnicity\", \"BMI\")])\n#> 'data.frame':\t17057 obs. of  6 variables:\n#>  $ SEQN         : num  73557 73558 73559 73561 73562 ...\n#>  $ Sex          : Factor w/ 2 levels \"Male\",\"Female\": 1 1 1 2 1 2 1 2 1 2 ...\n#>  $ Age          : num  69 54 72 73 56 61 42 56 65 26 ...\n#>  $ AgeGroup     : Factor w/ 3 levels \"20-39\",\"40-59\",..: 3 2 3 3 2 3 2 2 3 1 ...\n#>  $ RaceEthnicity: Factor w/ 5 levels \"Non-Hispanic White\",..: 2 1 1 1 3 1 3 1 1 1 ...\n#>  $ BMI          : num  26.7 28.6 28.9 19.7 41.7 35.7 NA 26.5 22 20.3 ...\n```\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 5: Create Final Analytic Dataset**\n\nCreate a final, analysis-ready dataset named `nhanes_analysis` that includes only the key variables.\n\n\n::: {.cell hash='accessingE3solution_cache/html/create-analytic-data_fee1f2e299bddc48aa0dcad47d714d0a'}\n\n```{.r .cell-code}\nnhanes_analysis <- select(nhanes_clean, SEQN, Sex, Age, AgeGroup, RaceEthnicity, BMI, BMICat)\n\n# Display the structure of the final analytic dataset\nstr(nhanes_analysis)\n#> 'data.frame':\t17057 obs. of  7 variables:\n#>  $ SEQN         : num  73557 73558 73559 73561 73562 ...\n#>  $ Sex          : Factor w/ 2 levels \"Male\",\"Female\": 1 1 1 2 1 2 1 2 1 2 ...\n#>  $ Age          : num  69 54 72 73 56 61 42 56 65 26 ...\n#>  $ AgeGroup     : Factor w/ 3 levels \"20-39\",\"40-59\",..: 3 2 3 3 2 3 2 2 3 1 ...\n#>  $ RaceEthnicity: Factor w/ 5 levels \"Non-Hispanic White\",..: 2 1 1 1 3 1 3 1 1 1 ...\n#>  $ BMI          : num  26.7 28.6 28.9 19.7 41.7 35.7 NA 26.5 22 20.3 ...\n#>  $ BMICat       : Factor w/ 4 levels \"Underweight\",..: 3 3 3 2 4 4 NA 3 2 2 ...\n```\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 6: Investigate Missing Data**\n\nNow that our data is correctly filtered and processed, let's re-examine the missing data patterns. The missingness should be much lower.\n\n\n::: {.cell hash='accessingE3solution_cache/html/missing-data-investigation_1774f06e5ea0f9759bc1a70fa2f6d5c0'}\n\n```{.r .cell-code}\n# 1. Count missing values for each column\nmissing_counts <- colSums(is.na(nhanes_analysis))\nprint(missing_counts)\n#>          SEQN           Sex           Age      AgeGroup RaceEthnicity \n#>             0             0             0             0             0 \n#>           BMI        BMICat \n#>           956           956\n\n# 2. Visualize the missing data\ngg_miss_var(nhanes_analysis, show_pct = TRUE) +\n  labs(title = \"Missing Data in NHANES Adult Participants (2013-2018)\")\n```\n\n::: {.cell-output-display}\n![](accessingE3solution_files/figure-html/missing-data-investigation-1.png){width=672}\n:::\n:::\n\n\n------------------------------------------------------------------------\n\n### **Problem 7: Create a Descriptive Table**\n\nFinally, with the data correctly loaded and cleaned for our adult population, create the summary table of sample characteristics, stratified by `Sex`.\n\n\n::: {.cell hash='accessingE3solution_cache/html/create-table-one_752eb36cef792af48697aafbe29b2647'}\n\n```{.r .cell-code}\n# Define the variables for the table\nvars <- c(\"Age\", \"AgeGroup\", \"RaceEthnicity\", \"BMI\", \"BMICat\")\n\n# Create the table, stratified by Sex\ntab1 <- CreateTableOne(vars = vars, data = nhanes_analysis, strata = \"Sex\", addOverall = TRUE, test = FALSE)\n\n# Print the table, showing all levels and missing data counts\nprint(tab1, smd = FALSE, showAllLevels = TRUE, missing = TRUE)\n#>                    Stratified by Sex\n#>                     level              Overall       Male         \n#>   n                                    17057          8207        \n#>   Age (mean (SD))                      50.03 (17.74) 50.23 (17.83)\n#>   AgeGroup (%)      20-39               5594 (32.8)   2687 (32.7) \n#>                     40-59               5571 (32.7)   2612 (31.8) \n#>                     60+                 5892 (34.5)   2908 (35.4) \n#>   RaceEthnicity (%) Non-Hispanic White  6270 (36.8)   3094 (37.7) \n#>                     Non-Hispanic Black  3673 (21.5)   1759 (21.4) \n#>                     Hispanic            4290 (25.2)   1978 (24.1) \n#>                     Non-Hispanic Asian  2168 (12.7)   1034 (12.6) \n#>                     Other                656 ( 3.8)    342 ( 4.2) \n#>   BMI (mean (SD))                      29.49 (7.21)  28.93 (6.33) \n#>   BMICat (%)        Underweight          247 ( 1.5)    105 ( 1.4) \n#>                     Normal weight       4244 (26.4)   1966 (25.5) \n#>                     Overweight          5168 (32.1)   2853 (37.0) \n#>                     Obese               6442 (40.0)   2790 (36.2) \n#>                    Stratified by Sex\n#>                     Female        Missing\n#>   n                  8850                \n#>   Age (mean (SD))   49.86 (17.66) 0.0    \n#>   AgeGroup (%)       2907 (32.8)  0.0    \n#>                      2959 (33.4)         \n#>                      2984 (33.7)         \n#>   RaceEthnicity (%)  3176 (35.9)  0.0    \n#>                      1914 (21.6)         \n#>                      2312 (26.1)         \n#>                      1134 (12.8)         \n#>                       314 ( 3.5)         \n#>   BMI (mean (SD))   30.01 (7.90)  5.6    \n#>   BMICat (%)          142 ( 1.7)  5.6    \n#>                      2278 (27.2)         \n#>                      2315 (27.6)         \n#>                      3652 (43.5)\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}