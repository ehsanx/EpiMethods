{
  "hash": "7dabc406da52ef6ecf1bc48fb5f197b4",
  "result": {
    "markdown": "## Survival analysis {.unnumbered}\n\n\n::: {.cell hash='nonbinary2_cache/html/setup_5fbef1d7bd675c36b80ed78b970d7ffb'}\n\n```{.r .cell-code}\n# Load required packages\nrequire(knitr)\nrequire(Publish)\nrequire(survey)\nlibrary(broom)\nlibrary(tidyverse)\nrequire(survminer)\n```\n:::\n\n\n### The lung dataset\n\n-   inst: Institution code\n-   time: Survival time in days\n-   status: censoring status\n    -   1=censored,\n    -   2=dead\n-   age: Age in years\n-   sex:\n    -   Male=1\n    -   Female=2\n-   ph.ecog: ECOG performance score (0=good 5=dead)\n-   ph.karno: Karnofsky performance score (bad=0-good=100) rated by physician\n-   pat.karno: Karnofsky performance score as rated by patient\n-   meal.cal: Calories consumed at meals\n-   wt.loss: Weight loss in last six months\n\n\n::: {.cell hash='nonbinary2_cache/html/load_423f50ce04f89ed56c976075e4a8714d'}\n\n```{.r .cell-code}\nlibrary(survival)\nhead(lung)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"inst\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"time\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"status\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"age\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"sex\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"ph.ecog\"],\"name\":[6],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"ph.karno\"],\"name\":[7],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"pat.karno\"],\"name\":[8],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"meal.cal\"],\"name\":[9],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"wt.loss\"],\"name\":[10],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"3\",\"2\":\"306\",\"3\":\"2\",\"4\":\"74\",\"5\":\"1\",\"6\":\"1\",\"7\":\"90\",\"8\":\"100\",\"9\":\"1175\",\"10\":\"NA\",\"_rn_\":\"1\"},{\"1\":\"3\",\"2\":\"455\",\"3\":\"2\",\"4\":\"68\",\"5\":\"1\",\"6\":\"0\",\"7\":\"90\",\"8\":\"90\",\"9\":\"1225\",\"10\":\"15\",\"_rn_\":\"2\"},{\"1\":\"3\",\"2\":\"1010\",\"3\":\"1\",\"4\":\"56\",\"5\":\"1\",\"6\":\"0\",\"7\":\"90\",\"8\":\"90\",\"9\":\"NA\",\"10\":\"15\",\"_rn_\":\"3\"},{\"1\":\"5\",\"2\":\"210\",\"3\":\"2\",\"4\":\"57\",\"5\":\"1\",\"6\":\"1\",\"7\":\"90\",\"8\":\"60\",\"9\":\"1150\",\"10\":\"11\",\"_rn_\":\"4\"},{\"1\":\"1\",\"2\":\"883\",\"3\":\"2\",\"4\":\"60\",\"5\":\"1\",\"6\":\"0\",\"7\":\"100\",\"8\":\"90\",\"9\":\"NA\",\"10\":\"0\",\"_rn_\":\"5\"},{\"1\":\"12\",\"2\":\"1022\",\"3\":\"1\",\"4\":\"74\",\"5\":\"1\",\"6\":\"1\",\"7\":\"50\",\"8\":\"80\",\"9\":\"513\",\"10\":\"0\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n\n```{.r .cell-code}\nkable(head(lung))\n```\n\n::: {.cell-output-display}\n| inst| time| status| age| sex| ph.ecog| ph.karno| pat.karno| meal.cal| wt.loss|\n|----:|----:|------:|---:|---:|-------:|--------:|---------:|--------:|-------:|\n|    3|  306|      2|  74|   1|       1|       90|       100|     1175|      NA|\n|    3|  455|      2|  68|   1|       0|       90|        90|     1225|      15|\n|    3| 1010|      1|  56|   1|       0|       90|        90|       NA|      15|\n|    5|  210|      2|  57|   1|       1|       90|        60|     1150|      11|\n|    1|  883|      2|  60|   1|       0|      100|        90|       NA|       0|\n|   12| 1022|      1|  74|   1|       1|       50|        80|      513|       0|\n:::\n\n```{.r .cell-code}\n# kable(lung)\n```\n:::\n\n\n### What is censoring?\n\nCensoring occurs if a subject leave the study without experiencing the event\n\n### Types of censoring\n\n#### Left censoring:\n\nThe subject has experienced the event before enrollment\n\n#### Right censoring:\n\n-   Loss to follow-up\n-   Withdraw from the study\n-   Survive to the end of the study\n\nIn this lab, we focus on right censoring\n\n### Components of survival data\n\nThere are four components in survival data:\n\nFor any individual i:\n\n-   Event time $T_i$\n-   Censoring time $C_i$\n-   Event indicator $\\delta_i$\n-   Observed time $Y_i=min(T_i,C_i)$\n\n### Event indicator\n\nThe event indicator $\\delta_i$ was defined as a binary data\n\n-   $\\delta_i=1$ if $T_i \\leq C_i$\n-   $\\delta_i=0$ if $T_i > C_i$\n\n### Survival function\n\nSurvival function represents the probability that an individual will survival past time $t$\n\n$S(t) = Pr(T>t)=1-F(t)$, where $F(t)$ is the cumulative distribution function.\n\n### Survival probability\n\nGiven that a subject is still alive just before time $t$, the survival probability $S(t)$ represents the probability of surviving beyond time $t$. We could plot survival probability in lung dataset\n\n### Creating survival objects\n\nA survival object is the survival time and can be used as the \"response\" in survival analysis. To estimate $S(t)$, we usually use the non-parametric method called Kaplan-Meier method. In R, we can use \"Surv\" in survival package to create survival objects. Let us take a look at the first 10 subjects in lung dataset. The numbers are the survival time for each individual, $+$ indicates that the observation has been censored\n\n\n::: {.cell hash='nonbinary2_cache/html/obj_67bdd5e6be228c146322c86bda31f28c'}\n\n```{.r .cell-code}\nSurv(lung$time, lung$status)[1:10]\n#>  [1]  306   455  1010+  210   883  1022+  310   361   218   166\n```\n:::\n\n\n### Estimating survival curves with the Kaplan-Meier method\n\n\"survfit\" in survival package can help us to estimate survival curves using KM method\n\n\n::: {.cell hash='nonbinary2_cache/html/fit_a19788f6cb80e73a8eea9c73dba3e365'}\n\n```{.r .cell-code}\nf1 <- survfit(Surv(time, status) ~ 1, data = lung)\n# Surv(time, status) is the survival object we just introduced\n# show the objects in the f1\nnames(f1)\n#>  [1] \"n\"         \"time\"      \"n.risk\"    \"n.event\"   \"n.censor\"  \"surv\"     \n#>  [7] \"std.err\"   \"cumhaz\"    \"std.chaz\"  \"type\"      \"logse\"     \"conf.int\" \n#> [13] \"conf.type\" \"lower\"     \"upper\"     \"call\"\n```\n:::\n\n\n### Kaplan-Meier plot\n\nWe could plot the above fitting to have a KM plot in R\n\n\n::: {.cell hash='nonbinary2_cache/html/km_f822826ae1ce5ee101e6b052afaf9775'}\n\n```{.r .cell-code}\nplot(survfit(Surv(time, status) ~ 1, data = lung), \n     xlab = \"Days\", \n     ylab = \"Overall survival probability\")\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/km-1.png){width=672}\n:::\n\n```{.r .cell-code}\n\n## We could also do KM by groups\nplot(survfit(Surv(time, status) ~ sex, data = lung), \n     xlab = \"Days\", \n     ylab = \"Overall survival probability\")\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/km-2.png){width=672}\n:::\n\n```{.r .cell-code}\n## Adding legend\nfit0 <- survfit(Surv(time, status) ~ sex, data = lung)\nplot(fit0, \n     xlab = \"Days\", \n     ylab = \"Overall survival probability\",\n     lty = 1:2,col=1:2)\nLab.x <- names(fit0$strata)\nlegend(\"topright\", legend=Lab.x,\n  col=1:2, lty=1:2,horiz=FALSE,bty='n')\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/km-3.png){width=672}\n:::\n\n```{.r .cell-code}\n#library(survminer)\n# ggsurvplot(survfit(Surv(time, status) ~ sex, data = lung), data = lung,\n#            xlab=\"Days\",\n#            ylab = \"Survival probability\")\n```\n:::\n\n\n### Estimating median survival time\n\nUsually, the survival time will not be normally (or symmetrically) distributed. Therefore, mean is not a good summary for survival time. Instead, we use median to estimate. \"survfit\" in survival package present the summary of median\n\n\n::: {.cell hash='nonbinary2_cache/html/median_735c6016e03777a8319e548cb914cf44'}\n\n```{.r .cell-code}\nsurvfit(Surv(time, status) ~ 1, data = lung)\n#> Call: survfit(formula = Surv(time, status) ~ 1, data = lung)\n#> \n#>        n events median 0.95LCL 0.95UCL\n#> [1,] 228    165    310     285     363\n```\n:::\n\n\n### Comparing survival times between groups\n\nWe could use log-rank test to test whether there exists significant difference in survival time between groups. The log-rank test put the same weights on every observation. It could be done in R use \"survdiff\" from survival package\n\n\n::: {.cell hash='nonbinary2_cache/html/stime_dfec2febfe53d55ff9d54a5f764e5116'}\n\n```{.r .cell-code}\nsurvdiff(Surv(time, status) ~ sex, data = lung)\n#> Call:\n#> survdiff(formula = Surv(time, status) ~ sex, data = lung)\n#> \n#>         N Observed Expected (O-E)^2/E (O-E)^2/V\n#> sex=1 138      112     91.6      4.55      10.3\n#> sex=2  90       53     73.4      5.68      10.3\n#> \n#>  Chisq= 10.3  on 1 degrees of freedom, p= 0.001\n```\n:::\n\n\nThe results indicated that the survival time depends on the sex (p-value = 0.001); e.g., associated with sex variable.\n\n### The Cox regression model\n\nThe Cox regression model (aka Cox proportional-hazard model) is semi-parametric model to quantify the effect size in survival analysis.\n\n-   $h(t|X_i)=h_0(t)exp(\\beta_0+\\beta_1X_{i1}+\\beta_2X_{i2}+\\beta_3X_{i3}+...+\\beta_pX_{ip})$, where\n    -   $h_0(t)$ is the baseline hazard and\n    -   $h(t)$ is the hazard at time $t$\n\nIn R, we have \"coxph\" from survival package to fit a Cox PH model\n\n\n::: {.cell hash='nonbinary2_cache/html/coxph_c3f8b86819e81390737331cffaa94c2b'}\n\n```{.r .cell-code}\nfit <- coxph(Surv(time, status) ~ sex, data = lung) # add sex as covariate\nsummary(fit)\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex, data = lung)\n#> \n#>   n= 228, number of events= 165 \n#> \n#>        coef exp(coef) se(coef)      z Pr(>|z|)   \n#> sex -0.5310    0.5880   0.1672 -3.176  0.00149 **\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>     exp(coef) exp(-coef) lower .95 upper .95\n#> sex     0.588      1.701    0.4237     0.816\n#> \n#> Concordance= 0.579  (se = 0.021 )\n#> Likelihood ratio test= 10.63  on 1 df,   p=0.001\n#> Wald test            = 10.09  on 1 df,   p=0.001\n#> Score (logrank) test = 10.33  on 1 df,   p=0.001\nrequire(Publish)\npublish(fit)\n#>  Variable Units HazardRatio       CI.95   p-value \n#>       sex              0.59 [0.42;0.82]   0.00149\n```\n:::\n\n\nMore variables\n\n\n::: {.cell hash='nonbinary2_cache/html/coxph2_f6efc254c5051c09711438eb7ed79435'}\n\n```{.r .cell-code}\nfit <- coxph(Surv(time, status) ~ sex + ph.ecog + \n               ph.karno + pat.karno + meal.cal + wt.loss, \n             data = lung) # add more covariates\nsummary(fit)\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex + ph.ecog + ph.karno + \n#>     pat.karno + meal.cal + wt.loss, data = lung)\n#> \n#>   n= 168, number of events= 121 \n#>    (60 observations deleted due to missingness)\n#> \n#>                 coef  exp(coef)   se(coef)      z Pr(>|z|)   \n#> sex       -5.571e-01  5.729e-01  2.003e-01 -2.782  0.00541 **\n#> ph.ecog    7.377e-01  2.091e+00  2.260e-01  3.264  0.00110 **\n#> ph.karno   2.041e-02  1.021e+00  1.108e-02  1.842  0.06549 . \n#> pat.karno -1.263e-02  9.874e-01  8.062e-03 -1.567  0.11707   \n#> meal.cal  -8.303e-06  1.000e+00  2.567e-04 -0.032  0.97420   \n#> wt.loss   -1.460e-02  9.855e-01  7.708e-03 -1.894  0.05820 . \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>           exp(coef) exp(-coef) lower .95 upper .95\n#> sex          0.5729     1.7456    0.3869    0.8483\n#> ph.ecog      2.0910     0.4782    1.3427    3.2565\n#> ph.karno     1.0206     0.9798    0.9987    1.0430\n#> pat.karno    0.9874     1.0127    0.9720    1.0032\n#> meal.cal     1.0000     1.0000    0.9995    1.0005\n#> wt.loss      0.9855     1.0147    0.9707    1.0005\n#> \n#> Concordance= 0.656  (se = 0.029 )\n#> Likelihood ratio test= 27.47  on 6 df,   p=1e-04\n#> Wald test            = 27.02  on 6 df,   p=1e-04\n#> Score (logrank) test = 27.82  on 6 df,   p=1e-04\n```\n:::\n\n\n### Formatting Cox regression results\n\nTo format the Cox regression results into a nice table format, we could use \"tidy\" (broom package).\n\n\n::: {.cell hash='nonbinary2_cache/html/coxphres_5ea02c8bfc2a5391b58654f30a84853e'}\n\n```{.r .cell-code}\nlibrary(broom)\nlibrary(tidyverse)\nsummary(fit)\n#> Call:\n#> coxph(formula = Surv(time, status) ~ sex + ph.ecog + ph.karno + \n#>     pat.karno + meal.cal + wt.loss, data = lung)\n#> \n#>   n= 168, number of events= 121 \n#>    (60 observations deleted due to missingness)\n#> \n#>                 coef  exp(coef)   se(coef)      z Pr(>|z|)   \n#> sex       -5.571e-01  5.729e-01  2.003e-01 -2.782  0.00541 **\n#> ph.ecog    7.377e-01  2.091e+00  2.260e-01  3.264  0.00110 **\n#> ph.karno   2.041e-02  1.021e+00  1.108e-02  1.842  0.06549 . \n#> pat.karno -1.263e-02  9.874e-01  8.062e-03 -1.567  0.11707   \n#> meal.cal  -8.303e-06  1.000e+00  2.567e-04 -0.032  0.97420   \n#> wt.loss   -1.460e-02  9.855e-01  7.708e-03 -1.894  0.05820 . \n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#>           exp(coef) exp(-coef) lower .95 upper .95\n#> sex          0.5729     1.7456    0.3869    0.8483\n#> ph.ecog      2.0910     0.4782    1.3427    3.2565\n#> ph.karno     1.0206     0.9798    0.9987    1.0430\n#> pat.karno    0.9874     1.0127    0.9720    1.0032\n#> meal.cal     1.0000     1.0000    0.9995    1.0005\n#> wt.loss      0.9855     1.0147    0.9707    1.0005\n#> \n#> Concordance= 0.656  (se = 0.029 )\n#> Likelihood ratio test= 27.47  on 6 df,   p=1e-04\n#> Wald test            = 27.02  on 6 df,   p=1e-04\n#> Score (logrank) test = 27.82  on 6 df,   p=1e-04\nrequire(Publish)\npublish(fit)\n#>   Variable Units Missing HazardRatio       CI.95   p-value \n#>        sex             0        0.57 [0.39;0.85]   0.00541 \n#>    ph.ecog             1        2.09 [1.34;3.26]   0.00110 \n#>   ph.karno             1        1.02 [1.00;1.04]   0.06549 \n#>  pat.karno             3        0.99 [0.97;1.00]   0.11707 \n#>   meal.cal            47        1.00 [1.00;1.00]   0.97420 \n#>    wt.loss            14        0.99 [0.97;1.00]   0.05820\nkable(broom::tidy(fit, exp = TRUE))\n```\n\n::: {.cell-output-display}\n|term      |  estimate| std.error|  statistic|   p.value|\n|:---------|---------:|---------:|----------:|---------:|\n|sex       | 0.5728725| 0.2002798| -2.7815687| 0.0054097|\n|ph.ecog   | 2.0910352| 0.2260265|  3.2635959| 0.0011001|\n|ph.karno  | 1.0206185| 0.0110803|  1.8418903| 0.0654912|\n|pat.karno | 0.9874450| 0.0080618| -1.5672047| 0.1170668|\n|meal.cal  | 0.9999917| 0.0002567| -0.0323431| 0.9741984|\n|wt.loss   | 0.9855065| 0.0077076| -1.8941781| 0.0582014|\n:::\n\n```{.r .cell-code}\nkable(broom::tidy(fit, exp = TRUE), digits = 2)\n```\n\n::: {.cell-output-display}\n|term      | estimate| std.error| statistic| p.value|\n|:---------|--------:|---------:|---------:|-------:|\n|sex       |     0.57|      0.20|     -2.78|    0.01|\n|ph.ecog   |     2.09|      0.23|      3.26|    0.00|\n|ph.karno  |     1.02|      0.01|      1.84|    0.07|\n|pat.karno |     0.99|      0.01|     -1.57|    0.12|\n|meal.cal  |     1.00|      0.00|     -0.03|    0.97|\n|wt.loss   |     0.99|      0.01|     -1.89|    0.06|\n:::\n\n```{.r .cell-code}\nrequire(survminer)\nggforest(fit, data = lung)\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/coxphres-1.png){width=672}\n:::\n:::\n\n\n### Hazard ratios\n\n-   In Cox regression model, the quantity we interested is the **hazard ratio**, which is the ratio of hazards in two different groups (i.e., exposed vs unexposed).\n-   Hazard ratio at time $t$ is denoted by $HR=\\frac{h_1(t)}{h_0(t)}$ where $h(t)$ is the hazard function representing the instantaneous rate that the first event may occur.\n-   Hazard ratio is **not** a risk, and it can estimated by exponatial the estimated coefficients (i.e., $exp(\\beta)$).\n-   In the above Cox model, the HR is 0.59 which indicated that the hazard in Female is smaller than Male.\n-   In generally, a $HR>1$ indicates a higher hazard, and $HR<1$ indicated a reduced hazard.\n\n### Assessing proportional hazards\n\n-   As mentioned before, the Cox model is also called as Cox proportional hazard model.\n-   The assumption made here is the hazards in both group are proportional.\n-   The easiest way of assessing proportional hazard assumption is to use \"cox.zph\"\n-   This function uses the Schoenfeld residuals against the transformed time.\n-   Ideally, this checks if the hazard rate of an individual is relatively constant in time.\n\n\n::: {.cell hash='nonbinary2_cache/html/coxph3_3a427ef4b166dc6dea7e0a6e417b2b71'}\n\n```{.r .cell-code}\nf2 <- coxph(Surv(time, status) ~ sex, data = lung)\ntest <- cox.zph(f2)\ntest\n#>        chisq df     p\n#> sex     2.86  1 0.091\n#> GLOBAL  2.86  1 0.091\nplot(test)\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/coxph3-1.png){width=672}\n:::\n:::\n\n\n-   Here, p-value is greater than 0.05, there is no evidence against PH assumption.\n-   Having very small p values (say, 0.001) indicates that there may be time dependent coefficients which the modelling needs to take care of.\n\n### Time-dependent covariate\n\nTime-dependent covariate occurs when individual's covariate values are may be different at different time (measured repeatedly over time).\n\n#### Data setup\n\n\n::: {.cell hash='nonbinary2_cache/html/tdcov_05850cdea31d7581d874157350c997ee'}\n\n```{.r .cell-code}\n# Create a simple data set for a time-dependent model\n# See ?coxph\ntest.data <- list(start=c(1, 2, 5, 2, 1, 7, 3, 4, 8, 8),\n                  stop =c(2, 3, 6, 7, 8, 9, 9, 9,14,17),\n                  event=c(1, 1, 1, 1, 1, 1, 1, 0, 0, 0),\n                  tx  =c(1, 0, 0, 1, 0, 1, 1, 1, 0, 0) )\ntest.data\n#> $start\n#>  [1] 1 2 5 2 1 7 3 4 8 8\n#> \n#> $stop\n#>  [1]  2  3  6  7  8  9  9  9 14 17\n#> \n#> $event\n#>  [1] 1 1 1 1 1 1 1 0 0 0\n#> \n#> $tx\n#>  [1] 1 0 0 1 0 1 1 1 0 0\nas.data.frame(test.data)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"start\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"stop\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"event\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"tx\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"1\",\"2\":\"2\",\"3\":\"1\",\"4\":\"1\"},{\"1\":\"2\",\"2\":\"3\",\"3\":\"1\",\"4\":\"0\"},{\"1\":\"5\",\"2\":\"6\",\"3\":\"1\",\"4\":\"0\"},{\"1\":\"2\",\"2\":\"7\",\"3\":\"1\",\"4\":\"1\"},{\"1\":\"1\",\"2\":\"8\",\"3\":\"1\",\"4\":\"0\"},{\"1\":\"7\",\"2\":\"9\",\"3\":\"1\",\"4\":\"1\"},{\"1\":\"3\",\"2\":\"9\",\"3\":\"1\",\"4\":\"1\"},{\"1\":\"4\",\"2\":\"9\",\"3\":\"0\",\"4\":\"1\"},{\"1\":\"8\",\"2\":\"14\",\"3\":\"0\",\"4\":\"0\"},{\"1\":\"8\",\"2\":\"17\",\"3\":\"0\",\"4\":\"0\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### Time-dependent covariate - Cox regression\n\n\n::: {.cell hash='nonbinary2_cache/html/tdcov2_0960c773f5c90660519296387b7870c4'}\n\n```{.r .cell-code}\nfit.td <- coxph( Surv(start, stop, event) ~ tx, test.data)\nsummary(fit.td)\n#> Call:\n#> coxph(formula = Surv(start, stop, event) ~ tx, data = test.data)\n#> \n#>   n= 10, number of events= 7 \n#> \n#>        coef exp(coef) se(coef)      z Pr(>|z|)\n#> tx -0.02111   0.97912  0.79518 -0.027    0.979\n#> \n#>    exp(coef) exp(-coef) lower .95 upper .95\n#> tx    0.9791      1.021    0.2061     4.653\n#> \n#> Concordance= 0.526  (se = 0.129 )\n#> Likelihood ratio test= 0  on 1 df,   p=1\n#> Wald test            = 0  on 1 df,   p=1\n#> Score (logrank) test = 0  on 1 df,   p=1\npublish(fit.td)\n#>  Variable Units HazardRatio       CI.95 p-value \n#>        tx              0.98 [0.21;4.65]   0.979\n```\n:::\n\n\n### Survival analysis in Complex Survey data\n\n-   Example data from [GitHub](https://github.com/chiragjp/nhanes_scidata).\n-   Below we created the design\n\n## Data and Variables\n\n\n::: {.cell hash='nonbinary2_cache/html/complex_241dbee0ba63325be41e3ef043b32822'}\n\n```{.r .cell-code}\nload(\"Data/nonbinary/nh_99-06.Rdata\") # \nanalytic.miss <- as.data.frame(MainTable[c(\"SDMVPSU\", \"SDMVSTRA\", \"WTMEC2YR\", \"PERMTH_INT\", \"PERMTH_EXM\", \"MORTSTAT\", \"female\", \"RIDAGEYR\", \"white\")])\n```\n:::\n\n\n-   MORTSTAT: Final Mortality Status\n    -   0 Assumed alive\n    -   1 Assumed deceased\n    -   Blank Ineligible for mortality follow-up or under age 17\n-   PERMTH_EXM: Person Months of Follow-up from MEC/Home Exam Date\n    -   0 - 217\n    -   Blank Ineligible\n-   PERMTH_INT: Person Months of Follow-up from Interview Date\n\n#### Data issues\n\n\n::: {.cell hash='nonbinary2_cache/html/complex2_403e590129e977679b900bb4977c003c'}\n\n```{.r .cell-code}\nwith(analytic.miss[1:30,], \n     Surv(PERMTH_EXM, MORTSTAT))\n#>  [1] NA? 90+ NA? NA? 74+ 86+ 76+ NA? NA? 79+ NA? 82+ 16  85+ 92+ 62  NA? NA? NA?\n#> [20] 86+ 87+ NA? NA? 72+ 84+ NA? 85+ 91+ 26  NA?\nsummary(analytic.miss$WTMEC2YR)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>       0    6365   15572   27245   38896  261361\n# avoiding 0 weight issues\nanalytic.miss$WTMEC2YR[analytic.miss$WTMEC2YR == 0] <- 0.001\nrequire(DataExplorer)\nplot_missing(analytic.miss)\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/complex2-1.png){width=672}\n:::\n:::\n\n\n#### Design creation\n\n\n::: {.cell hash='nonbinary2_cache/html/complex3_da5811869c008452ab71c56170eb36bc'}\n\n```{.r .cell-code}\nanalytic.miss$ID <- 1:nrow(analytic.miss)\nanalytic.miss$miss <- 0\nanalytic.cc <- as.data.frame(na.omit(analytic.miss))\ndim(analytic.cc)\n#> [1] 10557    11\nanalytic.miss$miss[analytic.miss$ID %in% \n                     analytic.cc$ID] <- 0\nw.design0 <- svydesign(id=~SDMVPSU, \n                       strata=~SDMVSTRA, \n                       weights=~WTMEC2YR, \n                       nest=TRUE,\n                       data=analytic.miss)\nw.design <- subset(w.design0, \n                   miss == 0)\nsummary(weights(w.design))\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>       0    6365   15572   27245   38896  261361\n```\n:::\n\n\n### Survival Analysis within Complex Survey\n\n#### KM plot\n\n\n::: {.cell hash='nonbinary2_cache/html/complex4_49076485ce65e141697525d7ba2f71d8'}\n\n```{.r .cell-code}\nfit0 <- svykm(Surv(PERMTH_EXM, MORTSTAT) ~ 1, \n              design = w.design)\nplot(fit0)\n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/complex4-1.png){width=672}\n:::\n:::\n\n\n#### Cox PH\n\n\n::: {.cell hash='nonbinary2_cache/html/complex5_fb775c94419805f4537e4fe09cf64f04'}\n\n```{.r .cell-code}\nfit <- svycoxph(Surv(PERMTH_EXM, MORTSTAT) ~ \n                  white + female + RIDAGEYR, \n                design = w.design) \npublish(fit)\n#> Stratified 1 - level Cluster Sampling design (with replacement)\n#> With (117) clusters.\n#> subset(w.design0, miss == 0)\n#>  Variable Units HazardRatio       CI.95   p-value \n#>     white              0.78 [0.66;0.93]   0.00441 \n#>    female              0.61 [0.50;0.75]   < 0.001 \n#>  RIDAGEYR              1.09 [1.08;1.10]   < 0.001\n```\n:::\n\n\n#### PH assumption\n\n\n::: {.cell hash='nonbinary2_cache/html/complex6_45fa00a6f860b5379aa995b3430efb36'}\n\n```{.r .cell-code}\ntestPh <- cox.zph(fit) \nprint(testPh)\n#>             chisq df    p\n#> white    7.39e-05  1 0.99\n#> female   2.84e-07  1 1.00\n#> RIDAGEYR 9.16e-05  1 0.99\n#> GLOBAL   1.45e-04  3 1.00\nplot(testPh) \n```\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/complex6-1.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/complex6-2.png){width=672}\n:::\n\n::: {.cell-output-display}\n![](nonbinary2_files/figure-html/complex6-3.png){width=672}\n:::\n:::\n\n\n### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/XpQW360Vkac\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}