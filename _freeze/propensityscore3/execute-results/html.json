{
  "hash": "101d96bf8b330b65d64333cb342b5e1e",
  "result": {
    "markdown": "## PSM in OA-CVD (US) {.unnumbered}\n\n\n\n\n\n### Pre-processing\n\n#### Load data\n\nLoad the dataset and inspect its structure and variables.\n\n\n::: {.cell hash='propensityscore3_cache/html/data_7e58789066707b26fc1e641fb70e9a8c'}\n\n```{.r .cell-code}\nload(file=\"Data/propensityscore/NHANES17.RData\") \nls()\n#> [1] \"analytic\"           \"analytic.with.miss\"\n```\n:::\n\n\nVisualize missing data patterns. \n\n\n::: {.cell hash='propensityscore3_cache/html/mplot_8e900758279d361d0107dca0d7be977b'}\n\n```{.r .cell-code}\nlibrary(dplyr)\n#> \n#> Attaching package: 'dplyr'\n#> The following objects are masked from 'package:data.table':\n#> \n#>     between, first, last\n#> The following objects are masked from 'package:stats':\n#> \n#>     filter, lag\n#> The following objects are masked from 'package:base':\n#> \n#>     intersect, setdiff, setequal, union\nanalytic.with.miss <- dplyr::select(analytic.with.miss, \n                  cholesterol, #outcome\n                  gender, age, born, race, education, \n                  married, income, bmi, diabetes, #predictors\n                  weight, psu, strata) #survey features\n\ndim(analytic.with.miss)\n#> [1] 9254   13\nstr(analytic.with.miss)\n#> 'data.frame':\t9254 obs. of  13 variables:\n#>  $ cholesterol: 'labelled' int  NA NA 157 148 189 209 176 NA 238 182 ...\n#>   ..- attr(*, \"label\")= chr \"Total Cholesterol (mg/dL)\"\n#>  $ gender     : chr  \"Female\" \"Male\" \"Female\" \"Male\" ...\n#>  $ age        : 'labelled' int  NA NA 66 NA NA 66 75 NA 56 NA ...\n#>   ..- attr(*, \"label\")= chr \"Age in years at screening\"\n#>  $ born       : chr  \"Born in 50 US states or Washingt\" \"Born in 50 US states or Washingt\" \"Born in 50 US states or Washingt\" \"Born in 50 US states or Washingt\" ...\n#>  $ race       : chr  \"Other\" \"White\" \"Black\" \"Other\" ...\n#>  $ education  : chr  NA NA \"High.School\" NA ...\n#>  $ married    : chr  NA NA \"Previously.married\" NA ...\n#>  $ income     : chr  \"Over100k\" \"Over100k\" \"<25k\" NA ...\n#>  $ bmi        : 'labelled' num  17.5 15.7 31.7 21.5 18.1 23.7 38.9 NA 21.3 19.7 ...\n#>   ..- attr(*, \"label\")= chr \"Body Mass Index (kg/m**2)\"\n#>  $ diabetes   : chr  \"No\" \"No\" \"No\" \"No\" ...\n#>  $ weight     : 'labelled' num  8540 42567 8338 8723 7065 ...\n#>   ..- attr(*, \"label\")= chr \"Full sample 2 year MEC exam weight\"\n#>  $ psu        : Factor w/ 2 levels \"1\",\"2\": 2 1 2 2 1 2 1 1 2 2 ...\n#>  $ strata     : Factor w/ 15 levels \"134\",\"135\",\"136\",..: 12 10 12 1 5 5 3 1 1 14 ...\nnames(analytic.with.miss)\n#>  [1] \"cholesterol\" \"gender\"      \"age\"         \"born\"        \"race\"       \n#>  [6] \"education\"   \"married\"     \"income\"      \"bmi\"         \"diabetes\"   \n#> [11] \"weight\"      \"psu\"         \"strata\"\n\nlibrary(DataExplorer)\nplot_missing(analytic.with.miss)\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/mplot-1.png){width=672}\n:::\n:::\n\n\n#### Formatting variables\n\nRename variables to avoid conflicts. Recode variables into binary or categorical as needed. Ensure variable types (factor, numeric) are appropriate.\n\n\n\n::: {.cell hash='propensityscore3_cache/html/format_664c3a4af7ce9ab4058d9ceca138e3a8'}\n\n```{.r .cell-code}\n# to avaoid any confusion later\n# rename weight variable as weights \n# is reserved for matching weights\nanalytic.with.miss$survey.weight <- analytic.with.miss$weight\nanalytic.with.miss$weight <- NULL\n\n#Creating binary variable for cholesterol\nanalytic.with.miss$cholesterol.bin <- ifelse(analytic.with.miss$cholesterol <200, \n                                             1, #\"healthy\",\n                                             0) #\"unhealthy\")\n# exposure recoding\nanalytic.with.miss$diabetes <- ifelse(analytic.with.miss$diabetes == \"Yes\", 1, 0)\n\n# ID\nanalytic.with.miss$ID <- 1:nrow(analytic.with.miss)\n\n# covariates\nanalytic.with.miss$born <- ifelse(analytic.with.miss$born == \"Other\", \n                                             0,\n                                             1)\n\nvars = c(\"gender\", \"race\", \"education\", \n         \"married\", \"income\", \"bmi\")\n\nnumeric.names <- c(\"cholesterol\", \"bmi\")\nfactor.names <- vars[!vars %in% numeric.names] \n\nanalytic.with.miss[factor.names] <- apply(X = analytic.with.miss[factor.names],\n                               MARGIN = 2, FUN = as.factor)\n\nanalytic.with.miss[numeric.names] <- apply(X = analytic.with.miss[numeric.names],\n                                MARGIN = 2, FUN =function (x) \n                                  as.numeric(as.character(x)))\nanalytic.with.miss$income <- factor(analytic.with.miss$income, \n                                    ordered = TRUE, \n                                levels = c(\"<25k\", \"Between.25kto54k\", \n                                           \"Between.55kto99k\", \n                                           \"Over100k\"))\n\n# features\ntable(analytic.with.miss$strata)\n#> \n#> 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 \n#> 510 638 695 554 605 653 612 693 735 551 689 609 604 596 510\ntable(analytic.with.miss$psu)\n#> \n#>    1    2 \n#> 4464 4790\ntable(analytic.with.miss$strata,analytic.with.miss$psu)\n#>      \n#>         1   2\n#>   134 215 295\n#>   135 316 322\n#>   136 320 375\n#>   137 306 248\n#>   138 308 297\n#>   139 278 375\n#>   140 315 297\n#>   141 282 411\n#>   142 349 386\n#>   143 232 319\n#>   144 351 338\n#>   145 339 270\n#>   146 277 327\n#>   147 335 261\n#>   148 241 269\n\n# impute\n# require(mice)\n# imputation1 <- mice(analytic.with.miss, seed = 123,\n#                    m = 1, # Number of multiple imputations. \n#                    maxit = 10 # Number of iteration; mostly useful for convergence\n#                    )\n# analytic.with.miss <- complete(imputation1)\n# plot_missing(analytic.with.miss)\n```\n:::\n\n\n#### Complete case data\n\nCreate a dataset (`analytic.data`) without `NA` values for analysis. This is done for simplified analysis, but this approach has it's own challenges. In a next tutorial, we will appropriately deal with missing observations in a propensity score modelling. \n\n\n::: {.cell hash='propensityscore3_cache/html/ccdata_e555aa0a61032bdd96f8995b89a4884d'}\n\n```{.r .cell-code}\ndim(analytic.with.miss)\n#> [1] 9254   15\nanalytic.data <- as.data.frame(na.omit(analytic.with.miss))\ndim(analytic.data) # complete case\n#> [1] 4167   15\n```\n:::\n\n\n### Zanutto (2006)\n\n-   Ref: [@zanutto2006comparison]\n\n\n#### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/bIzek3FumW0\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n\n\n#### Set seed\n\n\n::: {.cell hash='propensityscore3_cache/html/seed_fabf10c2fdb6d21cb8d8dd18d2b5240e'}\n\n```{.r .cell-code}\nset.seed(123)\n```\n:::\n\n\n-   \"it is not necessary to use survey-weighted estimation for the propensity score model\"\n\nPropensity score analysis in 4 steps:\n\n#### Step 1\n\nSpecify the propensity score model to estimate propensity scores\n\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep1_2e5e582634f5eb5534df4ffe8de350b4'}\n\n```{.r .cell-code}\nps.formula <- as.formula(diabetes ~ gender + born +\n                         race + education + married + income + bmi)\n```\n:::\n\n\n#### Step 2\n\nMatch treated and untreated subjects on the estimated propensity scores. Perform nearest-neighbor matching using the propensity scores. Visualize the distribution of propensity scores before and after matching.\n\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep2_4b34170d53dad92f247d00e9f3035c33'}\n\n```{.r .cell-code}\nrequire(MatchIt)\nset.seed(123)\n# This function fits propensity score model (using logistic \n# regression as above) when specified distance = 'logit'\n# performs nearest-neighbor (NN) matching, \n# without replacement \n# with caliper = .2*SD of propensity score  \n# within which to draw control units \n# with 1:1 ratio (pair-matching)\nmatch.obj <- matchit(ps.formula, data = analytic.data,\n                     distance = 'logit', \n                     method = \"nearest\", \n                     replace=FALSE,\n                     caliper = .2, \n                     ratio = 1)\n# see matchit function options here\n# https://www.rdocumentation.org/packages/MatchIt/versions/1.0-1/topics/matchit\nanalytic.data$PS <- match.obj$distance\nsummary(match.obj$distance)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.02901 0.12255 0.17658 0.18982 0.23876 0.82164\nplot(match.obj, type = \"jitter\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Zanstep2-1.png){width=672}\n:::\n\n```\n#> To identify the units, use first mouse button; to stop, use second.\nplot(match.obj, type = \"hist\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Zanstep2-2.png){width=672}\n:::\n\n```{.r .cell-code}\ntapply(analytic.data$PS, analytic.data$diabetes, summary)\n#> $`0`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.02901 0.11509 0.16687 0.17949 0.22816 0.75968 \n#> \n#> $`1`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.04793 0.16489 0.21300 0.23395 0.27768 0.82164\n# check how many matched\nmatch.obj\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: Propensity score [caliper]\n#>              - estimated with logistic regression\n#>  - caliper: <distance> (0.019)\n#>  - number of obs.: 4167 (original), 1564 (matched)\n#>  - target estimand: ATT\n#>  - covariates: gender, born, race, education, married, income, bmi\n# extract matched data\nmatched.data <- match.data(match.obj)\n```\n:::\n\n\n#### Step 3\n\ncompare the similarity of baseline characteristics between treated and untreated subjects in a the propensity score-matched sample. In this case, we will compare SMD \\< 0.2 or not.\n\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep3_778ebd5d4bcaa6920dde8ecd4057d40a'}\n\n```{.r .cell-code}\nrequire(tableone)\nbaselinevars <- c(\"gender\", \"born\", \"race\", \"education\", \n                  \"married\", \"income\", \"bmi\")\ntab1 <- CreateTableOne(strata = \"diabetes\", vars = baselinevars,\n                       data = analytic.data, test = FALSE)\nprint(tab1, smd = TRUE)\n#>                        Stratified by diabetes\n#>                         0             1             SMD   \n#>   n                      3376           791               \n#>   gender = Male (%)      1578 (46.7)    434 (54.9)   0.163\n#>   born (mean (SD))       1.00 (0.00)   1.00 (0.00)  <0.001\n#>   race (%)                                           0.060\n#>      Black                728 (21.6)    183 (23.1)        \n#>      Hispanic             727 (21.5)    170 (21.5)        \n#>      Other                642 (19.0)    159 (20.1)        \n#>      White               1279 (37.9)    279 (35.3)        \n#>   education (%)                                      0.185\n#>      College             1992 (59.0)    415 (52.5)        \n#>      High.School         1174 (34.8)    290 (36.7)        \n#>      School               210 ( 6.2)     86 (10.9)        \n#>   married (%)                                        0.316\n#>      Married             2027 (60.0)    488 (61.7)        \n#>      Never.married        631 (18.7)     70 ( 8.8)        \n#>      Previously.married   718 (21.3)    233 (29.5)        \n#>   income (%)                                         0.092\n#>      <25k                 830 (24.6)    225 (28.4)        \n#>      Between.25kto54k    1064 (31.5)    244 (30.8)        \n#>      Between.55kto99k     778 (23.0)    173 (21.9)        \n#>      Over100k             704 (20.9)    149 (18.8)        \n#>   bmi (mean (SD))       29.29 (7.11)  32.31 (8.03)   0.399\n```\n:::\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep3b_c0a8dbc7eeeb7b671506ceb7cee09fe5'}\n\n```{.r .cell-code}\ntab1m <- CreateTableOne(strata = \"diabetes\", vars = baselinevars, \n                        data = matched.data, test = FALSE)\nprint(tab1m, smd = TRUE)\n#>                        Stratified by diabetes\n#>                         0             1             SMD   \n#>   n                       782           782               \n#>   gender = Male (%)       422 (54.0)    430 (55.0)   0.021\n#>   born (mean (SD))       1.00 (0.00)   1.00 (0.00)  <0.001\n#>   race (%)                                           0.068\n#>      Black                180 (23.0)    179 (22.9)        \n#>      Hispanic             151 (19.3)    170 (21.7)        \n#>      Other                171 (21.9)    156 (19.9)        \n#>      White                280 (35.8)    277 (35.4)        \n#>   education (%)                                      0.077\n#>      College              441 (56.4)    411 (52.6)        \n#>      High.School          262 (33.5)    286 (36.6)        \n#>      School                79 (10.1)     85 (10.9)        \n#>   married (%)                                        0.044\n#>      Married              502 (64.2)    486 (62.1)        \n#>      Never.married         63 ( 8.1)     69 ( 8.8)        \n#>      Previously.married   217 (27.7)    227 (29.0)        \n#>   income (%)                                         0.065\n#>      <25k                 202 (25.8)    218 (27.9)        \n#>      Between.25kto54k     236 (30.2)    244 (31.2)        \n#>      Between.55kto99k     187 (23.9)    171 (21.9)        \n#>      Over100k             157 (20.1)    149 (19.1)        \n#>   bmi (mean (SD))       32.12 (8.29)  32.05 (7.58)   0.009\n```\n:::\n\n\n#### Step 4\n\nEstimate the effect of treatment on outcomes using propensity score-matched sample. Use the matched sample to estimate the treatment effect, considering survey design.\n\nIncorporating the survey design into both linear regression and propensity score analysis is crucial. Neglecting the survey weights can significantly impact the estimates, altering the representation of population-level effects.\n\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep4_9ad85200cd2e0dac991e44259734a610'}\n\n```{.r .cell-code}\nrequire(survey)\n# setup the design with survey features\nanalytic.with.miss$matched <- 0\nlength(analytic.with.miss$ID) # full data\n#> [1] 9254\nlength(matched.data$ID) # matched data\n#> [1] 1564\nlength(analytic.with.miss$ID[analytic.with.miss$ID %in% matched.data$ID])\n#> [1] 1564\nanalytic.with.miss$matched[analytic.with.miss$ID %in% matched.data$ID] <- 1\ntable(analytic.with.miss$matched)\n#> \n#>    0    1 \n#> 7690 1564\nw.design0 <- svydesign(strata=~strata, id=~psu, weights=~survey.weight, \n                      data=analytic.with.miss, nest=TRUE)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore3_cache/html/Zanstep4b_8861f519f6527f2b58389ecbc6681030'}\n\n```{.r .cell-code}\nout.formula <- as.formula(cholesterol.bin ~ diabetes)\nsfit <- svyglm(out.formula,family=binomial(logit), design = w.design.m)\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\nrequire(jtools)\nsumm(sfit, exp = TRUE, confint = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Observations </td>\n   <td style=\"text-align:right;\"> 1564 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Dependent variable </td>\n   <td style=\"text-align:right;\"> cholesterol.bin </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Type </td>\n   <td style=\"text-align:right;\"> Survey-weighted generalized linear model </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Family </td>\n   <td style=\"text-align:right;\"> binomial </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Link </td>\n   <td style=\"text-align:right;\"> logit </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (Cragg-Uhler) </td>\n   <td style=\"text-align:right;\"> 0.02 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (McFadden) </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> AIC </td>\n   <td style=\"text-align:right;\"> 1925.24 </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> exp(Est.) </th>\n   <th style=\"text-align:right;\"> 2.5% </th>\n   <th style=\"text-align:right;\"> 97.5% </th>\n   <th style=\"text-align:right;\"> t val. </th>\n   <th style=\"text-align:right;\"> p </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 1.33 </td>\n   <td style=\"text-align:right;\"> 0.97 </td>\n   <td style=\"text-align:right;\"> 1.80 </td>\n   <td style=\"text-align:right;\"> 1.79 </td>\n   <td style=\"text-align:right;\"> 0.09 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> diabetes </td>\n   <td style=\"text-align:right;\"> 1.68 </td>\n   <td style=\"text-align:right;\"> 1.17 </td>\n   <td style=\"text-align:right;\"> 2.41 </td>\n   <td style=\"text-align:right;\"> 2.84 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n</tbody>\n<tfoot><tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Standard errors: Robust</td></tr></tfoot>\n</table>\n`````\n:::\n:::\n\n\n### DuGoff et al. (2014)\n\n-   Ref: [@dugoff2014generalizing]\n\nPropensity score analysis in 4 steps (PATT)\n\n#### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/FPx5gF8gy9M\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n\n#### Step 1\n\nSpecify the propensity score model to estimate propensity scores. Similar to Zanutto but includes additional covariates in the model.\n\n\n::: {.cell hash='propensityscore3_cache/html/Dugstep1_d8f867a7f153236f9f6a91f6baf95cfa'}\n\n```{.r .cell-code}\n# response = exposure variable\n# independent variables = baseline covariates\nps.formula <- as.formula(diabetes ~ gender + born + race + education + \n                            married + income + bmi+\n                           psu+strata+survey.weight)\n```\n:::\n\n\n#### Step 2\n\nMatch treated and untreated subjects on the estimated propensity scores\n\n\n::: {.cell hash='propensityscore3_cache/html/Dugstep2_1fe72972d3b0ccdfc5de9f96d52a413e'}\n\n```{.r .cell-code}\nrequire(MatchIt)\nset.seed(123)\nmatch.obj <- matchit(ps.formula, data = analytic.data,\n                     distance = 'logit', \n                     method = \"nearest\", \n                     replace=FALSE,\n                     caliper = .2, \n                     ratio = 1)\nanalytic.data$PS <- match.obj$distance\nsummary(match.obj$distance)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.00363 0.11341 0.17509 0.18982 0.24765 0.80853\nplot(match.obj, type = \"jitter\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Dugstep2-1.png){width=672}\n:::\n\n```\n#> To identify the units, use first mouse button; to stop, use second.\nplot(match.obj, type = \"hist\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Dugstep2-2.png){width=672}\n:::\n\n```{.r .cell-code}\ntapply(analytic.data$PS, analytic.data$diabetes, summary)\n#> $`0`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.00363 0.10394 0.16243 0.17690 0.23461 0.73143 \n#> \n#> $`1`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.01182 0.17245 0.22748 0.24500 0.29948 0.80853\n# check how many matched\nmatch.obj\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: Propensity score [caliper]\n#>              - estimated with logistic regression\n#>  - caliper: <distance> (0.021)\n#>  - number of obs.: 4167 (original), 1570 (matched)\n#>  - target estimand: ATT\n#>  - covariates: gender, born, race, education, married, income, bmi, psu, strata, survey.weight\n# extract matched data\nmatched.data <- match.data(match.obj)\n```\n:::\n\n\n#### Step 3\n\nCompare the similarity of baseline characteristics between treated and untreated subjects in a the propensity score-matched sample. In this case, we will compare SMD \\< 0.2 or not.\n\n\n::: {.cell hash='propensityscore3_cache/html/Dugstep3_771f2d6f80c51cc5cdc1973aec205f0f'}\n\n```{.r .cell-code}\nrequire(tableone)\nbaselinevars <- c(\"gender\", \"born\", \"race\", \"education\", \n                  \"married\", \"income\", \"bmi\", \n                  \"psu\", \"strata\", \"survey.weight\")\nmatched.data$survey.weight <- as.numeric(as.character(matched.data$survey.weight))\nmatched.data$strata <- as.numeric(as.character(matched.data$strata))\ntab1m <- CreateTableOne(strata = \"diabetes\", vars = baselinevars, \n                        data = matched.data, test = FALSE)\nprint(tab1m, smd = TRUE)\n#>                            Stratified by diabetes\n#>                             0                   1                   SMD   \n#>   n                              785                 785                  \n#>   gender = Male (%)              433 (55.2)          431 (54.9)      0.005\n#>   born (mean (SD))              1.00 (0.00)         1.00 (0.00)     <0.001\n#>   race (%)                                                           0.048\n#>      Black                       193 (24.6)          180 (22.9)           \n#>      Hispanic                    163 (20.8)          170 (21.7)           \n#>      Other                       163 (20.8)          158 (20.1)           \n#>      White                       266 (33.9)          277 (35.3)           \n#>   education (%)                                                      0.032\n#>      College                     403 (51.3)          412 (52.5)           \n#>      High.School                 300 (38.2)          288 (36.7)           \n#>      School                       82 (10.4)           85 (10.8)           \n#>   married (%)                                                        0.030\n#>      Married                     473 (60.3)          484 (61.7)           \n#>      Never.married                71 ( 9.0)           70 ( 8.9)           \n#>      Previously.married          241 (30.7)          231 (29.4)           \n#>   income (%)                                                         0.035\n#>      <25k                        232 (29.6)          222 (28.3)           \n#>      Between.25kto54k            236 (30.1)          242 (30.8)           \n#>      Between.55kto99k            176 (22.4)          173 (22.0)           \n#>      Over100k                    141 (18.0)          148 (18.9)           \n#>   bmi (mean (SD))              31.92 (8.33)        32.09 (7.52)      0.020\n#>   psu = 2 (%)                    382 (48.7)          394 (50.2)      0.031\n#>   strata (mean (SD))          140.84 (4.24)       140.97 (4.23)      0.031\n#>   survey.weight (mean (SD)) 35647.01 (37699.98) 35596.81 (45212.82)  0.001\n```\n:::\n\n\n#### Step 4\n\nEstimate the effect of treatment on outcomes using propensity score-matched sample\n\n\n::: {.cell hash='propensityscore3_cache/html/Dugstep4_89b2dd9d23c83287fa03691c1e844532'}\n\n```{.r .cell-code}\n# setup the design with survey features\nanalytic.with.miss$matched <- 0\nlength(analytic.with.miss$ID) # full data\n#> [1] 9254\nlength(matched.data$ID) # matched data\n#> [1] 1570\nlength(analytic.with.miss$ID[analytic.with.miss$ID %in% matched.data$ID])\n#> [1] 1570\nanalytic.with.miss$matched[analytic.with.miss$ID %in% matched.data$ID] <- 1\ntable(analytic.with.miss$matched)\n#> \n#>    0    1 \n#> 7684 1570\nw.design0 <- svydesign(strata=~strata, id=~psu, weights=~survey.weight, \n                      data=analytic.with.miss, nest=TRUE)\nw.design.m <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore3_cache/html/Dugstep4b_922d6dc0583746c64628ec82ce5c19f8'}\n\n```{.r .cell-code}\nout.formula <- as.formula(cholesterol.bin ~ diabetes)\nsfit <- svyglm(out.formula,family=binomial, design = w.design.m)\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\nrequire(jtools)\nsumm(sfit, exp = TRUE, confint = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Observations </td>\n   <td style=\"text-align:right;\"> 1570 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Dependent variable </td>\n   <td style=\"text-align:right;\"> cholesterol.bin </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Type </td>\n   <td style=\"text-align:right;\"> Survey-weighted generalized linear model </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Family </td>\n   <td style=\"text-align:right;\"> binomial </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Link </td>\n   <td style=\"text-align:right;\"> logit </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (Cragg-Uhler) </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (McFadden) </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> AIC </td>\n   <td style=\"text-align:right;\"> 1918.09 </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> exp(Est.) </th>\n   <th style=\"text-align:right;\"> 2.5% </th>\n   <th style=\"text-align:right;\"> 97.5% </th>\n   <th style=\"text-align:right;\"> t val. </th>\n   <th style=\"text-align:right;\"> p </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 1.69 </td>\n   <td style=\"text-align:right;\"> 1.33 </td>\n   <td style=\"text-align:right;\"> 2.15 </td>\n   <td style=\"text-align:right;\"> 4.24 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> diabetes </td>\n   <td style=\"text-align:right;\"> 1.32 </td>\n   <td style=\"text-align:right;\"> 0.99 </td>\n   <td style=\"text-align:right;\"> 1.77 </td>\n   <td style=\"text-align:right;\"> 1.86 </td>\n   <td style=\"text-align:right;\"> 0.08 </td>\n  </tr>\n</tbody>\n<tfoot><tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Standard errors: Robust</td></tr></tfoot>\n</table>\n`````\n:::\n:::\n\n\n### Austin et al. (2018)\n\n-   Ref: [@austin2018propensity]\n\nPropensity score analysis in 4 steps (PATT)\n\n#### Video content (optional)\n\n::: callout-tip\nFor those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.\n:::\n\n::: {style=\"position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;\"}\n<iframe src=\"https://www.youtube.com/embed/UBp38smBtFA\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;\" allowfullscreen>\n\n</iframe>\n:::\n\n#### Step 1\n\nSpecify the propensity score model to estimate propensity scores. Use survey logistic regression to account for survey design in propensity score estimation.\n\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep1_150ed0bddbb367c4707faaa9f0c725c6'}\n\n```{.r .cell-code}\n# response = exposure variable\n# independent variables = baseline covariates\nps.formula <- as.formula(diabetes ~ gender + born + race + education + \n                            married + income + bmi)\nrequire(survey)\nanalytic.design <- svydesign(id=~psu,weights=~survey.weight, \n                             strata=~strata,\n                             data=analytic.data, nest=TRUE)\nps.fit <- svyglm(ps.formula, design=analytic.design, family=quasibinomial)\nanalytic.data$PS <- fitted(ps.fit)\nsummary(analytic.data$PS)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.01352 0.08788 0.13399 0.15120 0.19285 0.86375\n```\n:::\n\n\n#### Step 2\n\nMatch treated and untreated subjects on the estimated propensity scores. Two methods are explored: using the `Matching` package and the `MatchIt` package.\n\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep2a_3f479e113344d967ed32aa51376d5033'}\n\n```{.r .cell-code}\nrequire(Matching)\n#> Loading required package: Matching\n#> Warning: package 'Matching' was built under R version 4.3.1\n#> Loading required package: MASS\n#> \n#> Attaching package: 'MASS'\n#> The following object is masked from 'package:dplyr':\n#> \n#>     select\n#> ## \n#> ##  Matching (Version 4.10-14, Build Date: 2023-09-13)\n#> ##  See https://www.jsekhon.com for additional documentation.\n#> ##  Please cite software as:\n#> ##   Jasjeet S. Sekhon. 2011. ``Multivariate and Propensity Score Matching\n#> ##   Software with Automated Balance Optimization: The Matching package for R.''\n#> ##   Journal of Statistical Software, 42(7): 1-52. \n#> ##\nmatch.obj2 <- Match(Y=analytic.data$cholesterol, \n                    Tr=analytic.data$diabetes, \n                    X=analytic.data$PS, \n                    M=1, \n                    estimand = \"ATT\",\n                    replace=FALSE, \n                    caliper = 0.2)\nsummary(match.obj2)\n#> \n#> Estimate...  -15.287 \n#> SE.........  2.118 \n#> T-stat.....  -7.2175 \n#> p.val......  5.2958e-13 \n#> \n#> Original number of observations..............  4167 \n#> Original number of treated obs...............  791 \n#> Matched number of observations...............  781 \n#> Matched number of observations  (unweighted).  781 \n#> \n#> Caliper (SDs)........................................   0.2 \n#> Number of obs dropped by 'exact' or 'caliper'  10\nmatched.data2 <- analytic.data[c(match.obj2$index.treated, \n                                 match.obj2$index.control),]\ndim(matched.data2)\n#> [1] 1562   16\n```\n:::\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep2b_a29f52a83c9b2724c1ccf3b683a13e7a'}\n\n```{.r .cell-code}\nrequire(MatchIt)\nset.seed(123)\nmatch.obj <- matchit(ps.formula, data = analytic.data,\n                     distance = analytic.data$PS, \n                     method = \"nearest\", \n                     replace=FALSE,\n                     caliper = .2, \n                     ratio = 1)\nanalytic.data$PS <- match.obj$distance\nsummary(match.obj$distance)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.01352 0.08788 0.13399 0.15120 0.19285 0.86375\nplot(match.obj, type = \"jitter\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Ausstep2b-1.png){width=672}\n:::\n\n```\n#> To identify the units, use first mouse button; to stop, use second.\nplot(match.obj, type = \"hist\")\n```\n\n::: {.cell-output-display}\n![](propensityscore3_files/figure-html/Ausstep2b-2.png){width=672}\n:::\n\n```{.r .cell-code}\ntapply(analytic.data$PS, analytic.data$diabetes, summary)\n#> $`0`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.01352 0.08182 0.12644 0.14119 0.18267 0.75047 \n#> \n#> $`1`\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#> 0.02352 0.12362 0.16998 0.19389 0.23171 0.86375\n# check how many matched\nmatch.obj\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.019)\n#>  - number of obs.: 4167 (original), 1568 (matched)\n#>  - target estimand: ATT\n#>  - covariates: gender, born, race, education, married, income, bmi\n# extract matched data\nmatched.data2 <- match.data(match.obj)\ndim(matched.data2)\n#> [1] 1568   19\n```\n:::\n\n\n#### Step 3\n\nCompare the similarity of baseline characteristics between treated and untreated subjects in a the propensity score-matched sample. In this case, we will compare SMD \\< 0.2 or not.\n\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep3_4dc6e9b93f383bf3b93df2b302c33306'}\n\n```{.r .cell-code}\nbaselinevars <- c(\"gender\", \"born\", \"race\", \"education\", \n                  \"married\", \"income\", \"bmi\")\ntab1m <- CreateTableOne(strata = \"diabetes\", \n                           vars = baselinevars,\n                           data = matched.data2, test = FALSE)\nprint(tab1m, smd = TRUE)\n#>                        Stratified by diabetes\n#>                         0             1             SMD   \n#>   n                       784           784               \n#>   gender = Male (%)       405 (51.7)    431 (55.0)   0.067\n#>   born (mean (SD))       1.00 (0.00)   1.00 (0.00)  <0.001\n#>   race (%)                                           0.134\n#>      Black                163 (20.8)    182 (23.2)        \n#>      Hispanic             139 (17.7)    170 (21.7)        \n#>      Other                171 (21.8)    157 (20.0)        \n#>      White                311 (39.7)    275 (35.1)        \n#>   education (%)                                      0.040\n#>      College              428 (54.6)    413 (52.7)        \n#>      High.School          274 (34.9)    288 (36.7)        \n#>      School                82 (10.5)     83 (10.6)        \n#>   married (%)                                        0.070\n#>      Married              509 (64.9)    485 (61.9)        \n#>      Never.married         59 ( 7.5)     70 ( 8.9)        \n#>      Previously.married   216 (27.6)    229 (29.2)        \n#>   income (%)                                         0.063\n#>      <25k                 220 (28.1)    220 (28.1)        \n#>      Between.25kto54k     226 (28.8)    242 (30.9)        \n#>      Between.55kto99k     192 (24.5)    173 (22.1)        \n#>      Over100k             146 (18.6)    149 (19.0)        \n#>   bmi (mean (SD))       31.93 (8.16)  32.11 (7.61)   0.023\n```\n:::\n\n\n#### Step 4\n\nEstimate the effect of treatment on outcomes using propensity score-matched sample.\n\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep4_6188c9783742701996be4436b2d3a4a0'}\n\n```{.r .cell-code}\n# setup the design with survey features\nanalytic.with.miss$matched <- 0\nlength(analytic.with.miss$ID) # full data\n#> [1] 9254\nlength(matched.data2$ID) # matched data\n#> [1] 1568\nlength(analytic.with.miss$ID[analytic.with.miss$ID %in% matched.data2$ID])\n#> [1] 1568\nanalytic.with.miss$matched[analytic.with.miss$ID %in% matched.data2$ID] <- 1\ntable(analytic.with.miss$matched)\n#> \n#>    0    1 \n#> 7686 1568\nw.design0 <- svydesign(strata=~strata, id=~psu, weights=~survey.weight, \n                      data=analytic.with.miss, nest=TRUE)\nw.design.m2 <- subset(w.design0, matched == 1)\n```\n:::\n\n::: {.cell hash='propensityscore3_cache/html/Ausstep4b_dafb4990bf522c2efe935e987d77abee'}\n\n```{.r .cell-code}\nout.formula <- as.formula(cholesterol.bin ~ diabetes)\nsfit <- svyglm(out.formula,family=binomial, design = w.design.m2)\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n\nrequire(jtools)\nsumm(sfit, exp = TRUE, confint = TRUE)\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Observations </td>\n   <td style=\"text-align:right;\"> 1568 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Dependent variable </td>\n   <td style=\"text-align:right;\"> cholesterol.bin </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Type </td>\n   <td style=\"text-align:right;\"> Survey-weighted generalized linear model </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Family </td>\n   <td style=\"text-align:right;\"> binomial </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Link </td>\n   <td style=\"text-align:right;\"> logit </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (Cragg-Uhler) </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> Pseudo-R² (McFadden) </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> AIC </td>\n   <td style=\"text-align:right;\"> 1919.53 </td>\n  </tr>\n</tbody>\n</table> <table class=\"table table-striped table-hover table-condensed table-responsive\" style=\"width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:right;\"> exp(Est.) </th>\n   <th style=\"text-align:right;\"> 2.5% </th>\n   <th style=\"text-align:right;\"> 97.5% </th>\n   <th style=\"text-align:right;\"> t val. </th>\n   <th style=\"text-align:right;\"> p </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> (Intercept) </td>\n   <td style=\"text-align:right;\"> 1.46 </td>\n   <td style=\"text-align:right;\"> 1.15 </td>\n   <td style=\"text-align:right;\"> 1.86 </td>\n   <td style=\"text-align:right;\"> 3.11 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;font-weight: bold;\"> diabetes </td>\n   <td style=\"text-align:right;\"> 1.52 </td>\n   <td style=\"text-align:right;\"> 1.21 </td>\n   <td style=\"text-align:right;\"> 1.90 </td>\n   <td style=\"text-align:right;\"> 3.65 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n</tbody>\n<tfoot><tr><td style=\"padding: 0; \" colspan=\"100%\">\n<sup></sup> Standard errors: Robust</td></tr></tfoot>\n</table>\n`````\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}