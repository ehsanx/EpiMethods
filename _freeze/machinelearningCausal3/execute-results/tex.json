{
  "hash": "bbf8ac4ba0a911a1fcbaf7b6185e7349",
  "result": {
    "markdown": "## Binary Outcomes {.unnumbered}\n\n\n\n::: {.cell}\n\n:::\n\n\n\nFor this example we will be looking at the binary outcome variable `death`.\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/tab1bin_3033b8575b8250c8c389a463cdefa4ee'}\n\n```{.r .cell-code}\n# Data\nload(file = \"Data/machinelearningCausal/cl2.RData\")\n\n# Table 1\ntab1 <- CreateTableOne(vars = c(\"Death\"),\n                       data = ObsData, \n                       strata = \"RHC.use\", \n                       test = FALSE)\nprint(tab1, showAllLevels = FALSE, )\n#>                    Stratified by RHC.use\n#>                     0           1          \n#>   n                 3551        2184       \n#>   Death (mean (SD)) 0.63 (0.48) 0.68 (0.47)\n```\n:::\n\n\n\n### TMLE {.unnumbered}\n\nTMLE works by first constructing an initial outcome and extracting a crude estimate of the treatment effect. Then, TMLE aims to refine the initial estimate in the direction of the true value of the parameter of interest through use of the exposure model.\n\nTo label the treatment effect given by TMLE as causal, the same conditional exchangeability, positivity, and consistency assumptions must be met as for other modeling strategies (see [introduction to propensity score](propensityscore0.html)). TMLE also assumes that at least one of the exposure or outcome model is correctly specified. If this does not hold, TMLE does not necessarily produce a consistent estimator.\n\n::: column-margin\n@luque2018targeted discussed the implementation of TMLE, and providing a detailed step-by-step guide, primarily focusing on a binary outcome.\n:::\n\nThe basic steps are:\n\n1.  Construct initial outcome model & get crude estimate\n2.  Construct exposure model and use propensity scores to update the initial outcome model through a targeted adjustment\n3.  Extract treatment effect estimate\n4.  Estimate confidence interval based on a closed-form formula\n\nThe tmle package implements TMLE for both binary and continuous outcomes, and uses the SuperLearner to construct the exposure and outcome models.\n\nThe *tmle* method takes a number of parameters, including:\n\n\n\n\n```\n#> Warning: package 'knitr' was built under R version 4.2.3\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table table-striped table-hover table-condensed\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;font-weight: bold;color: white !important;background-color: #D3D3D3 !important;\"> Term </th>\n   <th style=\"text-align:left;font-weight: bold;color: white !important;background-color: #D3D3D3 !important;\"> Description </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> Y </td>\n   <td style=\"text-align:left;\"> Outcome vector </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> A </td>\n   <td style=\"text-align:left;\"> Exposure vector </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> W </td>\n   <td style=\"text-align:left;\"> Matrix that includes vectors of all covariates </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> family </td>\n   <td style=\"text-align:left;\"> Distribution </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> V </td>\n   <td style=\"text-align:left;\"> Cross-validation folds for exposure and outcome modeling </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Q.SL.library </td>\n   <td style=\"text-align:left;\"> Set of machine learning methods to use for SuperLearner for outcome modeling </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> g.SL.library </td>\n   <td style=\"text-align:left;\"> Set of machine learning methods to use for SuperLearner for exposure modeling </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n\n\n\n### Constructing SuperLearner {.unnumbered}\n\nWe will need to specify two SuperLearners, one for the exposure and one for the outcome model. We will need to consider the characteristics of our sample in order to decide the number of cross-validation folds and construct a diverse and computationally feasible library of algorithms.\n\n#### Number of folds {.unnumbered}\n\nFirst, we need to define the number of cross-validation folds to use for each model. This depends on our effective sample size [@phillips2023ConsiderationsSL].\n\nOur effective sample size for the outcome model is:\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-3_1513c5918884d945f030ab802e3900a0'}\n\n```{.r .cell-code}\nn <- nrow(ObsData) \np <- nrow(ObsData[ObsData$Death == 1,])/n \nn_eff <- min(n, 5*(n*min(p, 1-p))) \nn_eff\n#> [1] 5735\n```\n:::\n\n\n\nOur effective sample size for the exposure model is:\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-4_d8f55155177f8f363de2d65fab005d8a'}\n\n```{.r .cell-code}\np_exp <- nrow(ObsData[ObsData$RHC.use == 1,])/n \nn_eff_exp <- min(n, 5*(n*min(p, 1-p))) \nn_eff_exp\n#> [1] 5735\n```\n:::\n\n\n\nFor both models, the effective sample size is the same as our sample size, $n = 5,735$.\n\nSince $5,000 \\leq n_{eff} \\leq 10,000$, we should use 5 or more cross-validation folds according to @phillips2023ConsiderationsSL. For the sake of computational feasibility, we will use **5 folds** in this example.\n\n#### Candidate learners {.unnumbered}\n\nThe second step is to define the library of learners we will feed in to SuperLearner as potential options for each model (exposure and outcome). In this example, some of our covariates are continuous variables, such as temperature and blood pressure, so we need to include learners that allow non-linear/monotonic relationships.\n\nSince $n$ is large ($>5000$), we should include as many learners as is computationally feasible in our libraries.\n\nFurthermore, we have 50 covariates:\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-5_60f30a86d0504c5c395366e669bac6f3'}\n\n```{.r .cell-code}\nlength(c(baselinevars, \"Length.of.Stay\"))\n#> [1] 50\n```\n:::\n\n\n\n$5735/20 = 286.75$, and $50<286.75$, so we do not have high-dimensional data and including screeners is optional [@phillips2023ConsiderationsSL].\n\nSince the requirements for the exposure and outcome models are the same in this example, we will use the same SuperLearner library for both. Overall for this example we need to make sure to include:\n\n-   Parametric learners\n\n-   Highly data-adaptive learners\n\n-   Multiple variants of the same learner with different parameter specifications\n\n-   Learners that allow non-linear/monotonic relationships\n\nFor this example, we will include the following learners:\n\n-   Parametric\n\n    -   `SL.mean`: only mean\n\n    -   `SL.glm`: generalized linear model\n\n-   Highly data-adaptive\n\n    -   `SL.glmnet`: penalized regression such as lasso\n\n    -   `SL.xgboost`: extreme gradient boosting\n\n-   Allowing non-linear/monotonic relationships\n\n    -   `SL.randomForest`: random forest\n\n    -   `tmle.SL.dbarts2`: bayesian additive regression tree\n\n    -   `SL.svm`: support vector machine\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-6_14f0c8ebf3c6b005abd60967baa534a7'}\n\n```{.r .cell-code}\n# Construct the SuperLearner library\nSL.library <- c(\"SL.mean\", \n                \"SL.glm\", \n                \"SL.glmnet\", \n                \"SL.xgboost\", \n                \"SL.randomForest\", \n                \"tmle.SL.dbarts2\", \n                \"SL.svm\")\n```\n:::\n\n\n\n### TMLE with SuperLearner {.unnumbered}\n\nTo run TMLE, we need to install the tmle package and load it on the R environment.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#install.packages(c('tmle', 'xgboost'))\nrequire(tmle)\nrequire(xgboost)\n```\n:::\n\n\n\nWe also need to create a data frame containing only the covariates:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nObsData.noYA <- dplyr::select(ObsData, \n                              !c(Death, RHC.use))\nObsData$Death <- as.numeric(ObsData$Death)\n```\n:::\n\n\n\nThen we can run TMLE using the `tmle` method from the `tmle` package:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1444) \n\ntmle.fit <- tmle::tmle(Y = ObsData$Death, \n                   A = ObsData$RHC.use, \n                   W = ObsData.noYA, \n                   family = \"binomial\", \n                   V.Q = 5,\n                   V.g = 5,\n                   Q.SL.library = SL.library, \n                   g.SL.library = SL.library)\n\ntmle.est.bin <- tmle.fit$estimates$OR$psi\ntmle.ci.bin <- tmle.fit$estimates$OR$CI\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-11_c4aa706c5e150f8083359a65ebec8330'}\n\n:::\n\n\n\nATE for binary outcome using user-specified library: 1.28 and 95% CI is 1.1992981, 1.3761869\n\nThese results show those who received RHC had odds of death that were 1.28 times as high as the odds of death in those who did not receive RHC.\n\n### Understanding defaults {.unnumbered}\n\nWe can compare the results using our specified SuperLearner library to the results we would get when using the `tmle` package's default SuperLearner libraries. To do this we simply do not specify libraries for the `Q.SL.library` and `g.SL.library` arguments.\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-12_86fd10289400d4e6b395358aea7b9890'}\n\n```{.r .cell-code}\n# small test library \n# with only glm just \n# for sake of making this work\nSL.library.test <- c(\"SL.glm\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1444) \n\ntmle.fit.def <- tmle::tmle(Y = ObsData$Death, \n                           A = ObsData$RHC.use, \n                           W = ObsData.noYA, \n                           family = \"binomial\", \n                           V.Q = 5,\n                           V.g = 5)\n# Q.SL.library = SL.library.test,  ## removed this line\n# g.SL.library = SL.library.test)  ## removed this line\n\ntmle.est.bin.def <- tmle.fit.def$estimates$OR$psi\ntmle.ci.bin.def <- tmle.fit.def$estimates$OR$CI\n```\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-15_2ff41bb192dbf137bc749c39a5fc5b04'}\n\n:::\n\n\n\nATE for binary outcome using default library: 1.32 with 95% CI 1.1466162, 1.5219877.\n\nThese ATE when using the default SuperLearner library (1.31) is very close to the ATE when using our user-specified SuperLearner library (1.29). However, the confidence interval from TMLE using the default SuperLearner library (1.17, 1.46) is slightly wider than the confidence interval from TMLE using our user-specified SuperLearner library (1.20, 1.39).\n\n### Comparison of results {.unnumbered}\n\nWe can also compare these results to those from a basic regression and from the literature.\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/reg1bin_d89dc0884ff78d73e51ee653245d1b39'}\n\n:::\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/reg2bin_4f1fbcc388522f2053f2e6d0e88edabf'}\n\n```{.r .cell-code}\n# adjust the exposure variable \n# (primary interest) + covariates\nbaselineVars.Death <- c(baselinevars, \"Length.of.Stay\")\nout.formula.bin <- as.formula(\n  paste(\"Death~ RHC.use +\",\n        paste(baselineVars.Death, \n              collapse = \"+\")))\nfit1.bin <- glm(out.formula.bin, data = ObsData, family=\"binomial\")\n```\n:::\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/unnamed-chunk-16_9265c611590756636e478e37d50bd535'}\n\n:::\n\n\n\n@connors1996effectiveness conducted a propensity score matching analysis. Table 4 showed that, after propensity score pair (1-to-1) matching, the odds of in-hospital mortality were 39% higher in those who received RHC (OR: 1.39 (1.15, 1.67)).\n\n\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/summarytable0bin_c8c53498cad73dc44cb5213ad07b17a6'}\n\n:::\n\n::: {.cell hash='machinelearningCausal3_cache/pdf/summarytablebin_298fc96679d4fae2531ebc29a21628da'}\n::: {.cell-output-display}\n\\begin{tabular}{l|r|r|r}\n\\hline\nmethod.list & Estimate & 2.5 \\% & 97.5 \\%\\\\\n\\hline\nAdjusted Regression & 0.07 & 0.04 & 0.09\\\\\n\\hline\nTMLE (user-specified SL library) & 1.28 & 1.20 & 1.38\\\\\n\\hline\nTMLE (default SL library) & 1.32 & 1.15 & 1.52\\\\\n\\hline\nConnors et al. (1996) paper & 1.39 & 1.15 & 1.67\\\\\n\\hline\n\\end{tabular}\n:::\n:::\n\n\n\n### References {.unnumbered}\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{\"knit_meta_id\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"unnamed-chunk-2\",\"unnamed-chunk-2\"]}},\"value\":[{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"booktabs\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"longtable\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"array\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"multirow\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"wrapfig\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"float\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"colortbl\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"pdflscape\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"tabu\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"threeparttable\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"threeparttablex\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"ulem\"]},{\"type\":\"character\",\"attributes\":{},\"value\":[\"normalem\"]},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"makecell\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"options\",\"extra_lines\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"latex_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"xcolor\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"version\",\"src\",\"meta\",\"script\",\"stylesheet\",\"head\",\"attachment\",\"package\",\"all_files\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"html_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"kePrint\"]},{\"type\":\"character\",\"attributes\":{},\"value\":[\"0.0.1\"]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"file\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"C:/Users/wilds/AppData/Local/R/win-library/4.2/kableExtra/kePrint-0.0.1\"]}]},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"kePrint.js\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"logical\",\"attributes\":{},\"value\":[true]}]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"name\",\"version\",\"src\",\"meta\",\"script\",\"stylesheet\",\"head\",\"attachment\",\"package\",\"all_files\"]},\"class\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"html_dependency\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"lightable\"]},{\"type\":\"character\",\"attributes\":{},\"value\":[\"0.0.1\"]},{\"type\":\"list\",\"attributes\":{\"names\":{\"type\":\"character\",\"attributes\":{},\"value\":[\"file\"]}},\"value\":[{\"type\":\"character\",\"attributes\":{},\"value\":[\"C:/Users/wilds/AppData/Local/R/win-library/4.2/kableExtra/lightable-0.0.1\"]}]},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"character\",\"attributes\":{},\"value\":[\"lightable.css\"]},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"NULL\"},{\"type\":\"logical\",\"attributes\":{},\"value\":[true]}]}]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}