{
  "hash": "93bd78eb2c2d564fde45da60c9e540db",
  "result": {
    "engine": "knitr",
    "markdown": "## PSM with MI in subset {.unnumbered}\n\n\n\n\n\n### Problem\n\nIn this chapter, we will use **propensity score matching (PSM)** with **multiple imputation**, focusing on specific subpopulations defined by the study's eligibility criteria. We will use PSM as per @dugoff2014generalizing recommendation, with SMD cut-point 0.2 and adjust for imbalanced and/or all covariates in the outcome model, if any.\n\nThe modified dataset from NHANES 2017- 2018, which was also used in **missing data** [subpopulations chapter](missingdata5.html), will be used. This example aims to *demonstrate how to do the missing data analysis using multiple imputation with PSM in the context of complex surveys*.\n\n### Pre-processing\n\n#### Load data\n\nLet us import the dataset:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nload(\"Data/missingdata/MIexample.RData\")\nls()\n#> [1] \"dat.full\"\n```\n:::\n\n\n#### Variables\n\nThe dataset (`dat.full`) contains 9,254 subjects with 15 variables:\n\n**Survey information**\n\n-   `studyid`: Respondent sequence number\n-   `survey.weight`: Full sample 2 year interview weight\n-   `psu`: Masked pseudo PSU\n-   `strata`: Masked pseudo strata\n\n**Outcome variable**\n\n-   `cvd`: Whether having cardiovascular disease\n\n**Exposure variable**\n\n-   `rheumatoid`: Whether having rheumatoid arthritis\n\n**Covariates**\n\n-   `age`: age in years at screening\n-   `sex`\n-   `education`\n-   `race`: Race/Ethnicity\n-   `income`: Family income in \\$\n-   `bmi`: Body Mass Index in kg/m$^2$\n-   `smoking`: Smoking status\n-   `htn`: Having hypertension\n-   `diabetes`: Having diabetes\n\n#### Data pre-processng\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Categorical age\ndat.full$age.cat <- with(dat.full, ifelse(age >= 20 & age < 50, \"20-49\", \n                                  ifelse(age >= 50 & age < 65, \"50-64\", \"65+\")))\ndat.full$age.cat <- factor(dat.full$age.cat, levels = c(\"20-49\", \"50-64\", \"65+\"))\ntable(dat.full$age.cat, useNA = \"always\")\n#> \n#> 20-49 50-64   65+  <NA> \n#>  2500  1569  5185     0\n\n# Recode rheumatoid to arthritis\ndat.full$arthritis <- car::recode(dat.full$rheumatoid, \" 'No' = 'No arthritis';\n                                      'Yes' = 'Rheumatoid arthritis' \", as.factor = T)\ntable(dat.full$arthritis, useNA = \"always\")\n#> \n#>         No arthritis Rheumatoid arthritis                 <NA> \n#>                 3857                  337                 5060\n```\n:::\n\n\n#### Subsetting according to eligibility\n\nWe will create the analytic dataset with\n\n-   adults aged 20 years or more\n-   without missing values in outcome (cvd) or exposure (rheumatoid arthritis).\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Drop < 20 years\ndat.with.miss <- subset(dat.full, age >= 20)\n\n# Frequency for outcome and exposure \ntable(dat.with.miss$cvd, useNA = \"always\") # 6 missing\n#> \n#>   No  Yes <NA> \n#> 4872  691    6\ntable(dat.with.miss$rheumatoid, useNA = \"always\") # 1375 missing\n#> \n#>   No  Yes <NA> \n#> 3857  337 1375\n\n# Drop missing in outcome and exposure - dataset with missing values only in covariates\ndat.analytic <- dat.with.miss[complete.cases(dat.with.miss$cvd),]\ndat.analytic <- dat.analytic[complete.cases(dat.analytic$rheumatoid),]\nnrow(dat.analytic)\n#> [1] 4191\n```\n:::\n\n\nWe have 4,191 participants in our analytic dataset. The **general strategy of solution** to implement PSM with MI is as follows:\n\n-   We will build the imputation model on 4,191 eligible subjects, and\n-   Apply PSM on each of the imputed datasets, where we will utilize survey features for population-level estimate\n-   Pool the estimates using Rubin's rule\n\n#### variable summary\n\nLet us see the summary statistics as we did in the missing data analysis:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Keep only relevant variables\nvars <-  c(\"studyid\", \"survey.weight\", \"psu\", \"strata\", \"cvd\", \"arthritis\", \"age.cat\", \n           \"sex\", \"education\", \"race\", \"income\", \"bmi\", \"smoking\", \"htn\", \"diabetes\")\ndat.analytic2 <- dat.analytic[, vars]\n\n# Create Table 1\nvars <- c(\"arthritis\", \"age.cat\", \"sex\", \"education\", \"race\", \"income\", \"bmi\", \"smoking\",\n          \"htn\", \"diabetes\")\ntab1 <- CreateTableOne(vars = vars, strata = \"cvd\", data = dat.analytic2, includeNA = F,\n                       addOverall = T, test = F)\nprint(tab1, format = \"f\", showAllLevels = T)\n#>                  Stratified by cvd\n#>                   level                     Overall      No          \n#>   n                                          4191         3823       \n#>   arthritis       No arthritis               3854         3580       \n#>                   Rheumatoid arthritis        337          243       \n#>   age.cat         20-49                      2280         2240       \n#>                   50-64                      1097          979       \n#>                   65+                         814          604       \n#>   sex             Male                       2126         1884       \n#>                   Female                     2065         1939       \n#>   education       Less than high school       828          728       \n#>                   High school                2292         2094       \n#>                   College graduate or above  1063          993       \n#>   race            White                      1275         1113       \n#>                   Black                       998          898       \n#>                   Hispanic                   1015          958       \n#>                   Others                      903          854       \n#>   income          less than $20,000           659          557       \n#>                   $20,000 to $74,999         1967         1796       \n#>                   $75,000 and Over           1143         1079       \n#>   bmi (mean (SD))                           29.28 (7.19) 29.20 (7.18)\n#>   smoking         Never smoker               2570         2427       \n#>                   Previous smoker             882          726       \n#>                   Current smoker              739          670       \n#>   htn             No                         1424         1380       \n#>                   Yes                        2415         2107       \n#>   diabetes        No                         3622         3396       \n#>                   Yes                         566          424       \n#>                  Stratified by cvd\n#>                   Yes         \n#>   n                 368       \n#>   arthritis         274       \n#>                      94       \n#>   age.cat            40       \n#>                     118       \n#>                     210       \n#>   sex               242       \n#>                     126       \n#>   education         100       \n#>                     198       \n#>                      70       \n#>   race              162       \n#>                     100       \n#>                      57       \n#>                      49       \n#>   income            102       \n#>                     171       \n#>                      64       \n#>   bmi (mean (SD)) 30.09 (7.29)\n#>   smoking           143       \n#>                     156       \n#>                      69       \n#>   htn                44       \n#>                     308       \n#>   diabetes          226       \n#>                     142\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# missingness\nDataExplorer::plot_missing(dat.analytic2)\n```\n\n::: {.cell-output-display}\n![](propensityscore7_files/figure-html/miss0-1.png){width=80%}\n:::\n:::\n\n\n### Dealing with missing values in covariates\n\nSimilar to the [previous exercise](missingdata5.html), we will create 5 imputed datasets with 3 iterations, and the predictive mean matching method for bmi and income. We will use the strata variable as an auxiliary variable in the imputation model but not the survey weight or PSU variable.\n\n#### Step 0: Set up the imputation model\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 0: Set imputation model\nini <- mice(data = dat.analytic2, maxit = 0, print = FALSE)\npred <- ini$pred\n\n# Use the strata variable as an auxiliary variable in the imputation model\npred[\"strata\",] <- 0\n\n# Do not use survey weight or PSU variable as auxiliary variables\npred[,\"studyid\"] <- pred[\"studyid\",] <- 0\npred[,\"psu\"] <- pred[\"psu\",] <- 0\npred[,\"survey.weight\"] <- pred[\"survey.weight\",] <- 0\n\n# Set imputation method\nmeth <- ini$meth\nmeth[\"bmi\"] <- \"pmm\"\nmeth[\"income\"] <- \"pmm\"\nmeth\n#>       studyid survey.weight           psu        strata           cvd \n#>            \"\"            \"\"            \"\"            \"\"            \"\" \n#>     arthritis       age.cat           sex     education          race \n#>            \"\"            \"\"            \"\"     \"polyreg\"            \"\" \n#>        income           bmi       smoking           htn      diabetes \n#>         \"pmm\"         \"pmm\"            \"\"      \"logreg\"      \"logreg\"\n```\n:::\n\n\n#### Step 1: Imputing missing values using mice for eligible subjects\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Step 1: impute the incomplete data\nimputation <- mice(data = dat.analytic2,\n                   seed = 123,\n                   predictorMatrix = pred,\n                   method = meth,\n                   m = 5,\n                   maxit = 3,\n                   print = FALSE)\n```\n:::\n\n\nLet us save the datasets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsave(dat.full, dat.analytic, dat.analytic2, imputation, \n     file = \"Data/propensityscore/analytic_imputed.RData\")\n```\n:::\n\n\nNow we will combine m = 5 datasets and create a stacked dataset. This dataset should contain 5\\*4,191 = 20,955 rows.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimpdata <- mice::complete(imputation, action=\"long\")\ndim(impdata)\n#> [1] 20955    17\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Remove .id variable from the model as it was created in an intermediate step\nimpdata$.id <- NULL\n\n# Number of subjects\nnrow(impdata)\n#> [1] 20955\n\n# Missing after imputation\nDataExplorer::plot_missing(impdata)\n```\n\n::: {.cell-output-display}\n![](propensityscore7_files/figure-html/step1c-1.png){width=672}\n:::\n:::\n\n\nThere is no missing value after imputation. There is an additional variable (`.imp`) in the imputed dataset, which goes from 1 to m = 5, indicating the first to the fifth imputed datasets.\n\n#### Step 2: PSM steps 1-3 by DuGoff et al. (2014)\n\nOur next step is to use steps 1-3 of the PSM analysis:\n\n-   Step 2.1: Fit the PS model by considering survey features as covariates.\n-   Step 2.2: Match an exposed subject without replacement within the caliper of 0.2 times the standard deviation of the logit of PS.\n-   Step 2.3: Balance checking using SMD. Consider SMD \\<0.2 as a good covariate balancing.\n\n##### Step 2.1: PS model specification\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Specify the PS model to estimate propensity scores\nps.formula <- as.formula(I(arthritis == \"Rheumatoid arthritis\") ~ age.cat + sex + \n                           education + race + income + bmi + smoking + htn + \n                           diabetes + psu + strata + survey.weight)\n```\n:::\n\n\n##### Step 2.2: Estimating PS and matching for each imputed dataset\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Null vector or list to store values\ncaliper <- NULL\ndat.matched <- match.obj <- list(NULL)\n\nm <- 5 # 5 imputed dataset\n\n# PSM on each of the imputed datasets\nfor (ii in 1:m) {\n  # Imputed dataset\n  dat.imputed <- subset(impdata, .imp == ii)\n  \n  # Propensity scores\n  ps.fit <- glm(ps.formula, data = dat.imputed, family = binomial(\"logit\"))\n  dat.imputed$ps <- fitted(ps.fit)\n  \n  # Caliper fixing to 0.2*sd(logit of PS)\n  caliper[ii] <- 0.2*sd(log(dat.imputed$ps/(1-dat.imputed$ps)))\n  \n  # 1:1 PS matching  \n  set.seed(504)\n  match.obj[[ii]] <- matchit(ps.formula, data = dat.imputed,\n                        distance = dat.imputed$ps, \n                        method = \"nearest\", \n                        replace = FALSE,\n                        caliper = caliper[ii], \n                        ratio = 1)\n  dat.imputed$ps <- match.obj[[ii]]$distance\n  \n  # Extract matched data\n  dat.matched[[ii]] <- match.data(match.obj[[ii]]) \n}\nmatch.obj\n#> [[1]]\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.021)\n#>  - number of obs.: 4191 (original), 668 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age.cat, sex, education, race, income, bmi, smoking, htn, diabetes, psu, strata, survey.weight\n#> \n#> [[2]]\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.02)\n#>  - number of obs.: 4191 (original), 666 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age.cat, sex, education, race, income, bmi, smoking, htn, diabetes, psu, strata, survey.weight\n#> \n#> [[3]]\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.021)\n#>  - number of obs.: 4191 (original), 672 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age.cat, sex, education, race, income, bmi, smoking, htn, diabetes, psu, strata, survey.weight\n#> \n#> [[4]]\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.021)\n#>  - number of obs.: 4191 (original), 664 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age.cat, sex, education, race, income, bmi, smoking, htn, diabetes, psu, strata, survey.weight\n#> \n#> [[5]]\n#> A matchit object\n#>  - method: 1:1 nearest neighbor matching without replacement\n#>  - distance: User-defined [caliper]\n#>  - caliper: <distance> (0.021)\n#>  - number of obs.: 4191 (original), 662 (matched)\n#>  - target estimand: ATT\n#>  - covariates: age.cat, sex, education, race, income, bmi, smoking, htn, diabetes, psu, strata, survey.weight\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Dimension of each of the matched dataset\nlapply(dat.matched, dim)\n#> [[1]]\n#> [1] 668  20\n#> \n#> [[2]]\n#> [1] 666  20\n#> \n#> [[3]]\n#> [1] 672  20\n#> \n#> [[4]]\n#> [1] 664  20\n#> \n#> [[5]]\n#> [1] 662  20\n```\n:::\n\n\n##### Step 2.3: Balance checking for each imputed dataset\n\nNow we will check balance in terms of SMD on each dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntab1m <- list(NULL)\nfor (ii in 1:m) {\n  # Matched data\n  dat <- dat.matched[[ii]]\n  \n  # Covariates\n  vars <- c(\"age.cat\", \"sex\", \"education\", \"race\", \"income\", \"bmi\", \"smoking\", \n            \"htn\", \"diabetes\")\n  \n  # Balance checking \n  tab1m[[ii]] <- CreateTableOne(strata = \"arthritis\", vars = vars, data = dat, test = F)\n}\nprint(tab1m, smd = TRUE)\n#> [[1]]\n#>                               Stratified by arthritis\n#>                                No arthritis  Rheumatoid arthritis SMD   \n#>   n                              334           334                      \n#>   age.cat (%)                                                      0.018\n#>      20-49                        51 (15.3)     52 (15.6)               \n#>      50-64                       131 (39.2)    133 (39.8)               \n#>      65+                         152 (45.5)    149 (44.6)               \n#>   sex = Female (%)               172 (51.5)    178 (53.3)          0.036\n#>   education (%)                                                    0.034\n#>      Less than high school        80 (24.0)     84 (25.1)               \n#>      High school                 204 (61.1)    203 (60.8)               \n#>      College graduate or above    50 (15.0)     47 (14.1)               \n#>   race (%)                                                         0.049\n#>      White                       105 (31.4)    103 (30.8)               \n#>      Black                       107 (32.0)    112 (33.5)               \n#>      Hispanic                     67 (20.1)     69 (20.7)               \n#>      Others                       55 (16.5)     50 (15.0)               \n#>   income (%)                                                       0.073\n#>      less than $20,000            95 (28.4)    100 (29.9)               \n#>      $20,000 to $74,999          162 (48.5)    167 (50.0)               \n#>      $75,000 and Over             77 (23.1)     67 (20.1)               \n#>   bmi (mean (SD))              30.62 (8.16)  30.54 (7.34)          0.011\n#>   smoking (%)                                                      0.052\n#>      Never smoker                158 (47.3)    161 (48.2)               \n#>      Previous smoker             102 (30.5)    106 (31.7)               \n#>      Current smoker               74 (22.2)     67 (20.1)               \n#>   htn = Yes (%)                  283 (84.7)    279 (83.5)          0.033\n#>   diabetes = Yes (%)             106 (31.7)    100 (29.9)          0.039\n#> \n#> [[2]]\n#>                               Stratified by arthritis\n#>                                No arthritis  Rheumatoid arthritis SMD   \n#>   n                              333           333                      \n#>   age.cat (%)                                                      0.055\n#>      20-49                        50 (15.0)     52 (15.6)               \n#>      50-64                       142 (42.6)    133 (39.9)               \n#>      65+                         141 (42.3)    148 (44.4)               \n#>   sex = Female (%)               172 (51.7)    176 (52.9)          0.024\n#>   education (%)                                                    0.068\n#>      Less than high school        92 (27.6)     84 (25.2)               \n#>      High school                 191 (57.4)    202 (60.7)               \n#>      College graduate or above    50 (15.0)     47 (14.1)               \n#>   race (%)                                                         0.146\n#>      White                        91 (27.3)    104 (31.2)               \n#>      Black                       100 (30.0)    110 (33.0)               \n#>      Hispanic                     79 (23.7)     69 (20.7)               \n#>      Others                       63 (18.9)     50 (15.0)               \n#>   income (%)                                                       0.131\n#>      less than $20,000           115 (34.5)     96 (28.8)               \n#>      $20,000 to $74,999          166 (49.8)    175 (52.6)               \n#>      $75,000 and Over             52 (15.6)     62 (18.6)               \n#>   bmi (mean (SD))              30.50 (7.88)  30.51 (7.46)          0.001\n#>   smoking (%)                                                      0.015\n#>      Never smoker                160 (48.0)    161 (48.3)               \n#>      Previous smoker             104 (31.2)    105 (31.5)               \n#>      Current smoker               69 (20.7)     67 (20.1)               \n#>   htn = Yes (%)                  288 (86.5)    278 (83.5)          0.084\n#>   diabetes = Yes (%)              97 (29.1)     99 (29.7)          0.013\n#> \n#> [[3]]\n#>                               Stratified by arthritis\n#>                                No arthritis  Rheumatoid arthritis SMD   \n#>   n                              336           336                      \n#>   age.cat (%)                                                      0.077\n#>      20-49                        46 (13.7)     52 (15.5)               \n#>      50-64                       145 (43.2)    133 (39.6)               \n#>      65+                         145 (43.2)    151 (44.9)               \n#>   sex = Female (%)               176 (52.4)    179 (53.3)          0.018\n#>   education (%)                                                    0.076\n#>      Less than high school        80 (23.8)     86 (25.6)               \n#>      High school                 215 (64.0)    203 (60.4)               \n#>      College graduate or above    41 (12.2)     47 (14.0)               \n#>   race (%)                                                         0.084\n#>      White                       114 (33.9)    105 (31.2)               \n#>      Black                       114 (33.9)    112 (33.3)               \n#>      Hispanic                     59 (17.6)     69 (20.5)               \n#>      Others                       49 (14.6)     50 (14.9)               \n#>   income (%)                                                       0.118\n#>      less than $20,000            87 (25.9)    104 (31.0)               \n#>      $20,000 to $74,999          183 (54.5)    166 (49.4)               \n#>      $75,000 and Over             66 (19.6)     66 (19.6)               \n#>   bmi (mean (SD))              30.56 (7.71)  30.54 (7.53)          0.003\n#>   smoking (%)                                                      0.127\n#>      Never smoker                180 (53.6)    161 (47.9)               \n#>      Previous smoker              89 (26.5)    107 (31.8)               \n#>      Current smoker               67 (19.9)     68 (20.2)               \n#>   htn = Yes (%)                  280 (83.3)    281 (83.6)          0.008\n#>   diabetes = Yes (%)             104 (31.0)    102 (30.4)          0.013\n#> \n#> [[4]]\n#>                               Stratified by arthritis\n#>                                No arthritis  Rheumatoid arthritis SMD   \n#>   n                              332           332                      \n#>   age.cat (%)                                                      0.062\n#>      20-49                        48 (14.5)     52 (15.7)               \n#>      50-64                       127 (38.3)    133 (40.1)               \n#>      65+                         157 (47.3)    147 (44.3)               \n#>   sex = Female (%)               174 (52.4)    175 (52.7)          0.006\n#>   education (%)                                                    0.059\n#>      Less than high school        79 (23.8)     85 (25.6)               \n#>      High school                 200 (60.2)    200 (60.2)               \n#>      College graduate or above    53 (16.0)     47 (14.2)               \n#>   race (%)                                                         0.034\n#>      White                       100 (30.1)    105 (31.6)               \n#>      Black                       111 (33.4)    108 (32.5)               \n#>      Hispanic                     71 (21.4)     69 (20.8)               \n#>      Others                       50 (15.1)     50 (15.1)               \n#>   income (%)                                                       0.067\n#>      less than $20,000            93 (28.0)     95 (28.6)               \n#>      $20,000 to $74,999          165 (49.7)    172 (51.8)               \n#>      $75,000 and Over             74 (22.3)     65 (19.6)               \n#>   bmi (mean (SD))              30.06 (7.85)  30.46 (7.49)          0.052\n#>   smoking (%)                                                      0.053\n#>      Never smoker                166 (50.0)    161 (48.5)               \n#>      Previous smoker              97 (29.2)    105 (31.6)               \n#>      Current smoker               69 (20.8)     66 (19.9)               \n#>   htn = Yes (%)                  281 (84.6)    278 (83.7)          0.025\n#>   diabetes = Yes (%)              93 (28.0)     98 (29.5)          0.033\n#> \n#> [[5]]\n#>                               Stratified by arthritis\n#>                                No arthritis  Rheumatoid arthritis SMD   \n#>   n                              331           331                      \n#>   age.cat (%)                                                      0.026\n#>      20-49                        50 (15.1)     52 (15.7)               \n#>      50-64                       137 (41.4)    133 (40.2)               \n#>      65+                         144 (43.5)    146 (44.1)               \n#>   sex = Female (%)               172 (52.0)    175 (52.9)          0.018\n#>   education (%)                                                    0.025\n#>      Less than high school        86 (26.0)     84 (25.4)               \n#>      High school                 196 (59.2)    200 (60.4)               \n#>      College graduate or above    49 (14.8)     47 (14.2)               \n#>   race (%)                                                         0.026\n#>      White                        99 (29.9)    103 (31.1)               \n#>      Black                       111 (33.5)    109 (32.9)               \n#>      Hispanic                     70 (21.1)     69 (20.8)               \n#>      Others                       51 (15.4)     50 (15.1)               \n#>   income (%)                                                       0.074\n#>      less than $20,000            84 (25.4)     94 (28.4)               \n#>      $20,000 to $74,999          181 (54.7)    170 (51.4)               \n#>      $75,000 and Over             66 (19.9)     67 (20.2)               \n#>   bmi (mean (SD))              30.17 (7.58)  30.49 (7.86)          0.042\n#>   smoking (%)                                                      0.027\n#>      Never smoker                165 (49.8)    161 (48.6)               \n#>      Previous smoker             104 (31.4)    105 (31.7)               \n#>      Current smoker               62 (18.7)     65 (19.6)               \n#>   htn = Yes (%)                  276 (83.4)    277 (83.7)          0.008\n#>   diabetes = Yes (%)             102 (30.8)     97 (29.3)          0.033\n```\n:::\n\n\nFor each of the datasets, all SMDs are less than our specified cut-point of 0.2.\n\n#### Step 3: Outcome modelling\n\nOur next step is to fit the outcome model on each of the imputed dataset. Remember, we must utilize survey features to correctly estimate the standard error.\n\n##### 3.1 Preparing dataset for ineligible subjects\n\nNow we will add the **ineligible subjects**(ineligible by study restriction and unmatched) with the matched datasets, so that we can set up the survey design on the full dataset and then subset the design.\n\nLet us subset the data for ineligible subjects:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Subset for ineligible\ndat.ineligible <- list(NULL)\n\nfor(ii in 1:m){\n  # Matched dataset\n  dat <- dat.matched[[ii]]\n  \n  # Create an indicator variable in the full dataset\n  dat.full$ineligible <- 1\n  dat.full$ineligible[dat.full$studyid %in% dat$studyid] <- 0\n  \n  # Subset for ineligible\n  dat.ineligible[[ii]] <- subset(dat.full, ineligible == 1)\n  \n  # Create the .imp variable on each dataset with .imp 1 to m = 5\n  dat.ineligible[[ii]]$.imp <- ii\n}\n\n# Dimension of each dataset\nlapply(dat.ineligible, dim)\n#> [[1]]\n#> [1] 8586   19\n#> \n#> [[2]]\n#> [1] 8588   19\n#> \n#> [[3]]\n#> [1] 8582   19\n#> \n#> [[4]]\n#> [1] 8590   19\n#> \n#> [[5]]\n#> [1] 8592   19\n```\n:::\n\n\nThe next step is combining matched and ineligible datasets. Before merging, we must ensure the variable names are the same.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Variables in the matched datasets\nnames(dat.matched[[3]])\n#>  [1] \".imp\"          \"studyid\"       \"survey.weight\" \"psu\"          \n#>  [5] \"strata\"        \"cvd\"           \"arthritis\"     \"age.cat\"      \n#>  [9] \"sex\"           \"education\"     \"race\"          \"income\"       \n#> [13] \"bmi\"           \"smoking\"       \"htn\"           \"diabetes\"     \n#> [17] \"ps\"            \"distance\"      \"weights\"       \"subclass\"\n\n# Variables in the ineligible datasets\nnames(dat.ineligible[[3]])\n#>  [1] \"studyid\"       \"survey.weight\" \"psu\"           \"strata\"       \n#>  [5] \"cvd\"           \"rheumatoid\"    \"age\"           \"sex\"          \n#>  [9] \"education\"     \"race\"          \"income\"        \"bmi\"          \n#> [13] \"smoking\"       \"htn\"           \"diabetes\"      \"age.cat\"      \n#> [17] \"arthritis\"     \"ineligible\"    \".imp\"\n```\n:::\n\n\nFour variables (ps, distance, weights, and subclass) are unavailable in our full, analytic, or ineligible datasets but in the matched datasets. We need to create these 4 variables in the ineligible datasets.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat.ineligible2 <- list(NULL)\n\nfor (ii in 1:m) {\n  dat <- dat.ineligible[[ii]]\n  \n  # Drop the ineligible variable from the dataset\n  dat$ineligible <- NULL\n  \n  # Create ps, distance, weights, and subclass\n  dat$ps <- NA\n  dat$distance <- NA\n  dat$weights <- NA\n  dat$subclass <- NA\n  \n  # Keep only those variables available in the matched dataset\n  vars <- names(dat.matched[[1]])\n  dat <- dat[,vars]\n  \n  # Ineligible datasets in list format\n  dat.ineligible2[[ii]] <- dat\n}\n```\n:::\n\n\nWe created ps, distance, weights, and subclass with missing values for the ineligible participants. Note that it doesn't matter whether there are missing covariate values for ineligible. Since we will create the design on the full dataset and subset the design for only eligible (i.e., matched participants), missing covariate values for ineligible will not impact our analysis.\n\n##### 3.2 Combining eligible (matched) and ineligible (unimputed + unmatched) subjects\n\nNow, we will merge matched eligible and unimputed and unmatched ineligible subjects. We should have m = 5 copies of the full dataset with 9,254 subjects on each.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat.full2 <- list(NULL)\n\nfor (ii in 1:m) {\n  # Eligible\n  d1 <- data.frame(dat.matched[[ii]])\n  d1$eligible <- 1\n  \n  # Ineligible\n  d2 <- data.frame(dat.ineligible2[[ii]])\n  d2$eligible <- 0\n  \n  # Full data\n  d3 <- rbind(d1, d2)\n  dat.full2[[ii]] <- d3\n}\nlapply(dat.full2, dim)\n#> [[1]]\n#> [1] 9254   21\n#> \n#> [[2]]\n#> [1] 9254   21\n#> \n#> [[3]]\n#> [1] 9254   21\n#> \n#> [[4]]\n#> [1] 9254   21\n#> \n#> [[5]]\n#> [1] 9254   21\n\n# Stacked dataset\ndat.stacked <- rbindlist(dat.full2)\ndim(dat.stacked)\n#> [1] 46270    21\n```\n:::\n\n\n##### 3.3 Prepating Survey design and subpopulation of eligible\n\nThe next step is to create the design on the combined dataset.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nallImputations <- imputationList(lapply(1:m, function(n) subset(dat.stacked, subset=.imp==n)))\n\n# Design on full data\nw.design0 <- svydesign(ids = ~psu, \n                       weights = ~survey.weight, \n                       strata = ~strata,\n                      data = allImputations, \n                      nest = TRUE) \n\n# Subset the design\nw.design <- subset(w.design0, eligible == 1) \n#> Warning in subset.svyimputationList(w.design0, eligible == 1): subset differed\n#> between imputations\n```\n:::\n\n\nWe can see the length of the subsetted design:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlapply(w.design$designs, dim)\n#> [[1]]\n#> [1] 668  21\n#> \n#> [[2]]\n#> [1] 666  21\n#> \n#> [[3]]\n#> [1] 672  21\n#> \n#> [[4]]\n#> [1] 664  21\n#> \n#> [[5]]\n#> [1] 662  21\n```\n:::\n\n\nNow we will run the design-adjusted logistic regression on and pool the estimate using Rubin's rule:\n\n##### Step 3.4: Design adjusted regression analysis\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Design-adjusted logistic regression\nfit <- with(w.design, svyglm(I(cvd == \"Yes\") ~ arthritis, family = quasibinomial))\nres <- exp(as.data.frame(cbind(coef(fit[[1]]),\n                               coef(fit[[2]]),\n                               coef(fit[[3]]),\n                               coef(fit[[4]]),\n                               coef(fit[[5]]))))\nnames(res) <- paste(\"OR from m =\", 1:m)\nround(t(res),2)\n#>               (Intercept) arthritisRheumatoid arthritis\n#> OR from m = 1        0.18                          1.53\n#> OR from m = 2        0.24                          1.09\n#> OR from m = 3        0.21                          1.28\n#> OR from m = 4        0.17                          1.61\n#> OR from m = 5        0.12                          2.32\n```\n:::\n\n\n##### Step 3.5: Pooling estimates\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Pooled estimate\npooled.estimates <- MIcombine(fit)\nOR <- round(exp(pooled.estimates$coefficients), 2)\nOR <- as.data.frame(OR)\nCI <- round(exp(confint(pooled.estimates)), 2)\nOR <- cbind(OR, CI)\nOR\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OR\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"2.5 %\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"97.5 %\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.18\",\"2\":\"0.09\",\"3\":\"0.36\",\"_rn_\":\"(Intercept)\"},{\"1\":\"1.52\",\"2\":\"0.66\",\"3\":\"3.48\",\"_rn_\":\"arthritisRheumatoid arthritis\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n##### Double adjustment\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Outcome model with covariates adjustment\nfit2 <- with(w.design, svyglm(I(cvd == \"Yes\") ~ arthritis + age.cat + sex + education + \n                               race + income + bmi + smoking + htn + diabetes, \n                             family = quasibinomial))\n\n# Pooled estimate\npooled.estimates <- MIcombine(fit2)\nOR <- round(exp(pooled.estimates$coefficients), 2)\nOR <- as.data.frame(OR)\nCI <- round(exp(confint(pooled.estimates)), 2)\nOR <- cbind(OR, CI)\nOR\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"OR\"],\"name\":[1],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"2.5 %\"],\"name\":[2],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"97.5 %\"],\"name\":[3],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"0.03\",\"2\":\"0.00\",\"3\":\"0.94\",\"_rn_\":\"(Intercept)\"},{\"1\":\"2.07\",\"2\":\"0.87\",\"3\":\"4.92\",\"_rn_\":\"arthritisRheumatoid arthritis\"},{\"1\":\"3.32\",\"2\":\"0.73\",\"3\":\"15.18\",\"_rn_\":\"age.cat50-64\"},{\"1\":\"8.89\",\"2\":\"1.57\",\"3\":\"50.24\",\"_rn_\":\"age.cat65+\"},{\"1\":\"0.61\",\"2\":\"0.31\",\"3\":\"1.19\",\"_rn_\":\"sexFemale\"},{\"1\":\"0.86\",\"2\":\"0.44\",\"3\":\"1.67\",\"_rn_\":\"educationHigh school\"},{\"1\":\"1.09\",\"2\":\"0.35\",\"3\":\"3.38\",\"_rn_\":\"educationCollege graduate or above\"},{\"1\":\"0.85\",\"2\":\"0.38\",\"3\":\"1.90\",\"_rn_\":\"raceBlack\"},{\"1\":\"0.40\",\"2\":\"0.15\",\"3\":\"1.02\",\"_rn_\":\"raceHispanic\"},{\"1\":\"0.81\",\"2\":\"0.26\",\"3\":\"2.48\",\"_rn_\":\"raceOthers\"},{\"1\":\"0.44\",\"2\":\"0.18\",\"3\":\"1.07\",\"_rn_\":\"income$20,000 to $74,999\"},{\"1\":\"0.39\",\"2\":\"0.15\",\"3\":\"0.99\",\"_rn_\":\"income$75,000 and Over\"},{\"1\":\"1.01\",\"2\":\"0.93\",\"3\":\"1.08\",\"_rn_\":\"bmi\"},{\"1\":\"1.68\",\"2\":\"0.66\",\"3\":\"4.23\",\"_rn_\":\"smokingPrevious smoker\"},{\"1\":\"2.00\",\"2\":\"0.82\",\"3\":\"4.91\",\"_rn_\":\"smokingCurrent smoker\"},{\"1\":\"1.14\",\"2\":\"0.35\",\"3\":\"3.70\",\"_rn_\":\"htnYes\"},{\"1\":\"4.04\",\"2\":\"1.57\",\"3\":\"10.40\",\"_rn_\":\"diabetesYes\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n### References\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}