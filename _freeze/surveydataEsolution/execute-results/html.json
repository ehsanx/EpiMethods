{
  "hash": "e4a5b58c68b58dd5874a593081d0566d",
  "result": {
    "engine": "knitr",
    "markdown": "## Exercise 1 Solution (D) {.unnumbered}\n\n\n\nWe will use the article. We will use the following article by [Flegal et al. (2016)](https://jamanetwork.com/journals/jama/article-abstract/2526639).\n\nWe will reproduce some results from the article. The authors used NHANES 2013-14 dataset to create their main analytic dataset. The dataset contains 10,175 subjects with 12 relevant variables:\n\n-   SEQN: Respondent sequence number\n-   RIDAGEYR: Age in years at screening\n-   RIAGENDR: Gender\n-   DMDEDUC2: Education level\n-   RIDRETH3: Race/ethnicity\n-   RIDEXPRG: Pregnancy status at exam\n-   WTINT2YR: Full sample 2 year weights\n-   SDMVPSU: Masked variance pseudo-PSU\n-   SDMVSTRA: Masked variance pseudo-stratum\n-   BMXBMI: Body mass index in kg/m\\*\\*2\n-   SMQ020: Whether smoked at least 100 cigarettes in life\n-   SMQ040: Current status of smoking (Do you now smoke cigarettes?)\n\n## Question 1: Creating data and table\n\n### 1(a) Importing dataset\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load the dataset\nload(\"Data/surveydata/Flegal2016.RData\")\nls()\n#> [1] \"dat.full\"\nnames(dat.full)\n#>  [1] \"SEQN\"     \"RIDAGEYR\" \"RIAGENDR\" \"DMDEDUC2\" \"RIDRETH3\" \"RIDEXPRG\"\n#>  [7] \"WTINT2YR\" \"SDMVPSU\"  \"SDMVSTRA\" \"BMXBMI\"   \"SMQ020\"   \"SMQ040\"\n```\n:::\n\n\n### 1(b) Subsetting according to eligibility\n\nSubset the dataset according to the eligibility criteria described in the second paragraph of the `Methods` section.\n\n-   Hint: The authors restricted their study to\n    -   adults aged 20 years and more,\n    -   non-missing body mass index, and\n    -   non-pregnant.\n\nYour analytic sample size should be 5,455, as described in the first sentence in the `Results` section.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# 20+\ndat.analytic <- subset(dat.full, RIDAGEYR>=20) # N = 5,769\n\n# Non-missing outcome\ndat.analytic <- subset(dat.analytic, !is.na(BMXBMI)) # N = 5,520\n\n# Non-pregnant\ndat.analytic <- subset(dat.analytic, is.na(RIDEXPRG) | RIDEXPRG != \n                         \"Yes, positive lab pregnancy test\") # N = 5,455\n\ndim(dat.analytic)\n#> [1] 5455   12\n```\n:::\n\n\n### 1(c) Reproduce Table 1\n\nReproduce Table 1 of the article.\n\n-   Hint 1: The authors reported unweighted frequencies, and thus, survey features should not be utilized to answer this question. Please be advised to order the categories as shown in the table. `tableone` package could be helpful.\n\n-   Hint 2: the authors did not show the results for the `Other` race category. But in your table, you could include all race categories.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tableone)\n\ndat <- dat.analytic\n\n# Age\ndat$age <- cut(dat$RIDAGEYR, c(20, 40, 60, Inf), right = FALSE)\n\n# Gender\ndat$gender <- dat$RIAGENDR\n\n# Race/Hispanic origin group\ndat$race <- dat$RIDRETH3\ndat$race <- car::recode(dat$race, \" 'Non-Hispanic White'='White'; 'Non-Hispanic Black'=\n                        'Black'; 'Non-Hispanic Asian'='Asian'; c('Mexican American',\n                        'Other Hispanic')='Hispanic'; 'Other Race - Including Multi-Rac'=\n                        'Other'; else=NA\", levels = c(\"White\", \"Black\", \"Asian\",\n                                                      \"Hispanic\", \"Other\"))\n\n# Table 1: Overall \ntab11 <- CreateTableOne(vars = \"age\", strata = \"race\", data = dat, test = F, \n                        addOverall = T)\n\n# Table 1: Male\ntab12 <- CreateTableOne(vars = \"age\", strata = \"race\", test = F, addOverall = T, \n                        data = subset(dat, gender == \"Male\"))\n\n# Table 1: Female\ntab13 <- CreateTableOne(vars = \"age\", strata = \"race\", test = F, addOverall = T,\n                        data = subset(dat, gender == \"Female\"))\n\n# Reproducing Table 1\ntab1a <- list(Overall = tab11, Male = tab12, Female = tab13)\nprint(tab1a, format = \"f\") # Showing only frequencies \n#> $Overall\n#>              Stratified by race\n#>               Overall White Black Asian Hispanic Other\n#>   n           5455    2343  1115  623   1214     160  \n#>   age                                                 \n#>      [20,40)  1810     734   362  216    412      86  \n#>      [40,60)  1896     759   383  251    449      54  \n#>      [60,Inf) 1749     850   370  156    353      20  \n#> \n#> $Male\n#>              Stratified by race\n#>               Overall White Black Asian Hispanic Other\n#>   n           2638    1130  556   300   573      79   \n#>   age                                                 \n#>      [20,40)   909     386  182   106   189      46   \n#>      [40,60)   897     360  179   120   215      23   \n#>      [60,Inf)  832     384  195    74   169      10   \n#> \n#> $Female\n#>              Stratified by race\n#>               Overall White Black Asian Hispanic Other\n#>   n           2817    1213  559   323   641      81   \n#>   age                                                 \n#>      [20,40)   901     348  180   110   223      40   \n#>      [40,60)   999     399  204   131   234      31   \n#>      [60,Inf)  917     466  175    82   184      10\n```\n:::\n\n\n## Question 2\n\n### 2(a) Reproduce Table 1 with survey features \n\nNot in this article but in many other articles, you would see `n` comes from the analytic sample and `%` comes from the survey design that accounts for survey features such as strata, clusters and survey weights. In Question 1, you see how n comes from the analytic sample. Your task for Question 2(a) is to create % part of the Table 1 with survey features, i.e., % should come from the survey design that accounts for strata, clusters and survey weights. You do not need to show the frequiencis but show only the percentages (for categorical variables).\n\n**Hints**:\n\n-   Subset the design, not the sample. For this step, you need to work with your full data. If you have generated a variable in your analytic dataset, that variable should also be present in the full dataset.\n\n-   Generate age, gender, and race variable in your full data. Codes shown in Question 1 could be helpful.\n\n-   Make the design on the full data and then subset the design.\n\n-   Reproduce Table 1 with the design from the previous step. The `svyCreateTableOne` function could be a helpful function.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## Create all variables in the full data\n# Age\ndat.full$age <- cut(dat.full$RIDAGEYR, c(20, 40, 60, Inf), right = FALSE)\n\n# Gender\ndat.full$gender <- dat.full$RIAGENDR\n\n# Race/Hispanic origin group\ndat.full$race <- dat.full$RIDRETH3\ndat.full$race <- car::recode(dat.full$race, \" 'Non-Hispanic White'='White'; \n                             'Non-Hispanic Black'='Black'; 'Non-Hispanic Asian'='Asian'; \n                             c('Mexican American','Other Hispanic')='Hispanic'; \n                             'Other Race - Including Multi-Rac'='Other'; \n                             else=NA\", levels = c(\"White\", \"Black\", \"Asian\",\n                                                  \"Hispanic\", \"Other\"))\n\n# Survey features\ndat.full$survey.weight <- dat.full$WTINT2YR\ndat.full$psu <- dat.full$SDMVPSU\ndat.full$strata <- dat.full$SDMVSTRA\n\n# Subset the design\ndat.full$miss <- 1\ndat.full$miss[dat.full$SEQN %in% dat.analytic$SEQN] <- 0\nsvy.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight,\n                         data = dat.full, nest = TRUE)\nsvy.design <- subset(svy.design0, miss == 0)\n\n# Table 1: Overall \ntab11 <- svyCreateTableOne(vars = \"age\", strata = \"race\", data = svy.design, \n                           test = F, addOverall = T)\n\n# Table 1: Male\ntab12 <- svyCreateTableOne(vars = \"age\", strata = \"race\", test = F, addOverall = T, \n                        data = subset(svy.design, gender == \"Male\"))\n\n# Table 1: Female\ntab13 <- svyCreateTableOne(vars = \"age\", strata = \"race\", test = F, addOverall = T,\n                        data = subset(svy.design, gender == \"Female\"))\n\n# Reproducing Table 1\ntab1b <- list(Overall = tab11, Male = tab12, Female = tab13)\nprint(tab1b, format = \"p\") # Showing only percentages    \n#> $Overall\n#>              Stratified by race\n#>               Overall     White       Black      Asian      Hispanic  \n#>   n           217464332.1 143721046.2 24697511.9 11380679.8 31863752.6\n#>   age (%)                                                             \n#>      [20,40)         35.5        30.8       38.9       40.2       49.6\n#>      [40,60)         37.5        37.5       39.3       38.5       35.6\n#>      [60,Inf)        27.0        31.7       21.8       21.2       14.8\n#>              Stratified by race\n#>               Other    \n#>   n           5801341.5\n#>   age (%)              \n#>      [20,40)       49.2\n#>      [40,60)       38.4\n#>      [60,Inf)      12.4\n#> \n#> $Male\n#>              Stratified by race\n#>               Overall     White      Black      Asian     Hispanic   Other    \n#>   n           105744090.8 70126957.2 11285409.5 5233819.5 15947523.0 3150381.6\n#>   age (%)                                                                     \n#>      [20,40)         37.2       32.3       41.3      41.7       51.6      52.9\n#>      [40,60)         37.6       37.9       39.0      38.5       35.1      36.1\n#>      [60,Inf)        25.1       29.8       19.7      19.8       13.2      11.0\n#> \n#> $Female\n#>              Stratified by race\n#>               Overall     White      Black      Asian     Hispanic   Other    \n#>   n           111720241.3 73594089.0 13412102.4 6146860.3 15916229.6 2650960.0\n#>   age (%)                                                                     \n#>      [20,40)         33.8       29.4       36.9      39.0       47.6      44.7\n#>      [40,60)         37.4       37.1       39.5      38.6       36.0      41.2\n#>      [60,Inf)        28.8       33.5       23.6      22.5       16.4      14.1\n```\n:::\n\n\n### 2(b) Reproduce Table 3 \n\nReproduce the first column of Table 3 of the article (i.e., among men, explore the relationship between obesity and four predictors shown in the table).\n\n-   If necessary, re-level or re-order the levels.\n\n-   You need to generate obesity as BMI $\\ge 30 \\text{ kg/m}^2$\n\n-   You need to generate `smoking status` and `education`. The unweighted frequencies should be matched with the frequencies in eTable 1 and eTable 2. Make sure these variables are in your full dataset as well.\n\n-   Subset the design, not the sample.\n\n-   Fit the model. Do not need to report the model summary.\n\n-   The authors used SAS to produce the results vs. We are using R. The estimates could be slightly different (in second decimal point) from the estimates presented in Table 3, but they should be approximately similar.\n\n-   You can use `Publish` or `jtools` package to report the odds ratios. Your odds ratios could be look like as follows:\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](Images/surveydata/tab3exs.png){width=70%}\n:::\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obese\ndat.full$obese <- ifelse(dat.full$BMXBMI >= 30, \"Yes\", \"No\")\n\n# Smoking status\ndat.full$smoking <- dat.full$SMQ020\ndat.full$smoking <- car::recode(dat.full$smoking, \" 'Yes'='Current smoker'; \n                                'No'='Never smoker'; else=NA\",\n                                levels = c(\"Never smoker\", \"Former smoker\", \n                                           \"Current smoker\"))\ndat.full$smoking[dat.full$SMQ040 == \"Not at all\"] <- \"Former smoker\"\n\n# Education\ndat.full$education <- dat.full$DMDEDUC2\ndat.full$education <- car::recode(dat.full$education, \" c('Some college or AA degree', \n                             'College graduate or above') = '>High school';\n                             'High school graduate/GED or equi' = 'High school';\n                             c('Less than 9th grade',\n                             '9-11th grade (Includes 12th grad') = '<High school';\n                             else = NA\", levels = c(\"High school\", \"<High school\",\n                                                    \">High school\"))\n\n# Survey features\ndat.full$survey.weight <- dat.full$WTINT2YR\ndat.full$psu <- dat.full$SDMVPSU\ndat.full$strata <- dat.full$SDMVSTRA\n\n# Subset the design\ndat.full$miss <- 1\ndat.full$miss[dat.full$SEQN %in% dat.analytic$SEQN] <- 0\nsvy.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight,\n                         data = dat.full, nest = TRUE)\nsvy.design <- subset(svy.design0, miss == 0)\n\n# Table 3 - column 1\nfit.male <- svyglm(I(obese==\"Yes\") ~ age + race + smoking + education, \n                   family = binomial, design = subset(svy.design, gender == \"Male\"))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\npublish(fit.male)\n#>   Variable          Units OddsRatio       CI.95    p-value \n#>        age        [20,40)       Ref                        \n#>                   [40,60)      1.28 [0.94;1.74]   0.173590 \n#>                  [60,Inf)      1.20 [0.77;1.85]   0.458803 \n#>       race          White       Ref                        \n#>                     Black      1.24 [0.93;1.65]   0.202249 \n#>                     Asian      0.27 [0.20;0.37]   0.000345 \n#>                  Hispanic      1.22 [0.88;1.69]   0.293132 \n#>                     Other      1.23 [0.67;2.23]   0.532168 \n#>    smoking   Never smoker       Ref                        \n#>             Former smoker      1.25 [0.96;1.64]   0.157176 \n#>            Current smoker      0.71 [0.55;0.92]   0.047198 \n#>  education    High school       Ref                        \n#>              <High school      0.93 [0.67;1.29]   0.685577 \n#>              >High school      0.97 [0.72;1.29]   0.821357\n```\n:::\n\n\n### 2(c) Model selection \n\nFrom the literature, you know that `age` and `race` needs to be adjusted in the model, but you are not sure about `smoking` and `education`. Run an AIC based backward selection process to figure out whether you want to add `smoking` or `education`, or both in the final model in 2(b). What is your conclusion, i.e., which variables are selected/dropped \\[Expected answer: one short sentence\\]?\n\n**Hints**:\n\n-   Your design must be free from missing values. Even after applying eligibility criteria, you may have some missing values on multiple variables (see eTable 1 and eTable 2). This is especially important for model selection process.\n\n-   You can create a complete case analytic dataset (i.e., dataset without missing values in obesity, four predictors, and survey features). Then create the design on the full data and subset the design for the complete case samples.\n\n-   `step` function could be helpful.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Obese\ndat$obese <- ifelse(dat$BMXBMI >= 30, \"Yes\", \"No\")\ndat$obese <- factor(dat$obese, levels = c(\"No\", \"Yes\"))\n\n# Smoking status\ndat$smoking <- dat$SMQ020\ndat$smoking <- car::recode(dat$smoking, \" 'Yes'='Current smoker'; \n                                'No'='Never smoker'; else=NA\",\n                                levels = c(\"Never smoker\", \"Former smoker\", \n                                           \"Current smoker\"))\ndat$smoking[dat$SMQ040 == \"Not at all\"] <- \"Former smoker\"\n\n# Education\ndat$education <- dat$DMDEDUC2\ndat$education <- car::recode(dat$education, \" c('Some college or AA degree', \n                             'College graduate or above') = '>High school';\n                             'High school graduate/GED or equi' = 'High school';\n                             c('Less than 9th grade',\n                             '9-11th grade (Includes 12th grad') = '<High school';\n                             else = NA\", levels = c(\"High school\", \"<High school\",\n                                                    \">High school\"))\n\n# Survey design\ndat$survey.weight <- dat$WTINT2YR\ndat$psu <- dat$SDMVPSU\ndat$strata <- dat$SDMVSTRA\n\n# Select only relevant variables\ndat2 <- dat[,c(\"SEQN\", \"age\", \"race\", \"smoking\", \"education\", \n                         \"survey.weight\", \"psu\", \"strata\")]\n\n# Remove missing values\ndat2 <- dat2[complete.cases(dat2),] # 5 missing values dropped\n\n# Subset the design\ndat.full$miss <- 1\ndat.full$miss[dat.full$SEQN %in% dat2$SEQN] <- 0\nsvy.design0 <- svydesign(strata = ~strata, id = ~psu, weights = ~survey.weight,\n                         data = dat.full, nest = TRUE)\nsvy.design <- subset(svy.design0, miss == 0)\n\n# Initial model\nfit1 <- svyglm(I(obese==\"Yes\") ~ age + race + smoking + education, \n                   family = binomial, design = subset(svy.design, gender == \"Male\"))\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n\nscope <- list(upper = ~ age + race + smoking + education, \n              lower = ~ age + race)\n\n# Final model: Backward elimination using the AIC criteria\nfit2 <- step(fit1, scope = scope, trace = FALSE, k = 2, direction = \"backward\")\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n\n# Summary of the final model\npublish(fit2)\n#>  Variable          Units OddsRatio       CI.95   p-value \n#>       age        [20,40)       Ref                       \n#>                  [40,60)      1.28 [0.94;1.73]   0.15579 \n#>                 [60,Inf)      1.19 [0.76;1.86]   0.46397 \n#>      race          White       Ref                       \n#>                    Black      1.23 [0.92;1.65]   0.19682 \n#>                    Asian      0.27 [0.20;0.37]   < 1e-04 \n#>                 Hispanic      1.21 [0.90;1.61]   0.24507 \n#>                    Other      1.23 [0.68;2.23]   0.52048 \n#>   smoking   Never smoker       Ref                       \n#>            Former smoker      1.25 [0.96;1.64]   0.14296 \n#>           Current smoker      0.71 [0.54;0.92]   0.03895\n```\n:::\n\n\nThe `education` variable is dropped from the final model.\n\n### 2(d) Testing for interactions \n\nCheck whether the interaction between `age` and `smoking` should be added in the 2(b) model (yes or no answer required, along with the code and p-value):\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Model with interaction between age and smoking\nfit2 <- update(fit.male, .~. + age:smoking)\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\nanova(fit.male, fit2)$p\n#> Warning in eval(family$initialize): non-integer #successes in a binomial glm!\n#> [1] 0.404668\n```\n:::\n\n\nNo. We won't keep the age and smoking interaction.\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}