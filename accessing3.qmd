## Importing NHANES to R {.unnumbered}

This is a short instruction document of how to get NHANES dataset from the US CDC site to your RStudio environment. Once we bring the dataset into RStudio, the next step is to think about creating analytic dataset.

```{r setup, warning=FALSE, message=FALSE, cache=TRUE}
# Load required packages
#devtools::install_github("warnes/SASxport")
library(SASxport)
library(foreign)
library(nhanesA)
library(knitr)
require(DiagrammeR)
require(DiagrammeRsvg)
require(rsvg)
library(magrittr)
library(svglite)
library(png)
use.saved.chche <- TRUE
```

::: column-margin
Before installing a package from GitHub, it's better to check whether you installed the right version of [Rtools](https://cran.r-project.org/bin/windows/Rtools/)
:::

### Overview

National Center for Health Statistics (NCHS) conducts National Health and Nutrition Examination Survey (NHANES) [@nhanes]. These surveys are designed to evaluate the health and nutritional status of U.S. adults and children. These surveys are being administered in two-year cycles or intervals starting from 1999-2000. Prior to 1999, a number of surveys were conducted (e.g., NHANES III), but in our discussion, we will mostly restrict our discussions to continuous NHANES (e.g., NHANES 1999-2000 to NHANES 2017-2018).

::: column-margin
@nhanes
:::

### Sampling Procedure:
It is a probabilistic sample (we know probability of getting selected for all individuals). This sample is unlikely to be representative of the entire population, as some under/oversampling occurs (unlike SRS), and samples may be dependent (due to proximity of some samples). For example, household with the following characteristics may be oversampled in NHANES, e.g., African Americans, Mexican Americans, Low income White Americans, Persons age 60+ years.

::: column-margin
Sampling Procedure:

- not obtained via simple random sample
- multistage sample designs
- A sample weight is assigned to each sample person where weight = the number of people in the target population represented
by that sample person in NHANES
:::

NHANES used multistage sample designs:

- Stage 1: PSU/clusters = geographically contiguous counties. 50 states - divided into ~3100 counties. Each PSU is assigned to a strata (e.g., urban/rural or PSU size etc.). The counties are randomly/PPS selected using a 2-per-stratum design.  Complex sample variance estimation requires PSU + strata (masking involved).
- Stage 2: each selected county is broken into segments (with at least ~50-100 housing units). Segments are randomly/PPS selected.
- Stage 3: each selected segment is divided into households. Households are randomly selected. 
- Stage 4: Within each sampled household, an individual is randomly selected.

::: column-margin
To obtain population-level estimate, we must utilize the survey features (weights, strata, PSU/cluster)
:::

### Survey history

Overall NHANES survey history

```{r graph0i, echo=FALSE, cache=use.saved.chche}
g1 <- grViz("
	digraph causal {
	
	  # Nodes
    node [shape = circle]
    O0 [label = 'Older surveys\n NHES']
    M0 [label = 'Periodic survey\n NHANES I-III']
    N [label = 'Continuous\n NHANES']
    
	  node [shape = plaintext]
    # node [shape = circle]
    S [label = 'NHANES\n Surveys']
	  O [label = '1960-1970']
	  o1 [label = 'NHES I']
	  o2 [label = 'NHES II']
	  o3 [label = 'NHES III']
    M [label = '1971-1975']
    m [label = 'NHANES I']
    M1 [label = '1976-1980']
    m1 [label = 'NHANES II']
    M2 [label = '1988-1994']
    m2 [label = 'NHANES III']
    n [label = '1999 - ']
    n10 [label = 'NHANES 2017-2018']
    n9 [label = 'NHANES 2015-2016']
    n8 [label = 'NHANES 2013-2014']
    n7 [label = 'NHANES 2011-2012']
    n6 [label = 'NHANES 2009-2010']
    n5 [label = 'NHANES 2007-2008']
    n4 [label = 'NHANES 2005-2006']
    n3 [label = 'NHANES 2003-2004']
    n2 [label = 'NHANES 2001-2002']
    n1 [label = 'NHANES 1999-2000']
	  
	  # Edges
	  edge [color = black,
	        arrowhead = vee]
	  rankdir = LR
    S -> {O0 M0 N}
    O0 -> O
    M0 -> {M M1 M2}
	  O-> {o1 o2 o3}
    M -> m
    M1 -> m1
    M2 -> m2
    N -> n
    n -> {n1 n2 n3 n4 n5 n6 n7 n8 n9 n10}
	  
	  # Graph
	  graph [overlap = true, fontsize = 10]
	}")
g1 %>% export_svg %>% charToRaw %>% rsvg %>% png::writePNG("Images/accessing/g1.png")
```

```{r graph0xi, echo=FALSE, out.width = '75%'}
knitr::include_graphics("Images/accessing/g1.png")
```

### NHANES datafile and documents

#### File format

The Continuous NHANES files are stored in the NHANES website as SAS transport file formats (.xpt). You can import this data in any statistical package that supports this file format.

#### Continuous NHANES Components

Continuous NHANES components separated to reduce the amount of time to download and documentation size:

::: column-margin
[NHANES Tutorials](https://wwwn.cdc.gov/nchs/nhanes/tutorials/default.aspx?CDC_AA_refVal=https%3A%2F%2Fwww.cdc.gov%2Fnchs%2Ftutorials%2Findex.htm)
:::

```{r graph1i, echo=FALSE, cache=use.saved.chche}
g2 <- grViz("
	digraph causal {
	
	  # Nodes
    node [shape = box]
    # node [shape = circle]
    d [label = 'Demographics']
    i [label = 'Dietary']
    e [label = 'Examination'] 
    l [label = 'Laboratory']
    q [label = 'Questionnaire']

    node [shape = plaintext]
    N [label = 'Continuous NHANES\n cycles data\n collection']
    d1 [label = 'Survey design']
    d2 [label = 'demographic\n variables']
    i1 [label = 'foods']
    i2 [label = 'beverages']
    i3 [label = 'dietary\n supplements']
    e1 [label = 'physical exams*']
    e2 [label = 'dental exams']
    #e3 [label = 'dietary interview']
    l1 [label = 'blood']
    l2 [label = 'urine']
    l3 [label = 'hair']
    l4 [label = 'air']
    l5 [label = 'tuberculosis\n skin test']
    l6 [label = 'household\n dust and\n water\n specimens']
    q1 [label = 'household\n interview']
    q2 [label = 'mobile\n examination\n center (MEC)\n interview']
    d11 [label = 'weights']
    d12 [label = 'design\n strata']
    d13 [label = 'primary\n sampling\n units']
	  
	  # Edges
	  edge [color = black,
	        arrowhead = vee]
	  rankdir = LR
    N -> {d i e l q}
    d -> {d1 d2}
    i -> {i1 i2 i3}
    e -> {e1 e2}
    l -> {l1 l2 l3 l4 l5 l6}
    q -> {q1 q2}
    d1 -> {d11 d12 d13}

	  # Graph
	  graph [overlap = true, fontsize = 10]
	}")
g2 %>% export_svg %>% charToRaw %>% rsvg %>% png::writePNG("Images/accessing/g2.png")
```

```{r graph1xi, echo=FALSE, out.width = '75%'}
knitr::include_graphics("Images/accessing/g2.png")
```

::: column-margin
Broadly, continuous NHANES data are available in 5 categories:

-   Demographics
-   Dietary
-   Examination
-   Laboratory
-   Questionnaire
:::

#### Combining data

##### Different cycles

It is possible to combine datasets from different years/cycles together in NHANES. However, NHANES is a cross-sectional data, and identification of the same person accross different cycles is not possible in the public release datasets. For appending data from different cycles, please make sure that the variable names/labels are the same/identical in years under consideration (in some years, names and labels do change).

::: column-margin
The following data have not been released on the NHANES website as public release files due to confidentiality concerns:

-   adolescent data on alcohol use
-   smoking
-   sexual behavior
-   reproductive health and drug use
:::

##### Within the same cycle

Within NHANES datasets in a given cycle, each sampled person has an unique identifier sequence number (variable `SEQN`).

#### Missing data and outliers

@CDCfaq recommends:

::: column-margin
@CDCfaq
:::

> 1.  "As a general rule, if 10% or less of your data for a variable are missing from your analytic dataset, it is usually acceptable to continue your analysis without further evaluation or adjustment. However, if more than 10% of the data for a variable are missing, you may need to determine whether the missing values are distributed equally across socio-demographic characteristics, and decide whether further imputation of missing values or use of adjusted weights are necessary."

> 2.  "If you fail to identify 'refusal' or 'do not know' as types of missing data, and treat the assigned values for 'refused' or 'do not know' as real values, you will get distorted results in your statistical analyses. Therefore, it is important to recode 'refused' or 'don't know' responses as missing values (either as a period (.) for numeric variables or as a blank for character variables)."

> 3.  "Outliers with extremely large weights could have an influential impact on your estimates. You will have to decide whether to keep these influential outliers in your analysis or not. It is up to the analysts to make that decision."

#### NHANES documents

```{r graph2i, echo=FALSE,cache=use.saved.chche}
g3 <- grViz("
	digraph causal {
	
	  # Nodes
	  node [shape = plaintext]
    # node [shape = circle]
    N [label = 'Continuous NHANES cycles']
    c [label = 'codebook']
    d [label = 'data file\n documentation'] 
    f [label = 'frequency tables']
	  
	  # Edges
	  edge [color = black,
	        arrowhead = vee]
	  rankdir = LR
    N -> {c d f}

	  # Graph
	  graph [overlap = true, fontsize = 10]
	}")
g3 %>% export_svg %>% charToRaw %>% rsvg %>% png::writePNG("Images/accessing/g3.png")
```

```{r graph2xi, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/g3.png")
```

::: column-margin
The following websites could be helpful: - For more information about [NHANES design](https://wwwn.cdc.gov/nchs/nhanes/tutorials/module2.aspx).

-   Visit [US CDC](https://wwwn.cdc.gov/Nchs/Nhanes/search/) website and do a variable keyword search based on your research interest (e.g., arthritis).
:::

### Accessing NHANES Data Directly from the CDC website

In the following example, we will see how to download 'Demographics' data, and check associated variable in that dataset.

```{r cdc1, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/n15.png")
```

::: column-margin
NHANES 1999-2000 and onward survey datasets are publicly available at [wwwn.cdc.gov/nchs/nhanes/](https://wwwn.cdc.gov/nchs/nhanes/)
:::

-   **Step 1**: Say, for example, we are interested about the NHANES 2015-2016 survey. Clicking the associated link in the above Figure gets us to the page for the corresponding cycle (see below).

```{r cdc2, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/n15demo.png")
```

-   **Step 2**: There are various types of data available for this survey. Let's explore the demographic information from this cycle. These data are mostly available in the form of SAS `XPT` format (see below).

```{r cdc3, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/xptsasdata.png")
```

-   **Step 3**: We can download the XPT data in the local PC folder and read the data into R as as follows:

```{r load, echo=TRUE, eval=FALSE}
DEMO <- read.xport("Data/accessing/DEMO_I.XPT")
```

```{r loadMirror, echo=FALSE, eval=TRUE}
library(foreign)
DEMO <- read.xport("Data/accessing/DEMO_I.XPT")
```

-   **Step 4**: Once data is imported in RStudio, we will see the `DEMO` object listed under data window (see below):

```{r cdc4, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/rdata.png")
```

-   **Step 5**: We can also check the variable names in this `DEMO` dataset as follows:

```{r cdc5, echo=TRUE}
names(DEMO)
```

-   **Step 6**: We can open the data in RStudio in the dataview window (by clicking the `DEMO` data from the data window). The next Figure shows only a few columns and rows from this large dataset. Note that there are some values marked as "NA", which represents missing values.

```{r cdc6, echo=FALSE, out.width = '99%'}
knitr::include_graphics("Images/accessing/dataview.png")
```

-   **Step 7**: There is a column name associated with each column, e.g., `DMDHSEDU` in the first column in the above Figure. To understand what the column names mean in this Figure, we need to take a look at the codebook. To access codebook, click the `'DEMO|Doc'` link (in step 2). This will show the data documentation and associated codebook (see the next Figure).

```{r cdc7, echo=FALSE, out.width = '65%'}
knitr::include_graphics("Images/accessing/toc.png")
```

-   **Step 8**: We can see a link for the column or variable `DMDHSEDU` in the table of content (in the above Figure). Clicking that link will provide us further information about what this variable means (see the next Figure).

```{r cdc8, echo=FALSE, out.width = '85%'}
knitr::include_graphics("Images/accessing/DMDHSEDU.png")
```

-   **Step 9**: We can assess if the numbers reported under count and cumulative (from the above Figure) matches with what we get from the `DEMO` data we just imported (particularly, for the `DMDHSEDU` variable):

```{r cdc9, echo=TRUE}
table(DEMO$DMDHSEDU) # Frequency table
cumsum(table(DEMO$DMDHSEDU)) # Cumulative frequency table
length(is.na(DEMO$DMDHSEDU)) # Number of non-NA observations
```

### Accessing NHANES Data Using R Packages

#### nhanesA package

```{r load1, echo=TRUE, eval=FALSE}
library(nhanesA)
```

::: callout-tip
R package `nhanesA` provides a convenient way to download and analyze NHANES survey data.
:::

::: column-margin
RNHANES [@RNHANES] is another packages for downloading the NHANES data easily.
:::

-   **Step 1**: Witin the CDC website, NHANES data are available in 5 categories
    -   Demographics (`DEMO`)
    -   Dietary (`DIET`)
    -   Examination (`EXAM`)
    -   Laboratory (`LAB`)
    -   Questionnaire (`Q`)

To get a list of available variables within a data file, we run the following command (e.g., we check variable names within `DEMO` data):

```{r search, eval=TRUE, cache=use.saved.chche}
nhanesTables(data_group='DEMO', year=2015)
```

-   **Step 2**: We can obtain the summaries of the downloaded data as follows (see below):

```{r search3, eval=TRUE, cache=use.saved.chche}
demo <- nhanes('DEMO_I')
names(demo)
table(demo$DMDHSEDU) # Frequency table
cumsum(table(demo$DMDHSEDU)) # Cumulative frequency table
length(is.na(demo$DMDHSEDU)) # Number of non-NA observations
```

### References
