<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>OER: Advanced Epidemiological Methods - PSM in OA-CVD (CCHS)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./propensityscore3.html" rel="next">
<link href="./propensityscore1.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CVBPG0RQMY"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CVBPG0RQMY', { 'anonymize_ip': true});
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<meta name="twitter:title" content="OER: Advanced Epidemiological Methods - PSM in OA-CVD (CCHS)">
<meta name="twitter:description" content="This tutorial is a comprehensive guide on implementing Propensity Score Matching (PSM) using R, particularly focusing on a OA - CVD health study from the Canadian Community Health Survey (CCHS).">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar docked">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">PSM in OA-CVD (CCHS)</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OER: Advanced Epidemiological Methods</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">The Project</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./wrangling.html" class="sidebar-item-text sidebar-link">Data wrangling</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1a.html" class="sidebar-item-text sidebar-link">R basics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1b.html" class="sidebar-item-text sidebar-link">Data types</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1c.html" class="sidebar-item-text sidebar-link">Automating tasks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling2.html" class="sidebar-item-text sidebar-link">Importing dataset</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling3.html" class="sidebar-item-text sidebar-link">Data manipulation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling4.html" class="sidebar-item-text sidebar-link">Import external data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling5.html" class="sidebar-item-text sidebar-link">Summary tables</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling6.html" class="sidebar-item-text sidebar-link">R Markdown</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingF.html" class="sidebar-item-text sidebar-link">R Functions (W)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingQ.html" class="sidebar-item-text sidebar-link">Quiz (W)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingE.html" class="sidebar-item-text sidebar-link">Exercise (W)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./accessing.html" class="sidebar-item-text sidebar-link">Data accessing</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing1.html" class="sidebar-item-text sidebar-link">Survey data sources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing2.html" class="sidebar-item-text sidebar-link">Importing CCHS to R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing3.html" class="sidebar-item-text sidebar-link">Importing NHANES to R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing4.html" class="sidebar-item-text sidebar-link">Reproducing results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing5.html" class="sidebar-item-text sidebar-link">Importing NHIS to R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingF.html" class="sidebar-item-text sidebar-link">R Functions (A)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingQ.html" class="sidebar-item-text sidebar-link">Quiz (A)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingE.html" class="sidebar-item-text sidebar-link">Exercise (A)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./researchquestion.html" class="sidebar-item-text sidebar-link">Research questions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion1.html" class="sidebar-item-text sidebar-link">Predictive question-1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion2a.html" class="sidebar-item-text sidebar-link">Predictive question-2a</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion2b.html" class="sidebar-item-text sidebar-link">Predictive question-2b</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion3.html" class="sidebar-item-text sidebar-link">Causal question-1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion4.html" class="sidebar-item-text sidebar-link">Causal question-2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestionF.html" class="sidebar-item-text sidebar-link">R functions (Q)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestionQ.html" class="sidebar-item-text sidebar-link">Quiz (Q)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./confounding.html" class="sidebar-item-text sidebar-link">Causal roles</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding1.html" class="sidebar-item-text sidebar-link">Confounding</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding2.html" class="sidebar-item-text sidebar-link">Mediator</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding3.html" class="sidebar-item-text sidebar-link">Collider</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding4.html" class="sidebar-item-text sidebar-link">Z-bias</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding5.html" class="sidebar-item-text sidebar-link">Collapsibility</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding6.html" class="sidebar-item-text sidebar-link">Change-in-estimate</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confoundingF.html" class="sidebar-item-text sidebar-link">R functions (R)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confoundingQ.html" class="sidebar-item-text sidebar-link">Quiz (R)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./predictivefactors.html" class="sidebar-item-text sidebar-link">Prediction ideas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors1.html" class="sidebar-item-text sidebar-link">Collinear predictors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors2.html" class="sidebar-item-text sidebar-link">Continuous outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors3.html" class="sidebar-item-text sidebar-link">Binary outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors4.html" class="sidebar-item-text sidebar-link">Overfitting and performance</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors5.html" class="sidebar-item-text sidebar-link">Data spliting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors6.html" class="sidebar-item-text sidebar-link">Cross-validation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors7.html" class="sidebar-item-text sidebar-link">Bootstrap</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactorsF.html" class="sidebar-item-text sidebar-link">R functions (P)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactorsQ.html" class="sidebar-item-text sidebar-link">Quiz (P)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./surveydata.html" class="sidebar-item-text sidebar-link">Survey data analysis</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata1.html" class="sidebar-item-text sidebar-link">CCHS: Revisiting PICOT</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata2.html" class="sidebar-item-text sidebar-link">CCHS: Assessing data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata3.html" class="sidebar-item-text sidebar-link">CCHS: Bivariate analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata4.html" class="sidebar-item-text sidebar-link">CCHS: Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata5.html" class="sidebar-item-text sidebar-link">CCHS: Performance</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata6.html" class="sidebar-item-text sidebar-link">NHANES: Blood Pressure</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata7.html" class="sidebar-item-text sidebar-link">NHANES: Cholesterol</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata8.html" class="sidebar-item-text sidebar-link">NHANES: Subsetting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataF.html" class="sidebar-item-text sidebar-link">R functions (D)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataQ.html" class="sidebar-item-text sidebar-link">Quiz (D)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataE.html" class="sidebar-item-text sidebar-link">Exercise (D)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./missingdata.html" class="sidebar-item-text sidebar-link">Missing data analysis</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata1.html" class="sidebar-item-text sidebar-link">Imputation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata2.html" class="sidebar-item-text sidebar-link">Imputation in NHANES</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata3.html" class="sidebar-item-text sidebar-link">Missing in outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata4.html" class="sidebar-item-text sidebar-link">Performance with NA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata5.html" class="sidebar-item-text sidebar-link">Subpopulations</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata6.html" class="sidebar-item-text sidebar-link">MCAR tests</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata7.html" class="sidebar-item-text sidebar-link">Effect modification</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataF.html" class="sidebar-item-text sidebar-link">R functions (M)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataQ.html" class="sidebar-item-text sidebar-link">Quiz (M)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataE.html" class="sidebar-item-text sidebar-link">Exercise (M)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./propensityscore.html" class="sidebar-item-text sidebar-link">Propensity score</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore1.html" class="sidebar-item-text sidebar-link">Exact Matching (CCHS)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore2.html" class="sidebar-item-text sidebar-link active">PSM in OA-CVD (CCHS)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore3.html" class="sidebar-item-text sidebar-link">PSM in OA-CVD (US)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore4.html" class="sidebar-item-text sidebar-link">PSM in BMI-diabetes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore5.html" class="sidebar-item-text sidebar-link">PSM with MI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreF.html" class="sidebar-item-text sidebar-link">R functions (S)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreQ.html" class="sidebar-item-text sidebar-link">Quiz (S)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreE.html" class="sidebar-item-text sidebar-link">Exercise (S)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./machinelearning.html" class="sidebar-item-text sidebar-link">Machine learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning1.html" class="sidebar-item-text sidebar-link">Continuous outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning2.html" class="sidebar-item-text sidebar-link">Data spliting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning3.html" class="sidebar-item-text sidebar-link">Cross-validation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning4.html" class="sidebar-item-text sidebar-link">Binary outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning5.html" class="sidebar-item-text sidebar-link">Supervised learning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning6.html" class="sidebar-item-text sidebar-link">Unsupervised learning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearningF.html" class="sidebar-item-text sidebar-link">R functions (L)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./machinelearningCausal.html" class="sidebar-item-text sidebar-link">Causal learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearningCausalF.html" class="sidebar-item-text sidebar-link">R functions (C)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./nonbinary.html" class="sidebar-item-text sidebar-link">Complex outcomes</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonbinary1.html" class="sidebar-item-text sidebar-link">Polytomous and ordinal</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonbinary2.html" class="sidebar-item-text sidebar-link">Survival analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonbinary3.html" class="sidebar-item-text sidebar-link">Poisson</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonbinaryF.html" class="sidebar-item-text sidebar-link">R functions (N)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./nonbinaryQ.html" class="sidebar-item-text sidebar-link">Quiz (N)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./longitudinal.html" class="sidebar-item-text sidebar-link">Longitudinal data</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-12" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-12" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinal1.html" class="sidebar-item-text sidebar-link">Mixed effects models</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinal2.html" class="sidebar-item-text sidebar-link">GEE</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinalF.html" class="sidebar-item-text sidebar-link">R functions (T)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./longitudinalQ.html" class="sidebar-item-text sidebar-link">Quiz (T)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./mediation.html" class="sidebar-item-text sidebar-link">Mediation analysis</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-13" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-13" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediation1.html" class="sidebar-item-text sidebar-link">Baron and Kenny</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediation2.html" class="sidebar-item-text sidebar-link">Justification</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediation3.html" class="sidebar-item-text sidebar-link">Mediation Example</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediationF.html" class="sidebar-item-text sidebar-link">R functions (I)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./mediationQ.html" class="sidebar-item-text sidebar-link">Quiz (I)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./reporting.html" class="sidebar-item-text sidebar-link">Writing Tools</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-14" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-14" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting1.html" class="sidebar-item-text sidebar-link">Collaborative Writing</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting2.html" class="sidebar-item-text sidebar-link">Formatting Tools</a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#load-packages" id="toc-load-packages" class="nav-link active" data-scroll-target="#load-packages">Load packages</a></li>
  <li><a href="#load-data" id="toc-load-data" class="nav-link" data-scroll-target="#load-data">Load data</a></li>
  <li><a href="#analysis" id="toc-analysis" class="nav-link" data-scroll-target="#analysis">Analysis</a></li>
  <li><a href="#step-1" id="toc-step-1" class="nav-link" data-scroll-target="#step-1">Step 1</a></li>
  <li><a href="#step-2" id="toc-step-2" class="nav-link" data-scroll-target="#step-2">Step 2</a></li>
  <li><a href="#step-3" id="toc-step-3" class="nav-link" data-scroll-target="#step-3">Step 3</a></li>
  <li><a href="#repeat-of-step-1-3-again" id="toc-repeat-of-step-1-3-again" class="nav-link" data-scroll-target="#repeat-of-step-1-3-again">Repeat of Step 1-3 again</a></li>
  <li><a href="#step-4" id="toc-step-4" class="nav-link" data-scroll-target="#step-4">Step 4</a></li>
  <li><a href="#matched-data-with-increase-ratio" id="toc-matched-data-with-increase-ratio" class="nav-link" data-scroll-target="#matched-data-with-increase-ratio">Matched data with increase ratio</a></li>
  <li><a href="#video-content-optional" id="toc-video-content-optional" class="nav-link" data-scroll-target="#video-content-optional">Video content (optional)</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">PSM in OA-CVD (CCHS)</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i></button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>This tutorial is a comprehensive guide on implementing Propensity Score Matching (PSM) using R, particularly focusing on a OA - CVD health study from the Canadian Community Health Survey (CCHS). This PSM method is used to reduce bias due to confounding variables in observational studies by matching treated and control units with similar propensity scores. The tutorial illustrates that PSM is an iterative process, where researchers may need to refine their matching strategy to achieve satisfactory balance in the matched sample. Different strategies for estimating the treatment effect in the matched sample are explored, each with its own assumptions and implications.</p>
<section id="load-packages" class="level3"><h3 class="anchored" data-anchor-id="load-packages">Load packages</h3>
<p>At first, various R packages are loaded to utilize their functions for data manipulation, statistical analysis, and visualization.</p>
<div class="cell" data-hash="propensityscore2_cache/html/setup_41fc00b48777f01a707bb5d0e5747c10">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load required packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">require</span>(tableone)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">require</span>(survey)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">require</span>(cobalt)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">require</span>(Publish)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">require</span>(optmatch)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="load-data" class="level3"><h3 class="anchored" data-anchor-id="load-data">Load data</h3>
<p>The dataset is loaded into the R environment. Variables are renamed to avoid conflicts in subsequent analyses.</p>
<div class="cell" data-hash="propensityscore2_cache/html/data_77164924df979c43b937ca8d40f2710c">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">"Data/propensityscore/cchs123c.RData"</span>)</span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">head</span>(analytic11n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["weight"],"name":[18],"type":["dbl"],"align":["right"]},{"label":["cycle"],"name":[19],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[20],"type":["int"],"align":["right"]},{"label":["OA"],"name":[21],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[22],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[23],"type":["dbl"],"align":["right"]}],"data":[{"1":"no event","2":"30-39 years","3":"Female","4":"single","5":"Non-white","6":"Other 2nd grad.","7":"$50,000-$79,999","8":"healthy weight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"20.66","19":"11","20":"17838","21":"0","22":"not immigrant","23":"0","_rn_":"17838"},{"1":"no event","2":"30-39 years","3":"Female","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"healthy weight","9":"Moderate","10":"No","11":"Not too stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"15.06","19":"11","20":"17839","21":"0","22":"not immigrant","23":"0","_rn_":"17839"},{"1":"event","2":"50-59 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$80,000 or more","8":"healthy weight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Never drank","14":"6+ daily serving","15":"Yes","16":"No","17":"North","18":"74.04","19":"11","20":"17842","21":"0","22":"not immigrant","23":"0","_rn_":"17842"},{"1":"no event","2":"30-39 years","3":"Female","4":"not single","5":"Non-white","6":"Post-2nd grad.","7":"$80,000 or more","8":"healthy weight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Former smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"30.47","19":"11","20":"17844","21":"0","22":"not immigrant","23":"0","_rn_":"17844"},{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"12.10","19":"11","20":"17846","21":"0","22":"not immigrant","23":"0","_rn_":"17846"},{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Current drinker","14":"6+ daily serving","15":"No","16":"No","17":"North","18":"16.90","19":"11","20":"17847","21":"0","22":"not immigrant","23":"0","_rn_":"17847"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co"># later we will create another variable called weights</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co"># hence to avoid any conflict/ambiguity,</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="co"># renaming weight variable to survey.weight</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>analytic.miss<span class="sc">$</span>survey.weight <span class="ot">&lt;-</span> analytic.miss<span class="sc">$</span>weight</span>
<span id="cb3-6"><a href="#cb3-6"></a>analytic11n<span class="sc">$</span>survey.weight <span class="ot">&lt;-</span> analytic11n<span class="sc">$</span>weight</span>
<span id="cb3-7"><a href="#cb3-7"></a>analytic.miss<span class="sc">$</span>weight <span class="ot">&lt;-</span> analytic11n<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="cn">NULL</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="analysis" class="level3"><h3 class="anchored" data-anchor-id="analysis">Analysis</h3>
<p>We are going to apply propensity score analysis (Matching) in our OA - CVD problem from CCHS. For computation considerations, we will only work with cycle 1.1, and the people from Northern provinces in Canada (<code>analytic11n</code> data).</p>
</section><section id="step-1" class="level3"><h3 class="anchored" data-anchor-id="step-1">Step 1</h3>
<section id="specify-ps" class="level4"><h4 class="anchored" data-anchor-id="specify-ps">Specify PS</h4>
<p>A logistic regression model formula is specified to calculate the propensity scores (PS), which is the probability of receiving the treatment given the observed covariates.</p>
<div class="cell" data-hash="propensityscore2_cache/html/step1_bd33865d210bb860a3bf87a9d4d60fd0">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>ps.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"OA ~ age + sex + stress + married + </span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="st">                         income + race + bmi + phyact + smoke +</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="st">                        doctor + drink + bp + </span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="st">                         immigrate + fruit + diab + edu"</span>)</span>
<span id="cb4-5"><a href="#cb4-5"></a>var.names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"stress"</span>, <span class="st">"married"</span>, </span>
<span id="cb4-6"><a href="#cb4-6"></a>               <span class="st">"income"</span>, <span class="st">"race"</span>, <span class="st">"bmi"</span>, <span class="st">"phyact"</span>, <span class="st">"smoke"</span>, </span>
<span id="cb4-7"><a href="#cb4-7"></a>               <span class="st">"doctor"</span>, <span class="st">"drink"</span>, <span class="st">"bp"</span>, </span>
<span id="cb4-8"><a href="#cb4-8"></a>               <span class="st">"immigrate"</span>, <span class="st">"fruit"</span>, <span class="st">"diab"</span>, <span class="st">"edu"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="fit-model" class="level4"><h4 class="anchored" data-anchor-id="fit-model">Fit model</h4>
<p>The software fits the PS model using a logistic regression by default. This package actually performs step 1 and 2 with one command <code>matchit</code>.</p>
<p>Look at the website for arguments of matchit <span class="citation" data-cites="Matchit">(<a href="#ref-Matchit" role="doc-biblioref">RDocumentation 2023</a>)</span>]. It looks like this</p>
<div class="cell">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">matchit</span>(formula, data, <span class="at">model=</span><span class="st">"logit"</span>, <span class="at">discard=</span><span class="dv">0</span>, <span class="at">reestimate=</span><span class="cn">FALSE</span>, <span class="at">nearest=</span><span class="cn">TRUE</span>,</span>
<span id="cb5-2"><a href="#cb5-2"></a>                 <span class="at">replace=</span><span class="cn">FALSE</span>, <span class="at">m.order=</span><span class="dv">2</span>, <span class="at">ratio=</span><span class="dv">1</span>, <span class="at">caliper=</span><span class="dv">0</span>, <span class="at">calclosest=</span><span class="cn">FALSE</span>,</span>
<span id="cb5-3"><a href="#cb5-3"></a>                 <span class="at">subclass=</span><span class="dv">0</span>, <span class="at">sub.by=</span><span class="st">"treat"</span>, <span class="at">mahvars=</span><span class="cn">NULL</span>, <span class="at">exact=</span><span class="cn">FALSE</span>, <span class="at">counter=</span><span class="cn">TRUE</span>, <span class="at">full=</span><span class="cn">FALSE</span>, <span class="at">full.options=</span><span class="fu">list</span>(),...)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Nearest-Neighbor Matching</strong>:</p>
<p>Nearest-neighbor matching is a widely used technique in PSM to pair treated and control units based on the proximity of their propensity scores. It is straightforward and computationally efficient, making it a popular choice in many applications of PSM. Nearest-neighbor matching is often termed a “greedy” algorithm because it matches units in order, without considering the global distribution of propensity scores. Once a match is made, it is not revisited, even if a later unit would have been a better match. The method seeks to minimize bias by creating closely matched pairs but can increase variance if the pool of potential matches is reduced too much (e.g., using a very narrow caliper). It is essential to ensure that there is a common support region where the distributions of propensity scores for treated and control units overlap, ensuring comparability.</p>
</div>
</div>
</section></section><section id="step-2" class="level3"><h3 class="anchored" data-anchor-id="step-2">Step 2</h3>
<section id="match-subjects-by-ps" class="level4"><h4 class="anchored" data-anchor-id="match-subjects-by-ps">Match subjects by PS</h4>
<p>We are going to match using a Nearest neighbor algorithm. This is a greedy matching algorithm. Note that we are not even defining any caliper.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Caliper</strong>:</p>
<p>In the context of PSM, a caliper is a predefined maximum allowable difference between the propensity scores of matched units. Essentially, it sets a threshold for how dissimilar matched units can be in terms of their propensity scores. When a caliper is used, a treated unit is only matched with a control unit if the absolute difference in their propensity scores is less than or equal to the specified caliper width. The caliper is used to avoid bad matches and thereby minimize bias in the estimated treatment effect. The size of the caliper is crucial. Too wide a caliper may allow poor matches, while too narrow a caliper may result in many units going unmatched. Implementing a caliper involves a trade-off between bias and efficiency. Using a caliper reduces bias by avoiding poor matches but may increase variance by reducing the number of matched pairs available for analysis. Therefore, the use of a caliper in PSM is a strategic decision to enhance the quality of matches and thereby improve the validity of causal inferences drawn from observational data. It is a practical tool to ensure that matched units are sufficiently similar in terms of their propensity scores, reducing the likelihood of bias due to poor matches.</p>
</div>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/step2_a38ac165127c1bef7c99cb15b7d7bfc6">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># set seed</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co"># match</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb6-5"><a href="#cb6-5"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb6-6"><a href="#cb6-6"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb6-7"><a href="#cb6-7"></a>                        <span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co"># see how many matched</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>matching.obj</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt;  - distance: Propensity score</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt;  - number of obs.: 1424 (original), 134 (matched)</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt;  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co"># create the "matched"" data</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co"># see the dimension</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="fu">dim</span>(analytic11n)</span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt; [1] 1424   23</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="fu">dim</span>(OACVD.match)</span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">#&gt; [1] 134  26</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s try to understand how this is working.</p>
</section><section id="extract-matched-ids" class="level4"><h4 class="anchored" data-anchor-id="extract-matched-ids">Extract matched IDs</h4>
<div class="cell" data-hash="propensityscore2_cache/html/matchitstrata2_acc3f982d008eba89095ec0d4538fc93">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>m.mat<span class="ot">&lt;-</span>matching.obj<span class="sc">$</span>match.matrix</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">head</span>(m.mat)</span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt;       [,1]    </span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt; 17864 "96719" </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt; 17921 "17846" </span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; 18191 "97168" </span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; 18256 "111999"</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt; 18264 "17989" </span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; 18383 "108197"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="extract-the-matched-treated-ids" class="level4"><h4 class="anchored" data-anchor-id="extract-the-matched-treated-ids">Extract the matched treated IDs</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step2b_59ed09bd750b88161146a794acc8c5db">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>treated.id<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">row.names</span>(m.mat))</span>
<span id="cb8-2"><a href="#cb8-2"></a>treated.id <span class="co"># basically row names</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="co">#&gt;  [1]  17864  17921  18191  18256  18264  18383  18389  18475  39105  96344</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#&gt; [11]  96364  96407  96424  96460  96484  96571  96582  96625  96632  96641</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt; [21]  96657  96686  96693  96696  96705  96734  96795  96840  96913  97027</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt; [31]  97065  97125 108178 108183 108185 108192 111809 111813 111856 111859</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt; [41] 111895 111896 111920 111942 112014 112026 112046 112083 112086 112114</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt; [51] 112122 112151 112167 112189 112197 112215 112232 112245 112275 112284</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt; [61] 112289 112290 112300 112325 112375 126477 126522</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="extract-the-matched-untreated-ids" class="level4"><h4 class="anchored" data-anchor-id="extract-the-matched-untreated-ids">Extract the matched untreated IDs</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step2c_566083270d85bdd554067a769d40d57c">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>untreated.id <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(m.mat)</span>
<span id="cb9-2"><a href="#cb9-2"></a>untreated.id <span class="co"># basically row names</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&gt;  [1]  96719  17846  97168 111999  17989 108197 112384  17909 126561 111880</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&gt; [11] 112184  18117  96865  18120  97023 112379  97017 126562  96356 126470</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; [21] 126385  96374  18203  18262  96972 111924  96354  96983  18235  96882</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; [31] 112054  18321 112349  18426  38996 126516 111814 112087  96569 111932</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt; [41] 126539  18315  96665  18225 112052 112324 112165  18329  96609 126376</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt; [51]  96474 126570 126547 126343  96680  96558 111931  96718  96533 111823</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt; [61] 112177  17953  17904 111908 111962  96644  96576</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="extract-the-matched-treated-data" class="level4"><h4 class="anchored" data-anchor-id="extract-the-matched-treated-data">Extract the matched treated data</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step2d_606e2043348ec4e6eadadc6600734af5">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>tx <span class="ot">&lt;-</span> analytic11n[<span class="fu">rownames</span>(analytic11n) <span class="sc">%in%</span> treated.id,]</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="fu">head</span>(tx[<span class="fu">c</span>(<span class="st">"OA"</span>, <span class="st">"CVD"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"race"</span>, <span class="st">"edu"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["OA"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["CVD"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["age"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]}],"data":[{"1":"1","2":"no event","3":"Female","4":"40-49 years","5":"Non-white","6":"< 2ndary","_rn_":"17864"},{"1":"1","2":"no event","3":"Female","4":"30-39 years","5":"White","6":"Post-2nd grad.","_rn_":"17921"},{"1":"1","2":"no event","3":"Female","4":"40-49 years","5":"Non-white","6":"< 2ndary","_rn_":"18191"},{"1":"1","2":"no event","3":"Male","4":"30-39 years","5":"Non-white","6":"Post-2nd grad.","_rn_":"18256"},{"1":"1","2":"no event","3":"Male","4":"20-29 years","5":"Non-white","6":"< 2ndary","_rn_":"18264"},{"1":"1","2":"no event","3":"Male","4":"30-39 years","5":"Non-white","6":"< 2ndary","_rn_":"18383"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section><section id="extract-the-matched-untreated-data" class="level4"><h4 class="anchored" data-anchor-id="extract-the-matched-untreated-data">Extract the matched untreated data</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step2e_8f53b110824b1fa36f2ecde24978966c">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>utx <span class="ot">&lt;-</span> analytic11n[<span class="fu">rownames</span>(analytic11n) <span class="sc">%in%</span> untreated.id,]</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">head</span>(utx[<span class="fu">c</span>(<span class="st">"OA"</span>, <span class="st">"CVD"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"race"</span>, <span class="st">"edu"</span>)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["OA"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["CVD"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["age"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]}],"data":[{"1":"0","2":"no event","3":"Male","4":"30-39 years","5":"White","6":"Post-2nd grad.","_rn_":"17846"},{"1":"0","2":"no event","3":"Female","4":"40-49 years","5":"Non-white","6":"< 2ndary","_rn_":"17904"},{"1":"0","2":"no event","3":"Female","4":"20-29 years","5":"White","6":"Post-2nd grad.","_rn_":"17909"},{"1":"0","2":"no event","3":"Male","4":"20-29 years","5":"White","6":"Post-2nd grad.","_rn_":"17953"},{"1":"0","2":"event","3":"Male","4":"30-39 years","5":"Non-white","6":"2nd grad.","_rn_":"17989"},{"1":"0","2":"no event","3":"Female","4":"60-64 years","5":"Non-white","6":"< 2ndary","_rn_":"18117"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section><section id="extract-the-matched-data-altogether" class="level4"><h4 class="anchored" data-anchor-id="extract-the-matched-data-altogether">Extract the matched data altogether</h4>
<p>Simply using <code>match.data</code> is enough (as done earlier).</p>
<div class="cell" data-hash="propensityscore2_cache/html/step2f_bf97749361e21174c16b0348f6faa25f">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="assign-match-id" class="level4"><h4 class="anchored" data-anchor-id="assign-match-id">Assign match ID</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step2g_ac9c99a3cb09a34774ce3f7d7348bb99">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>OACVD.match<span class="sc">$</span>match.ID <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>OACVD.match<span class="sc">$</span>match.ID[<span class="fu">rownames</span>(OACVD.match) <span class="sc">%in%</span> treated.id] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(treated.id)</span>
<span id="cb13-3"><a href="#cb13-3"></a>OACVD.match<span class="sc">$</span>match.ID[<span class="fu">rownames</span>(OACVD.match) <span class="sc">%in%</span> untreated.id] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(untreated.id)</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="fu">table</span>(OACVD.match<span class="sc">$</span>match.ID)</span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt; </span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="co">#&gt;  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 </span></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt;  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 </span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="co">#&gt; 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 </span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt;  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 </span></span>
<span id="cb13-10"><a href="#cb13-10"></a><span class="co">#&gt; 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 </span></span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co">#&gt;  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Take a look at individual matches for the first match</p>
<div class="cell" data-hash="propensityscore2_cache/html/step2h_387b628a12476e0af902753a25f43631">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">na.omit</span>(OACVD.match[OACVD.match<span class="sc">$</span>match.ID <span class="sc">==</span> <span class="dv">1</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["subclass"],"name":[26],"type":["fct"],"align":["left"]},{"label":["match.ID"],"name":[27],"type":["int"],"align":["right"]}],"data":[{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17846","20":"0","21":"not immigrant","22":"0","23":"12.10","24":"0.01854076","25":"1","26":"46","27":"1","_rn_":"17846"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17864","20":"1","21":"not immigrant","22":"0","23":"38.23","24":"0.18190027","25":"1","26":"30","27":"1","_rn_":"17864"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
<p>Take a look at individual matches for the second match</p>
<div class="cell" data-hash="propensityscore2_cache/html/step2i_fbfbad05b3c5660ff100df497f9704f2">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="fu">na.omit</span>(OACVD.match[OACVD.match<span class="sc">$</span>match.ID <span class="sc">==</span> <span class="dv">2</span>,])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["subclass"],"name":[26],"type":["fct"],"align":["left"]},{"label":["match.ID"],"name":[27],"type":["int"],"align":["right"]}],"data":[{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Former driker","14":"0-3 daily serving","15":"Yes","16":"No","17":"North","18":"11","19":"17904","20":"0","21":"not immigrant","22":"0","23":"52.04","24":"0.06783228","25":"1","26":"25","27":"2","_rn_":"17904"},{"1":"no event","2":"30-39 years","3":"Female","4":"single","5":"White","6":"Post-2nd grad.","7":"$29,999 or less","8":"Overweight","9":"Inactive","10":"No","11":"stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17921","20":"1","21":"not immigrant","22":"0","23":"15.88","24":"0.01857417","25":"1","26":"46","27":"2","_rn_":"17921"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section></section><section id="step-3" class="level3"><h3 class="anchored" data-anchor-id="step-3">Step 3</h3>
<p>Both graphical and numerical methods are used to assess the quality of the matches and the balance of covariates in the matched sample.</p>
<section id="examining-ps-graphically" class="level4"><h4 class="anchored" data-anchor-id="examining-ps-graphically">Examining PS graphically</h4>
<p>Visually inspect the PS and assess the balance of covariates in the matched sample. Various plots are generated to visualize the distribution of PS across treatment groups and to check the balance of covariates before and after matching.</p>
</section><section id="matchit-package" class="level4"><h4 class="anchored" data-anchor-id="matchit-package">matchit package</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step3_eaebbead8a9ff44754817e38a7fb0d5c">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># plot(matching.obj) # covariate balance</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="fu">plot</span>(matching.obj, <span class="at">type =</span> <span class="st">"jitter"</span>) <span class="co"># propensity score locations</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3-1.png" class="img-fluid" width="672"></p>
</div>
<pre><code>#&gt; To identify the units, use first mouse button; to stop, use second.
plot(matching.obj, type = "hist") #check matched treated vs matched control</code></pre>
<div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3-2.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>summrize.output <span class="ot">&lt;-</span> <span class="fu">summary</span>(matching.obj, <span class="at">standardize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="fu">plot</span>(summrize.output)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3-3.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="overalp-check" class="level4"><h4 class="anchored" data-anchor-id="overalp-check">Overalp check</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step3b_a04c8692aa9cca9244ea4bd5744c0328">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># plot propensity scores by exposure group</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">plot</span>(<span class="fu">density</span>(OACVD.match<span class="sc">$</span>distance[OACVD.match<span class="sc">$</span>OA<span class="sc">==</span><span class="dv">1</span>]), </span>
<span id="cb19-3"><a href="#cb19-3"></a>     <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="fu">lines</span>(<span class="fu">density</span>(OACVD.match<span class="sc">$</span>distance[OACVD.match<span class="sc">$</span>OA<span class="sc">==</span><span class="dv">0</span>]), </span>
<span id="cb19-5"><a href="#cb19-5"></a>      <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="fu">c</span>(<span class="st">"Non-arthritis"</span>,<span class="st">"OA"</span>), </span>
<span id="cb19-7"><a href="#cb19-7"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3b-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="cobalt-package" class="level4"><h4 class="anchored" data-anchor-id="cobalt-package">cobalt package</h4>
<p>Overlap check in a more convenient way</p>
<div class="cell" data-hash="propensityscore2_cache/html/step3c_bb6c1fc10e90ea17d67ad6946fef1591">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a><span class="co"># different badwidth</span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"distance"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3c-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="look-at-the-data" class="level4"><h4 class="anchored" data-anchor-id="look-at-the-data">Look at the data</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step3d_6010a159df2ab6e9342a198e69daddc3">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># what is distance variable here?</span></span>
<span id="cb21-2"><a href="#cb21-2"></a><span class="fu">head</span>(OACVD.match)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["subclass"],"name":[26],"type":["fct"],"align":["left"]},{"label":["match.ID"],"name":[27],"type":["int"],"align":["right"]}],"data":[{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17846","20":"0","21":"not immigrant","22":"0","23":"12.10","24":"0.01854076","25":"1","26":"46","27":"1","_rn_":"17846"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17864","20":"1","21":"not immigrant","22":"0","23":"38.23","24":"0.18190027","25":"1","26":"30","27":"1","_rn_":"17864"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Former driker","14":"0-3 daily serving","15":"Yes","16":"No","17":"North","18":"11","19":"17904","20":"0","21":"not immigrant","22":"0","23":"52.04","24":"0.06783228","25":"1","26":"25","27":"2","_rn_":"17904"},{"1":"no event","2":"20-29 years","3":"Female","4":"not single","5":"White","6":"Post-2nd grad.","7":"$80,000 or more","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17909","20":"0","21":"not immigrant","22":"0","23":"33.23","24":"0.03126371","25":"1","26":"36","27":"3","_rn_":"17909"},{"1":"no event","2":"30-39 years","3":"Female","4":"single","5":"White","6":"Post-2nd grad.","7":"$29,999 or less","8":"Overweight","9":"Inactive","10":"No","11":"stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17921","20":"1","21":"not immigrant","22":"0","23":"15.88","24":"0.01857417","25":"1","26":"46","27":"2","_rn_":"17921"},{"1":"no event","2":"20-29 years","3":"Male","4":"not single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Moderate","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17953","20":"0","21":"not immigrant","22":"0","23":"26.91","24":"0.00467081","25":"1","26":"24","27":"4","_rn_":"17953"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section><section id="numerical-values-of-ps" class="level4"><h4 class="anchored" data-anchor-id="numerical-values-of-ps">Numerical values of PS</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step3e_d8803c9224dca3d6d0d92a10c67db4ac">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>distance)</span>
<span id="cb22-2"><a href="#cb22-2"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb22-3"><a href="#cb22-3"></a><span class="co">#&gt; 0.004671 0.044834 0.099094 0.138969 0.200576 0.611166</span></span>
<span id="cb22-4"><a href="#cb22-4"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb22-5"><a href="#cb22-5"></a><span class="co">#&gt; OACVD.match$OA: 0</span></span>
<span id="cb22-6"><a href="#cb22-6"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb22-7"><a href="#cb22-7"></a><span class="co">#&gt; 0.004671 0.047344 0.099215 0.135042 0.199279 0.418206 </span></span>
<span id="cb22-8"><a href="#cb22-8"></a><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span id="cb22-9"><a href="#cb22-9"></a><span class="co">#&gt; OACVD.match$OA: 1</span></span>
<span id="cb22-10"><a href="#cb22-10"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb22-11"><a href="#cb22-11"></a><span class="co">#&gt; 0.004671 0.047346 0.098973 0.142897 0.198741 0.611166</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="question-for-the-students" class="level4"><h4 class="anchored" data-anchor-id="question-for-the-students">Question for the students</h4>
<ul>
<li>Are you happy with the matching after reviewing the plots?</li>
</ul></section><section id="covariate-balance-in-matched-sample" class="level4"><h4 class="anchored" data-anchor-id="covariate-balance-in-matched-sample">Covariate balance in matched sample</h4>
<p>Covariate balance is assessed numerically using standardized mean differences (SMD).</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Standardized mean differences</strong>: SMD is a versatile and widely used statistical measure that facilitates the comparison of groups in research by providing a scale-free metric of difference and balance. In the context of propensity score matching, achieving low SMD values for covariates after matching is crucial to ensuring the validity of causal inferences drawn from the matched sample.</p>
<p>Benifits:</p>
<ul>
<li>SMD is not influenced by the scale of the measured variable, making it suitable for comparing the balance of different variables measured on different scales.</li>
<li>Unlike hypothesis testing, SMD is not affected by sample size, making it a reliable measure for assessing balance in matched samples.</li>
</ul>
</div>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/step3f_b3e0aad2d6204b6704142d05de21d8a0">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb23-2"><a href="#cb23-2"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="co">#&gt;                        Stratified by OA</span></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="co">#&gt;                         0          1          SMD   </span></span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="co">#&gt;   n                     67         67               </span></span>
<span id="cb23-7"><a href="#cb23-7"></a><span class="co">#&gt;   age (%)                                      0.190</span></span>
<span id="cb23-8"><a href="#cb23-8"></a><span class="co">#&gt;      20-29 years         4 ( 6.0)   4 ( 6.0)        </span></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="co">#&gt;      30-39 years        16 (23.9)  11 (16.4)        </span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="co">#&gt;      40-49 years        16 (23.9)  18 (26.9)        </span></span>
<span id="cb23-11"><a href="#cb23-11"></a><span class="co">#&gt;      50-59 years        28 (41.8)  31 (46.3)        </span></span>
<span id="cb23-12"><a href="#cb23-12"></a><span class="co">#&gt;      60-64 years         3 ( 4.5)   3 ( 4.5)        </span></span>
<span id="cb23-13"><a href="#cb23-13"></a><span class="co">#&gt;      65 years and over   0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb23-14"><a href="#cb23-14"></a><span class="co">#&gt;      teen                0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb23-15"><a href="#cb23-15"></a><span class="co">#&gt;   sex = Male (%)        28 (41.8)  32 (47.8)   0.120</span></span>
<span id="cb23-16"><a href="#cb23-16"></a><span class="co">#&gt;   stress = stressed (%) 20 (29.9)  21 (31.3)   0.032</span></span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co">#&gt;   married = single (%)  22 (32.8)  23 (34.3)   0.032</span></span>
<span id="cb23-18"><a href="#cb23-18"></a><span class="co">#&gt;   income (%)                                   0.183</span></span>
<span id="cb23-19"><a href="#cb23-19"></a><span class="co">#&gt;      $29,999 or less    11 (16.4)  13 (19.4)        </span></span>
<span id="cb23-20"><a href="#cb23-20"></a><span class="co">#&gt;      $30,000-$49,999    19 (28.4)  15 (22.4)        </span></span>
<span id="cb23-21"><a href="#cb23-21"></a><span class="co">#&gt;      $50,000-$79,999    14 (20.9)  12 (17.9)        </span></span>
<span id="cb23-22"><a href="#cb23-22"></a><span class="co">#&gt;      $80,000 or more    23 (34.3)  27 (40.3)        </span></span>
<span id="cb23-23"><a href="#cb23-23"></a><span class="co">#&gt;   race = White (%)      43 (64.2)  44 (65.7)   0.031</span></span>
<span id="cb23-24"><a href="#cb23-24"></a><span class="co">#&gt;   bmi (%)                                     &lt;0.001</span></span>
<span id="cb23-25"><a href="#cb23-25"></a><span class="co">#&gt;      Underweight         0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb23-26"><a href="#cb23-26"></a><span class="co">#&gt;      healthy weight     18 (26.9)  18 (26.9)        </span></span>
<span id="cb23-27"><a href="#cb23-27"></a><span class="co">#&gt;      Overweight         49 (73.1)  49 (73.1)        </span></span>
<span id="cb23-28"><a href="#cb23-28"></a><span class="co">#&gt;   phyact (%)                                   0.041</span></span>
<span id="cb23-29"><a href="#cb23-29"></a><span class="co">#&gt;      Active             16 (23.9)  16 (23.9)        </span></span>
<span id="cb23-30"><a href="#cb23-30"></a><span class="co">#&gt;      Inactive           40 (59.7)  39 (58.2)        </span></span>
<span id="cb23-31"><a href="#cb23-31"></a><span class="co">#&gt;      Moderate           11 (16.4)  12 (17.9)        </span></span>
<span id="cb23-32"><a href="#cb23-32"></a><span class="co">#&gt;   smoke (%)                                    0.258</span></span>
<span id="cb23-33"><a href="#cb23-33"></a><span class="co">#&gt;      Never smoker       14 (20.9)   9 (13.4)        </span></span>
<span id="cb23-34"><a href="#cb23-34"></a><span class="co">#&gt;      Current smoker     20 (29.9)  27 (40.3)        </span></span>
<span id="cb23-35"><a href="#cb23-35"></a><span class="co">#&gt;      Former smoker      33 (49.3)  31 (46.3)        </span></span>
<span id="cb23-36"><a href="#cb23-36"></a><span class="co">#&gt;   doctor = Yes (%)      51 (76.1)  47 (70.1)   0.135</span></span>
<span id="cb23-37"><a href="#cb23-37"></a><span class="co">#&gt;   drink (%)                                    0.116</span></span>
<span id="cb23-38"><a href="#cb23-38"></a><span class="co">#&gt;      Never drank         2 ( 3.0)   2 ( 3.0)        </span></span>
<span id="cb23-39"><a href="#cb23-39"></a><span class="co">#&gt;      Current drinker    54 (80.6)  51 (76.1)        </span></span>
<span id="cb23-40"><a href="#cb23-40"></a><span class="co">#&gt;      Former driker      11 (16.4)  14 (20.9)        </span></span>
<span id="cb23-41"><a href="#cb23-41"></a><span class="co">#&gt;   bp = Yes (%)           7 (10.4)   5 ( 7.5)   0.105</span></span>
<span id="cb23-42"><a href="#cb23-42"></a><span class="co">#&gt;   immigrate (%)                                0.180</span></span>
<span id="cb23-43"><a href="#cb23-43"></a><span class="co">#&gt;      not immigrant      64 (95.5)  61 (91.0)        </span></span>
<span id="cb23-44"><a href="#cb23-44"></a><span class="co">#&gt;      &gt; 10 years          3 ( 4.5)   6 ( 9.0)        </span></span>
<span id="cb23-45"><a href="#cb23-45"></a><span class="co">#&gt;      recent              0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb23-46"><a href="#cb23-46"></a><span class="co">#&gt;   fruit (%)                                    0.146</span></span>
<span id="cb23-47"><a href="#cb23-47"></a><span class="co">#&gt;      0-3 daily serving  19 (28.4)  19 (28.4)        </span></span>
<span id="cb23-48"><a href="#cb23-48"></a><span class="co">#&gt;      4-6 daily serving  28 (41.8)  32 (47.8)        </span></span>
<span id="cb23-49"><a href="#cb23-49"></a><span class="co">#&gt;      6+ daily serving   20 (29.9)  16 (23.9)        </span></span>
<span id="cb23-50"><a href="#cb23-50"></a><span class="co">#&gt;   diab = Yes (%)         1 ( 1.5)   4 ( 6.0)   0.238</span></span>
<span id="cb23-51"><a href="#cb23-51"></a><span class="co">#&gt;   edu (%)                                      0.105</span></span>
<span id="cb23-52"><a href="#cb23-52"></a><span class="co">#&gt;      &lt; 2ndary           14 (20.9)  13 (19.4)        </span></span>
<span id="cb23-53"><a href="#cb23-53"></a><span class="co">#&gt;      2nd grad.           1 ( 1.5)   2 ( 3.0)        </span></span>
<span id="cb23-54"><a href="#cb23-54"></a><span class="co">#&gt;      Other 2nd grad.     1 ( 1.5)   1 ( 1.5)        </span></span>
<span id="cb23-55"><a href="#cb23-55"></a><span class="co">#&gt;      Post-2nd grad.     51 (76.1)  51 (76.1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="question-for-the-students-1" class="level4"><h4 class="anchored" data-anchor-id="question-for-the-students-1">Question for the students</h4>
<ul>
<li>All SMD &lt; 0.20?</li>
</ul></section><section id="other-balance-measures" class="level4"><h4 class="anchored" data-anchor-id="other-balance-measures">Other balance measures</h4>
<section id="individual-categories" class="level5"><h5 class="anchored" data-anchor-id="individual-categories">Individual categories</h5>
<p>If you want to check balance at each category (not very useful in general situations). We are generally interested if the variables are balanced or not (not categories).</p>
<div class="cell" data-hash="propensityscore2_cache/html/step3g_efa8b3a85a452eed2c2bdbb3c06ba8b1">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>baltab <span class="ot">&lt;-</span> <span class="fu">bal.tab</span>(matching.obj)</span>
<span id="cb24-2"><a href="#cb24-2"></a>baltab</span>
<span id="cb24-3"><a href="#cb24-3"></a><span class="co">#&gt; Balance Measures</span></span>
<span id="cb24-4"><a href="#cb24-4"></a><span class="co">#&gt;                             Type Diff.Adj</span></span>
<span id="cb24-5"><a href="#cb24-5"></a><span class="co">#&gt; distance                Distance   0.0597</span></span>
<span id="cb24-6"><a href="#cb24-6"></a><span class="co">#&gt; age_20-29 years           Binary   0.0000</span></span>
<span id="cb24-7"><a href="#cb24-7"></a><span class="co">#&gt; age_30-39 years           Binary  -0.0746</span></span>
<span id="cb24-8"><a href="#cb24-8"></a><span class="co">#&gt; age_40-49 years           Binary   0.0299</span></span>
<span id="cb24-9"><a href="#cb24-9"></a><span class="co">#&gt; age_50-59 years           Binary   0.0448</span></span>
<span id="cb24-10"><a href="#cb24-10"></a><span class="co">#&gt; age_60-64 years           Binary   0.0000</span></span>
<span id="cb24-11"><a href="#cb24-11"></a><span class="co">#&gt; sex_Male                  Binary   0.0597</span></span>
<span id="cb24-12"><a href="#cb24-12"></a><span class="co">#&gt; stress_stressed           Binary   0.0149</span></span>
<span id="cb24-13"><a href="#cb24-13"></a><span class="co">#&gt; married_single            Binary   0.0149</span></span>
<span id="cb24-14"><a href="#cb24-14"></a><span class="co">#&gt; income_$29,999 or less    Binary   0.0299</span></span>
<span id="cb24-15"><a href="#cb24-15"></a><span class="co">#&gt; income_$30,000-$49,999    Binary  -0.0597</span></span>
<span id="cb24-16"><a href="#cb24-16"></a><span class="co">#&gt; income_$50,000-$79,999    Binary  -0.0299</span></span>
<span id="cb24-17"><a href="#cb24-17"></a><span class="co">#&gt; income_$80,000 or more    Binary   0.0597</span></span>
<span id="cb24-18"><a href="#cb24-18"></a><span class="co">#&gt; race_White                Binary   0.0149</span></span>
<span id="cb24-19"><a href="#cb24-19"></a><span class="co">#&gt; bmi_Underweight           Binary   0.0000</span></span>
<span id="cb24-20"><a href="#cb24-20"></a><span class="co">#&gt; bmi_healthy weight        Binary   0.0000</span></span>
<span id="cb24-21"><a href="#cb24-21"></a><span class="co">#&gt; bmi_Overweight            Binary   0.0000</span></span>
<span id="cb24-22"><a href="#cb24-22"></a><span class="co">#&gt; phyact_Active             Binary   0.0000</span></span>
<span id="cb24-23"><a href="#cb24-23"></a><span class="co">#&gt; phyact_Inactive           Binary  -0.0149</span></span>
<span id="cb24-24"><a href="#cb24-24"></a><span class="co">#&gt; phyact_Moderate           Binary   0.0149</span></span>
<span id="cb24-25"><a href="#cb24-25"></a><span class="co">#&gt; smoke_Never smoker        Binary  -0.0746</span></span>
<span id="cb24-26"><a href="#cb24-26"></a><span class="co">#&gt; smoke_Current smoker      Binary   0.1045</span></span>
<span id="cb24-27"><a href="#cb24-27"></a><span class="co">#&gt; smoke_Former smoker       Binary  -0.0299</span></span>
<span id="cb24-28"><a href="#cb24-28"></a><span class="co">#&gt; doctor_Yes                Binary  -0.0597</span></span>
<span id="cb24-29"><a href="#cb24-29"></a><span class="co">#&gt; drink_Never drank         Binary   0.0000</span></span>
<span id="cb24-30"><a href="#cb24-30"></a><span class="co">#&gt; drink_Current drinker     Binary  -0.0448</span></span>
<span id="cb24-31"><a href="#cb24-31"></a><span class="co">#&gt; drink_Former driker       Binary   0.0448</span></span>
<span id="cb24-32"><a href="#cb24-32"></a><span class="co">#&gt; bp_Yes                    Binary  -0.0299</span></span>
<span id="cb24-33"><a href="#cb24-33"></a><span class="co">#&gt; immigrate_not immigrant   Binary  -0.0448</span></span>
<span id="cb24-34"><a href="#cb24-34"></a><span class="co">#&gt; immigrate_&gt; 10 years      Binary   0.0448</span></span>
<span id="cb24-35"><a href="#cb24-35"></a><span class="co">#&gt; immigrate_recent          Binary   0.0000</span></span>
<span id="cb24-36"><a href="#cb24-36"></a><span class="co">#&gt; fruit_0-3 daily serving   Binary   0.0000</span></span>
<span id="cb24-37"><a href="#cb24-37"></a><span class="co">#&gt; fruit_4-6 daily serving   Binary   0.0597</span></span>
<span id="cb24-38"><a href="#cb24-38"></a><span class="co">#&gt; fruit_6+ daily serving    Binary  -0.0597</span></span>
<span id="cb24-39"><a href="#cb24-39"></a><span class="co">#&gt; diab_Yes                  Binary   0.0448</span></span>
<span id="cb24-40"><a href="#cb24-40"></a><span class="co">#&gt; edu_&lt; 2ndary              Binary  -0.0149</span></span>
<span id="cb24-41"><a href="#cb24-41"></a><span class="co">#&gt; edu_2nd grad.             Binary   0.0149</span></span>
<span id="cb24-42"><a href="#cb24-42"></a><span class="co">#&gt; edu_Other 2nd grad.       Binary   0.0000</span></span>
<span id="cb24-43"><a href="#cb24-43"></a><span class="co">#&gt; edu_Post-2nd grad.        Binary   0.0000</span></span>
<span id="cb24-44"><a href="#cb24-44"></a><span class="co">#&gt; </span></span>
<span id="cb24-45"><a href="#cb24-45"></a><span class="co">#&gt; Sample sizes</span></span>
<span id="cb24-46"><a href="#cb24-46"></a><span class="co">#&gt;           Control Treated</span></span>
<span id="cb24-47"><a href="#cb24-47"></a><span class="co">#&gt; All          1357      67</span></span>
<span id="cb24-48"><a href="#cb24-48"></a><span class="co">#&gt; Matched        67      67</span></span>
<span id="cb24-49"><a href="#cb24-49"></a><span class="co">#&gt; Unmatched    1290       0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="individual-plots" class="level5"><h5 class="anchored" data-anchor-id="individual-plots">Individual plots</h5>
<p>You could plot each variables individually</p>
<div class="cell" data-hash="propensityscore2_cache/html/step3h_2d0d2774a69b9c76e9d218722ccfeeb6">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"income"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3h-1.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"age"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3h-2.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"race"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3h-3.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"diab"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3h-4.png" class="img-fluid" width="672"></p>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"immigrate"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/step3h-5.png" class="img-fluid" width="672"></p>
</div>
</div>
</section><section id="love-plot" class="level5"><h5 class="anchored" data-anchor-id="love-plot">Love plot</h5>
<div class="cell" data-hash="propensityscore2_cache/html/loveplot_0a47658a80b3082fdb25de43e4f2fa80">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1"></a><span class="co"># Individual categories again</span></span>
<span id="cb30-2"><a href="#cb30-2"></a><span class="fu">love.plot</span>(baltab, <span class="at">threshold =</span> .<span class="dv">2</span>)</span>
<span id="cb30-3"><a href="#cb30-3"></a><span class="co">#&gt; Warning: Unadjusted values are missing. This can occur when `un = FALSE` and</span></span>
<span id="cb30-4"><a href="#cb30-4"></a><span class="co">#&gt; `quick = TRUE` in the original call to `bal.tab()`.</span></span>
<span id="cb30-5"><a href="#cb30-5"></a><span class="co">#&gt; Warning: Standardized mean differences and raw mean differences are present in the same plot. </span></span>
<span id="cb30-6"><a href="#cb30-6"></a><span class="co">#&gt; Use the `stars` argument to distinguish between them and appropriately label the x-axis.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore2_files/figure-html/loveplot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section></section></section><section id="repeat-of-step-1-3-again" class="level3"><h3 class="anchored" data-anchor-id="repeat-of-step-1-3-again">Repeat of Step 1-3 again</h3>
<p>Covariate balance is reassessed in each step to ensure the quality of the match.</p>
<section id="add-caliper" class="level4"><h4 class="anchored" data-anchor-id="add-caliper">Add caliper</h4>
<p>The matching process is repeated, this time introducing a caliper to ensure that matches are only made within a specified range of PS.</p>
<div class="cell" data-hash="propensityscore2_cache/html/step3i_8d227fbf633ac580edc4e8952ddd0e1d">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a>logitPS <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">/</span>OACVD.match<span class="sc">$</span>distance <span class="sc">-</span> <span class="dv">1</span>) </span>
<span id="cb31-2"><a href="#cb31-2"></a><span class="co"># logit of the propensity score</span></span>
<span id="cb31-3"><a href="#cb31-3"></a>.<span class="dv">2</span><span class="sc">*</span><span class="fu">sd</span>(logitPS) <span class="co"># suggested in the literature</span></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co">#&gt; [1] 0.2334615</span></span>
<span id="cb31-5"><a href="#cb31-5"></a></span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb31-8"><a href="#cb31-8"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb31-9"><a href="#cb31-9"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb31-10"><a href="#cb31-10"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb31-11"><a href="#cb31-11"></a>                        <span class="at">ratio =</span> <span class="dv">1</span>,</span>
<span id="cb31-12"><a href="#cb31-12"></a>                        <span class="at">caliper =</span> .<span class="dv">2</span><span class="sc">*</span><span class="fu">sd</span>(logitPS))</span>
<span id="cb31-13"><a href="#cb31-13"></a><span class="co"># see how many matched</span></span>
<span id="cb31-14"><a href="#cb31-14"></a>matching.obj</span>
<span id="cb31-15"><a href="#cb31-15"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb31-16"><a href="#cb31-16"></a><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span id="cb31-17"><a href="#cb31-17"></a><span class="co">#&gt;  - distance: Propensity score [caliper]</span></span>
<span id="cb31-18"><a href="#cb31-18"></a><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span id="cb31-19"><a href="#cb31-19"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.015)</span></span>
<span id="cb31-20"><a href="#cb31-20"></a><span class="co">#&gt;  - number of obs.: 1424 (original), 128 (matched)</span></span>
<span id="cb31-21"><a href="#cb31-21"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb31-22"><a href="#cb31-22"></a><span class="co">#&gt;  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu</span></span>
<span id="cb31-23"><a href="#cb31-23"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/step3j_4df312b8b00d1c451d4572156071c5ef">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="co"># Step 3</span></span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="co">#&gt; OACVD.match$OA: 0</span></span>
<span id="cb32-4"><a href="#cb32-4"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb32-5"><a href="#cb32-5"></a><span class="co">#&gt; 0.004671 0.041740 0.094963 0.124665 0.184103 0.418206 </span></span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span id="cb32-7"><a href="#cb32-7"></a><span class="co">#&gt; OACVD.match$OA: 1</span></span>
<span id="cb32-8"><a href="#cb32-8"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb32-9"><a href="#cb32-9"></a><span class="co">#&gt; 0.004671 0.041694 0.095089 0.125262 0.183739 0.424895</span></span>
<span id="cb32-10"><a href="#cb32-10"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb32-11"><a href="#cb32-11"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb32-12"><a href="#cb32-12"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb32-13"><a href="#cb32-13"></a><span class="co">#&gt;                        Stratified by OA</span></span>
<span id="cb32-14"><a href="#cb32-14"></a><span class="co">#&gt;                         0          1          SMD   </span></span>
<span id="cb32-15"><a href="#cb32-15"></a><span class="co">#&gt;   n                     64         64               </span></span>
<span id="cb32-16"><a href="#cb32-16"></a><span class="co">#&gt;   age (%)                                      0.196</span></span>
<span id="cb32-17"><a href="#cb32-17"></a><span class="co">#&gt;      20-29 years         4 ( 6.2)   4 ( 6.2)        </span></span>
<span id="cb32-18"><a href="#cb32-18"></a><span class="co">#&gt;      30-39 years        16 (25.0)  11 (17.2)        </span></span>
<span id="cb32-19"><a href="#cb32-19"></a><span class="co">#&gt;      40-49 years        16 (25.0)  18 (28.1)        </span></span>
<span id="cb32-20"><a href="#cb32-20"></a><span class="co">#&gt;      50-59 years        25 (39.1)  28 (43.8)        </span></span>
<span id="cb32-21"><a href="#cb32-21"></a><span class="co">#&gt;      60-64 years         3 ( 4.7)   3 ( 4.7)        </span></span>
<span id="cb32-22"><a href="#cb32-22"></a><span class="co">#&gt;      65 years and over   0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb32-23"><a href="#cb32-23"></a><span class="co">#&gt;      teen                0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb32-24"><a href="#cb32-24"></a><span class="co">#&gt;   sex = Male (%)        27 (42.2)  30 (46.9)   0.094</span></span>
<span id="cb32-25"><a href="#cb32-25"></a><span class="co">#&gt;   stress = stressed (%) 18 (28.1)  18 (28.1)  &lt;0.001</span></span>
<span id="cb32-26"><a href="#cb32-26"></a><span class="co">#&gt;   married = single (%)  21 (32.8)  23 (35.9)   0.066</span></span>
<span id="cb32-27"><a href="#cb32-27"></a><span class="co">#&gt;   income (%)                                   0.204</span></span>
<span id="cb32-28"><a href="#cb32-28"></a><span class="co">#&gt;      $29,999 or less    11 (17.2)  13 (20.3)        </span></span>
<span id="cb32-29"><a href="#cb32-29"></a><span class="co">#&gt;      $30,000-$49,999    19 (29.7)  14 (21.9)        </span></span>
<span id="cb32-30"><a href="#cb32-30"></a><span class="co">#&gt;      $50,000-$79,999    13 (20.3)  12 (18.8)        </span></span>
<span id="cb32-31"><a href="#cb32-31"></a><span class="co">#&gt;      $80,000 or more    21 (32.8)  25 (39.1)        </span></span>
<span id="cb32-32"><a href="#cb32-32"></a><span class="co">#&gt;   race = White (%)      40 (62.5)  42 (65.6)   0.065</span></span>
<span id="cb32-33"><a href="#cb32-33"></a><span class="co">#&gt;   bmi (%)                                     &lt;0.001</span></span>
<span id="cb32-34"><a href="#cb32-34"></a><span class="co">#&gt;      Underweight         0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb32-35"><a href="#cb32-35"></a><span class="co">#&gt;      healthy weight     18 (28.1)  18 (28.1)        </span></span>
<span id="cb32-36"><a href="#cb32-36"></a><span class="co">#&gt;      Overweight         46 (71.9)  46 (71.9)        </span></span>
<span id="cb32-37"><a href="#cb32-37"></a><span class="co">#&gt;   phyact (%)                                   0.096</span></span>
<span id="cb32-38"><a href="#cb32-38"></a><span class="co">#&gt;      Active             14 (21.9)  16 (25.0)        </span></span>
<span id="cb32-39"><a href="#cb32-39"></a><span class="co">#&gt;      Inactive           39 (60.9)  36 (56.2)        </span></span>
<span id="cb32-40"><a href="#cb32-40"></a><span class="co">#&gt;      Moderate           11 (17.2)  12 (18.8)        </span></span>
<span id="cb32-41"><a href="#cb32-41"></a><span class="co">#&gt;   smoke (%)                                    0.267</span></span>
<span id="cb32-42"><a href="#cb32-42"></a><span class="co">#&gt;      Never smoker       14 (21.9)   9 (14.1)        </span></span>
<span id="cb32-43"><a href="#cb32-43"></a><span class="co">#&gt;      Current smoker     19 (29.7)  26 (40.6)        </span></span>
<span id="cb32-44"><a href="#cb32-44"></a><span class="co">#&gt;      Former smoker      31 (48.4)  29 (45.3)        </span></span>
<span id="cb32-45"><a href="#cb32-45"></a><span class="co">#&gt;   doctor = Yes (%)      48 (75.0)  44 (68.8)   0.139</span></span>
<span id="cb32-46"><a href="#cb32-46"></a><span class="co">#&gt;   drink (%)                                    0.123</span></span>
<span id="cb32-47"><a href="#cb32-47"></a><span class="co">#&gt;      Never drank         2 ( 3.1)   2 ( 3.1)        </span></span>
<span id="cb32-48"><a href="#cb32-48"></a><span class="co">#&gt;      Current drinker    52 (81.2)  49 (76.6)        </span></span>
<span id="cb32-49"><a href="#cb32-49"></a><span class="co">#&gt;      Former driker      10 (15.6)  13 (20.3)        </span></span>
<span id="cb32-50"><a href="#cb32-50"></a><span class="co">#&gt;   bp = Yes (%)           7 (10.9)   5 ( 7.8)   0.107</span></span>
<span id="cb32-51"><a href="#cb32-51"></a><span class="co">#&gt;   immigrate (%)                                0.260</span></span>
<span id="cb32-52"><a href="#cb32-52"></a><span class="co">#&gt;      not immigrant      62 (96.9)  58 (90.6)        </span></span>
<span id="cb32-53"><a href="#cb32-53"></a><span class="co">#&gt;      &gt; 10 years          2 ( 3.1)   6 ( 9.4)        </span></span>
<span id="cb32-54"><a href="#cb32-54"></a><span class="co">#&gt;      recent              0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb32-55"><a href="#cb32-55"></a><span class="co">#&gt;   fruit (%)                                    0.116</span></span>
<span id="cb32-56"><a href="#cb32-56"></a><span class="co">#&gt;      0-3 daily serving  19 (29.7)  19 (29.7)        </span></span>
<span id="cb32-57"><a href="#cb32-57"></a><span class="co">#&gt;      4-6 daily serving  27 (42.2)  30 (46.9)        </span></span>
<span id="cb32-58"><a href="#cb32-58"></a><span class="co">#&gt;      6+ daily serving   18 (28.1)  15 (23.4)        </span></span>
<span id="cb32-59"><a href="#cb32-59"></a><span class="co">#&gt;   diab = Yes (%)         0 ( 0.0)   3 ( 4.7)   0.314</span></span>
<span id="cb32-60"><a href="#cb32-60"></a><span class="co">#&gt;   edu (%)                                      0.108</span></span>
<span id="cb32-61"><a href="#cb32-61"></a><span class="co">#&gt;      &lt; 2ndary           14 (21.9)  13 (20.3)        </span></span>
<span id="cb32-62"><a href="#cb32-62"></a><span class="co">#&gt;      2nd grad.           1 ( 1.6)   2 ( 3.1)        </span></span>
<span id="cb32-63"><a href="#cb32-63"></a><span class="co">#&gt;      Other 2nd grad.     1 ( 1.6)   1 ( 1.6)        </span></span>
<span id="cb32-64"><a href="#cb32-64"></a><span class="co">#&gt;      Post-2nd grad.     48 (75.0)  48 (75.0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="question-for-the-students-2" class="level4"><h4 class="anchored" data-anchor-id="question-for-the-students-2">Question for the students</h4>
<ul>
<li>Did all of the SMDs decrease?</li>
</ul></section><section id="look-at-the-data-1" class="level4"><h4 class="anchored" data-anchor-id="look-at-the-data-1">Look at the data</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step3k_722e2d8c4e1d3c189500dbd2e2f6f80d">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1"></a><span class="co"># what is weights variable for pair matching?</span></span>
<span id="cb33-2"><a href="#cb33-2"></a><span class="fu">head</span>(OACVD.match)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["subclass"],"name":[26],"type":["fct"],"align":["left"]}],"data":[{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17846","20":"0","21":"not immigrant","22":"0","23":"12.10","24":"0.01854076","25":"1","26":"46","_rn_":"17846"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17864","20":"1","21":"not immigrant","22":"0","23":"38.23","24":"0.18190027","25":"1","26":"30","_rn_":"17864"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Former driker","14":"0-3 daily serving","15":"Yes","16":"No","17":"North","18":"11","19":"17904","20":"0","21":"not immigrant","22":"0","23":"52.04","24":"0.06783228","25":"1","26":"25","_rn_":"17904"},{"1":"no event","2":"20-29 years","3":"Female","4":"not single","5":"White","6":"Post-2nd grad.","7":"$80,000 or more","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17909","20":"0","21":"not immigrant","22":"0","23":"33.23","24":"0.03126371","25":"1","26":"36","_rn_":"17909"},{"1":"no event","2":"30-39 years","3":"Female","4":"single","5":"White","6":"Post-2nd grad.","7":"$29,999 or less","8":"Overweight","9":"Inactive","10":"No","11":"stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17921","20":"1","21":"not immigrant","22":"0","23":"15.88","24":"0.01857417","25":"1","26":"46","_rn_":"17921"},{"1":"no event","2":"20-29 years","3":"Male","4":"not single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Moderate","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17953","20":"0","21":"not immigrant","22":"0","23":"26.91","24":"0.00467081","25":"1","26":"24","_rn_":"17953"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="co">#&gt;       1       1       1       1       1       1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="step-4" class="level3"><h3 class="anchored" data-anchor-id="step-4">Step 4</h3>
<section id="estimate-treatment-effect-for-matched-data" class="level4"><h4 class="anchored" data-anchor-id="estimate-treatment-effect-for-matched-data">Estimate treatment effect for matched data</h4>
<p>Different models (e.g., unconditional logistic regression, survey design) are fitted to estimate the treatment effect in the matched sample.</p>
</section><section id="unconditional-logistic" class="level4"><h4 class="anchored" data-anchor-id="unconditional-logistic">Unconditional logistic</h4>
<div class="cell" data-hash="propensityscore2_cache/html/step4_a5241f6f63352a012705249257394c92">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1"></a><span class="co"># Wrong model for population!!</span></span>
<span id="cb35-2"><a href="#cb35-2"></a>outcome.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(CVD <span class="sc">~</span> OA, <span class="at">data =</span> OACVD.match, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb35-3"><a href="#cb35-3"></a><span class="fu">publish</span>(outcome.model)</span>
<span id="cb35-4"><a href="#cb35-4"></a><span class="co">#&gt;  Variable Units OddsRatio       CI.95  p-value </span></span>
<span id="cb35-5"><a href="#cb35-5"></a><span class="co">#&gt;        OA            0.48 [0.09;2.74]   0.4119</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="survey-design" class="level4"><h4 class="anchored" data-anchor-id="survey-design">Survey design</h4>
<section id="convert-data-to-design" class="level5"><h5 class="anchored" data-anchor-id="convert-data-to-design">Convert data to design</h5>
<p>The matched data is converted to a survey design object to account for the matched pairs in the analysis.</p>
<div class="cell" data-hash="propensityscore2_cache/html/step4b_19891cf6266acf9e360b30359ff0fd20">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="co">#&gt; [1] 397173</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="co">#&gt; [1] 128</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="co">#&gt; [1] 128</span></span>
<span id="cb36-8"><a href="#cb36-8"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb36-10"><a href="#cb36-10"></a><span class="co">#&gt; </span></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="co">#&gt;      0      1 </span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="co">#&gt; 397045    128</span></span>
<span id="cb36-13"><a href="#cb36-13"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>survey.weight, </span>
<span id="cb36-14"><a href="#cb36-14"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb36-15"><a href="#cb36-15"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="balance-in-matched-population" class="level5"><h5 class="anchored" data-anchor-id="balance-in-matched-population">Balance in matched population?</h5>
<div class="cell" data-hash="propensityscore2_cache/html/step4c_209be743b31bba1ac8514610d8b3d6ca">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">svyCreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> w.design.m, </span>
<span id="cb37-2"><a href="#cb37-2"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb37-4"><a href="#cb37-4"></a><span class="co">#&gt;                        Stratified by OA</span></span>
<span id="cb37-5"><a href="#cb37-5"></a><span class="co">#&gt;                         0              1              SMD   </span></span>
<span id="cb37-6"><a href="#cb37-6"></a><span class="co">#&gt;   n                     1783.6         2002.1               </span></span>
<span id="cb37-7"><a href="#cb37-7"></a><span class="co">#&gt;   age (%)                                              0.307</span></span>
<span id="cb37-8"><a href="#cb37-8"></a><span class="co">#&gt;      20-29 years         131.0 ( 7.3)   120.9 ( 6.0)        </span></span>
<span id="cb37-9"><a href="#cb37-9"></a><span class="co">#&gt;      30-39 years         388.0 (21.8)   237.8 (11.9)        </span></span>
<span id="cb37-10"><a href="#cb37-10"></a><span class="co">#&gt;      40-49 years         518.3 (29.1)   572.7 (28.6)        </span></span>
<span id="cb37-11"><a href="#cb37-11"></a><span class="co">#&gt;      50-59 years         680.1 (38.1)   999.3 (49.9)        </span></span>
<span id="cb37-12"><a href="#cb37-12"></a><span class="co">#&gt;      60-64 years          66.1 ( 3.7)    71.4 ( 3.6)        </span></span>
<span id="cb37-13"><a href="#cb37-13"></a><span class="co">#&gt;      65 years and over     0.0 ( 0.0)     0.0 ( 0.0)        </span></span>
<span id="cb37-14"><a href="#cb37-14"></a><span class="co">#&gt;      teen                  0.0 ( 0.0)     0.0 ( 0.0)        </span></span>
<span id="cb37-15"><a href="#cb37-15"></a><span class="co">#&gt;   sex = Male (%)         852.4 (47.8)   985.1 (49.2)   0.028</span></span>
<span id="cb37-16"><a href="#cb37-16"></a><span class="co">#&gt;   stress = stressed (%)  544.6 (30.5)   531.8 (26.6)   0.088</span></span>
<span id="cb37-17"><a href="#cb37-17"></a><span class="co">#&gt;   married = single (%)   419.8 (23.5)   427.5 (21.4)   0.052</span></span>
<span id="cb37-18"><a href="#cb37-18"></a><span class="co">#&gt;   income (%)                                           0.222</span></span>
<span id="cb37-19"><a href="#cb37-19"></a><span class="co">#&gt;      $29,999 or less     266.6 (14.9)   352.4 (17.6)        </span></span>
<span id="cb37-20"><a href="#cb37-20"></a><span class="co">#&gt;      $30,000-$49,999     462.8 (25.9)   348.8 (17.4)        </span></span>
<span id="cb37-21"><a href="#cb37-21"></a><span class="co">#&gt;      $50,000-$79,999     298.6 (16.7)   315.7 (15.8)        </span></span>
<span id="cb37-22"><a href="#cb37-22"></a><span class="co">#&gt;      $80,000 or more     755.5 (42.4)   985.2 (49.2)        </span></span>
<span id="cb37-23"><a href="#cb37-23"></a><span class="co">#&gt;   race = White (%)      1129.2 (63.3)  1364.9 (68.2)   0.103</span></span>
<span id="cb37-24"><a href="#cb37-24"></a><span class="co">#&gt;   bmi (%)                                              0.045</span></span>
<span id="cb37-25"><a href="#cb37-25"></a><span class="co">#&gt;      Underweight           0.0 ( 0.0)     0.0 ( 0.0)        </span></span>
<span id="cb37-26"><a href="#cb37-26"></a><span class="co">#&gt;      healthy weight      483.3 (27.1)   583.3 (29.1)        </span></span>
<span id="cb37-27"><a href="#cb37-27"></a><span class="co">#&gt;      Overweight         1300.2 (72.9)  1418.8 (70.9)        </span></span>
<span id="cb37-28"><a href="#cb37-28"></a><span class="co">#&gt;   phyact (%)                                           0.054</span></span>
<span id="cb37-29"><a href="#cb37-29"></a><span class="co">#&gt;      Active              448.0 (25.1)   493.9 (24.7)        </span></span>
<span id="cb37-30"><a href="#cb37-30"></a><span class="co">#&gt;      Inactive           1075.2 (60.3)  1176.6 (58.8)        </span></span>
<span id="cb37-31"><a href="#cb37-31"></a><span class="co">#&gt;      Moderate            260.3 (14.6)   331.5 (16.6)        </span></span>
<span id="cb37-32"><a href="#cb37-32"></a><span class="co">#&gt;   smoke (%)                                            0.288</span></span>
<span id="cb37-33"><a href="#cb37-33"></a><span class="co">#&gt;      Never smoker        400.2 (22.4)   265.8 (13.3)        </span></span>
<span id="cb37-34"><a href="#cb37-34"></a><span class="co">#&gt;      Current smoker      548.8 (30.8)   836.6 (41.8)        </span></span>
<span id="cb37-35"><a href="#cb37-35"></a><span class="co">#&gt;      Former smoker       834.6 (46.8)   899.6 (44.9)        </span></span>
<span id="cb37-36"><a href="#cb37-36"></a><span class="co">#&gt;   doctor = Yes (%)      1376.0 (77.1)  1430.1 (71.4)   0.131</span></span>
<span id="cb37-37"><a href="#cb37-37"></a><span class="co">#&gt;   drink (%)                                            0.194</span></span>
<span id="cb37-38"><a href="#cb37-38"></a><span class="co">#&gt;      Never drank          44.0 ( 2.5)   112.6 ( 5.6)        </span></span>
<span id="cb37-39"><a href="#cb37-39"></a><span class="co">#&gt;      Current drinker    1464.1 (82.1)  1510.6 (75.5)        </span></span>
<span id="cb37-40"><a href="#cb37-40"></a><span class="co">#&gt;      Former driker       275.4 (15.4)   378.9 (18.9)        </span></span>
<span id="cb37-41"><a href="#cb37-41"></a><span class="co">#&gt;   bp = Yes (%)           166.6 ( 9.3)   153.5 ( 7.7)   0.060</span></span>
<span id="cb37-42"><a href="#cb37-42"></a><span class="co">#&gt;   immigrate (%)                                        0.235</span></span>
<span id="cb37-43"><a href="#cb37-43"></a><span class="co">#&gt;      not immigrant      1694.8 (95.0)  1774.1 (88.6)        </span></span>
<span id="cb37-44"><a href="#cb37-44"></a><span class="co">#&gt;      &gt; 10 years           88.8 ( 5.0)   228.0 (11.4)        </span></span>
<span id="cb37-45"><a href="#cb37-45"></a><span class="co">#&gt;      recent                0.0 ( 0.0)     0.0 ( 0.0)        </span></span>
<span id="cb37-46"><a href="#cb37-46"></a><span class="co">#&gt;   fruit (%)                                            0.293</span></span>
<span id="cb37-47"><a href="#cb37-47"></a><span class="co">#&gt;      0-3 daily serving   426.1 (23.9)   480.8 (24.0)        </span></span>
<span id="cb37-48"><a href="#cb37-48"></a><span class="co">#&gt;      4-6 daily serving   748.1 (41.9)  1082.3 (54.1)        </span></span>
<span id="cb37-49"><a href="#cb37-49"></a><span class="co">#&gt;      6+ daily serving    609.4 (34.2)   439.0 (21.9)        </span></span>
<span id="cb37-50"><a href="#cb37-50"></a><span class="co">#&gt;   diab = Yes (%)           0.0 ( 0.0)    83.6 ( 4.2)   0.295</span></span>
<span id="cb37-51"><a href="#cb37-51"></a><span class="co">#&gt;   edu (%)                                              0.172</span></span>
<span id="cb37-52"><a href="#cb37-52"></a><span class="co">#&gt;      &lt; 2ndary            324.9 (18.2)   342.8 (17.1)        </span></span>
<span id="cb37-53"><a href="#cb37-53"></a><span class="co">#&gt;      2nd grad.            18.8 ( 1.1)    47.6 ( 2.4)        </span></span>
<span id="cb37-54"><a href="#cb37-54"></a><span class="co">#&gt;      Other 2nd grad.      15.2 ( 0.9)    52.2 ( 2.6)        </span></span>
<span id="cb37-55"><a href="#cb37-55"></a><span class="co">#&gt;      Post-2nd grad.     1424.7 (79.9)  1559.4 (77.9)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="outcome-analysis" class="level5"><h5 class="anchored" data-anchor-id="outcome-analysis">Outcome analysis</h5>
<div class="cell" data-hash="propensityscore2_cache/html/step4d_a070e67d36187dab8e9f06d991c7933c">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(CVD <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb38-2"><a href="#cb38-2"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb38-3"><a href="#cb38-3"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb38-4"><a href="#cb38-4"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb38-5"><a href="#cb38-5"></a><span class="co">#&gt;  Variable Units OddsRatio       CI.95  p-value </span></span>
<span id="cb38-6"><a href="#cb38-6"></a><span class="co">#&gt;        OA            0.50 [0.08;3.09]   0.4535</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section></section><section id="matched-data-with-increase-ratio" class="level3"><h3 class="anchored" data-anchor-id="matched-data-with-increase-ratio">Matched data with increase ratio</h3>
<p>The matching process is repeated with a different ratio (e.g., 1:5) to explore how changing the ratio affects the covariate balance and treatment effect estimation.</p>
<div class="cell" data-hash="propensityscore2_cache/html/ratio_7e9a7035395a25a5f32e875635e03a46">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb39-2"><a href="#cb39-2"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb39-3"><a href="#cb39-3"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb39-4"><a href="#cb39-4"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb39-5"><a href="#cb39-5"></a>                        <span class="at">ratio =</span> <span class="dv">5</span>,</span>
<span id="cb39-6"><a href="#cb39-6"></a>                        <span class="at">caliper =</span> <span class="fl">0.2</span>)</span>
<span id="cb39-7"><a href="#cb39-7"></a><span class="co"># see how many matched</span></span>
<span id="cb39-8"><a href="#cb39-8"></a>matching.obj</span>
<span id="cb39-9"><a href="#cb39-9"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb39-10"><a href="#cb39-10"></a><span class="co">#&gt;  - method: 5:1 nearest neighbor matching without replacement</span></span>
<span id="cb39-11"><a href="#cb39-11"></a><span class="co">#&gt;  - distance: Propensity score [caliper]</span></span>
<span id="cb39-12"><a href="#cb39-12"></a><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span id="cb39-13"><a href="#cb39-13"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.013)</span></span>
<span id="cb39-14"><a href="#cb39-14"></a><span class="co">#&gt;  - number of obs.: 1424 (original), 349 (matched)</span></span>
<span id="cb39-15"><a href="#cb39-15"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb39-16"><a href="#cb39-16"></a><span class="co">#&gt;  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu</span></span>
<span id="cb39-17"><a href="#cb39-17"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb39-18"><a href="#cb39-18"></a><span class="co"># Step 3</span></span>
<span id="cb39-19"><a href="#cb39-19"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb39-20"><a href="#cb39-20"></a><span class="co">#&gt; OACVD.match$OA: 0</span></span>
<span id="cb39-21"><a href="#cb39-21"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb39-22"><a href="#cb39-22"></a><span class="co">#&gt; 0.004643 0.039181 0.084421 0.101576 0.146403 0.418206 </span></span>
<span id="cb39-23"><a href="#cb39-23"></a><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span id="cb39-24"><a href="#cb39-24"></a><span class="co">#&gt; OACVD.match$OA: 1</span></span>
<span id="cb39-25"><a href="#cb39-25"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb39-26"><a href="#cb39-26"></a><span class="co">#&gt; 0.004671 0.041694 0.095089 0.125262 0.183739 0.424895</span></span>
<span id="cb39-27"><a href="#cb39-27"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb39-28"><a href="#cb39-28"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb39-29"><a href="#cb39-29"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb39-30"><a href="#cb39-30"></a><span class="co">#&gt;                        Stratified by OA</span></span>
<span id="cb39-31"><a href="#cb39-31"></a><span class="co">#&gt;                         0           1          SMD   </span></span>
<span id="cb39-32"><a href="#cb39-32"></a><span class="co">#&gt;   n                     285         64               </span></span>
<span id="cb39-33"><a href="#cb39-33"></a><span class="co">#&gt;   age (%)                                       0.217</span></span>
<span id="cb39-34"><a href="#cb39-34"></a><span class="co">#&gt;      20-29 years         24 ( 8.4)   4 ( 6.2)        </span></span>
<span id="cb39-35"><a href="#cb39-35"></a><span class="co">#&gt;      30-39 years         59 (20.7)  11 (17.2)        </span></span>
<span id="cb39-36"><a href="#cb39-36"></a><span class="co">#&gt;      40-49 years         94 (33.0)  18 (28.1)        </span></span>
<span id="cb39-37"><a href="#cb39-37"></a><span class="co">#&gt;      50-59 years         98 (34.4)  28 (43.8)        </span></span>
<span id="cb39-38"><a href="#cb39-38"></a><span class="co">#&gt;      60-64 years         10 ( 3.5)   3 ( 4.7)        </span></span>
<span id="cb39-39"><a href="#cb39-39"></a><span class="co">#&gt;      65 years and over    0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb39-40"><a href="#cb39-40"></a><span class="co">#&gt;      teen                 0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb39-41"><a href="#cb39-41"></a><span class="co">#&gt;   sex = Male (%)        132 (46.3)  30 (46.9)   0.011</span></span>
<span id="cb39-42"><a href="#cb39-42"></a><span class="co">#&gt;   stress = stressed (%)  81 (28.4)  18 (28.1)   0.007</span></span>
<span id="cb39-43"><a href="#cb39-43"></a><span class="co">#&gt;   married = single (%)   91 (31.9)  23 (35.9)   0.085</span></span>
<span id="cb39-44"><a href="#cb39-44"></a><span class="co">#&gt;   income (%)                                    0.065</span></span>
<span id="cb39-45"><a href="#cb39-45"></a><span class="co">#&gt;      $29,999 or less     64 (22.5)  13 (20.3)        </span></span>
<span id="cb39-46"><a href="#cb39-46"></a><span class="co">#&gt;      $30,000-$49,999     65 (22.8)  14 (21.9)        </span></span>
<span id="cb39-47"><a href="#cb39-47"></a><span class="co">#&gt;      $50,000-$79,999     51 (17.9)  12 (18.8)        </span></span>
<span id="cb39-48"><a href="#cb39-48"></a><span class="co">#&gt;      $80,000 or more    105 (36.8)  25 (39.1)        </span></span>
<span id="cb39-49"><a href="#cb39-49"></a><span class="co">#&gt;   race = White (%)      169 (59.3)  42 (65.6)   0.131</span></span>
<span id="cb39-50"><a href="#cb39-50"></a><span class="co">#&gt;   bmi (%)                                       0.097</span></span>
<span id="cb39-51"><a href="#cb39-51"></a><span class="co">#&gt;      Underweight          0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb39-52"><a href="#cb39-52"></a><span class="co">#&gt;      healthy weight      68 (23.9)  18 (28.1)        </span></span>
<span id="cb39-53"><a href="#cb39-53"></a><span class="co">#&gt;      Overweight         217 (76.1)  46 (71.9)        </span></span>
<span id="cb39-54"><a href="#cb39-54"></a><span class="co">#&gt;   phyact (%)                                    0.136</span></span>
<span id="cb39-55"><a href="#cb39-55"></a><span class="co">#&gt;      Active              57 (20.0)  16 (25.0)        </span></span>
<span id="cb39-56"><a href="#cb39-56"></a><span class="co">#&gt;      Inactive           178 (62.5)  36 (56.2)        </span></span>
<span id="cb39-57"><a href="#cb39-57"></a><span class="co">#&gt;      Moderate            50 (17.5)  12 (18.8)        </span></span>
<span id="cb39-58"><a href="#cb39-58"></a><span class="co">#&gt;   smoke (%)                                     0.097</span></span>
<span id="cb39-59"><a href="#cb39-59"></a><span class="co">#&gt;      Never smoker        46 (16.1)   9 (14.1)        </span></span>
<span id="cb39-60"><a href="#cb39-60"></a><span class="co">#&gt;      Current smoker     123 (43.2)  26 (40.6)        </span></span>
<span id="cb39-61"><a href="#cb39-61"></a><span class="co">#&gt;      Former smoker      116 (40.7)  29 (45.3)        </span></span>
<span id="cb39-62"><a href="#cb39-62"></a><span class="co">#&gt;   doctor = Yes (%)      183 (64.2)  44 (68.8)   0.096</span></span>
<span id="cb39-63"><a href="#cb39-63"></a><span class="co">#&gt;   drink (%)                                     0.051</span></span>
<span id="cb39-64"><a href="#cb39-64"></a><span class="co">#&gt;      Never drank         10 ( 3.5)   2 ( 3.1)        </span></span>
<span id="cb39-65"><a href="#cb39-65"></a><span class="co">#&gt;      Current drinker    212 (74.4)  49 (76.6)        </span></span>
<span id="cb39-66"><a href="#cb39-66"></a><span class="co">#&gt;      Former driker       63 (22.1)  13 (20.3)        </span></span>
<span id="cb39-67"><a href="#cb39-67"></a><span class="co">#&gt;   bp = Yes (%)           22 ( 7.7)   5 ( 7.8)   0.003</span></span>
<span id="cb39-68"><a href="#cb39-68"></a><span class="co">#&gt;   immigrate (%)                                 0.100</span></span>
<span id="cb39-69"><a href="#cb39-69"></a><span class="co">#&gt;      not immigrant      266 (93.3)  58 (90.6)        </span></span>
<span id="cb39-70"><a href="#cb39-70"></a><span class="co">#&gt;      &gt; 10 years          19 ( 6.7)   6 ( 9.4)        </span></span>
<span id="cb39-71"><a href="#cb39-71"></a><span class="co">#&gt;      recent               0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb39-72"><a href="#cb39-72"></a><span class="co">#&gt;   fruit (%)                                     0.149</span></span>
<span id="cb39-73"><a href="#cb39-73"></a><span class="co">#&gt;      0-3 daily serving  104 (36.5)  19 (29.7)        </span></span>
<span id="cb39-74"><a href="#cb39-74"></a><span class="co">#&gt;      4-6 daily serving  124 (43.5)  30 (46.9)        </span></span>
<span id="cb39-75"><a href="#cb39-75"></a><span class="co">#&gt;      6+ daily serving    57 (20.0)  15 (23.4)        </span></span>
<span id="cb39-76"><a href="#cb39-76"></a><span class="co">#&gt;   diab = Yes (%)         12 ( 4.2)   3 ( 4.7)   0.023</span></span>
<span id="cb39-77"><a href="#cb39-77"></a><span class="co">#&gt;   edu (%)                                       0.137</span></span>
<span id="cb39-78"><a href="#cb39-78"></a><span class="co">#&gt;      &lt; 2ndary            67 (23.5)  13 (20.3)        </span></span>
<span id="cb39-79"><a href="#cb39-79"></a><span class="co">#&gt;      2nd grad.            9 ( 3.2)   2 ( 3.1)        </span></span>
<span id="cb39-80"><a href="#cb39-80"></a><span class="co">#&gt;      Other 2nd grad.      9 ( 3.2)   1 ( 1.6)        </span></span>
<span id="cb39-81"><a href="#cb39-81"></a><span class="co">#&gt;      Post-2nd grad.     200 (70.2)  48 (75.0)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="question-for-the-students-3" class="level5"><h5 class="anchored" data-anchor-id="question-for-the-students-3">Question for the students</h5>
<ul>
<li>Did all of the SMDs decrease?</li>
</ul></section><section id="look-at-the-data-2" class="level5"><h5 class="anchored" data-anchor-id="look-at-the-data-2">Look at the data</h5>
<div class="cell" data-hash="propensityscore2_cache/html/summdata_a83fddff664a38be2a71add01d451a45">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1"></a><span class="co"># what is weights variable now for 1:5 ratio?</span></span>
<span id="cb40-2"><a href="#cb40-2"></a><span class="fu">head</span>(OACVD.match)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]},{"label":["subclass"],"name":[26],"type":["fct"],"align":["left"]}],"data":[{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17846","20":"0","21":"not immigrant","22":"0","23":"12.10","24":"0.01854076","25":"0.890625","26":"46","_rn_":"17846"},{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Current drinker","14":"6+ daily serving","15":"No","16":"No","17":"North","18":"11","19":"17847","20":"0","21":"not immigrant","22":"0","23":"16.90","24":"0.05730827","25":"0.890625","26":"41","_rn_":"17847"},{"1":"event","2":"40-49 years","3":"Male","4":"not single","5":"Non-white","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Active","10":"No","11":"stressed","12":"Current smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17848","20":"0","21":"not immigrant","22":"0","23":"39.28","24":"0.08589902","25":"0.890625","26":"63","_rn_":"17848"},{"1":"no event","2":"40-49 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Moderate","10":"Yes","11":"Not too stressed","12":"Former smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17852","20":"0","21":"not immigrant","22":"0","23":"12.52","24":"0.05208657","25":"0.890625","26":"12","_rn_":"17852"},{"1":"no event","2":"50-59 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$29,999 or less","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Current smoker","13":"Never drank","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17863","20":"0","21":"not immigrant","22":"0","23":"34.98","24":"0.09000168","25":"0.890625","26":"43","_rn_":"17863"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17864","20":"1","21":"not immigrant","22":"0","23":"38.23","24":"0.18190027","25":"1.000000","26":"30","_rn_":"17864"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb41-2"><a href="#cb41-2"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb41-3"><a href="#cb41-3"></a><span class="co">#&gt;  0.8906  0.8906  0.8906  1.0000  0.8906  4.4531</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="combining-matching-weights" class="level4"><h4 class="anchored" data-anchor-id="combining-matching-weights">Combining matching weights</h4>
<p>Different approaches to incorporating weights (e.g., matching weights, survey weights) are explored.</p>
</section><section id="not-incorporating-matching-weights" class="level4"><h4 class="anchored" data-anchor-id="not-incorporating-matching-weights">Not incorporating matching weights</h4>
<div class="cell" data-hash="propensityscore2_cache/html/ratio1_b771797a4aa55606c6004bea2cbf5223">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb42-2"><a href="#cb42-2"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb42-3"><a href="#cb42-3"></a><span class="co">#&gt; [1] 397173</span></span>
<span id="cb42-4"><a href="#cb42-4"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb42-5"><a href="#cb42-5"></a><span class="co">#&gt; [1] 349</span></span>
<span id="cb42-6"><a href="#cb42-6"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb42-7"><a href="#cb42-7"></a><span class="co">#&gt; [1] 349</span></span>
<span id="cb42-8"><a href="#cb42-8"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb42-10"><a href="#cb42-10"></a><span class="co">#&gt; </span></span>
<span id="cb42-11"><a href="#cb42-11"></a><span class="co">#&gt;      0      1 </span></span>
<span id="cb42-12"><a href="#cb42-12"></a><span class="co">#&gt; 396824    349</span></span>
<span id="cb42-13"><a href="#cb42-13"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>survey.weight, </span>
<span id="cb42-14"><a href="#cb42-14"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb42-15"><a href="#cb42-15"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/ratio2_a59f0948c31866ba55ea66b33d02be0d">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(CVD <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb43-2"><a href="#cb43-2"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb43-3"><a href="#cb43-3"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb43-4"><a href="#cb43-4"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb43-5"><a href="#cb43-5"></a><span class="co">#&gt;  Variable Units OddsRatio       CI.95 p-value </span></span>
<span id="cb43-6"><a href="#cb43-6"></a><span class="co">#&gt;        OA            0.80 [0.23;2.80]   0.722</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="incorporating-matching-weights" class="level5"><h5 class="anchored" data-anchor-id="incorporating-matching-weights">Incorporating matching weights</h5>
<div class="cell" data-hash="propensityscore2_cache/html/ratio3_6dd5224418323a88792ee30434b73c06">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb44-2"><a href="#cb44-2"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb44-3"><a href="#cb44-3"></a><span class="co">#&gt; [1] 397173</span></span>
<span id="cb44-4"><a href="#cb44-4"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb44-5"><a href="#cb44-5"></a><span class="co">#&gt; [1] 349</span></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb44-7"><a href="#cb44-7"></a><span class="co">#&gt; [1] 349</span></span>
<span id="cb44-8"><a href="#cb44-8"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb44-9"><a href="#cb44-9"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb44-10"><a href="#cb44-10"></a><span class="co">#&gt; </span></span>
<span id="cb44-11"><a href="#cb44-11"></a><span class="co">#&gt;      0      1 </span></span>
<span id="cb44-12"><a href="#cb44-12"></a><span class="co">#&gt; 396824    349</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/ratio4_ca8cfa47adb7021c072aa3a48fdc22bf">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1"></a><span class="co"># multiply with matching (ratio) weights with survey weights</span></span>
<span id="cb45-2"><a href="#cb45-2"></a>analytic.miss<span class="sc">$</span>combined.weight <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb45-3"><a href="#cb45-3"></a>analytic.miss<span class="sc">$</span>combined.weight[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span></span>
<span id="cb45-4"><a href="#cb45-4"></a>  OACVD.match<span class="sc">$</span>weights<span class="sc">*</span>OACVD.match<span class="sc">$</span>survey.weight</span>
<span id="cb45-5"><a href="#cb45-5"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>combined.weight, </span>
<span id="cb45-6"><a href="#cb45-6"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb45-7"><a href="#cb45-7"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/ratio5_a99c3807a6f13722e241cfbd53c86c10">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">I</span>(CVD<span class="sc">==</span><span class="st">"event"</span>) <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb46-2"><a href="#cb46-2"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb46-3"><a href="#cb46-3"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb46-4"><a href="#cb46-4"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb46-5"><a href="#cb46-5"></a><span class="co">#&gt;  Variable Units OddsRatio       CI.95  p-value </span></span>
<span id="cb46-6"><a href="#cb46-6"></a><span class="co">#&gt;        OA            1.14 [0.32;4.07]   0.8419</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="matched-with-replacement" class="level4"><h4 class="anchored" data-anchor-id="matched-with-replacement">Matched with replacement</h4>
<p>Matching is performed with replacement, allowing control units to be used in more than one match.</p>
<div class="cell" data-hash="propensityscore2_cache/html/ratio6_caf0beb0922ab310c70fc303ba94c977">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb47-2"><a href="#cb47-2"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb47-3"><a href="#cb47-3"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb47-4"><a href="#cb47-4"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb47-5"><a href="#cb47-5"></a>                        <span class="at">ratio =</span> <span class="dv">5</span>,</span>
<span id="cb47-6"><a href="#cb47-6"></a>                        <span class="at">caliper =</span> <span class="fl">0.2</span>,</span>
<span id="cb47-7"><a href="#cb47-7"></a>                        <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-8"><a href="#cb47-8"></a><span class="co"># see how many matched</span></span>
<span id="cb47-9"><a href="#cb47-9"></a>matching.obj</span>
<span id="cb47-10"><a href="#cb47-10"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb47-11"><a href="#cb47-11"></a><span class="co">#&gt;  - method: 5:1 nearest neighbor matching with replacement</span></span>
<span id="cb47-12"><a href="#cb47-12"></a><span class="co">#&gt;  - distance: Propensity score [caliper]</span></span>
<span id="cb47-13"><a href="#cb47-13"></a><span class="co">#&gt;              - estimated with logistic regression</span></span>
<span id="cb47-14"><a href="#cb47-14"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.013)</span></span>
<span id="cb47-15"><a href="#cb47-15"></a><span class="co">#&gt;  - number of obs.: 1424 (original), 308 (matched)</span></span>
<span id="cb47-16"><a href="#cb47-16"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb47-17"><a href="#cb47-17"></a><span class="co">#&gt;  - covariates: age, sex, stress, married, income, race, bmi, phyact, smoke, doctor, drink, bp, immigrate, fruit, diab, edu</span></span>
<span id="cb47-18"><a href="#cb47-18"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb47-19"><a href="#cb47-19"></a><span class="co"># Step 3</span></span>
<span id="cb47-20"><a href="#cb47-20"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb47-21"><a href="#cb47-21"></a><span class="co">#&gt; OACVD.match$OA: 0</span></span>
<span id="cb47-22"><a href="#cb47-22"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb47-23"><a href="#cb47-23"></a><span class="co">#&gt; 0.004643 0.034244 0.067224 0.100845 0.148958 0.418206 </span></span>
<span id="cb47-24"><a href="#cb47-24"></a><span class="co">#&gt; ------------------------------------------------------------ </span></span>
<span id="cb47-25"><a href="#cb47-25"></a><span class="co">#&gt; OACVD.match$OA: 1</span></span>
<span id="cb47-26"><a href="#cb47-26"></a><span class="co">#&gt;     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span id="cb47-27"><a href="#cb47-27"></a><span class="co">#&gt; 0.004671 0.042322 0.097877 0.129743 0.189255 0.424895</span></span>
<span id="cb47-28"><a href="#cb47-28"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb47-29"><a href="#cb47-29"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb47-30"><a href="#cb47-30"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-31"><a href="#cb47-31"></a><span class="co">#&gt;                        Stratified by OA</span></span>
<span id="cb47-32"><a href="#cb47-32"></a><span class="co">#&gt;                         0           1          SMD   </span></span>
<span id="cb47-33"><a href="#cb47-33"></a><span class="co">#&gt;   n                     243         65               </span></span>
<span id="cb47-34"><a href="#cb47-34"></a><span class="co">#&gt;   age (%)                                       0.266</span></span>
<span id="cb47-35"><a href="#cb47-35"></a><span class="co">#&gt;      20-29 years         22 ( 9.1)   4 ( 6.2)        </span></span>
<span id="cb47-36"><a href="#cb47-36"></a><span class="co">#&gt;      30-39 years         57 (23.5)  11 (16.9)        </span></span>
<span id="cb47-37"><a href="#cb47-37"></a><span class="co">#&gt;      40-49 years         74 (30.5)  18 (27.7)        </span></span>
<span id="cb47-38"><a href="#cb47-38"></a><span class="co">#&gt;      50-59 years         82 (33.7)  29 (44.6)        </span></span>
<span id="cb47-39"><a href="#cb47-39"></a><span class="co">#&gt;      60-64 years          8 ( 3.3)   3 ( 4.6)        </span></span>
<span id="cb47-40"><a href="#cb47-40"></a><span class="co">#&gt;      65 years and over    0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb47-41"><a href="#cb47-41"></a><span class="co">#&gt;      teen                 0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb47-42"><a href="#cb47-42"></a><span class="co">#&gt;   sex = Male (%)        113 (46.5)  31 (47.7)   0.024</span></span>
<span id="cb47-43"><a href="#cb47-43"></a><span class="co">#&gt;   stress = stressed (%)  67 (27.6)  19 (29.2)   0.037</span></span>
<span id="cb47-44"><a href="#cb47-44"></a><span class="co">#&gt;   married = single (%)   75 (30.9)  23 (35.4)   0.096</span></span>
<span id="cb47-45"><a href="#cb47-45"></a><span class="co">#&gt;   income (%)                                    0.079</span></span>
<span id="cb47-46"><a href="#cb47-46"></a><span class="co">#&gt;      $29,999 or less     53 (21.8)  13 (20.0)        </span></span>
<span id="cb47-47"><a href="#cb47-47"></a><span class="co">#&gt;      $30,000-$49,999     57 (23.5)  14 (21.5)        </span></span>
<span id="cb47-48"><a href="#cb47-48"></a><span class="co">#&gt;      $50,000-$79,999     44 (18.1)  12 (18.5)        </span></span>
<span id="cb47-49"><a href="#cb47-49"></a><span class="co">#&gt;      $80,000 or more     89 (36.6)  26 (40.0)        </span></span>
<span id="cb47-50"><a href="#cb47-50"></a><span class="co">#&gt;   race = White (%)      146 (60.1)  42 (64.6)   0.094</span></span>
<span id="cb47-51"><a href="#cb47-51"></a><span class="co">#&gt;   bmi (%)                                       0.088</span></span>
<span id="cb47-52"><a href="#cb47-52"></a><span class="co">#&gt;      Underweight          0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb47-53"><a href="#cb47-53"></a><span class="co">#&gt;      healthy weight      58 (23.9)  18 (27.7)        </span></span>
<span id="cb47-54"><a href="#cb47-54"></a><span class="co">#&gt;      Overweight         185 (76.1)  47 (72.3)        </span></span>
<span id="cb47-55"><a href="#cb47-55"></a><span class="co">#&gt;   phyact (%)                                    0.160</span></span>
<span id="cb47-56"><a href="#cb47-56"></a><span class="co">#&gt;      Active              45 (18.5)  16 (24.6)        </span></span>
<span id="cb47-57"><a href="#cb47-57"></a><span class="co">#&gt;      Inactive           155 (63.8)  37 (56.9)        </span></span>
<span id="cb47-58"><a href="#cb47-58"></a><span class="co">#&gt;      Moderate            43 (17.7)  12 (18.5)        </span></span>
<span id="cb47-59"><a href="#cb47-59"></a><span class="co">#&gt;   smoke (%)                                     0.095</span></span>
<span id="cb47-60"><a href="#cb47-60"></a><span class="co">#&gt;      Never smoker        40 (16.5)   9 (13.8)        </span></span>
<span id="cb47-61"><a href="#cb47-61"></a><span class="co">#&gt;      Current smoker     101 (41.6)  26 (40.0)        </span></span>
<span id="cb47-62"><a href="#cb47-62"></a><span class="co">#&gt;      Former smoker      102 (42.0)  30 (46.2)        </span></span>
<span id="cb47-63"><a href="#cb47-63"></a><span class="co">#&gt;   doctor = Yes (%)      152 (62.6)  45 (69.2)   0.141</span></span>
<span id="cb47-64"><a href="#cb47-64"></a><span class="co">#&gt;   drink (%)                                     0.059</span></span>
<span id="cb47-65"><a href="#cb47-65"></a><span class="co">#&gt;      Never drank          9 ( 3.7)   2 ( 3.1)        </span></span>
<span id="cb47-66"><a href="#cb47-66"></a><span class="co">#&gt;      Current drinker    181 (74.5)  50 (76.9)        </span></span>
<span id="cb47-67"><a href="#cb47-67"></a><span class="co">#&gt;      Former driker       53 (21.8)  13 (20.0)        </span></span>
<span id="cb47-68"><a href="#cb47-68"></a><span class="co">#&gt;   bp = Yes (%)           19 ( 7.8)   5 ( 7.7)   0.005</span></span>
<span id="cb47-69"><a href="#cb47-69"></a><span class="co">#&gt;   immigrate (%)                                 0.115</span></span>
<span id="cb47-70"><a href="#cb47-70"></a><span class="co">#&gt;      not immigrant      228 (93.8)  59 (90.8)        </span></span>
<span id="cb47-71"><a href="#cb47-71"></a><span class="co">#&gt;      &gt; 10 years          15 ( 6.2)   6 ( 9.2)        </span></span>
<span id="cb47-72"><a href="#cb47-72"></a><span class="co">#&gt;      recent               0 ( 0.0)   0 ( 0.0)        </span></span>
<span id="cb47-73"><a href="#cb47-73"></a><span class="co">#&gt;   fruit (%)                                     0.147</span></span>
<span id="cb47-74"><a href="#cb47-74"></a><span class="co">#&gt;      0-3 daily serving   87 (35.8)  19 (29.2)        </span></span>
<span id="cb47-75"><a href="#cb47-75"></a><span class="co">#&gt;      4-6 daily serving  109 (44.9)  31 (47.7)        </span></span>
<span id="cb47-76"><a href="#cb47-76"></a><span class="co">#&gt;      6+ daily serving    47 (19.3)  15 (23.1)        </span></span>
<span id="cb47-77"><a href="#cb47-77"></a><span class="co">#&gt;   diab = Yes (%)         11 ( 4.5)   3 ( 4.6)   0.004</span></span>
<span id="cb47-78"><a href="#cb47-78"></a><span class="co">#&gt;   edu (%)                                       0.175</span></span>
<span id="cb47-79"><a href="#cb47-79"></a><span class="co">#&gt;      &lt; 2ndary            58 (23.9)  13 (20.0)        </span></span>
<span id="cb47-80"><a href="#cb47-80"></a><span class="co">#&gt;      2nd grad.            8 ( 3.3)   2 ( 3.1)        </span></span>
<span id="cb47-81"><a href="#cb47-81"></a><span class="co">#&gt;      Other 2nd grad.      9 ( 3.7)   1 ( 1.5)        </span></span>
<span id="cb47-82"><a href="#cb47-82"></a><span class="co">#&gt;      Post-2nd grad.     168 (69.1)  49 (75.4)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="question-for-the-students-4" class="level4"><h4 class="anchored" data-anchor-id="question-for-the-students-4">Question for the students</h4>
<ul>
<li>Did all of the SMDs decrease?</li>
</ul></section><section id="look-at-the-data-3" class="level4"><h4 class="anchored" data-anchor-id="look-at-the-data-3">Look at the data</h4>
<div class="cell" data-hash="propensityscore2_cache/html/ratio7_20987e94438fcd53ecd4716ae49030fa">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># what is weights variable now for 1:5 ratio?</span></span>
<span id="cb48-2"><a href="#cb48-2"></a><span class="fu">head</span>(OACVD.match)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["CVD"],"name":[1],"type":["fct"],"align":["left"]},{"label":["age"],"name":[2],"type":["fct"],"align":["left"]},{"label":["sex"],"name":[3],"type":["fct"],"align":["left"]},{"label":["married"],"name":[4],"type":["fct"],"align":["left"]},{"label":["race"],"name":[5],"type":["fct"],"align":["left"]},{"label":["edu"],"name":[6],"type":["fct"],"align":["left"]},{"label":["income"],"name":[7],"type":["fct"],"align":["left"]},{"label":["bmi"],"name":[8],"type":["fct"],"align":["left"]},{"label":["phyact"],"name":[9],"type":["fct"],"align":["left"]},{"label":["doctor"],"name":[10],"type":["fct"],"align":["left"]},{"label":["stress"],"name":[11],"type":["fct"],"align":["left"]},{"label":["smoke"],"name":[12],"type":["fct"],"align":["left"]},{"label":["drink"],"name":[13],"type":["fct"],"align":["left"]},{"label":["fruit"],"name":[14],"type":["fct"],"align":["left"]},{"label":["bp"],"name":[15],"type":["fct"],"align":["left"]},{"label":["diab"],"name":[16],"type":["fct"],"align":["left"]},{"label":["province"],"name":[17],"type":["fct"],"align":["left"]},{"label":["cycle"],"name":[18],"type":["fct"],"align":["left"]},{"label":["ID"],"name":[19],"type":["int"],"align":["right"]},{"label":["OA"],"name":[20],"type":["dbl"],"align":["right"]},{"label":["immigrate"],"name":[21],"type":["fct"],"align":["left"]},{"label":["miss"],"name":[22],"type":["dbl"],"align":["right"]},{"label":["survey.weight"],"name":[23],"type":["dbl"],"align":["right"]},{"label":["distance"],"name":[24],"type":["dbl"],"align":["right"]},{"label":["weights"],"name":[25],"type":["dbl"],"align":["right"]}],"data":[{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Never smoker","13":"Current drinker","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17846","20":"0","21":"not immigrant","22":"0","23":"12.10","24":"0.01854076","25":"0.7476923","_rn_":"17846"},{"1":"no event","2":"30-39 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Current drinker","14":"6+ daily serving","15":"No","16":"No","17":"North","18":"11","19":"17847","20":"0","21":"not immigrant","22":"0","23":"16.90","24":"0.05730827","25":"0.7476923","_rn_":"17847"},{"1":"no event","2":"40-49 years","3":"Male","4":"single","5":"White","6":"Post-2nd grad.","7":"$50,000-$79,999","8":"Overweight","9":"Moderate","10":"Yes","11":"Not too stressed","12":"Former smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17852","20":"0","21":"not immigrant","22":"0","23":"12.52","24":"0.05208657","25":"1.4953846","_rn_":"17852"},{"1":"no event","2":"50-59 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$29,999 or less","8":"Overweight","9":"Inactive","10":"No","11":"Not too stressed","12":"Current smoker","13":"Never drank","14":"0-3 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17863","20":"0","21":"not immigrant","22":"0","23":"34.98","24":"0.09000168","25":"0.7476923","_rn_":"17863"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"stressed","12":"Current smoker","13":"Current drinker","14":"4-6 daily serving","15":"No","16":"No","17":"North","18":"11","19":"17864","20":"1","21":"not immigrant","22":"0","23":"38.23","24":"0.18190027","25":"1.0000000","_rn_":"17864"},{"1":"no event","2":"40-49 years","3":"Female","4":"not single","5":"Non-white","6":"< 2ndary","7":"$30,000-$49,999","8":"Overweight","9":"Inactive","10":"Yes","11":"Not too stressed","12":"Current smoker","13":"Former driker","14":"0-3 daily serving","15":"Yes","16":"No","17":"North","18":"11","19":"17904","20":"0","21":"not immigrant","22":"0","23":"52.04","24":"0.06783228","25":"0.7476923","_rn_":"17904"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb49-2"><a href="#cb49-2"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="co">#&gt;  0.7477  0.7477  0.7477  1.0000  1.0000  7.4769</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="survey-design-1" class="level4"><h4 class="anchored" data-anchor-id="survey-design-1">Survey design</h4>
<p>The matched data is converted into a survey design object, and the treatment effect is estimated while accounting for the complex survey design.</p>
<div class="cell" data-hash="propensityscore2_cache/html/new0_206cb2cf18113b2f1171cee4c262b55b">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb50-2"><a href="#cb50-2"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb50-3"><a href="#cb50-3"></a><span class="co">#&gt; [1] 397173</span></span>
<span id="cb50-4"><a href="#cb50-4"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb50-5"><a href="#cb50-5"></a><span class="co">#&gt; [1] 308</span></span>
<span id="cb50-6"><a href="#cb50-6"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb50-7"><a href="#cb50-7"></a><span class="co">#&gt; [1] 308</span></span>
<span id="cb50-8"><a href="#cb50-8"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb50-9"><a href="#cb50-9"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb50-10"><a href="#cb50-10"></a><span class="co">#&gt; </span></span>
<span id="cb50-11"><a href="#cb50-11"></a><span class="co">#&gt;      0      1 </span></span>
<span id="cb50-12"><a href="#cb50-12"></a><span class="co">#&gt; 396865    308</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/new1_6533f78fe40fa73018fec802b1178dbf">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1"></a><span class="co"># multiply with matching (ratio) weights with survey weights</span></span>
<span id="cb51-2"><a href="#cb51-2"></a>analytic.miss<span class="sc">$</span>combined.weight <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb51-3"><a href="#cb51-3"></a>analytic.miss<span class="sc">$</span>combined.weight[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span></span>
<span id="cb51-4"><a href="#cb51-4"></a>  OACVD.match<span class="sc">$</span>weights<span class="sc">*</span>OACVD.match<span class="sc">$</span>survey.weight</span>
<span id="cb51-5"><a href="#cb51-5"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>combined.weight, </span>
<span id="cb51-6"><a href="#cb51-6"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb51-7"><a href="#cb51-7"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell" data-hash="propensityscore2_cache/html/new2_256137433b5defd12c19fa0f9efe4816">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">I</span>(CVD<span class="sc">==</span><span class="st">"event"</span>) <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb52-2"><a href="#cb52-2"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb52-4"><a href="#cb52-4"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb52-5"><a href="#cb52-5"></a><span class="co">#&gt;  Variable Units OddsRatio       CI.95  p-value </span></span>
<span id="cb52-6"><a href="#cb52-6"></a><span class="co">#&gt;        OA            0.99 [0.26;3.72]   0.9909</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="video-content-optional" class="level3"><h3 class="anchored" data-anchor-id="video-content-optional">Video content (optional)</h3>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>For those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.</p>
</div>
</div>
<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
<iframe src="https://www.youtube.com/embed/ONaKFZCTRfw" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen="">
</iframe>
</div>


<!-- -->

<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-Matchit" class="csl-entry" role="doc-biblioentry">
RDocumentation. 2023. <span>“Matchit: Matchit: Matching Software for Causal Inference.”</span> <a href="https://www.rdocumentation.org/packages/MatchIt/versions/1.0-1/topics/matchit">https://www.rdocumentation.org/packages/MatchIt/versions/1.0-1/topics/matchit</a>.
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./propensityscore1.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Exact Matching (CCHS)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./propensityscore3.html" class="pagination-link">
        <span class="nav-page-text">PSM in OA-CVD (US)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb53" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb53-1"><a href="#cb53-1"></a><span class="fu">## PSM in OA-CVD (CCHS) {.unnumbered}</span></span>
<span id="cb53-2"><a href="#cb53-2"></a></span>
<span id="cb53-3"><a href="#cb53-3"></a>This tutorial is a comprehensive guide on implementing Propensity Score Matching (PSM) using R, particularly focusing on a OA - CVD health study from the Canadian Community Health Survey (CCHS). This PSM method is used to reduce bias due to confounding variables in observational studies by matching treated and control units with similar propensity scores. The tutorial illustrates that PSM is an iterative process, where researchers may need to refine their matching strategy to achieve satisfactory balance in the matched sample. Different strategies for estimating the treatment effect in the matched sample are explored, each with its own assumptions and implications.</span>
<span id="cb53-4"><a href="#cb53-4"></a></span>
<span id="cb53-5"><a href="#cb53-5"></a><span class="fu">### Load packages</span></span>
<span id="cb53-6"><a href="#cb53-6"></a></span>
<span id="cb53-7"><a href="#cb53-7"></a>At first, various R packages are loaded to utilize their functions for data manipulation, statistical analysis, and visualization.</span>
<span id="cb53-8"><a href="#cb53-8"></a></span>
<span id="cb53-9"><a href="#cb53-9"></a><span class="in">```{r setup, warning=FALSE, message=FALSE, cache=TRUE}</span></span>
<span id="cb53-10"><a href="#cb53-10"></a><span class="co"># Load required packages</span></span>
<span id="cb53-11"><a href="#cb53-11"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb53-12"><a href="#cb53-12"></a><span class="fu">require</span>(tableone)</span>
<span id="cb53-13"><a href="#cb53-13"></a><span class="fu">require</span>(survey)</span>
<span id="cb53-14"><a href="#cb53-14"></a><span class="fu">require</span>(cobalt)</span>
<span id="cb53-15"><a href="#cb53-15"></a><span class="fu">require</span>(Publish)</span>
<span id="cb53-16"><a href="#cb53-16"></a><span class="fu">require</span>(optmatch)</span>
<span id="cb53-17"><a href="#cb53-17"></a><span class="in">```</span></span>
<span id="cb53-18"><a href="#cb53-18"></a></span>
<span id="cb53-19"><a href="#cb53-19"></a><span class="fu">### Load data</span></span>
<span id="cb53-20"><a href="#cb53-20"></a></span>
<span id="cb53-21"><a href="#cb53-21"></a>The dataset is loaded into the R environment. Variables are renamed to avoid conflicts in subsequent analyses.</span>
<span id="cb53-22"><a href="#cb53-22"></a></span>
<span id="cb53-23"><a href="#cb53-23"></a><span class="in">```{r data, cache=TRUE}</span></span>
<span id="cb53-24"><a href="#cb53-24"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">"Data/propensityscore/cchs123c.RData"</span>)</span>
<span id="cb53-25"><a href="#cb53-25"></a><span class="fu">head</span>(analytic11n)</span>
<span id="cb53-26"><a href="#cb53-26"></a></span>
<span id="cb53-27"><a href="#cb53-27"></a><span class="co"># later we will create another variable called weights</span></span>
<span id="cb53-28"><a href="#cb53-28"></a><span class="co"># hence to avoid any conflict/ambiguity,</span></span>
<span id="cb53-29"><a href="#cb53-29"></a><span class="co"># renaming weight variable to survey.weight</span></span>
<span id="cb53-30"><a href="#cb53-30"></a>analytic.miss<span class="sc">$</span>survey.weight <span class="ot">&lt;-</span> analytic.miss<span class="sc">$</span>weight</span>
<span id="cb53-31"><a href="#cb53-31"></a>analytic11n<span class="sc">$</span>survey.weight <span class="ot">&lt;-</span> analytic11n<span class="sc">$</span>weight</span>
<span id="cb53-32"><a href="#cb53-32"></a>analytic.miss<span class="sc">$</span>weight <span class="ot">&lt;-</span> analytic11n<span class="sc">$</span>weight <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb53-33"><a href="#cb53-33"></a><span class="in">```</span></span>
<span id="cb53-34"><a href="#cb53-34"></a></span>
<span id="cb53-35"><a href="#cb53-35"></a><span class="fu">### Analysis</span></span>
<span id="cb53-36"><a href="#cb53-36"></a></span>
<span id="cb53-37"><a href="#cb53-37"></a>We are going to apply propensity score analysis (Matching) in our OA - CVD problem from CCHS. For computation considerations, we will only work with cycle 1.1, and the people from Northern provinces in Canada (<span class="in">`analytic11n`</span> data).</span>
<span id="cb53-38"><a href="#cb53-38"></a></span>
<span id="cb53-39"><a href="#cb53-39"></a><span class="fu">### Step 1</span></span>
<span id="cb53-40"><a href="#cb53-40"></a></span>
<span id="cb53-41"><a href="#cb53-41"></a><span class="fu">#### Specify PS</span></span>
<span id="cb53-42"><a href="#cb53-42"></a></span>
<span id="cb53-43"><a href="#cb53-43"></a>A logistic regression model formula is specified to calculate the propensity scores (PS), which is the probability of receiving the treatment given the observed covariates.</span>
<span id="cb53-44"><a href="#cb53-44"></a></span>
<span id="cb53-45"><a href="#cb53-45"></a><span class="in">```{r step1, cache=TRUE}</span></span>
<span id="cb53-46"><a href="#cb53-46"></a>ps.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="st">"OA ~ age + sex + stress + married + </span></span>
<span id="cb53-47"><a href="#cb53-47"></a><span class="st">                         income + race + bmi + phyact + smoke +</span></span>
<span id="cb53-48"><a href="#cb53-48"></a><span class="st">                        doctor + drink + bp + </span></span>
<span id="cb53-49"><a href="#cb53-49"></a><span class="st">                         immigrate + fruit + diab + edu"</span>)</span>
<span id="cb53-50"><a href="#cb53-50"></a>var.names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"stress"</span>, <span class="st">"married"</span>, </span>
<span id="cb53-51"><a href="#cb53-51"></a>               <span class="st">"income"</span>, <span class="st">"race"</span>, <span class="st">"bmi"</span>, <span class="st">"phyact"</span>, <span class="st">"smoke"</span>, </span>
<span id="cb53-52"><a href="#cb53-52"></a>               <span class="st">"doctor"</span>, <span class="st">"drink"</span>, <span class="st">"bp"</span>, </span>
<span id="cb53-53"><a href="#cb53-53"></a>               <span class="st">"immigrate"</span>, <span class="st">"fruit"</span>, <span class="st">"diab"</span>, <span class="st">"edu"</span>)</span>
<span id="cb53-54"><a href="#cb53-54"></a><span class="in">```</span></span>
<span id="cb53-55"><a href="#cb53-55"></a></span>
<span id="cb53-56"><a href="#cb53-56"></a><span class="fu">#### Fit model</span></span>
<span id="cb53-57"><a href="#cb53-57"></a></span>
<span id="cb53-58"><a href="#cb53-58"></a>The software fits the PS model using a logistic regression by default. This package actually performs step 1 and 2 with one command <span class="in">`matchit`</span>. </span>
<span id="cb53-59"><a href="#cb53-59"></a></span>
<span id="cb53-60"><a href="#cb53-60"></a>Look at the website for arguments of matchit <span class="co">[</span><span class="ot">@Matchit</span><span class="co">]</span><span class="sc">\]</span>. It looks like this</span>
<span id="cb53-61"><a href="#cb53-61"></a></span>
<span id="cb53-62"><a href="#cb53-62"></a><span class="in">```{r  step1b, eval=FALSE}</span></span>
<span id="cb53-63"><a href="#cb53-63"></a><span class="fu">matchit</span>(formula, data, <span class="at">model=</span><span class="st">"logit"</span>, <span class="at">discard=</span><span class="dv">0</span>, <span class="at">reestimate=</span><span class="cn">FALSE</span>, <span class="at">nearest=</span><span class="cn">TRUE</span>,</span>
<span id="cb53-64"><a href="#cb53-64"></a>                 <span class="at">replace=</span><span class="cn">FALSE</span>, <span class="at">m.order=</span><span class="dv">2</span>, <span class="at">ratio=</span><span class="dv">1</span>, <span class="at">caliper=</span><span class="dv">0</span>, <span class="at">calclosest=</span><span class="cn">FALSE</span>,</span>
<span id="cb53-65"><a href="#cb53-65"></a>                 <span class="at">subclass=</span><span class="dv">0</span>, <span class="at">sub.by=</span><span class="st">"treat"</span>, <span class="at">mahvars=</span><span class="cn">NULL</span>, <span class="at">exact=</span><span class="cn">FALSE</span>, <span class="at">counter=</span><span class="cn">TRUE</span>, <span class="at">full=</span><span class="cn">FALSE</span>, <span class="at">full.options=</span><span class="fu">list</span>(),...)</span>
<span id="cb53-66"><a href="#cb53-66"></a><span class="in">```</span></span>
<span id="cb53-67"><a href="#cb53-67"></a></span>
<span id="cb53-68"><a href="#cb53-68"></a>::: callout-tip</span>
<span id="cb53-69"><a href="#cb53-69"></a>**Nearest-Neighbor Matching**:</span>
<span id="cb53-70"><a href="#cb53-70"></a></span>
<span id="cb53-71"><a href="#cb53-71"></a>Nearest-neighbor matching is a widely used technique in PSM to pair treated and control units based on the proximity of their propensity scores. It is straightforward and computationally efficient, making it a popular choice in many applications of PSM. Nearest-neighbor matching is often termed a "greedy" algorithm because it matches units in order, without considering the global distribution of propensity scores. Once a match is made, it is not revisited, even if a later unit would have been a better match. The method seeks to minimize bias by creating closely matched pairs but can increase variance if the pool of potential matches is reduced too much (e.g., using a very narrow caliper). It is essential to ensure that there is a common support region where the distributions of propensity scores for treated and control units overlap, ensuring comparability.</span>
<span id="cb53-72"><a href="#cb53-72"></a>::: </span>
<span id="cb53-73"><a href="#cb53-73"></a></span>
<span id="cb53-74"><a href="#cb53-74"></a><span class="fu">### Step 2</span></span>
<span id="cb53-75"><a href="#cb53-75"></a></span>
<span id="cb53-76"><a href="#cb53-76"></a><span class="fu">#### Match subjects by PS</span></span>
<span id="cb53-77"><a href="#cb53-77"></a></span>
<span id="cb53-78"><a href="#cb53-78"></a>We are going to match using a Nearest neighbor algorithm. This is a greedy matching algorithm. Note that we are not even defining any caliper.</span>
<span id="cb53-79"><a href="#cb53-79"></a></span>
<span id="cb53-80"><a href="#cb53-80"></a>::: callout-tip</span>
<span id="cb53-81"><a href="#cb53-81"></a>**Caliper**:</span>
<span id="cb53-82"><a href="#cb53-82"></a></span>
<span id="cb53-83"><a href="#cb53-83"></a>In the context of PSM, a caliper is a predefined maximum allowable difference between the propensity scores of matched units. Essentially, it sets a threshold for how dissimilar matched units can be in terms of their propensity scores. When a caliper is used, a treated unit is only matched with a control unit if the absolute difference in their propensity scores is less than or equal to the specified caliper width. The caliper is used to avoid bad matches and thereby minimize bias in the estimated treatment effect. The size of the caliper is crucial. Too wide a caliper may allow poor matches, while too narrow a caliper may result in many units going unmatched. Implementing a caliper involves a trade-off between bias and efficiency. Using a caliper reduces bias by avoiding poor matches but may increase variance by reducing the number of matched pairs available for analysis. Therefore, the use of a caliper in PSM is a strategic decision to enhance the quality of matches and thereby improve the validity of causal inferences drawn from observational data. It is a practical tool to ensure that matched units are sufficiently similar in terms of their propensity scores, reducing the likelihood of bias due to poor matches.</span>
<span id="cb53-84"><a href="#cb53-84"></a>:::</span>
<span id="cb53-85"><a href="#cb53-85"></a></span>
<span id="cb53-86"><a href="#cb53-86"></a><span class="in">```{r step2, cache=TRUE}</span></span>
<span id="cb53-87"><a href="#cb53-87"></a><span class="co"># set seed</span></span>
<span id="cb53-88"><a href="#cb53-88"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb53-89"><a href="#cb53-89"></a><span class="co"># match</span></span>
<span id="cb53-90"><a href="#cb53-90"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb53-91"><a href="#cb53-91"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb53-92"><a href="#cb53-92"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb53-93"><a href="#cb53-93"></a>                        <span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb53-94"><a href="#cb53-94"></a><span class="co"># see how many matched</span></span>
<span id="cb53-95"><a href="#cb53-95"></a>matching.obj</span>
<span id="cb53-96"><a href="#cb53-96"></a><span class="co"># create the "matched"" data</span></span>
<span id="cb53-97"><a href="#cb53-97"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb53-98"><a href="#cb53-98"></a><span class="co"># see the dimension</span></span>
<span id="cb53-99"><a href="#cb53-99"></a><span class="fu">dim</span>(analytic11n)</span>
<span id="cb53-100"><a href="#cb53-100"></a><span class="fu">dim</span>(OACVD.match)</span>
<span id="cb53-101"><a href="#cb53-101"></a><span class="in">```</span></span>
<span id="cb53-102"><a href="#cb53-102"></a></span>
<span id="cb53-103"><a href="#cb53-103"></a>Let's try to understand how this is working.</span>
<span id="cb53-104"><a href="#cb53-104"></a></span>
<span id="cb53-105"><a href="#cb53-105"></a><span class="fu">#### Extract matched IDs</span></span>
<span id="cb53-106"><a href="#cb53-106"></a></span>
<span id="cb53-107"><a href="#cb53-107"></a><span class="in">```{r matchitstrata2, cache=TRUE }</span></span>
<span id="cb53-108"><a href="#cb53-108"></a>m.mat<span class="ot">&lt;-</span>matching.obj<span class="sc">$</span>match.matrix</span>
<span id="cb53-109"><a href="#cb53-109"></a><span class="fu">head</span>(m.mat)</span>
<span id="cb53-110"><a href="#cb53-110"></a><span class="in">```</span></span>
<span id="cb53-111"><a href="#cb53-111"></a></span>
<span id="cb53-112"><a href="#cb53-112"></a><span class="fu">#### Extract the matched treated IDs</span></span>
<span id="cb53-113"><a href="#cb53-113"></a></span>
<span id="cb53-114"><a href="#cb53-114"></a><span class="in">```{r step2b, cache=TRUE}</span></span>
<span id="cb53-115"><a href="#cb53-115"></a>treated.id<span class="ot">&lt;-</span><span class="fu">as.numeric</span>(<span class="fu">row.names</span>(m.mat))</span>
<span id="cb53-116"><a href="#cb53-116"></a>treated.id <span class="co"># basically row names</span></span>
<span id="cb53-117"><a href="#cb53-117"></a><span class="in">```</span></span>
<span id="cb53-118"><a href="#cb53-118"></a></span>
<span id="cb53-119"><a href="#cb53-119"></a><span class="fu">#### Extract the matched untreated IDs</span></span>
<span id="cb53-120"><a href="#cb53-120"></a></span>
<span id="cb53-121"><a href="#cb53-121"></a><span class="in">```{r step2c, cache=TRUE}</span></span>
<span id="cb53-122"><a href="#cb53-122"></a>untreated.id <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(m.mat)</span>
<span id="cb53-123"><a href="#cb53-123"></a>untreated.id <span class="co"># basically row names</span></span>
<span id="cb53-124"><a href="#cb53-124"></a><span class="in">```</span></span>
<span id="cb53-125"><a href="#cb53-125"></a></span>
<span id="cb53-126"><a href="#cb53-126"></a><span class="fu">#### Extract the matched treated data</span></span>
<span id="cb53-127"><a href="#cb53-127"></a></span>
<span id="cb53-128"><a href="#cb53-128"></a><span class="in">```{r step2d, cache=TRUE}</span></span>
<span id="cb53-129"><a href="#cb53-129"></a>tx <span class="ot">&lt;-</span> analytic11n[<span class="fu">rownames</span>(analytic11n) <span class="sc">%in%</span> treated.id,]</span>
<span id="cb53-130"><a href="#cb53-130"></a><span class="fu">head</span>(tx[<span class="fu">c</span>(<span class="st">"OA"</span>, <span class="st">"CVD"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"race"</span>, <span class="st">"edu"</span>)])</span>
<span id="cb53-131"><a href="#cb53-131"></a><span class="in">```</span></span>
<span id="cb53-132"><a href="#cb53-132"></a></span>
<span id="cb53-133"><a href="#cb53-133"></a><span class="fu">#### Extract the matched untreated data</span></span>
<span id="cb53-134"><a href="#cb53-134"></a></span>
<span id="cb53-135"><a href="#cb53-135"></a><span class="in">```{r step2e, cache=TRUE}</span></span>
<span id="cb53-136"><a href="#cb53-136"></a>utx <span class="ot">&lt;-</span> analytic11n[<span class="fu">rownames</span>(analytic11n) <span class="sc">%in%</span> untreated.id,]</span>
<span id="cb53-137"><a href="#cb53-137"></a><span class="fu">head</span>(utx[<span class="fu">c</span>(<span class="st">"OA"</span>, <span class="st">"CVD"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"race"</span>, <span class="st">"edu"</span>)])</span>
<span id="cb53-138"><a href="#cb53-138"></a><span class="in">```</span></span>
<span id="cb53-139"><a href="#cb53-139"></a></span>
<span id="cb53-140"><a href="#cb53-140"></a><span class="fu">#### Extract the matched data altogether</span></span>
<span id="cb53-141"><a href="#cb53-141"></a></span>
<span id="cb53-142"><a href="#cb53-142"></a>Simply using <span class="in">`match.data`</span> is enough (as done earlier).</span>
<span id="cb53-143"><a href="#cb53-143"></a></span>
<span id="cb53-144"><a href="#cb53-144"></a><span class="in">```{r step2f, cache=TRUE}</span></span>
<span id="cb53-145"><a href="#cb53-145"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb53-146"><a href="#cb53-146"></a><span class="in">```</span></span>
<span id="cb53-147"><a href="#cb53-147"></a></span>
<span id="cb53-148"><a href="#cb53-148"></a><span class="fu">#### Assign match ID</span></span>
<span id="cb53-149"><a href="#cb53-149"></a></span>
<span id="cb53-150"><a href="#cb53-150"></a><span class="in">```{r step2g, cache=TRUE}</span></span>
<span id="cb53-151"><a href="#cb53-151"></a>OACVD.match<span class="sc">$</span>match.ID <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb53-152"><a href="#cb53-152"></a>OACVD.match<span class="sc">$</span>match.ID[<span class="fu">rownames</span>(OACVD.match) <span class="sc">%in%</span> treated.id] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(treated.id)</span>
<span id="cb53-153"><a href="#cb53-153"></a>OACVD.match<span class="sc">$</span>match.ID[<span class="fu">rownames</span>(OACVD.match) <span class="sc">%in%</span> untreated.id] <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(untreated.id)</span>
<span id="cb53-154"><a href="#cb53-154"></a><span class="fu">table</span>(OACVD.match<span class="sc">$</span>match.ID)</span>
<span id="cb53-155"><a href="#cb53-155"></a><span class="in">```</span></span>
<span id="cb53-156"><a href="#cb53-156"></a></span>
<span id="cb53-157"><a href="#cb53-157"></a>Take a look at individual matches for the first match</span>
<span id="cb53-158"><a href="#cb53-158"></a></span>
<span id="cb53-159"><a href="#cb53-159"></a><span class="in">```{r step2h, cache=TRUE}</span></span>
<span id="cb53-160"><a href="#cb53-160"></a><span class="fu">na.omit</span>(OACVD.match[OACVD.match<span class="sc">$</span>match.ID <span class="sc">==</span> <span class="dv">1</span>,])</span>
<span id="cb53-161"><a href="#cb53-161"></a><span class="in">```</span></span>
<span id="cb53-162"><a href="#cb53-162"></a></span>
<span id="cb53-163"><a href="#cb53-163"></a>Take a look at individual matches for the second match</span>
<span id="cb53-164"><a href="#cb53-164"></a></span>
<span id="cb53-165"><a href="#cb53-165"></a><span class="in">```{r step2i, cache=TRUE}</span></span>
<span id="cb53-166"><a href="#cb53-166"></a><span class="fu">na.omit</span>(OACVD.match[OACVD.match<span class="sc">$</span>match.ID <span class="sc">==</span> <span class="dv">2</span>,])</span>
<span id="cb53-167"><a href="#cb53-167"></a><span class="in">```</span></span>
<span id="cb53-168"><a href="#cb53-168"></a></span>
<span id="cb53-169"><a href="#cb53-169"></a><span class="fu">### Step 3</span></span>
<span id="cb53-170"><a href="#cb53-170"></a></span>
<span id="cb53-171"><a href="#cb53-171"></a>Both graphical and numerical methods are used to assess the quality of the matches and the balance of covariates in the matched sample.</span>
<span id="cb53-172"><a href="#cb53-172"></a></span>
<span id="cb53-173"><a href="#cb53-173"></a><span class="fu">#### Examining PS graphically</span></span>
<span id="cb53-174"><a href="#cb53-174"></a></span>
<span id="cb53-175"><a href="#cb53-175"></a>Visually inspect the PS and assess the balance of covariates in the matched sample. Various plots are generated to visualize the distribution of PS across treatment groups and to check the balance of covariates before and after matching.</span>
<span id="cb53-176"><a href="#cb53-176"></a></span>
<span id="cb53-177"><a href="#cb53-177"></a><span class="fu">#### matchit package</span></span>
<span id="cb53-178"><a href="#cb53-178"></a></span>
<span id="cb53-179"><a href="#cb53-179"></a><span class="in">```{r step3, cache=TRUE}</span></span>
<span id="cb53-180"><a href="#cb53-180"></a><span class="co"># plot(matching.obj) # covariate balance</span></span>
<span id="cb53-181"><a href="#cb53-181"></a><span class="fu">plot</span>(matching.obj, <span class="at">type =</span> <span class="st">"jitter"</span>) <span class="co"># propensity score locations</span></span>
<span id="cb53-182"><a href="#cb53-182"></a><span class="fu">plot</span>(matching.obj, <span class="at">type =</span> <span class="st">"hist"</span>) <span class="co">#check matched treated vs matched control</span></span>
<span id="cb53-183"><a href="#cb53-183"></a>summrize.output <span class="ot">&lt;-</span> <span class="fu">summary</span>(matching.obj, <span class="at">standardize =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-184"><a href="#cb53-184"></a><span class="fu">plot</span>(summrize.output)</span>
<span id="cb53-185"><a href="#cb53-185"></a><span class="in">```</span></span>
<span id="cb53-186"><a href="#cb53-186"></a></span>
<span id="cb53-187"><a href="#cb53-187"></a><span class="fu">#### Overalp check</span></span>
<span id="cb53-188"><a href="#cb53-188"></a></span>
<span id="cb53-189"><a href="#cb53-189"></a><span class="in">```{r step3b, cache=TRUE}</span></span>
<span id="cb53-190"><a href="#cb53-190"></a><span class="co"># plot propensity scores by exposure group</span></span>
<span id="cb53-191"><a href="#cb53-191"></a><span class="fu">plot</span>(<span class="fu">density</span>(OACVD.match<span class="sc">$</span>distance[OACVD.match<span class="sc">$</span>OA<span class="sc">==</span><span class="dv">1</span>]), </span>
<span id="cb53-192"><a href="#cb53-192"></a>     <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">main =</span> <span class="st">""</span>)</span>
<span id="cb53-193"><a href="#cb53-193"></a><span class="fu">lines</span>(<span class="fu">density</span>(OACVD.match<span class="sc">$</span>distance[OACVD.match<span class="sc">$</span>OA<span class="sc">==</span><span class="dv">0</span>]), </span>
<span id="cb53-194"><a href="#cb53-194"></a>      <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb53-195"><a href="#cb53-195"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="fu">c</span>(<span class="st">"Non-arthritis"</span>,<span class="st">"OA"</span>), </span>
<span id="cb53-196"><a href="#cb53-196"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="at">lty=</span><span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span>
<span id="cb53-197"><a href="#cb53-197"></a><span class="in">```</span></span>
<span id="cb53-198"><a href="#cb53-198"></a></span>
<span id="cb53-199"><a href="#cb53-199"></a><span class="fu">#### cobalt package</span></span>
<span id="cb53-200"><a href="#cb53-200"></a></span>
<span id="cb53-201"><a href="#cb53-201"></a>Overlap check in a more convenient way</span>
<span id="cb53-202"><a href="#cb53-202"></a></span>
<span id="cb53-203"><a href="#cb53-203"></a><span class="in">```{r step3c, cache=TRUE}</span></span>
<span id="cb53-204"><a href="#cb53-204"></a><span class="co"># different badwidth</span></span>
<span id="cb53-205"><a href="#cb53-205"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"distance"</span>)</span>
<span id="cb53-206"><a href="#cb53-206"></a><span class="in">```</span></span>
<span id="cb53-207"><a href="#cb53-207"></a></span>
<span id="cb53-208"><a href="#cb53-208"></a><span class="fu">#### Look at the data</span></span>
<span id="cb53-209"><a href="#cb53-209"></a></span>
<span id="cb53-210"><a href="#cb53-210"></a><span class="in">```{r step3d, cache=TRUE}</span></span>
<span id="cb53-211"><a href="#cb53-211"></a><span class="co"># what is distance variable here?</span></span>
<span id="cb53-212"><a href="#cb53-212"></a><span class="fu">head</span>(OACVD.match)</span>
<span id="cb53-213"><a href="#cb53-213"></a><span class="in">```</span></span>
<span id="cb53-214"><a href="#cb53-214"></a></span>
<span id="cb53-215"><a href="#cb53-215"></a><span class="fu">#### Numerical values of PS</span></span>
<span id="cb53-216"><a href="#cb53-216"></a></span>
<span id="cb53-217"><a href="#cb53-217"></a><span class="in">```{r step3e, cache=TRUE}</span></span>
<span id="cb53-218"><a href="#cb53-218"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>distance)</span>
<span id="cb53-219"><a href="#cb53-219"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb53-220"><a href="#cb53-220"></a><span class="in">```</span></span>
<span id="cb53-221"><a href="#cb53-221"></a></span>
<span id="cb53-222"><a href="#cb53-222"></a><span class="fu">#### Question for the students</span></span>
<span id="cb53-223"><a href="#cb53-223"></a></span>
<span id="cb53-224"><a href="#cb53-224"></a><span class="ss">-   </span>Are you happy with the matching after reviewing the plots?</span>
<span id="cb53-225"><a href="#cb53-225"></a></span>
<span id="cb53-226"><a href="#cb53-226"></a><span class="fu">#### Covariate balance in matched sample</span></span>
<span id="cb53-227"><a href="#cb53-227"></a></span>
<span id="cb53-228"><a href="#cb53-228"></a>Covariate balance is assessed numerically using standardized mean differences (SMD).</span>
<span id="cb53-229"><a href="#cb53-229"></a></span>
<span id="cb53-230"><a href="#cb53-230"></a>::: callout-tip</span>
<span id="cb53-231"><a href="#cb53-231"></a>**Standardized mean differences**:</span>
<span id="cb53-232"><a href="#cb53-232"></a>SMD is a versatile and widely used statistical measure that facilitates the comparison of groups in research by providing a scale-free metric of difference and balance. In the context of propensity score matching, achieving low SMD values for covariates after matching is crucial to ensuring the validity of causal inferences drawn from the matched sample.</span>
<span id="cb53-233"><a href="#cb53-233"></a></span>
<span id="cb53-234"><a href="#cb53-234"></a>Benifits:</span>
<span id="cb53-235"><a href="#cb53-235"></a></span>
<span id="cb53-236"><a href="#cb53-236"></a><span class="ss">- </span>SMD is not influenced by the scale of the measured variable, making it suitable for comparing the balance of different variables measured on different scales.</span>
<span id="cb53-237"><a href="#cb53-237"></a><span class="ss">- </span>Unlike hypothesis testing, SMD is not affected by sample size, making it a reliable measure for assessing balance in matched samples.</span>
<span id="cb53-238"><a href="#cb53-238"></a>::: </span>
<span id="cb53-239"><a href="#cb53-239"></a></span>
<span id="cb53-240"><a href="#cb53-240"></a><span class="in">```{r step3f, cache=TRUE}</span></span>
<span id="cb53-241"><a href="#cb53-241"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb53-242"><a href="#cb53-242"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb53-243"><a href="#cb53-243"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-244"><a href="#cb53-244"></a><span class="in">```</span></span>
<span id="cb53-245"><a href="#cb53-245"></a></span>
<span id="cb53-246"><a href="#cb53-246"></a><span class="fu">#### Question for the students</span></span>
<span id="cb53-247"><a href="#cb53-247"></a></span>
<span id="cb53-248"><a href="#cb53-248"></a><span class="ss">-   </span>All SMD <span class="sc">\&lt;</span> 0.20?</span>
<span id="cb53-249"><a href="#cb53-249"></a></span>
<span id="cb53-250"><a href="#cb53-250"></a><span class="fu">#### Other balance measures</span></span>
<span id="cb53-251"><a href="#cb53-251"></a></span>
<span id="cb53-252"><a href="#cb53-252"></a><span class="fu">##### Individual categories</span></span>
<span id="cb53-253"><a href="#cb53-253"></a></span>
<span id="cb53-254"><a href="#cb53-254"></a>If you want to check balance at each category (not very useful in general situations). We are generally interested if the variables are balanced or not (not categories).</span>
<span id="cb53-255"><a href="#cb53-255"></a></span>
<span id="cb53-256"><a href="#cb53-256"></a><span class="in">```{r step3g, cache=TRUE}</span></span>
<span id="cb53-257"><a href="#cb53-257"></a>baltab <span class="ot">&lt;-</span> <span class="fu">bal.tab</span>(matching.obj)</span>
<span id="cb53-258"><a href="#cb53-258"></a>baltab</span>
<span id="cb53-259"><a href="#cb53-259"></a><span class="in">```</span></span>
<span id="cb53-260"><a href="#cb53-260"></a></span>
<span id="cb53-261"><a href="#cb53-261"></a><span class="fu">##### Individual plots</span></span>
<span id="cb53-262"><a href="#cb53-262"></a></span>
<span id="cb53-263"><a href="#cb53-263"></a>You could plot each variables individually</span>
<span id="cb53-264"><a href="#cb53-264"></a></span>
<span id="cb53-265"><a href="#cb53-265"></a><span class="in">```{r step3h, cache=TRUE}</span></span>
<span id="cb53-266"><a href="#cb53-266"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"income"</span>)</span>
<span id="cb53-267"><a href="#cb53-267"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"age"</span>)</span>
<span id="cb53-268"><a href="#cb53-268"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"race"</span>)</span>
<span id="cb53-269"><a href="#cb53-269"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"diab"</span>)</span>
<span id="cb53-270"><a href="#cb53-270"></a><span class="fu">bal.plot</span>(matching.obj, <span class="at">var.name =</span> <span class="st">"immigrate"</span>)</span>
<span id="cb53-271"><a href="#cb53-271"></a><span class="in">```</span></span>
<span id="cb53-272"><a href="#cb53-272"></a></span>
<span id="cb53-273"><a href="#cb53-273"></a><span class="fu">##### Love plot</span></span>
<span id="cb53-274"><a href="#cb53-274"></a></span>
<span id="cb53-275"><a href="#cb53-275"></a><span class="in">```{r loveplot, cache=TRUE}</span></span>
<span id="cb53-276"><a href="#cb53-276"></a><span class="co"># Individual categories again</span></span>
<span id="cb53-277"><a href="#cb53-277"></a><span class="fu">love.plot</span>(baltab, <span class="at">threshold =</span> .<span class="dv">2</span>)</span>
<span id="cb53-278"><a href="#cb53-278"></a><span class="in">```</span></span>
<span id="cb53-279"><a href="#cb53-279"></a></span>
<span id="cb53-280"><a href="#cb53-280"></a><span class="fu">### Repeat of Step 1-3 again</span></span>
<span id="cb53-281"><a href="#cb53-281"></a></span>
<span id="cb53-282"><a href="#cb53-282"></a>Covariate balance is reassessed in each step to ensure the quality of the match.</span>
<span id="cb53-283"><a href="#cb53-283"></a></span>
<span id="cb53-284"><a href="#cb53-284"></a><span class="fu">#### Add caliper</span></span>
<span id="cb53-285"><a href="#cb53-285"></a></span>
<span id="cb53-286"><a href="#cb53-286"></a>The matching process is repeated, this time introducing a caliper to ensure that matches are only made within a specified range of PS.</span>
<span id="cb53-287"><a href="#cb53-287"></a></span>
<span id="cb53-288"><a href="#cb53-288"></a><span class="in">```{r step3i, cache=TRUE}</span></span>
<span id="cb53-289"><a href="#cb53-289"></a>logitPS <span class="ot">&lt;-</span>  <span class="sc">-</span><span class="fu">log</span>(<span class="dv">1</span><span class="sc">/</span>OACVD.match<span class="sc">$</span>distance <span class="sc">-</span> <span class="dv">1</span>) </span>
<span id="cb53-290"><a href="#cb53-290"></a><span class="co"># logit of the propensity score</span></span>
<span id="cb53-291"><a href="#cb53-291"></a>.<span class="dv">2</span><span class="sc">*</span><span class="fu">sd</span>(logitPS) <span class="co"># suggested in the literature</span></span>
<span id="cb53-292"><a href="#cb53-292"></a></span>
<span id="cb53-293"><a href="#cb53-293"></a></span>
<span id="cb53-294"><a href="#cb53-294"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb53-295"><a href="#cb53-295"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb53-296"><a href="#cb53-296"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb53-297"><a href="#cb53-297"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb53-298"><a href="#cb53-298"></a>                        <span class="at">ratio =</span> <span class="dv">1</span>,</span>
<span id="cb53-299"><a href="#cb53-299"></a>                        <span class="at">caliper =</span> .<span class="dv">2</span><span class="sc">*</span><span class="fu">sd</span>(logitPS))</span>
<span id="cb53-300"><a href="#cb53-300"></a><span class="co"># see how many matched</span></span>
<span id="cb53-301"><a href="#cb53-301"></a>matching.obj</span>
<span id="cb53-302"><a href="#cb53-302"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb53-303"><a href="#cb53-303"></a><span class="in">```</span></span>
<span id="cb53-304"><a href="#cb53-304"></a></span>
<span id="cb53-305"><a href="#cb53-305"></a><span class="in">```{r step3j, cache=TRUE}</span></span>
<span id="cb53-306"><a href="#cb53-306"></a><span class="co"># Step 3</span></span>
<span id="cb53-307"><a href="#cb53-307"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb53-308"><a href="#cb53-308"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb53-309"><a href="#cb53-309"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb53-310"><a href="#cb53-310"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-311"><a href="#cb53-311"></a><span class="in">```</span></span>
<span id="cb53-312"><a href="#cb53-312"></a></span>
<span id="cb53-313"><a href="#cb53-313"></a><span class="fu">#### Question for the students</span></span>
<span id="cb53-314"><a href="#cb53-314"></a></span>
<span id="cb53-315"><a href="#cb53-315"></a><span class="ss">-   </span>Did all of the SMDs decrease?</span>
<span id="cb53-316"><a href="#cb53-316"></a></span>
<span id="cb53-317"><a href="#cb53-317"></a><span class="fu">#### Look at the data</span></span>
<span id="cb53-318"><a href="#cb53-318"></a></span>
<span id="cb53-319"><a href="#cb53-319"></a><span class="in">```{r step3k, cache=TRUE}</span></span>
<span id="cb53-320"><a href="#cb53-320"></a><span class="co"># what is weights variable for pair matching?</span></span>
<span id="cb53-321"><a href="#cb53-321"></a><span class="fu">head</span>(OACVD.match)</span>
<span id="cb53-322"><a href="#cb53-322"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb53-323"><a href="#cb53-323"></a><span class="in">```</span></span>
<span id="cb53-324"><a href="#cb53-324"></a></span>
<span id="cb53-325"><a href="#cb53-325"></a><span class="fu">### Step 4</span></span>
<span id="cb53-326"><a href="#cb53-326"></a></span>
<span id="cb53-327"><a href="#cb53-327"></a><span class="fu">#### Estimate treatment effect for matched data</span></span>
<span id="cb53-328"><a href="#cb53-328"></a></span>
<span id="cb53-329"><a href="#cb53-329"></a>Different models (e.g., unconditional logistic regression, survey design) are fitted to estimate the treatment effect in the matched sample.</span>
<span id="cb53-330"><a href="#cb53-330"></a></span>
<span id="cb53-331"><a href="#cb53-331"></a><span class="fu">#### Unconditional logistic</span></span>
<span id="cb53-332"><a href="#cb53-332"></a></span>
<span id="cb53-333"><a href="#cb53-333"></a><span class="in">```{r step4, cache=TRUE}</span></span>
<span id="cb53-334"><a href="#cb53-334"></a><span class="co"># Wrong model for population!!</span></span>
<span id="cb53-335"><a href="#cb53-335"></a>outcome.model <span class="ot">&lt;-</span> <span class="fu">glm</span>(CVD <span class="sc">~</span> OA, <span class="at">data =</span> OACVD.match, <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb53-336"><a href="#cb53-336"></a><span class="fu">publish</span>(outcome.model)</span>
<span id="cb53-337"><a href="#cb53-337"></a><span class="in">```</span></span>
<span id="cb53-338"><a href="#cb53-338"></a></span>
<span id="cb53-339"><a href="#cb53-339"></a><span class="fu">#### Survey design</span></span>
<span id="cb53-340"><a href="#cb53-340"></a></span>
<span id="cb53-341"><a href="#cb53-341"></a><span class="fu">##### Convert data to design</span></span>
<span id="cb53-342"><a href="#cb53-342"></a></span>
<span id="cb53-343"><a href="#cb53-343"></a>The matched data is converted to a survey design object to account for the matched pairs in the analysis.</span>
<span id="cb53-344"><a href="#cb53-344"></a></span>
<span id="cb53-345"><a href="#cb53-345"></a><span class="in">```{r step4b, cache=TRUE}</span></span>
<span id="cb53-346"><a href="#cb53-346"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-347"><a href="#cb53-347"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb53-348"><a href="#cb53-348"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb53-349"><a href="#cb53-349"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb53-350"><a href="#cb53-350"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-351"><a href="#cb53-351"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb53-352"><a href="#cb53-352"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>survey.weight, </span>
<span id="cb53-353"><a href="#cb53-353"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb53-354"><a href="#cb53-354"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb53-355"><a href="#cb53-355"></a><span class="in">```</span></span>
<span id="cb53-356"><a href="#cb53-356"></a></span>
<span id="cb53-357"><a href="#cb53-357"></a><span class="fu">##### Balance in matched population?</span></span>
<span id="cb53-358"><a href="#cb53-358"></a></span>
<span id="cb53-359"><a href="#cb53-359"></a><span class="in">```{r step4c, cache=TRUE}</span></span>
<span id="cb53-360"><a href="#cb53-360"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">svyCreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> w.design.m, </span>
<span id="cb53-361"><a href="#cb53-361"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb53-362"><a href="#cb53-362"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-363"><a href="#cb53-363"></a><span class="in">```</span></span>
<span id="cb53-364"><a href="#cb53-364"></a></span>
<span id="cb53-365"><a href="#cb53-365"></a><span class="fu">##### Outcome analysis</span></span>
<span id="cb53-366"><a href="#cb53-366"></a></span>
<span id="cb53-367"><a href="#cb53-367"></a><span class="in">```{r step4d, cache=TRUE}</span></span>
<span id="cb53-368"><a href="#cb53-368"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(CVD <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb53-369"><a href="#cb53-369"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb53-370"><a href="#cb53-370"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb53-371"><a href="#cb53-371"></a><span class="in">```</span></span>
<span id="cb53-372"><a href="#cb53-372"></a></span>
<span id="cb53-373"><a href="#cb53-373"></a><span class="fu">### Matched data with increase ratio</span></span>
<span id="cb53-374"><a href="#cb53-374"></a></span>
<span id="cb53-375"><a href="#cb53-375"></a>The matching process is repeated with a different ratio (e.g., 1:5) to explore how changing the ratio affects the covariate balance and treatment effect estimation.</span>
<span id="cb53-376"><a href="#cb53-376"></a></span>
<span id="cb53-377"><a href="#cb53-377"></a><span class="in">```{r ratio, cache=TRUE}</span></span>
<span id="cb53-378"><a href="#cb53-378"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb53-379"><a href="#cb53-379"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb53-380"><a href="#cb53-380"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb53-381"><a href="#cb53-381"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb53-382"><a href="#cb53-382"></a>                        <span class="at">ratio =</span> <span class="dv">5</span>,</span>
<span id="cb53-383"><a href="#cb53-383"></a>                        <span class="at">caliper =</span> <span class="fl">0.2</span>)</span>
<span id="cb53-384"><a href="#cb53-384"></a><span class="co"># see how many matched</span></span>
<span id="cb53-385"><a href="#cb53-385"></a>matching.obj</span>
<span id="cb53-386"><a href="#cb53-386"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb53-387"><a href="#cb53-387"></a><span class="co"># Step 3</span></span>
<span id="cb53-388"><a href="#cb53-388"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb53-389"><a href="#cb53-389"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb53-390"><a href="#cb53-390"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb53-391"><a href="#cb53-391"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-392"><a href="#cb53-392"></a><span class="in">```</span></span>
<span id="cb53-393"><a href="#cb53-393"></a></span>
<span id="cb53-394"><a href="#cb53-394"></a><span class="fu">##### Question for the students</span></span>
<span id="cb53-395"><a href="#cb53-395"></a></span>
<span id="cb53-396"><a href="#cb53-396"></a><span class="ss">-   </span>Did all of the SMDs decrease?</span>
<span id="cb53-397"><a href="#cb53-397"></a></span>
<span id="cb53-398"><a href="#cb53-398"></a><span class="fu">##### Look at the data</span></span>
<span id="cb53-399"><a href="#cb53-399"></a></span>
<span id="cb53-400"><a href="#cb53-400"></a><span class="in">```{r summdata, cache=TRUE}</span></span>
<span id="cb53-401"><a href="#cb53-401"></a><span class="co"># what is weights variable now for 1:5 ratio?</span></span>
<span id="cb53-402"><a href="#cb53-402"></a><span class="fu">head</span>(OACVD.match)</span>
<span id="cb53-403"><a href="#cb53-403"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb53-404"><a href="#cb53-404"></a><span class="in">```</span></span>
<span id="cb53-405"><a href="#cb53-405"></a></span>
<span id="cb53-406"><a href="#cb53-406"></a><span class="fu">#### Combining matching weights</span></span>
<span id="cb53-407"><a href="#cb53-407"></a></span>
<span id="cb53-408"><a href="#cb53-408"></a>Different approaches to incorporating weights (e.g., matching weights, survey weights) are explored.</span>
<span id="cb53-409"><a href="#cb53-409"></a></span>
<span id="cb53-410"><a href="#cb53-410"></a><span class="fu">#### Not incorporating matching weights</span></span>
<span id="cb53-411"><a href="#cb53-411"></a></span>
<span id="cb53-412"><a href="#cb53-412"></a><span class="in">```{r ratio1, cache=TRUE}</span></span>
<span id="cb53-413"><a href="#cb53-413"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-414"><a href="#cb53-414"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb53-415"><a href="#cb53-415"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb53-416"><a href="#cb53-416"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb53-417"><a href="#cb53-417"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-418"><a href="#cb53-418"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb53-419"><a href="#cb53-419"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>survey.weight, </span>
<span id="cb53-420"><a href="#cb53-420"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb53-421"><a href="#cb53-421"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb53-422"><a href="#cb53-422"></a><span class="in">```</span></span>
<span id="cb53-423"><a href="#cb53-423"></a></span>
<span id="cb53-424"><a href="#cb53-424"></a><span class="in">```{r ratio2, cache=TRUE}</span></span>
<span id="cb53-425"><a href="#cb53-425"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(CVD <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb53-426"><a href="#cb53-426"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb53-427"><a href="#cb53-427"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb53-428"><a href="#cb53-428"></a><span class="in">```</span></span>
<span id="cb53-429"><a href="#cb53-429"></a></span>
<span id="cb53-430"><a href="#cb53-430"></a><span class="fu">##### Incorporating matching weights</span></span>
<span id="cb53-431"><a href="#cb53-431"></a></span>
<span id="cb53-432"><a href="#cb53-432"></a><span class="in">```{r ratio3, cache=TRUE}</span></span>
<span id="cb53-433"><a href="#cb53-433"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-434"><a href="#cb53-434"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb53-435"><a href="#cb53-435"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb53-436"><a href="#cb53-436"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb53-437"><a href="#cb53-437"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-438"><a href="#cb53-438"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb53-439"><a href="#cb53-439"></a><span class="in">```</span></span>
<span id="cb53-440"><a href="#cb53-440"></a></span>
<span id="cb53-441"><a href="#cb53-441"></a><span class="in">```{r ratio4, cache=TRUE}</span></span>
<span id="cb53-442"><a href="#cb53-442"></a><span class="co"># multiply with matching (ratio) weights with survey weights</span></span>
<span id="cb53-443"><a href="#cb53-443"></a>analytic.miss<span class="sc">$</span>combined.weight <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-444"><a href="#cb53-444"></a>analytic.miss<span class="sc">$</span>combined.weight[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span></span>
<span id="cb53-445"><a href="#cb53-445"></a>  OACVD.match<span class="sc">$</span>weights<span class="sc">*</span>OACVD.match<span class="sc">$</span>survey.weight</span>
<span id="cb53-446"><a href="#cb53-446"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>combined.weight, </span>
<span id="cb53-447"><a href="#cb53-447"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb53-448"><a href="#cb53-448"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb53-449"><a href="#cb53-449"></a><span class="in">```</span></span>
<span id="cb53-450"><a href="#cb53-450"></a></span>
<span id="cb53-451"><a href="#cb53-451"></a><span class="in">```{r ratio5, cache=TRUE}</span></span>
<span id="cb53-452"><a href="#cb53-452"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">I</span>(CVD<span class="sc">==</span><span class="st">"event"</span>) <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb53-453"><a href="#cb53-453"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb53-454"><a href="#cb53-454"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb53-455"><a href="#cb53-455"></a><span class="in">```</span></span>
<span id="cb53-456"><a href="#cb53-456"></a></span>
<span id="cb53-457"><a href="#cb53-457"></a><span class="fu">#### Matched with replacement</span></span>
<span id="cb53-458"><a href="#cb53-458"></a></span>
<span id="cb53-459"><a href="#cb53-459"></a>Matching is performed with replacement, allowing control units to be used in more than one match.</span>
<span id="cb53-460"><a href="#cb53-460"></a></span>
<span id="cb53-461"><a href="#cb53-461"></a><span class="in">```{r ratio6, cache=TRUE}</span></span>
<span id="cb53-462"><a href="#cb53-462"></a><span class="co"># Step 1 and 2</span></span>
<span id="cb53-463"><a href="#cb53-463"></a>matching.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula,</span>
<span id="cb53-464"><a href="#cb53-464"></a>                        <span class="at">data =</span> analytic11n,</span>
<span id="cb53-465"><a href="#cb53-465"></a>                        <span class="at">method =</span> <span class="st">"nearest"</span>,</span>
<span id="cb53-466"><a href="#cb53-466"></a>                        <span class="at">ratio =</span> <span class="dv">5</span>,</span>
<span id="cb53-467"><a href="#cb53-467"></a>                        <span class="at">caliper =</span> <span class="fl">0.2</span>,</span>
<span id="cb53-468"><a href="#cb53-468"></a>                        <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-469"><a href="#cb53-469"></a><span class="co"># see how many matched</span></span>
<span id="cb53-470"><a href="#cb53-470"></a>matching.obj</span>
<span id="cb53-471"><a href="#cb53-471"></a>OACVD.match <span class="ot">&lt;-</span> <span class="fu">match.data</span>(matching.obj)</span>
<span id="cb53-472"><a href="#cb53-472"></a><span class="co"># Step 3</span></span>
<span id="cb53-473"><a href="#cb53-473"></a><span class="fu">by</span>(OACVD.match<span class="sc">$</span>distance, OACVD.match<span class="sc">$</span>OA, summary)</span>
<span id="cb53-474"><a href="#cb53-474"></a>tab1 <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"OA"</span>, <span class="at">data =</span> OACVD.match, </span>
<span id="cb53-475"><a href="#cb53-475"></a>                       <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">vars =</span> var.names)</span>
<span id="cb53-476"><a href="#cb53-476"></a><span class="fu">print</span>(tab1, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-477"><a href="#cb53-477"></a><span class="in">```</span></span>
<span id="cb53-478"><a href="#cb53-478"></a></span>
<span id="cb53-479"><a href="#cb53-479"></a><span class="fu">#### Question for the students</span></span>
<span id="cb53-480"><a href="#cb53-480"></a></span>
<span id="cb53-481"><a href="#cb53-481"></a><span class="ss">-   </span>Did all of the SMDs decrease?</span>
<span id="cb53-482"><a href="#cb53-482"></a></span>
<span id="cb53-483"><a href="#cb53-483"></a><span class="fu">#### Look at the data</span></span>
<span id="cb53-484"><a href="#cb53-484"></a></span>
<span id="cb53-485"><a href="#cb53-485"></a><span class="in">```{r ratio7, cache=TRUE}</span></span>
<span id="cb53-486"><a href="#cb53-486"></a><span class="co"># what is weights variable now for 1:5 ratio?</span></span>
<span id="cb53-487"><a href="#cb53-487"></a><span class="fu">head</span>(OACVD.match)</span>
<span id="cb53-488"><a href="#cb53-488"></a><span class="fu">summary</span>(OACVD.match<span class="sc">$</span>weights)</span>
<span id="cb53-489"><a href="#cb53-489"></a><span class="in">```</span></span>
<span id="cb53-490"><a href="#cb53-490"></a></span>
<span id="cb53-491"><a href="#cb53-491"></a><span class="fu">#### Survey design</span></span>
<span id="cb53-492"><a href="#cb53-492"></a></span>
<span id="cb53-493"><a href="#cb53-493"></a>The matched data is converted into a survey design object, and the treatment effect is estimated while accounting for the complex survey design.</span>
<span id="cb53-494"><a href="#cb53-494"></a></span>
<span id="cb53-495"><a href="#cb53-495"></a><span class="in">```{r new0, cache=TRUE}</span></span>
<span id="cb53-496"><a href="#cb53-496"></a>analytic.miss<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-497"><a href="#cb53-497"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID) <span class="co"># full data</span></span>
<span id="cb53-498"><a href="#cb53-498"></a><span class="fu">length</span>(OACVD.match<span class="sc">$</span>ID) <span class="co"># matched data</span></span>
<span id="cb53-499"><a href="#cb53-499"></a><span class="fu">length</span>(analytic.miss<span class="sc">$</span>ID[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID])</span>
<span id="cb53-500"><a href="#cb53-500"></a>analytic.miss<span class="sc">$</span>matched[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb53-501"><a href="#cb53-501"></a><span class="fu">table</span>(analytic.miss<span class="sc">$</span>matched)</span>
<span id="cb53-502"><a href="#cb53-502"></a><span class="in">```</span></span>
<span id="cb53-503"><a href="#cb53-503"></a></span>
<span id="cb53-504"><a href="#cb53-504"></a><span class="in">```{r new1, cache=TRUE}</span></span>
<span id="cb53-505"><a href="#cb53-505"></a><span class="co"># multiply with matching (ratio) weights with survey weights</span></span>
<span id="cb53-506"><a href="#cb53-506"></a>analytic.miss<span class="sc">$</span>combined.weight <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb53-507"><a href="#cb53-507"></a>analytic.miss<span class="sc">$</span>combined.weight[analytic.miss<span class="sc">$</span>ID <span class="sc">%in%</span> OACVD.match<span class="sc">$</span>ID] <span class="ot">&lt;-</span></span>
<span id="cb53-508"><a href="#cb53-508"></a>  OACVD.match<span class="sc">$</span>weights<span class="sc">*</span>OACVD.match<span class="sc">$</span>survey.weight</span>
<span id="cb53-509"><a href="#cb53-509"></a>w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">id=</span><span class="sc">~</span><span class="dv">1</span>, <span class="at">weights=</span><span class="sc">~</span>combined.weight, </span>
<span id="cb53-510"><a href="#cb53-510"></a>                      <span class="at">data=</span>analytic.miss)</span>
<span id="cb53-511"><a href="#cb53-511"></a>w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb53-512"><a href="#cb53-512"></a><span class="in">```</span></span>
<span id="cb53-513"><a href="#cb53-513"></a></span>
<span id="cb53-514"><a href="#cb53-514"></a><span class="in">```{r new2, cache=TRUE}</span></span>
<span id="cb53-515"><a href="#cb53-515"></a>fit.design <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(<span class="fu">I</span>(CVD<span class="sc">==</span><span class="st">"event"</span>) <span class="sc">~</span> OA, <span class="at">design =</span> w.design.m, </span>
<span id="cb53-516"><a href="#cb53-516"></a>       <span class="at">family =</span> <span class="fu">binomial</span>(logit))</span>
<span id="cb53-517"><a href="#cb53-517"></a><span class="fu">publish</span>(fit.design)</span>
<span id="cb53-518"><a href="#cb53-518"></a><span class="in">```</span></span>
<span id="cb53-519"><a href="#cb53-519"></a></span>
<span id="cb53-520"><a href="#cb53-520"></a></span>
<span id="cb53-521"><a href="#cb53-521"></a><span class="fu">### Video content (optional)</span></span>
<span id="cb53-522"><a href="#cb53-522"></a></span>
<span id="cb53-523"><a href="#cb53-523"></a>::: callout-tip</span>
<span id="cb53-524"><a href="#cb53-524"></a>For those who prefer a video walkthrough, feel free to watch the video below, which offers a description of an earlier version of the above content.</span>
<span id="cb53-525"><a href="#cb53-525"></a>:::</span>
<span id="cb53-526"><a href="#cb53-526"></a></span>
<span id="cb53-527"><a href="#cb53-527"></a>::: {style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;"}</span>
<span id="cb53-528"><a href="#cb53-528"></a><span class="kw">&lt;iframe</span> <span class="er">src</span><span class="ot">=</span><span class="st">"https://www.youtube.com/embed/ONaKFZCTRfw"</span> <span class="er">style</span><span class="ot">=</span><span class="st">"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;"</span> <span class="er">allowfullscreen</span><span class="kw">&gt;</span></span>
<span id="cb53-529"><a href="#cb53-529"></a></span>
<span id="cb53-530"><a href="#cb53-530"></a><span class="kw">&lt;/iframe&gt;</span></span>
<span id="cb53-531"><a href="#cb53-531"></a>:::</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>