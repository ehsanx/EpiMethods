<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>OER: Advanced Epidemiological Methods - PSM with MI</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./propensityscoreF.html" rel="next">
<link href="./propensityscore4.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-CVBPG0RQMY"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-CVBPG0RQMY', { 'anonymize_ip': true});
</script><link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet">
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<meta name="twitter:title" content="OER: Advanced Epidemiological Methods - PSM with MI">
<meta name="twitter:description" content="The tutorial provides a detailed walkthrough of implementing Propensity Score Matching (PSM) combined with Multiple Imputation (MI) in a statistical analysis, focusing on handling missing data and…">
<meta name="twitter:card" content="summary">
</head>
<body class="nav-sidebar docked">


<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }"><div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">PSM with MI</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">OER: Advanced Epidemiological Methods</a> 
        <div class="sidebar-tools-main">
  <a href="" class="quarto-reader-toggle sidebar-tool" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">The Project</a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./wrangling.html" class="sidebar-item-text sidebar-link">Data wrangling</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1a.html" class="sidebar-item-text sidebar-link">R basics</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1b.html" class="sidebar-item-text sidebar-link">Data types</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling1c.html" class="sidebar-item-text sidebar-link">Automating tasks</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling2.html" class="sidebar-item-text sidebar-link">Importing dataset</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling3.html" class="sidebar-item-text sidebar-link">Data manipulation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling4.html" class="sidebar-item-text sidebar-link">Import external data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling5.html" class="sidebar-item-text sidebar-link">Summary tables</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wrangling6.html" class="sidebar-item-text sidebar-link">R Markdown</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingF.html" class="sidebar-item-text sidebar-link">R Functions (W)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingQ.html" class="sidebar-item-text sidebar-link">Quiz (W)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wranglingE.html" class="sidebar-item-text sidebar-link">Exercise (W)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./accessing.html" class="sidebar-item-text sidebar-link">Data accessing</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing1.html" class="sidebar-item-text sidebar-link">Survey data sources</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing2.html" class="sidebar-item-text sidebar-link">Importing CCHS to R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing3.html" class="sidebar-item-text sidebar-link">Importing NHANES to R</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessing4.html" class="sidebar-item-text sidebar-link">Reproducing results</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingF.html" class="sidebar-item-text sidebar-link">R Functions (A)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingQ.html" class="sidebar-item-text sidebar-link">Quiz (A)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./accessingE.html" class="sidebar-item-text sidebar-link">Exercise (A)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./researchquestion.html" class="sidebar-item-text sidebar-link">Research questions</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion1.html" class="sidebar-item-text sidebar-link">Predictive question-1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion2a.html" class="sidebar-item-text sidebar-link">Predictive question-2a</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion2b.html" class="sidebar-item-text sidebar-link">Predictive question-2b</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion3.html" class="sidebar-item-text sidebar-link">Causal question-1</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestion4.html" class="sidebar-item-text sidebar-link">Causal question-2</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestionF.html" class="sidebar-item-text sidebar-link">R functions (Q)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./researchquestionQ.html" class="sidebar-item-text sidebar-link">Quiz (Q)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./confounding.html" class="sidebar-item-text sidebar-link">Causal roles</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding1.html" class="sidebar-item-text sidebar-link">Confounding</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding2.html" class="sidebar-item-text sidebar-link">Mediator</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding3.html" class="sidebar-item-text sidebar-link">Collider</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding4.html" class="sidebar-item-text sidebar-link">Z-bias</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding5.html" class="sidebar-item-text sidebar-link">Collapsibility</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confounding6.html" class="sidebar-item-text sidebar-link">Change-in-estimate</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confoundingF.html" class="sidebar-item-text sidebar-link">R functions (R)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./confoundingQ.html" class="sidebar-item-text sidebar-link">Quiz (R)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./predictivefactors.html" class="sidebar-item-text sidebar-link">Prediction ideas</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors1.html" class="sidebar-item-text sidebar-link">Collinear predictors</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors2.html" class="sidebar-item-text sidebar-link">Continuous outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors3.html" class="sidebar-item-text sidebar-link">Binary outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors4.html" class="sidebar-item-text sidebar-link">Overfitting and performance</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors5.html" class="sidebar-item-text sidebar-link">Data spliting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors6.html" class="sidebar-item-text sidebar-link">Cross-validation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactors7.html" class="sidebar-item-text sidebar-link">Bootstrap</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactorsF.html" class="sidebar-item-text sidebar-link">R functions (P)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./predictivefactorsQ.html" class="sidebar-item-text sidebar-link">Quiz (P)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./surveydata.html" class="sidebar-item-text sidebar-link">Survey data analysis</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata1.html" class="sidebar-item-text sidebar-link">CCHS: Revisiting PICOT</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata2.html" class="sidebar-item-text sidebar-link">CCHS: Assessing data</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata3.html" class="sidebar-item-text sidebar-link">CCHS: Bivariate analysis</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata4.html" class="sidebar-item-text sidebar-link">CCHS: Regression</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata5.html" class="sidebar-item-text sidebar-link">CCHS: Performance</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata6.html" class="sidebar-item-text sidebar-link">NHANES: Blood Pressure</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata7.html" class="sidebar-item-text sidebar-link">NHANES: Cholesterol</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydata8.html" class="sidebar-item-text sidebar-link">NHANES: Subsetting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataF.html" class="sidebar-item-text sidebar-link">R functions (D)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataQ.html" class="sidebar-item-text sidebar-link">Quiz (D)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./surveydataE.html" class="sidebar-item-text sidebar-link">Exercise (D)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./missingdata.html" class="sidebar-item-text sidebar-link">Missing data analysis</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-7" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-7" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata1.html" class="sidebar-item-text sidebar-link">Imputation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata2.html" class="sidebar-item-text sidebar-link">Imputation in NHANES</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata3.html" class="sidebar-item-text sidebar-link">Missing in outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata4.html" class="sidebar-item-text sidebar-link">Performance with NA</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata5.html" class="sidebar-item-text sidebar-link">Subpopulations</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata6.html" class="sidebar-item-text sidebar-link">MCAR tests</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdata7.html" class="sidebar-item-text sidebar-link">Effect modification</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataF.html" class="sidebar-item-text sidebar-link">R functions (M)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataQ.html" class="sidebar-item-text sidebar-link">Quiz (M)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./missingdataE.html" class="sidebar-item-text sidebar-link">Exercise (M)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./propensityscore.html" class="sidebar-item-text sidebar-link">Propensity score</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-8" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-8" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore1.html" class="sidebar-item-text sidebar-link">Exact Matching (CCHS)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore2.html" class="sidebar-item-text sidebar-link">PSM in OA-CVD (CCHS)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore3.html" class="sidebar-item-text sidebar-link">PSM in OA-CVD (US)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore4.html" class="sidebar-item-text sidebar-link">PSM in BMI-diabetes</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscore5.html" class="sidebar-item-text sidebar-link active">PSM with MI</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreF.html" class="sidebar-item-text sidebar-link">R functions (S)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreQ.html" class="sidebar-item-text sidebar-link">Quiz (S)</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./propensityscoreE.html" class="sidebar-item-text sidebar-link">Exercise (S)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./machinelearning.html" class="sidebar-item-text sidebar-link">Machine learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-9" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-9" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning1.html" class="sidebar-item-text sidebar-link">Continuous outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning2.html" class="sidebar-item-text sidebar-link">Data spliting</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning3.html" class="sidebar-item-text sidebar-link">Cross-validation</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning4.html" class="sidebar-item-text sidebar-link">Binary outcome</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning5.html" class="sidebar-item-text sidebar-link">Supervised learning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearning6.html" class="sidebar-item-text sidebar-link">Unsupervised learning</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearningF.html" class="sidebar-item-text sidebar-link">R functions (L)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./machinelearningCausal.html" class="sidebar-item-text sidebar-link">Causal learning</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-10" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-10" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./machinelearningCausalF.html" class="sidebar-item-text sidebar-link">R functions (C)</a>
  </div>
</li>
      </ul>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a href="./reporting.html" class="sidebar-item-text sidebar-link">Writing Tools</a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-11" aria-expanded="true">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-11" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting1.html" class="sidebar-item-text sidebar-link">Collaborative Writing</a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./reporting2.html" class="sidebar-item-text sidebar-link">Formatting Tools</a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><!-- margin-sidebar --><div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#problem-statement" id="toc-problem-statement" class="nav-link active" data-scroll-target="#problem-statement">Problem Statement</a></li>
  <li><a href="#data-and-variables" id="toc-data-and-variables" class="nav-link" data-scroll-target="#data-and-variables">Data and variables</a></li>
  <li><a href="#logistic-regression-1" id="toc-logistic-regression-1" class="nav-link" data-scroll-target="#logistic-regression-1">Logistic regression</a></li>
  <li><a href="#propensity-score-matching-analysis" id="toc-propensity-score-matching-analysis" class="nav-link" data-scroll-target="#propensity-score-matching-analysis">Propensity score matching analysis</a></li>
  <li><a href="#pooled-estimate" id="toc-pooled-estimate" class="nav-link" data-scroll-target="#pooled-estimate">Pooled estimate</a></li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title d-none d-lg-block">PSM with MI</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i></button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>The tutorial provides a detailed walkthrough of implementing Propensity Score Matching (PSM) combined with Multiple Imputation (MI) in a statistical analysis, focusing on handling missing data and mitigating bias in observational studies.</p>
<p>The initial chunk is dedicated to loading various R packages that will be utilized throughout the tutorial. These libraries provide functions and tools that facilitate data manipulation, statistical modeling, visualization, and more.</p>
<div class="cell" data-hash="propensityscore5_cache/html/setup_f60a7910c4b849f4886b6f017d5e0650">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Load required packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="fu">require</span>(tableone)</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="fu">require</span>(survey)</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="fu">require</span>(cobalt)</span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="fu">require</span>(Publish)</span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="fu">require</span>(optmatch)</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="fu">require</span>(data.table)</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="fu">require</span>(jtools)</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="fu">require</span>(ggstance)</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="fu">require</span>(DataExplorer)</span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="fu">require</span>(mitools)</span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="fu">library</span>(mice)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="problem-statement" class="level3"><h3 class="anchored" data-anchor-id="problem-statement">Problem Statement</h3>
<section id="logistic-regression" class="level4"><h4 class="anchored" data-anchor-id="logistic-regression">Logistic regression</h4>
<ul>
<li><p>Perform multiple imputation to deal with missing values; with 3 imputed datasets, 5 iterations,</p></li>
<li><p>fit <strong>survey featured logistic regression</strong> in all of the 3 imputed datasets, and</p></li>
<li><p>obtain the pooled OR (adjusted) and the corresponding 95% confidence intervals.</p></li>
<li>
<p>Hints</p>
<ul>
<li>Use the <strong>covariates</strong> (listed below) in the imputation model.</li>
<li>
<strong>Imputation model covariates</strong> can be different than the original analysis covariates. You are encouraged to use variables in the imputation model that can be predictive of the variables with missing observations. In this example, we use the strata variable as an <strong>auxiliary variable</strong> in the imputation model, but not the survey weight or PSU variable.</li>
<li>Also the <strong>imputation model specification</strong> can be modified. For example, we use <strong>pmm</strong> method for bmi in the imputation model.</li>
<li>Remove any subject ID variable from the imputation model, if created in an intermediate step. Indeed ID variables should not be in the imputation model, if they are <strong>not predictive</strong> of the variables with missing observations.</li>
</ul>
</li>
</ul>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Predictive Mean Matching</strong>:</p>
<p>The “Predictive Mean Matching” (PMM) method in Multiple Imputation (MI) is a widely used technique to handle missing data, particularly well-suited for continuous variables. PMM operates by first creating a predictive model for the variable with missing data, using observed values from other variables in the dataset. For each missing value, PMM identifies a set of observed values with predicted scores that are close to the predicted score for the missing value, derived from the predictive model. Then, instead of imputing a predicted score directly, PMM randomly selects one of the observed values from this set and assigns it as the imputed value. This method retains the original distribution of the imputed variable since it only uses observed values for imputation, and it also tends to preserve relationships between variables. PMM is particularly advantageous when the normality assumption of the imputed variable is questionable, providing a robust and practical approach to managing missing data in various research contexts.</p>
</div>
</div>
</section><section id="propensity-score-matching-zanutto-2006" class="level4"><h4 class="anchored" data-anchor-id="propensity-score-matching-zanutto-2006">Propensity score matching (Zanutto, 2006)</h4>
<ul>
<li>Use the <strong>propensity score matching as per Zanutto E. L. (2006)</strong>’s recommendation in all of the imputed datasets.</li>
<li>Report the pooled OR estimates (adjusted) and corresponding 95% confidence intervals (adjusted OR).</li>
</ul></section></section><section id="data-and-variables" class="level3"><h3 class="anchored" data-anchor-id="data-and-variables">Data and variables</h3>
<section id="analytic-data" class="level4"><h4 class="anchored" data-anchor-id="analytic-data">Analytic data</h4>
<p>The analytic dataset is saved as NHANES17.RData.</p>
</section><section id="variables" class="level4"><h4 class="anchored" data-anchor-id="variables">Variables</h4>
<p>We are primarily interested in outcome <strong>diabetes</strong> and exposure <strong>whether born in the US (born)</strong>.</p>
<p>Variables under consideration:</p>
<ul>
<li>survey features
<ul>
<li>PSU</li>
<li>strata</li>
<li>survey weight</li>
</ul>
</li>
<li>Covariates
<ul>
<li>race</li>
<li>age</li>
<li>marriage</li>
<li>education</li>
<li>gender</li>
<li>BMI</li>
<li>systolic blood pressure</li>
</ul>
</li>
</ul></section><section id="pre-processing" class="level4"><h4 class="anchored" data-anchor-id="pre-processing">Pre-processing</h4>
<p>The data is loaded and variables of interest are identified.</p>
<div class="cell" data-hash="propensityscore5_cache/html/data_1c9342393b0461b5cc31b64f50b17177">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">"Data/propensityscore/NHANES17.RData"</span>) <span class="co"># read data</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="fu">ls</span>()</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#&gt; [1] "analytic"           "analytic.with.miss"</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="fu">dim</span>(analytic.with.miss)</span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="co">#&gt; [1] 9254   34</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ID"</span>, <span class="co"># ID</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>          <span class="st">"psu"</span>, <span class="st">"strata"</span>, <span class="st">"weight"</span>, <span class="co"># Survey features </span></span>
<span id="cb2-8"><a href="#cb2-8"></a>          <span class="st">"race"</span>, <span class="st">"age"</span>, <span class="st">"married"</span>,<span class="st">"education"</span>,<span class="st">"gender"</span>,<span class="st">"bmi"</span>,<span class="st">"systolicBP"</span>, <span class="co"># Covariates</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>          <span class="st">"born"</span>, <span class="co"># Exposure</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>          <span class="st">"diabetes"</span>) <span class="co"># Outcome</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="subset-the-dataset" class="level4"><h4 class="anchored" data-anchor-id="subset-the-dataset">Subset the dataset</h4>
<p>The dataset is then subsetted to retain only the relevant variables, ensuring that subsequent analyses are focused and computationally efficient.</p>
<div class="cell" data-hash="propensityscore5_cache/html/subset_651e1cfd817dc93aa2de1eaac0746e80">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>dat.with.miss <span class="ot">&lt;-</span> analytic.with.miss[,vars]</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">dim</span>(analytic.with.miss)</span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">#&gt; [1] 9254   34</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="inspect-weights" class="level4"><h4 class="anchored" data-anchor-id="inspect-weights">Inspect weights</h4>
<p>The weights of the observations are inspected and adjusted to avoid issues in subsequent analyses.</p>
<div class="cell" data-hash="propensityscore5_cache/html/weight_03644e3f051f4971926f362149004b5e">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">summary</span>(dat.with.miss<span class="sc">$</span>weight)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="co">#&gt;    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="co">#&gt;       0   12347   21060   34671   37562  419763</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># weight = 0 would create problem in the analysis</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="co"># ad-hoc solution to 0 weight problem</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>dat.with.miss<span class="sc">$</span>weight[dat.with.miss<span class="sc">$</span>weight <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.00000001</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="recode-the-exposure-variable" class="level4"><h4 class="anchored" data-anchor-id="recode-the-exposure-variable">Recode the exposure variable</h4>
<p>The exposure variable is recoded for clarity and ease of interpretation in results.</p>
<div class="cell" data-hash="propensityscore5_cache/html/recode_4c999db1d4dcbf784b8d628ad954e620">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>dat.with.miss<span class="sc">$</span>born <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">recode</span>(dat.with.miss<span class="sc">$</span>born, </span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="at">recodes =</span> <span class="st">" 'Born in 50 US states or Washingt' = </span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">'Born in US'; 'Others' = 'Others'; else = NA "</span> )</span>
<span id="cb5-4"><a href="#cb5-4"></a>dat.with.miss<span class="sc">$</span>born <span class="ot">&lt;-</span> <span class="fu">factor</span>(dat.with.miss<span class="sc">$</span>born, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Born in US"</span>, <span class="st">"Others"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="variable-types" class="level4"><h4 class="anchored" data-anchor-id="variable-types">variable types</h4>
<p>Variable types are set, ensuring that each variable is treated appropriately in the analyses.</p>
<div class="cell" data-hash="propensityscore5_cache/html/vartype_65c58d5e0a311de470a95629a38aa12e">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>factor.names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"married"</span>, <span class="st">"education"</span>, <span class="st">"gender"</span>, <span class="st">"diabetes"</span>)</span>
<span id="cb6-2"><a href="#cb6-2"></a>dat.with.miss[,factor.names] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(dat.with.miss[,factor.names], factor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="inspect-extent-of-missing-data-problem" class="level4"><h4 class="anchored" data-anchor-id="inspect-extent-of-missing-data-problem">Inspect extent of missing data problem</h4>
<p>A visualization is generated to explore the extent and pattern of missing data in the dataset, which informs the strategy for handling them.</p>
<div class="cell" data-hash="propensityscore5_cache/html/plot_a94082b017d2a021110a4a264e924d9a">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="fu">require</span>(DataExplorer)</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">plot_missing</span>(dat.with.miss)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">
<p><img src="propensityscore5_files/figure-html/plot-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Note that, <strong>multiple imputation then delete</strong> (MID) approach can be applied if the outcome had some missing values. Due to the small number of missingness, MICE may not impute the outcomes BTW.</p>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Multiple imputation then delete (MID)</strong>:</p>
<p>MID is a specific approach used in the context of multiple imputation (MI) when dealing with missing outcome data. All missing values, including those in the outcome variable, are imputed to create several complete datasets. In subsequent analyses, the imputed values for the outcome variable are deleted, so that only observed outcome values are analyzed. Each dataset (with observed outcome values and imputed predictor values) is analyzed separately, and results are pooled to provide a single estimate.</p>
</div>
</div>
</section></section><section id="logistic-regression-1" class="level3"><h3 class="anchored" data-anchor-id="logistic-regression-1">Logistic regression</h3>
<section id="initialization" class="level4"><h4 class="anchored" data-anchor-id="initialization">Initialization</h4>
<p>The MI process is initialized, setting up the framework for subsequent imputations.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp0_e57d40044760199da38ab603439059ca">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, <span class="at">maxit =</span> <span class="dv">0</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="setting-imputation-model-covariates" class="level4"><h4 class="anchored" data-anchor-id="setting-imputation-model-covariates">Setting imputation model covariates</h4>
<p>The predictor matrix is adjusted to specify which variables will be used to predict missing values in the imputation model. Setting strata as auxiliary variable:</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp1_58abd12e14db4cacfc61f61ae4c39f73">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>pred <span class="ot">&lt;-</span> imputation<span class="sc">$</span>pred</span>
<span id="cb9-2"><a href="#cb9-2"></a>pred</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="co">#&gt;            ID psu strata weight race age married education gender bmi</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co">#&gt; ID          0   1      1      1    1   1       1         1      1   1</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; psu         1   0      1      1    1   1       1         1      1   1</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; strata      1   1      0      1    1   1       1         1      1   1</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co">#&gt; weight      1   1      1      0    1   1       1         1      1   1</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="co">#&gt; race        1   1      1      1    0   1       1         1      1   1</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt; age         1   1      1      1    1   0       1         1      1   1</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co">#&gt; married     1   1      1      1    1   1       0         1      1   1</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#&gt; education   1   1      1      1    1   1       1         0      1   1</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#&gt; gender      1   1      1      1    1   1       1         1      0   1</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&gt; bmi         1   1      1      1    1   1       1         1      1   0</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co">#&gt; systolicBP  1   1      1      1    1   1       1         1      1   1</span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co">#&gt; born        1   1      1      1    1   1       1         1      1   1</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&gt; diabetes    1   1      1      1    1   1       1         1      1   1</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co">#&gt;            systolicBP born diabetes</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="co">#&gt; ID                  1    1        1</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co">#&gt; psu                 1    1        1</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">#&gt; strata              1    1        1</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co">#&gt; weight              1    1        1</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="co">#&gt; race                1    1        1</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="co">#&gt; age                 1    1        1</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="co">#&gt; married             1    1        1</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="co">#&gt; education           1    1        1</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="co">#&gt; gender              1    1        1</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="co">#&gt; bmi                 1    1        1</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="co">#&gt; systolicBP          0    1        1</span></span>
<span id="cb9-29"><a href="#cb9-29"></a><span class="co">#&gt; born                1    0        1</span></span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="co">#&gt; diabetes            1    1        0</span></span>
<span id="cb9-31"><a href="#cb9-31"></a>pred[,<span class="st">"ID"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"ID"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-32"><a href="#cb9-32"></a>pred[,<span class="st">"psu"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"psu"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-33"><a href="#cb9-33"></a>pred[,<span class="st">"weight"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"weight"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-34"><a href="#cb9-34"></a>pred[<span class="st">"strata"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-35"><a href="#cb9-35"></a>pred</span>
<span id="cb9-36"><a href="#cb9-36"></a><span class="co">#&gt;            ID psu strata weight race age married education gender bmi</span></span>
<span id="cb9-37"><a href="#cb9-37"></a><span class="co">#&gt; ID          0   0      0      0    0   0       0         0      0   0</span></span>
<span id="cb9-38"><a href="#cb9-38"></a><span class="co">#&gt; psu         0   0      0      0    0   0       0         0      0   0</span></span>
<span id="cb9-39"><a href="#cb9-39"></a><span class="co">#&gt; strata      0   0      0      0    0   0       0         0      0   0</span></span>
<span id="cb9-40"><a href="#cb9-40"></a><span class="co">#&gt; weight      0   0      0      0    0   0       0         0      0   0</span></span>
<span id="cb9-41"><a href="#cb9-41"></a><span class="co">#&gt; race        0   0      1      0    0   1       1         1      1   1</span></span>
<span id="cb9-42"><a href="#cb9-42"></a><span class="co">#&gt; age         0   0      1      0    1   0       1         1      1   1</span></span>
<span id="cb9-43"><a href="#cb9-43"></a><span class="co">#&gt; married     0   0      1      0    1   1       0         1      1   1</span></span>
<span id="cb9-44"><a href="#cb9-44"></a><span class="co">#&gt; education   0   0      1      0    1   1       1         0      1   1</span></span>
<span id="cb9-45"><a href="#cb9-45"></a><span class="co">#&gt; gender      0   0      1      0    1   1       1         1      0   1</span></span>
<span id="cb9-46"><a href="#cb9-46"></a><span class="co">#&gt; bmi         0   0      1      0    1   1       1         1      1   0</span></span>
<span id="cb9-47"><a href="#cb9-47"></a><span class="co">#&gt; systolicBP  0   0      1      0    1   1       1         1      1   1</span></span>
<span id="cb9-48"><a href="#cb9-48"></a><span class="co">#&gt; born        0   0      1      0    1   1       1         1      1   1</span></span>
<span id="cb9-49"><a href="#cb9-49"></a><span class="co">#&gt; diabetes    0   0      1      0    1   1       1         1      1   1</span></span>
<span id="cb9-50"><a href="#cb9-50"></a><span class="co">#&gt;            systolicBP born diabetes</span></span>
<span id="cb9-51"><a href="#cb9-51"></a><span class="co">#&gt; ID                  0    0        0</span></span>
<span id="cb9-52"><a href="#cb9-52"></a><span class="co">#&gt; psu                 0    0        0</span></span>
<span id="cb9-53"><a href="#cb9-53"></a><span class="co">#&gt; strata              0    0        0</span></span>
<span id="cb9-54"><a href="#cb9-54"></a><span class="co">#&gt; weight              0    0        0</span></span>
<span id="cb9-55"><a href="#cb9-55"></a><span class="co">#&gt; race                1    1        1</span></span>
<span id="cb9-56"><a href="#cb9-56"></a><span class="co">#&gt; age                 1    1        1</span></span>
<span id="cb9-57"><a href="#cb9-57"></a><span class="co">#&gt; married             1    1        1</span></span>
<span id="cb9-58"><a href="#cb9-58"></a><span class="co">#&gt; education           1    1        1</span></span>
<span id="cb9-59"><a href="#cb9-59"></a><span class="co">#&gt; gender              1    1        1</span></span>
<span id="cb9-60"><a href="#cb9-60"></a><span class="co">#&gt; bmi                 1    1        1</span></span>
<span id="cb9-61"><a href="#cb9-61"></a><span class="co">#&gt; systolicBP          0    1        1</span></span>
<span id="cb9-62"><a href="#cb9-62"></a><span class="co">#&gt; born                1    0        1</span></span>
<span id="cb9-63"><a href="#cb9-63"></a><span class="co">#&gt; diabetes            1    1        0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="setting-imputation-model-specification" class="level4"><h4 class="anchored" data-anchor-id="setting-imputation-model-specification">Setting imputation model specification</h4>
<p>The method for imputing a particular variable is specified (e.g., using Predictive Mean Matching). Here, we add <code>pmm</code> for bmi:</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp2_6b1275b8a0444a57150f4e67478cfb27">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>meth <span class="ot">&lt;-</span> imputation<span class="sc">$</span>meth</span>
<span id="cb10-2"><a href="#cb10-2"></a>meth[<span class="st">"bmi"</span>] <span class="ot">&lt;-</span> <span class="st">"pmm"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="impute-incomplete-data" class="level4"><h4 class="anchored" data-anchor-id="impute-incomplete-data">Impute incomplete data</h4>
<p>Multiple datasets are imputed, each providing a different “guess” at the missing values, based on observed data. We are imputing m = 3 times.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp3_e2d3d6cf2af8606f2a180e6429eeb77a">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, </span>
<span id="cb11-2"><a href="#cb11-2"></a>                   <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb11-3"><a href="#cb11-3"></a>                   <span class="at">predictorMatrix =</span> pred,</span>
<span id="cb11-4"><a href="#cb11-4"></a>                   <span class="at">method =</span> meth, </span>
<span id="cb11-5"><a href="#cb11-5"></a>                   <span class="at">m =</span> <span class="dv">3</span>, </span>
<span id="cb11-6"><a href="#cb11-6"></a>                   <span class="at">maxit =</span> <span class="dv">5</span>, </span>
<span id="cb11-7"><a href="#cb11-7"></a>                   <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-8"><a href="#cb11-8"></a>impdata <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(imputation, <span class="at">action=</span><span class="st">"long"</span>)</span>
<span id="cb11-9"><a href="#cb11-9"></a>impdata<span class="sc">$</span>.id <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb11-12"><a href="#cb11-12"></a>allImputations <span class="ot">&lt;-</span>  <span class="fu">imputationList</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>m, </span>
<span id="cb11-13"><a href="#cb11-13"></a>                                         <span class="cf">function</span>(n)</span>
<span id="cb11-14"><a href="#cb11-14"></a>                                           <span class="fu">subset</span>(impdata, </span>
<span id="cb11-15"><a href="#cb11-15"></a>                                                  <span class="at">subset=</span>.imp<span class="sc">==</span>n)))</span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="fu">str</span>(allImputations)</span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt; List of 2</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">#&gt;  $ imputations:List of 3</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="co">#&gt;   ..$ :'data.frame': 9254 obs. of  14 variables:</span></span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="co">#&gt;   .. ..$ .imp      : int [1:9254] 1 1 1 1 1 1 1 1 1 1 ...</span></span>
<span id="cb11-21"><a href="#cb11-21"></a><span class="co">#&gt;   .. ..$ ID        : int [1:9254] 93703 93704 93705 93706 93707 93708 93709 93710 93711 93712 ...</span></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="co">#&gt;   .. ..$ psu       : Factor w/ 2 levels "1","2": 2 1 2 2 1 2 1 1 2 2 ...</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="co">#&gt;   .. ..$ strata    : Factor w/ 15 levels "134","135","136",..: 12 10 12 1 5 5 3 1 1 14 ...</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="co">#&gt;   .. ..$ weight    : num [1:9254] 8540 42567 8338 8723 7065 ...</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="co">#&gt;   .. ..$ race      : Factor w/ 4 levels "Black","Hispanic",..: 3 4 1 3 3 3 1 4 3 2 ...</span></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co">#&gt;   .. ..$ age       : int [1:9254] 57 46 66 50 23 66 75 49 56 36 ...</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">#&gt;   .. ..$ married   : Factor w/ 3 levels "Married","Never.married",..: 1 1 3 1 2 1 3 3 1 1 ...</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="co">#&gt;   .. ..$ education : Factor w/ 3 levels "College","High.School",..: 1 2 2 1 1 3 1 2 1 3 ...</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="co">#&gt;   .. ..$ gender    : Factor w/ 2 levels "Female","Male": 1 2 1 2 2 1 1 1 2 2 ...</span></span>
<span id="cb11-30"><a href="#cb11-30"></a><span class="co">#&gt;   .. ..$ bmi       : num [1:9254] 17.5 15.7 31.7 21.5 18.1 23.7 38.9 31.2 21.3 19.7 ...</span></span>
<span id="cb11-31"><a href="#cb11-31"></a><span class="co">#&gt;   .. ..$ systolicBP: int [1:9254] 108 96 200 112 128 124 120 122 108 112 ...</span></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="co">#&gt;   .. ..$ born      : Factor w/ 2 levels "Born in US","Others": 1 1 1 1 1 2 1 1 2 2 ...</span></span>
<span id="cb11-33"><a href="#cb11-33"></a><span class="co">#&gt;   .. ..$ diabetes  : Factor w/ 2 levels "No","Yes": 1 1 1 1 1 2 1 1 1 1 ...</span></span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="co">#&gt;   ..$ :'data.frame': 9254 obs. of  14 variables:</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="co">#&gt;   .. ..$ .imp      : int [1:9254] 2 2 2 2 2 2 2 2 2 2 ...</span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="co">#&gt;   .. ..$ ID        : int [1:9254] 93703 93704 93705 93706 93707 93708 93709 93710 93711 93712 ...</span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="co">#&gt;   .. ..$ psu       : Factor w/ 2 levels "1","2": 2 1 2 2 1 2 1 1 2 2 ...</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="co">#&gt;   .. ..$ strata    : Factor w/ 15 levels "134","135","136",..: 12 10 12 1 5 5 3 1 1 14 ...</span></span>
<span id="cb11-39"><a href="#cb11-39"></a><span class="co">#&gt;   .. ..$ weight    : num [1:9254] 8540 42567 8338 8723 7065 ...</span></span>
<span id="cb11-40"><a href="#cb11-40"></a><span class="co">#&gt;   .. ..$ race      : Factor w/ 4 levels "Black","Hispanic",..: 3 4 1 3 3 3 1 4 3 2 ...</span></span>
<span id="cb11-41"><a href="#cb11-41"></a><span class="co">#&gt;   .. ..$ age       : int [1:9254] 24 49 66 32 34 66 75 80 56 28 ...</span></span>
<span id="cb11-42"><a href="#cb11-42"></a><span class="co">#&gt;   .. ..$ married   : Factor w/ 3 levels "Married","Never.married",..: 2 1 3 2 1 1 3 3 1 2 ...</span></span>
<span id="cb11-43"><a href="#cb11-43"></a><span class="co">#&gt;   .. ..$ education : Factor w/ 3 levels "College","High.School",..: 1 1 2 1 2 3 1 1 1 1 ...</span></span>
<span id="cb11-44"><a href="#cb11-44"></a><span class="co">#&gt;   .. ..$ gender    : Factor w/ 2 levels "Female","Male": 1 2 1 2 2 1 1 1 2 2 ...</span></span>
<span id="cb11-45"><a href="#cb11-45"></a><span class="co">#&gt;   .. ..$ bmi       : num [1:9254] 17.5 15.7 31.7 21.5 18.1 23.7 38.9 24.9 21.3 19.7 ...</span></span>
<span id="cb11-46"><a href="#cb11-46"></a><span class="co">#&gt;   .. ..$ systolicBP: int [1:9254] 102 104 136 112 128 120 120 120 108 112 ...</span></span>
<span id="cb11-47"><a href="#cb11-47"></a><span class="co">#&gt;   .. ..$ born      : Factor w/ 2 levels "Born in US","Others": 1 1 1 1 1 2 1 1 2 2 ...</span></span>
<span id="cb11-48"><a href="#cb11-48"></a><span class="co">#&gt;   .. ..$ diabetes  : Factor w/ 2 levels "No","Yes": 1 1 1 1 1 2 1 1 1 1 ...</span></span>
<span id="cb11-49"><a href="#cb11-49"></a><span class="co">#&gt;   ..$ :'data.frame': 9254 obs. of  14 variables:</span></span>
<span id="cb11-50"><a href="#cb11-50"></a><span class="co">#&gt;   .. ..$ .imp      : int [1:9254] 3 3 3 3 3 3 3 3 3 3 ...</span></span>
<span id="cb11-51"><a href="#cb11-51"></a><span class="co">#&gt;   .. ..$ ID        : int [1:9254] 93703 93704 93705 93706 93707 93708 93709 93710 93711 93712 ...</span></span>
<span id="cb11-52"><a href="#cb11-52"></a><span class="co">#&gt;   .. ..$ psu       : Factor w/ 2 levels "1","2": 2 1 2 2 1 2 1 1 2 2 ...</span></span>
<span id="cb11-53"><a href="#cb11-53"></a><span class="co">#&gt;   .. ..$ strata    : Factor w/ 15 levels "134","135","136",..: 12 10 12 1 5 5 3 1 1 14 ...</span></span>
<span id="cb11-54"><a href="#cb11-54"></a><span class="co">#&gt;   .. ..$ weight    : num [1:9254] 8540 42567 8338 8723 7065 ...</span></span>
<span id="cb11-55"><a href="#cb11-55"></a><span class="co">#&gt;   .. ..$ race      : Factor w/ 4 levels "Black","Hispanic",..: 3 4 1 3 3 3 1 4 3 2 ...</span></span>
<span id="cb11-56"><a href="#cb11-56"></a><span class="co">#&gt;   .. ..$ age       : int [1:9254] 47 71 66 71 45 66 75 37 56 47 ...</span></span>
<span id="cb11-57"><a href="#cb11-57"></a><span class="co">#&gt;   .. ..$ married   : Factor w/ 3 levels "Married","Never.married",..: 1 1 3 1 1 1 3 1 1 1 ...</span></span>
<span id="cb11-58"><a href="#cb11-58"></a><span class="co">#&gt;   .. ..$ education : Factor w/ 3 levels "College","High.School",..: 1 1 2 1 1 3 1 1 1 2 ...</span></span>
<span id="cb11-59"><a href="#cb11-59"></a><span class="co">#&gt;   .. ..$ gender    : Factor w/ 2 levels "Female","Male": 1 2 1 2 2 1 1 1 2 2 ...</span></span>
<span id="cb11-60"><a href="#cb11-60"></a><span class="co">#&gt;   .. ..$ bmi       : num [1:9254] 17.5 15.7 31.7 21.5 18.1 23.7 38.9 15.9 21.3 19.7 ...</span></span>
<span id="cb11-61"><a href="#cb11-61"></a><span class="co">#&gt;   .. ..$ systolicBP: int [1:9254] 100 114 162 112 128 166 120 116 108 112 ...</span></span>
<span id="cb11-62"><a href="#cb11-62"></a><span class="co">#&gt;   .. ..$ born      : Factor w/ 2 levels "Born in US","Others": 1 1 1 1 1 2 1 1 2 2 ...</span></span>
<span id="cb11-63"><a href="#cb11-63"></a><span class="co">#&gt;   .. ..$ diabetes  : Factor w/ 2 levels "No","Yes": 1 1 1 1 1 2 1 1 1 1 ...</span></span>
<span id="cb11-64"><a href="#cb11-64"></a><span class="co">#&gt;  $ call       : language imputationList(lapply(1:m, function(n) subset(impdata, subset = .imp ==      n)))</span></span>
<span id="cb11-65"><a href="#cb11-65"></a><span class="co">#&gt;  - attr(*, "class")= chr "imputationList"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="design" class="level4"><h4 class="anchored" data-anchor-id="design">Design</h4>
<p>A survey design object is created, ensuring that subsequent analyses appropriately account for the survey design.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp4_3a47ccf4cc8513719a9129cdba1c2fe5">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>w.design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>psu, <span class="at">weights =</span> <span class="sc">~</span>weight, <span class="at">strata =</span> <span class="sc">~</span>strata,</span>
<span id="cb12-2"><a href="#cb12-2"></a>                      <span class="at">data =</span> allImputations, <span class="at">nest =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="survey-data-analysis" class="level4"><h4 class="anchored" data-anchor-id="survey-data-analysis">Survey data analysis</h4>
<p>A logistic regression model is fitted to each imputed dataset.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp5_a3352996fbc38a0378a9d7f852968422">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>model.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(diabetes <span class="sc">==</span> <span class="st">'Yes'</span>) <span class="sc">~</span> </span>
<span id="cb13-2"><a href="#cb13-2"></a>                              born <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb13-3"><a href="#cb13-3"></a>                              education <span class="sc">+</span> gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb13-4"><a href="#cb13-4"></a>fit.from.logistic <span class="ot">&lt;-</span> <span class="fu">with</span>(w.design, <span class="fu">svyglm</span>(model.formula, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>)))</span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span>
<span id="cb13-8"><a href="#cb13-8"></a></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="co">#&gt; Warning in eval(family$initialize): non-integer #successes in a binomial glm!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="pooled-estimates" class="level4"><h4 class="anchored" data-anchor-id="pooled-estimates">Pooled estimates</h4>
<p>Results from models across all imputed datasets are pooled to provide a single estimate, accounting for the uncertainty due to missing data.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp6_70b14a96301e33eb5fd980d299ccaeec">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>pooled.estimates <span class="ot">&lt;-</span> <span class="fu">MIcombine</span>(fit.from.logistic)</span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">summary</span>(pooled.estimates, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">logeffect=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="co">#&gt; Multiple imputation results:</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="co">#&gt;       with(w.design, svyglm(model.formula, family = binomial("logit")))</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="co">#&gt;       MIcombine.default(fit.from.logistic)</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="co">#&gt;                           results      se  (lower  upper) missInfo</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="co">#&gt; (Intercept)               0.00013 7.5e-05 3.9e-05 0.00041     22 %</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co">#&gt; bornOthers                1.44729 2.7e-01 1.0e+00 2.07384      0 %</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#&gt; raceHispanic              0.81619 1.1e-01 6.3e-01 1.05882      0 %</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#&gt; raceOther                 1.43817 2.6e-01 1.0e+00 2.04954      3 %</span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">#&gt; raceWhite                 0.86411 1.3e-01 6.5e-01 1.14994      3 %</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co">#&gt; age                       1.06157 3.6e-03 1.1e+00 1.06874      6 %</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co">#&gt; marriedNever.married      0.83242 1.6e-01 5.7e-01 1.20809     10 %</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co">#&gt; marriedPreviously.married 0.88401 1.1e-01 6.8e-01 1.14163     11 %</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">#&gt; educationHigh.School      1.16331 1.9e-01 8.4e-01 1.60803      0 %</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co">#&gt; educationSchool           1.41943 2.4e-01 1.0e+00 1.98397      7 %</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="co">#&gt; genderMale                1.53458 1.8e-01 1.2e+00 1.94217      3 %</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="co">#&gt; bmi                       1.10597 1.2e-02 1.1e+00 1.12956      1 %</span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="co">#&gt; systolicBP                1.00325 3.2e-03 1.0e+00 1.01001     39 %</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>OR <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(pooled.estimates<span class="sc">$</span>coefficients), <span class="dv">2</span>) </span>
<span id="cb14-21"><a href="#cb14-21"></a>OR <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(OR)</span>
<span id="cb14-22"><a href="#cb14-22"></a>CI <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(pooled.estimates)), <span class="dv">2</span>)</span>
<span id="cb14-23"><a href="#cb14-23"></a>OR <span class="ot">&lt;-</span> <span class="fu">cbind</span>(OR, CI)</span>
<span id="cb14-24"><a href="#cb14-24"></a>OR[<span class="dv">2</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["OR"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["2.5 %"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["97.5 %"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"1.45","2":"1.01","3":"2.07","_rn_":"bornOthers"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>
</section></section><section id="propensity-score-matching-analysis" class="level3"><h3 class="anchored" data-anchor-id="propensity-score-matching-analysis">Propensity score matching analysis</h3>
<section id="initialization-1" class="level4"><h4 class="anchored" data-anchor-id="initialization-1">Initialization</h4>
<p>The MI process is re-initialized to facilitate PSM in the context of MI.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp7_e58dd86b0580bedf72ea5b0af0d3313f">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, <span class="at">maxit =</span> <span class="dv">0</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-2"><a href="#cb15-2"></a>impdata <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(imputation, <span class="at">action=</span><span class="st">"long"</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb15-4"><a href="#cb15-4"></a>allImputations <span class="ot">&lt;-</span> <span class="fu">imputationList</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>m, </span>
<span id="cb15-5"><a href="#cb15-5"></a>                                        <span class="cf">function</span>(n) </span>
<span id="cb15-6"><a href="#cb15-6"></a>                                          <span class="fu">subset</span>(impdata, </span>
<span id="cb15-7"><a href="#cb15-7"></a>                                                 <span class="at">subset=</span>.imp<span class="sc">==</span>n)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="zanutto-e.-l.-2006-under-multiple-imputation" class="level4"><h4 class="anchored" data-anchor-id="zanutto-e.-l.-2006-under-multiple-imputation">Zanutto E. L. (2006) under multiple imputation</h4>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>An iterative process is performed within each imputed dataset, which involves:</p>
<ol type="1">
<li>Estimating propensity scores.</li>
<li>Matching treated and untreated subjects based on these scores.</li>
<li>Extracting matched data and checking the balance of covariates across matched groups.</li>
<li>Fitting outcome models to the survey weighted matched data and estimating treatment effects.</li>
</ol>
</div>
</div>
<p>Notice that we are performing multi-step process within MI</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp8_367435dae48ae1d536210f11746c396b">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>match.statm <span class="ot">&lt;-</span> SMDm <span class="ot">&lt;-</span> tab1m <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, m) </span>
<span id="cb16-2"><a href="#cb16-2"></a>fit.from.PS <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, m)</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb16-5"><a href="#cb16-5"></a>  analytic.i <span class="ot">&lt;-</span> allImputations<span class="sc">$</span>imputations[[i]]</span>
<span id="cb16-6"><a href="#cb16-6"></a>  <span class="co"># Rename the weight variable into survey.weight</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>  <span class="fu">names</span>(analytic.i)[<span class="fu">names</span>(analytic.i) <span class="sc">==</span> <span class="st">"weight"</span>] <span class="ot">&lt;-</span> <span class="st">"survey.weight"</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>  </span>
<span id="cb16-9"><a href="#cb16-9"></a>  <span class="co"># Specify the PS model to estimate propensity scores</span></span>
<span id="cb16-10"><a href="#cb16-10"></a>  ps.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(born<span class="sc">==</span><span class="st">"Others"</span>) <span class="sc">~</span> </span>
<span id="cb16-11"><a href="#cb16-11"></a>                             race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> education <span class="sc">+</span> </span>
<span id="cb16-12"><a href="#cb16-12"></a>                             gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb16-13"><a href="#cb16-13"></a></span>
<span id="cb16-14"><a href="#cb16-14"></a>  <span class="co"># Propensity scores</span></span>
<span id="cb16-15"><a href="#cb16-15"></a>  ps.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(ps.formula, <span class="at">data =</span> analytic.i, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb16-16"><a href="#cb16-16"></a>  analytic.i<span class="sc">$</span>PS <span class="ot">&lt;-</span> <span class="fu">fitted</span>(ps.fit)</span>
<span id="cb16-17"><a href="#cb16-17"></a>  </span>
<span id="cb16-18"><a href="#cb16-18"></a>  <span class="co"># Match exposed and unexposed subjects </span></span>
<span id="cb16-19"><a href="#cb16-19"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb16-20"><a href="#cb16-20"></a>  match.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula, <span class="at">data =</span> analytic.i, </span>
<span id="cb16-21"><a href="#cb16-21"></a>                       <span class="at">distance =</span> analytic.i<span class="sc">$</span>PS, </span>
<span id="cb16-22"><a href="#cb16-22"></a>                       <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb16-23"><a href="#cb16-23"></a>                       <span class="at">replace =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-24"><a href="#cb16-24"></a>                       <span class="at">caliper =</span> <span class="fl">0.2</span>, </span>
<span id="cb16-25"><a href="#cb16-25"></a>                       <span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb16-26"><a href="#cb16-26"></a>  match.statm[[i]] <span class="ot">&lt;-</span> match.obj</span>
<span id="cb16-27"><a href="#cb16-27"></a>  analytic.i<span class="sc">$</span>PS <span class="ot">&lt;-</span> match.obj<span class="sc">$</span>distance</span>
<span id="cb16-28"><a href="#cb16-28"></a>  </span>
<span id="cb16-29"><a href="#cb16-29"></a>  <span class="co"># Extract matched data</span></span>
<span id="cb16-30"><a href="#cb16-30"></a>  matched.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(match.obj) </span>
<span id="cb16-31"><a href="#cb16-31"></a>  </span>
<span id="cb16-32"><a href="#cb16-32"></a>  <span class="co"># Balance checking</span></span>
<span id="cb16-33"><a href="#cb16-33"></a>  cov <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"age"</span>, <span class="st">"married"</span>, <span class="st">"education"</span>, <span class="st">"gender"</span>, <span class="st">"bmi"</span>, <span class="st">"systolicBP"</span>)</span>
<span id="cb16-34"><a href="#cb16-34"></a>  </span>
<span id="cb16-35"><a href="#cb16-35"></a>  tab1m[[i]] <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"born"</span>, </span>
<span id="cb16-36"><a href="#cb16-36"></a>                               <span class="at">vars =</span> cov, <span class="at">data =</span> matched.data, </span>
<span id="cb16-37"><a href="#cb16-37"></a>                               <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-38"><a href="#cb16-38"></a>  SMDm[[i]] <span class="ot">&lt;-</span> <span class="fu">ExtractSmd</span>(tab1m[[i]])</span>
<span id="cb16-39"><a href="#cb16-39"></a>  </span>
<span id="cb16-40"><a href="#cb16-40"></a>  <span class="co"># Setup the design with survey features</span></span>
<span id="cb16-41"><a href="#cb16-41"></a>  analytic.i<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb16-42"><a href="#cb16-42"></a>  analytic.i<span class="sc">$</span>matched[analytic.i<span class="sc">$</span>ID <span class="sc">%in%</span> matched.data<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb16-43"><a href="#cb16-43"></a>  </span>
<span id="cb16-44"><a href="#cb16-44"></a>  <span class="co"># Survey setup for full data</span></span>
<span id="cb16-45"><a href="#cb16-45"></a>  w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">strata =</span> <span class="sc">~</span>strata, <span class="at">id =</span> <span class="sc">~</span>psu, <span class="at">weights =</span> <span class="sc">~</span>survey.weight, </span>
<span id="cb16-46"><a href="#cb16-46"></a>                         <span class="at">data =</span> analytic.i, <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb16-47"><a href="#cb16-47"></a>  </span>
<span id="cb16-48"><a href="#cb16-48"></a>  <span class="co"># Subset matched data</span></span>
<span id="cb16-49"><a href="#cb16-49"></a>  w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb16-50"><a href="#cb16-50"></a>  </span>
<span id="cb16-51"><a href="#cb16-51"></a>  <span class="co"># Outcome model (double adjustment)</span></span>
<span id="cb16-52"><a href="#cb16-52"></a>  out.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(diabetes <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">~</span> </span>
<span id="cb16-53"><a href="#cb16-53"></a>                              born <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb16-54"><a href="#cb16-54"></a>                              education <span class="sc">+</span> gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb16-55"><a href="#cb16-55"></a>  fit.from.PS[[i]] <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(out.formula, <span class="at">design =</span> w.design.m, </span>
<span id="cb16-56"><a href="#cb16-56"></a>                     <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb16-57"><a href="#cb16-57"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="check-matched-data" class="level4"><h4 class="anchored" data-anchor-id="check-matched-data">Check matched data</h4>
<p>The matched data is inspected to ensure that matching was successful and appropriate.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp9_8e78ca2203b516b82611dd525a6c73c5">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>match.statm</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb17-3"><a href="#cb17-3"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb17-4"><a href="#cb17-4"></a><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span id="cb17-5"><a href="#cb17-5"></a><span class="co">#&gt;  - distance: User-defined [caliper]</span></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.044)</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">#&gt;  - number of obs.: 9254 (original), 3590 (matched)</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="co">#&gt;  - covariates: race, age, married, education, gender, bmi, systolicBP</span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">#&gt; </span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co">#&gt;  - distance: User-defined [caliper]</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.044)</span></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="co">#&gt;  - number of obs.: 9254 (original), 3598 (matched)</span></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="co">#&gt;  - covariates: race, age, married, education, gender, bmi, systolicBP</span></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co">#&gt; </span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb17-21"><a href="#cb17-21"></a><span class="co">#&gt; A matchit object</span></span>
<span id="cb17-22"><a href="#cb17-22"></a><span class="co">#&gt;  - method: 1:1 nearest neighbor matching without replacement</span></span>
<span id="cb17-23"><a href="#cb17-23"></a><span class="co">#&gt;  - distance: User-defined [caliper]</span></span>
<span id="cb17-24"><a href="#cb17-24"></a><span class="co">#&gt;  - caliper: &lt;distance&gt; (0.044)</span></span>
<span id="cb17-25"><a href="#cb17-25"></a><span class="co">#&gt;  - number of obs.: 9254 (original), 3594 (matched)</span></span>
<span id="cb17-26"><a href="#cb17-26"></a><span class="co">#&gt;  - target estimand: ATT</span></span>
<span id="cb17-27"><a href="#cb17-27"></a><span class="co">#&gt;  - covariates: race, age, married, education, gender, bmi, systolicBP</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section><section id="check-balance-in-matched-data" class="level4"><h4 class="anchored" data-anchor-id="check-balance-in-matched-data">Check balance in matched data</h4>
<p>The balance of covariates across matched groups is assessed to ensure that matching has successfully reduced bias.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp10_2477a0973328d5d5e2299d6af00db772">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a>SMDm</span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co">#&gt; [[1]]</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">#&gt;                 1 vs 2</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co">#&gt; race       0.028883793</span></span>
<span id="cb18-5"><a href="#cb18-5"></a><span class="co">#&gt; age        0.033614763</span></span>
<span id="cb18-6"><a href="#cb18-6"></a><span class="co">#&gt; married    0.007318561</span></span>
<span id="cb18-7"><a href="#cb18-7"></a><span class="co">#&gt; education  0.117536503</span></span>
<span id="cb18-8"><a href="#cb18-8"></a><span class="co">#&gt; gender     0.040145831</span></span>
<span id="cb18-9"><a href="#cb18-9"></a><span class="co">#&gt; bmi        0.043350560</span></span>
<span id="cb18-10"><a href="#cb18-10"></a><span class="co">#&gt; systolicBP 0.054549772</span></span>
<span id="cb18-11"><a href="#cb18-11"></a><span class="co">#&gt; </span></span>
<span id="cb18-12"><a href="#cb18-12"></a><span class="co">#&gt; [[2]]</span></span>
<span id="cb18-13"><a href="#cb18-13"></a><span class="co">#&gt;                 1 vs 2</span></span>
<span id="cb18-14"><a href="#cb18-14"></a><span class="co">#&gt; race       0.019901420</span></span>
<span id="cb18-15"><a href="#cb18-15"></a><span class="co">#&gt; age        0.016267050</span></span>
<span id="cb18-16"><a href="#cb18-16"></a><span class="co">#&gt; married    0.017196043</span></span>
<span id="cb18-17"><a href="#cb18-17"></a><span class="co">#&gt; education  0.128811588</span></span>
<span id="cb18-18"><a href="#cb18-18"></a><span class="co">#&gt; gender     0.003338016</span></span>
<span id="cb18-19"><a href="#cb18-19"></a><span class="co">#&gt; bmi        0.057014434</span></span>
<span id="cb18-20"><a href="#cb18-20"></a><span class="co">#&gt; systolicBP 0.071553721</span></span>
<span id="cb18-21"><a href="#cb18-21"></a><span class="co">#&gt; </span></span>
<span id="cb18-22"><a href="#cb18-22"></a><span class="co">#&gt; [[3]]</span></span>
<span id="cb18-23"><a href="#cb18-23"></a><span class="co">#&gt;                1 vs 2</span></span>
<span id="cb18-24"><a href="#cb18-24"></a><span class="co">#&gt; race       0.04490482</span></span>
<span id="cb18-25"><a href="#cb18-25"></a><span class="co">#&gt; age        0.01959377</span></span>
<span id="cb18-26"><a href="#cb18-26"></a><span class="co">#&gt; married    0.03687394</span></span>
<span id="cb18-27"><a href="#cb18-27"></a><span class="co">#&gt; education  0.13301810</span></span>
<span id="cb18-28"><a href="#cb18-28"></a><span class="co">#&gt; gender     0.01225625</span></span>
<span id="cb18-29"><a href="#cb18-29"></a><span class="co">#&gt; bmi        0.03697878</span></span>
<span id="cb18-30"><a href="#cb18-30"></a><span class="co">#&gt; systolicBP 0.10025529</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section></section><section id="pooled-estimate" class="level3"><h3 class="anchored" data-anchor-id="pooled-estimate">Pooled estimate</h3>
<p>Finally, the treatment effect estimates from the matched analyses across all imputed datasets are pooled to provide a single, overall estimate, ensuring that the final result appropriately accounts for the uncertainty due to both the matching process and the imputation of missing data.</p>
<div class="cell" data-hash="propensityscore5_cache/html/imp11_2be954224277b88d1e87822b47ed9f0a">
<details><summary>Show the code</summary><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>pooled.estimates <span class="ot">&lt;-</span> <span class="fu">MIcombine</span>(fit.from.PS)</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="fu">summary</span>(pooled.estimates, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">logeffect=</span><span class="cn">TRUE</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="co">#&gt; Multiple imputation results:</span></span>
<span id="cb19-4"><a href="#cb19-4"></a><span class="co">#&gt;       MIcombine.default(fit.from.PS)</span></span>
<span id="cb19-5"><a href="#cb19-5"></a><span class="co">#&gt;                           results      se  (lower  upper) missInfo</span></span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">#&gt; (Intercept)               8.9e-05 4.9e-05 0.00003 0.00026      8 %</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">#&gt; bornOthers                2.0e+00 3.1e-01 1.47719 2.73325     16 %</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">#&gt; raceHispanic              7.0e-01 1.7e-01 0.42593 1.15504     27 %</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="co">#&gt; raceOther                 1.4e+00 4.1e-01 0.77209 2.53278     26 %</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">#&gt; raceWhite                 4.9e-01 2.7e-01 0.15853 1.52308     28 %</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">#&gt; age                       1.1e+00 4.6e-03 1.04472 1.06298      8 %</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co">#&gt; marriedNever.married      5.9e-01 2.0e-01 0.28824 1.18926     38 %</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co">#&gt; marriedPreviously.married 1.0e+00 2.5e-01 0.62417 1.64438     11 %</span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co">#&gt; educationHigh.School      1.4e+00 3.0e-01 0.89403 2.10852      2 %</span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co">#&gt; educationSchool           1.3e+00 3.4e-01 0.81042 2.21438      7 %</span></span>
<span id="cb19-16"><a href="#cb19-16"></a><span class="co">#&gt; genderMale                1.3e+00 2.3e-01 0.86695 1.83880     31 %</span></span>
<span id="cb19-17"><a href="#cb19-17"></a><span class="co">#&gt; bmi                       1.1e+00 1.1e-02 1.08062 1.12285      5 %</span></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="co">#&gt; systolicBP                1.0e+00 3.0e-03 1.00314 1.01494      3 %</span></span>
<span id="cb19-19"><a href="#cb19-19"></a>OR <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(pooled.estimates<span class="sc">$</span>coefficients), <span class="dv">2</span>) </span>
<span id="cb19-20"><a href="#cb19-20"></a>OR <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(OR)</span>
<span id="cb19-21"><a href="#cb19-21"></a>CI <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(pooled.estimates)), <span class="dv">2</span>)</span>
<span id="cb19-22"><a href="#cb19-22"></a>OR <span class="ot">&lt;-</span> <span class="fu">cbind</span>(OR, CI)</span>
<span id="cb19-23"><a href="#cb19-23"></a>OR[<span class="dv">2</span>,]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details><div class="cell-output-display">

<div data-pagedtable="false">
  <script data-pagedtable-source="" type="application/json">
{"columns":[{"label":[""],"name":["_rn_"],"type":[""],"align":["left"]},{"label":["OR"],"name":[1],"type":["dbl"],"align":["right"]},{"label":["2.5 %"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["97.5 %"],"name":[3],"type":["dbl"],"align":["right"]}],"data":[{"1":"2.01","2":"1.48","3":"2.72","_rn_":"bornOthers"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
</div>
</div>


<!-- -->

</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./propensityscore4.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">PSM in BMI-diabetes</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./propensityscoreF.html" class="pagination-link">
        <span class="nav-page-text">R functions (S)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb20" data-shortcodes="false"><pre class="sourceCode numberSource markdown number-lines code-with-copy"><code class="sourceCode markdown"><span id="cb20-1"><a href="#cb20-1"></a><span class="fu">## PSM with MI {.unnumbered}</span></span>
<span id="cb20-2"><a href="#cb20-2"></a></span>
<span id="cb20-3"><a href="#cb20-3"></a>The tutorial provides a detailed walkthrough of implementing Propensity Score Matching (PSM) combined with Multiple Imputation (MI) in a statistical analysis, focusing on handling missing data and mitigating bias in observational studies.</span>
<span id="cb20-4"><a href="#cb20-4"></a></span>
<span id="cb20-5"><a href="#cb20-5"></a></span>
<span id="cb20-6"><a href="#cb20-6"></a>The initial chunk is dedicated to loading various R packages that will be utilized throughout the tutorial. These libraries provide functions and tools that facilitate data manipulation, statistical modeling, visualization, and more.</span>
<span id="cb20-7"><a href="#cb20-7"></a></span>
<span id="cb20-8"><a href="#cb20-8"></a><span class="in">```{r setup, warning=FALSE, message=FALSE, cache=TRUE}</span></span>
<span id="cb20-9"><a href="#cb20-9"></a><span class="co"># Load required packages</span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="fu">library</span>(MatchIt)</span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="fu">require</span>(tableone)</span>
<span id="cb20-12"><a href="#cb20-12"></a><span class="fu">require</span>(survey)</span>
<span id="cb20-13"><a href="#cb20-13"></a><span class="fu">require</span>(cobalt)</span>
<span id="cb20-14"><a href="#cb20-14"></a><span class="fu">require</span>(Publish)</span>
<span id="cb20-15"><a href="#cb20-15"></a><span class="fu">require</span>(optmatch)</span>
<span id="cb20-16"><a href="#cb20-16"></a><span class="fu">require</span>(data.table)</span>
<span id="cb20-17"><a href="#cb20-17"></a><span class="fu">require</span>(jtools)</span>
<span id="cb20-18"><a href="#cb20-18"></a><span class="fu">require</span>(ggstance)</span>
<span id="cb20-19"><a href="#cb20-19"></a><span class="fu">require</span>(DataExplorer)</span>
<span id="cb20-20"><a href="#cb20-20"></a><span class="fu">require</span>(mitools)</span>
<span id="cb20-21"><a href="#cb20-21"></a><span class="fu">library</span>(kableExtra)</span>
<span id="cb20-22"><a href="#cb20-22"></a><span class="fu">library</span>(mice)</span>
<span id="cb20-23"><a href="#cb20-23"></a><span class="in">```</span></span>
<span id="cb20-24"><a href="#cb20-24"></a></span>
<span id="cb20-25"><a href="#cb20-25"></a><span class="fu">### Problem Statement</span></span>
<span id="cb20-26"><a href="#cb20-26"></a></span>
<span id="cb20-27"><a href="#cb20-27"></a><span class="fu">#### Logistic regression</span></span>
<span id="cb20-28"><a href="#cb20-28"></a></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="ss">-   </span>Perform multiple imputation to deal with missing values; with 3 imputed datasets, 5 iterations,</span>
<span id="cb20-30"><a href="#cb20-30"></a></span>
<span id="cb20-31"><a href="#cb20-31"></a><span class="ss">-   </span>fit **survey featured logistic regression** in all of the 3 imputed datasets, and</span>
<span id="cb20-32"><a href="#cb20-32"></a></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="ss">-   </span>obtain the pooled OR (adjusted) and the corresponding 95% confidence intervals.</span>
<span id="cb20-34"><a href="#cb20-34"></a></span>
<span id="cb20-35"><a href="#cb20-35"></a><span class="ss">-   </span>Hints</span>
<span id="cb20-36"><a href="#cb20-36"></a></span>
<span id="cb20-37"><a href="#cb20-37"></a><span class="ss">    -   </span>Use the **covariates** (listed below) in the imputation model.</span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="ss">    -   </span>**Imputation model covariates** can be different than the original analysis covariates. You are encouraged to use variables in the imputation model that can be predictive of the variables with missing observations. In this example, we use the strata variable as an **auxiliary variable** in the imputation model, but not the survey weight or PSU variable.</span>
<span id="cb20-39"><a href="#cb20-39"></a><span class="ss">    -   </span>Also the **imputation model specification** can be modified. For example, we use **pmm** method for bmi in the imputation model.</span>
<span id="cb20-40"><a href="#cb20-40"></a><span class="ss">    -   </span>Remove any subject ID variable from the imputation model, if created in an intermediate step. Indeed ID variables should not be in the imputation model, if they are **not predictive** of the variables with missing observations.</span>
<span id="cb20-41"><a href="#cb20-41"></a></span>
<span id="cb20-42"><a href="#cb20-42"></a>::: callout-tip</span>
<span id="cb20-43"><a href="#cb20-43"></a>**Predictive Mean Matching**:</span>
<span id="cb20-44"><a href="#cb20-44"></a></span>
<span id="cb20-45"><a href="#cb20-45"></a>The "Predictive Mean Matching" (PMM) method in Multiple Imputation (MI) is a widely used technique to handle missing data, particularly well-suited for continuous variables. PMM operates by first creating a predictive model for the variable with missing data, using observed values from other variables in the dataset. For each missing value, PMM identifies a set of observed values with predicted scores that are close to the predicted score for the missing value, derived from the predictive model. Then, instead of imputing a predicted score directly, PMM randomly selects one of the observed values from this set and assigns it as the imputed value. This method retains the original distribution of the imputed variable since it only uses observed values for imputation, and it also tends to preserve relationships between variables. PMM is particularly advantageous when the normality assumption of the imputed variable is questionable, providing a robust and practical approach to managing missing data in various research contexts.</span>
<span id="cb20-46"><a href="#cb20-46"></a>::: </span>
<span id="cb20-47"><a href="#cb20-47"></a></span>
<span id="cb20-48"><a href="#cb20-48"></a></span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="fu">#### Propensity score matching (Zanutto, 2006)</span></span>
<span id="cb20-50"><a href="#cb20-50"></a></span>
<span id="cb20-51"><a href="#cb20-51"></a><span class="ss">-   </span>Use the **propensity score matching as per Zanutto E. L. (2006)**'s recommendation in all of the imputed datasets.</span>
<span id="cb20-52"><a href="#cb20-52"></a><span class="ss">-   </span>Report the pooled OR estimates (adjusted) and corresponding 95% confidence intervals (adjusted OR).</span>
<span id="cb20-53"><a href="#cb20-53"></a></span>
<span id="cb20-54"><a href="#cb20-54"></a><span class="fu">### Data and variables</span></span>
<span id="cb20-55"><a href="#cb20-55"></a></span>
<span id="cb20-56"><a href="#cb20-56"></a><span class="fu">#### Analytic data</span></span>
<span id="cb20-57"><a href="#cb20-57"></a></span>
<span id="cb20-58"><a href="#cb20-58"></a>The analytic dataset is saved as NHANES17.RData.</span>
<span id="cb20-59"><a href="#cb20-59"></a></span>
<span id="cb20-60"><a href="#cb20-60"></a><span class="fu">#### Variables</span></span>
<span id="cb20-61"><a href="#cb20-61"></a></span>
<span id="cb20-62"><a href="#cb20-62"></a>We are primarily interested in outcome **diabetes** and exposure **whether born in the US (born)**.</span>
<span id="cb20-63"><a href="#cb20-63"></a></span>
<span id="cb20-64"><a href="#cb20-64"></a>Variables under consideration:</span>
<span id="cb20-65"><a href="#cb20-65"></a></span>
<span id="cb20-66"><a href="#cb20-66"></a><span class="ss">-   </span>survey features</span>
<span id="cb20-67"><a href="#cb20-67"></a><span class="ss">    -   </span>PSU</span>
<span id="cb20-68"><a href="#cb20-68"></a><span class="ss">    -   </span>strata</span>
<span id="cb20-69"><a href="#cb20-69"></a><span class="ss">    -   </span>survey weight</span>
<span id="cb20-70"><a href="#cb20-70"></a><span class="ss">-   </span>Covariates</span>
<span id="cb20-71"><a href="#cb20-71"></a><span class="ss">    -   </span>race</span>
<span id="cb20-72"><a href="#cb20-72"></a><span class="ss">    -   </span>age</span>
<span id="cb20-73"><a href="#cb20-73"></a><span class="ss">    -   </span>marriage</span>
<span id="cb20-74"><a href="#cb20-74"></a><span class="ss">    -   </span>education</span>
<span id="cb20-75"><a href="#cb20-75"></a><span class="ss">    -   </span>gender</span>
<span id="cb20-76"><a href="#cb20-76"></a><span class="ss">    -   </span>BMI</span>
<span id="cb20-77"><a href="#cb20-77"></a><span class="ss">    -   </span>systolic blood pressure</span>
<span id="cb20-78"><a href="#cb20-78"></a></span>
<span id="cb20-79"><a href="#cb20-79"></a><span class="fu">#### Pre-processing</span></span>
<span id="cb20-80"><a href="#cb20-80"></a></span>
<span id="cb20-81"><a href="#cb20-81"></a>The data is loaded and variables of interest are identified. </span>
<span id="cb20-82"><a href="#cb20-82"></a></span>
<span id="cb20-83"><a href="#cb20-83"></a><span class="in">```{r data, cache=TRUE}</span></span>
<span id="cb20-84"><a href="#cb20-84"></a><span class="fu">load</span>(<span class="at">file=</span><span class="st">"Data/propensityscore/NHANES17.RData"</span>) <span class="co"># read data</span></span>
<span id="cb20-85"><a href="#cb20-85"></a><span class="fu">ls</span>()</span>
<span id="cb20-86"><a href="#cb20-86"></a><span class="fu">dim</span>(analytic.with.miss)</span>
<span id="cb20-87"><a href="#cb20-87"></a>vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"ID"</span>, <span class="co"># ID</span></span>
<span id="cb20-88"><a href="#cb20-88"></a>          <span class="st">"psu"</span>, <span class="st">"strata"</span>, <span class="st">"weight"</span>, <span class="co"># Survey features </span></span>
<span id="cb20-89"><a href="#cb20-89"></a>          <span class="st">"race"</span>, <span class="st">"age"</span>, <span class="st">"married"</span>,<span class="st">"education"</span>,<span class="st">"gender"</span>,<span class="st">"bmi"</span>,<span class="st">"systolicBP"</span>, <span class="co"># Covariates</span></span>
<span id="cb20-90"><a href="#cb20-90"></a>          <span class="st">"born"</span>, <span class="co"># Exposure</span></span>
<span id="cb20-91"><a href="#cb20-91"></a>          <span class="st">"diabetes"</span>) <span class="co"># Outcome</span></span>
<span id="cb20-92"><a href="#cb20-92"></a><span class="in">```</span></span>
<span id="cb20-93"><a href="#cb20-93"></a></span>
<span id="cb20-94"><a href="#cb20-94"></a><span class="fu">#### Subset the dataset</span></span>
<span id="cb20-95"><a href="#cb20-95"></a></span>
<span id="cb20-96"><a href="#cb20-96"></a>The dataset is then subsetted to retain only the relevant variables, ensuring that subsequent analyses are focused and computationally efficient. </span>
<span id="cb20-97"><a href="#cb20-97"></a></span>
<span id="cb20-98"><a href="#cb20-98"></a><span class="in">```{r subset, cache=TRUE}</span></span>
<span id="cb20-99"><a href="#cb20-99"></a>dat.with.miss <span class="ot">&lt;-</span> analytic.with.miss[,vars]</span>
<span id="cb20-100"><a href="#cb20-100"></a><span class="fu">dim</span>(analytic.with.miss)</span>
<span id="cb20-101"><a href="#cb20-101"></a><span class="in">```</span></span>
<span id="cb20-102"><a href="#cb20-102"></a></span>
<span id="cb20-103"><a href="#cb20-103"></a><span class="fu">#### Inspect weights</span></span>
<span id="cb20-104"><a href="#cb20-104"></a></span>
<span id="cb20-105"><a href="#cb20-105"></a></span>
<span id="cb20-106"><a href="#cb20-106"></a>The weights of the observations are inspected and adjusted to avoid issues in subsequent analyses.</span>
<span id="cb20-107"><a href="#cb20-107"></a></span>
<span id="cb20-108"><a href="#cb20-108"></a><span class="in">```{r weight, cache=TRUE}</span></span>
<span id="cb20-109"><a href="#cb20-109"></a><span class="fu">summary</span>(dat.with.miss<span class="sc">$</span>weight)</span>
<span id="cb20-110"><a href="#cb20-110"></a><span class="co"># weight = 0 would create problem in the analysis</span></span>
<span id="cb20-111"><a href="#cb20-111"></a><span class="co"># ad-hoc solution to 0 weight problem</span></span>
<span id="cb20-112"><a href="#cb20-112"></a>dat.with.miss<span class="sc">$</span>weight[dat.with.miss<span class="sc">$</span>weight <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="fl">0.00000001</span></span>
<span id="cb20-113"><a href="#cb20-113"></a><span class="in">```</span></span>
<span id="cb20-114"><a href="#cb20-114"></a></span>
<span id="cb20-115"><a href="#cb20-115"></a><span class="fu">#### Recode the exposure variable</span></span>
<span id="cb20-116"><a href="#cb20-116"></a></span>
<span id="cb20-117"><a href="#cb20-117"></a>The exposure variable is recoded for clarity and ease of interpretation in results.</span>
<span id="cb20-118"><a href="#cb20-118"></a></span>
<span id="cb20-119"><a href="#cb20-119"></a><span class="in">```{r recode, cache=TRUE}</span></span>
<span id="cb20-120"><a href="#cb20-120"></a>dat.with.miss<span class="sc">$</span>born <span class="ot">&lt;-</span> car<span class="sc">::</span><span class="fu">recode</span>(dat.with.miss<span class="sc">$</span>born, </span>
<span id="cb20-121"><a href="#cb20-121"></a><span class="at">recodes =</span> <span class="st">" 'Born in 50 US states or Washingt' = </span></span>
<span id="cb20-122"><a href="#cb20-122"></a><span class="st">'Born in US'; 'Others' = 'Others'; else = NA "</span> )</span>
<span id="cb20-123"><a href="#cb20-123"></a>dat.with.miss<span class="sc">$</span>born <span class="ot">&lt;-</span> <span class="fu">factor</span>(dat.with.miss<span class="sc">$</span>born, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Born in US"</span>, <span class="st">"Others"</span>))</span>
<span id="cb20-124"><a href="#cb20-124"></a><span class="in">```</span></span>
<span id="cb20-125"><a href="#cb20-125"></a></span>
<span id="cb20-126"><a href="#cb20-126"></a><span class="fu">#### variable types</span></span>
<span id="cb20-127"><a href="#cb20-127"></a></span>
<span id="cb20-128"><a href="#cb20-128"></a>Variable types are set, ensuring that each variable is treated appropriately in the analyses.</span>
<span id="cb20-129"><a href="#cb20-129"></a></span>
<span id="cb20-130"><a href="#cb20-130"></a><span class="in">```{r vartype, cache=TRUE}</span></span>
<span id="cb20-131"><a href="#cb20-131"></a>factor.names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"married"</span>, <span class="st">"education"</span>, <span class="st">"gender"</span>, <span class="st">"diabetes"</span>)</span>
<span id="cb20-132"><a href="#cb20-132"></a>dat.with.miss[,factor.names] <span class="ot">&lt;-</span> <span class="fu">lapply</span>(dat.with.miss[,factor.names], factor)</span>
<span id="cb20-133"><a href="#cb20-133"></a><span class="in">```</span></span>
<span id="cb20-134"><a href="#cb20-134"></a></span>
<span id="cb20-135"><a href="#cb20-135"></a><span class="fu">#### Inspect extent of missing data problem</span></span>
<span id="cb20-136"><a href="#cb20-136"></a></span>
<span id="cb20-137"><a href="#cb20-137"></a>A visualization is generated to explore the extent and pattern of missing data in the dataset, which informs the strategy for handling them.</span>
<span id="cb20-138"><a href="#cb20-138"></a></span>
<span id="cb20-139"><a href="#cb20-139"></a><span class="in">```{r plot, cache=TRUE}</span></span>
<span id="cb20-140"><a href="#cb20-140"></a><span class="fu">require</span>(DataExplorer)</span>
<span id="cb20-141"><a href="#cb20-141"></a><span class="fu">plot_missing</span>(dat.with.miss)</span>
<span id="cb20-142"><a href="#cb20-142"></a><span class="in">```</span></span>
<span id="cb20-143"><a href="#cb20-143"></a></span>
<span id="cb20-144"><a href="#cb20-144"></a>Note that, **multiple imputation then delete** (MID) approach can be applied if the outcome had some missing values. Due to the small number of missingness, MICE may not impute the outcomes BTW.</span>
<span id="cb20-145"><a href="#cb20-145"></a></span>
<span id="cb20-146"><a href="#cb20-146"></a>::: callout-tip</span>
<span id="cb20-147"><a href="#cb20-147"></a>**Multiple imputation then delete (MID)**:</span>
<span id="cb20-148"><a href="#cb20-148"></a></span>
<span id="cb20-149"><a href="#cb20-149"></a>MID is a specific approach used in the context of multiple imputation (MI) when dealing with missing outcome data. All missing values, including those in the outcome variable, are imputed to create several complete datasets. In subsequent analyses, the imputed values for the outcome variable are deleted, so that only observed outcome values are analyzed. Each dataset (with observed outcome values and imputed predictor values) is analyzed separately, and results are pooled to provide a single estimate.</span>
<span id="cb20-150"><a href="#cb20-150"></a>::: </span>
<span id="cb20-151"><a href="#cb20-151"></a></span>
<span id="cb20-152"><a href="#cb20-152"></a><span class="fu">### Logistic regression</span></span>
<span id="cb20-153"><a href="#cb20-153"></a></span>
<span id="cb20-154"><a href="#cb20-154"></a><span class="fu">#### Initialization</span></span>
<span id="cb20-155"><a href="#cb20-155"></a></span>
<span id="cb20-156"><a href="#cb20-156"></a>The MI process is initialized, setting up the framework for subsequent imputations.</span>
<span id="cb20-157"><a href="#cb20-157"></a></span>
<span id="cb20-158"><a href="#cb20-158"></a><span class="in">```{r imp0, cache=TRUE}</span></span>
<span id="cb20-159"><a href="#cb20-159"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, <span class="at">maxit =</span> <span class="dv">0</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-160"><a href="#cb20-160"></a><span class="in">```</span></span>
<span id="cb20-161"><a href="#cb20-161"></a></span>
<span id="cb20-162"><a href="#cb20-162"></a><span class="fu">#### Setting imputation model covariates</span></span>
<span id="cb20-163"><a href="#cb20-163"></a></span>
<span id="cb20-164"><a href="#cb20-164"></a>The predictor matrix is adjusted to specify which variables will be used to predict missing values in the imputation model. Setting strata as auxiliary variable:</span>
<span id="cb20-165"><a href="#cb20-165"></a></span>
<span id="cb20-166"><a href="#cb20-166"></a><span class="in">```{r imp1, cache=TRUE}</span></span>
<span id="cb20-167"><a href="#cb20-167"></a>pred <span class="ot">&lt;-</span> imputation<span class="sc">$</span>pred</span>
<span id="cb20-168"><a href="#cb20-168"></a>pred</span>
<span id="cb20-169"><a href="#cb20-169"></a>pred[,<span class="st">"ID"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"ID"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-170"><a href="#cb20-170"></a>pred[,<span class="st">"psu"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"psu"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-171"><a href="#cb20-171"></a>pred[,<span class="st">"weight"</span>] <span class="ot">&lt;-</span> pred[<span class="st">"weight"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-172"><a href="#cb20-172"></a>pred[<span class="st">"strata"</span>,] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-173"><a href="#cb20-173"></a>pred</span>
<span id="cb20-174"><a href="#cb20-174"></a><span class="in">```</span></span>
<span id="cb20-175"><a href="#cb20-175"></a></span>
<span id="cb20-176"><a href="#cb20-176"></a><span class="fu">#### Setting imputation model specification</span></span>
<span id="cb20-177"><a href="#cb20-177"></a></span>
<span id="cb20-178"><a href="#cb20-178"></a>The method for imputing a particular variable is specified (e.g., using Predictive Mean Matching). Here, we add <span class="in">`pmm`</span> for bmi:</span>
<span id="cb20-179"><a href="#cb20-179"></a></span>
<span id="cb20-180"><a href="#cb20-180"></a><span class="in">```{r imp2, cache=TRUE}</span></span>
<span id="cb20-181"><a href="#cb20-181"></a>meth <span class="ot">&lt;-</span> imputation<span class="sc">$</span>meth</span>
<span id="cb20-182"><a href="#cb20-182"></a>meth[<span class="st">"bmi"</span>] <span class="ot">&lt;-</span> <span class="st">"pmm"</span></span>
<span id="cb20-183"><a href="#cb20-183"></a><span class="in">```</span></span>
<span id="cb20-184"><a href="#cb20-184"></a></span>
<span id="cb20-185"><a href="#cb20-185"></a><span class="fu">#### Impute incomplete data</span></span>
<span id="cb20-186"><a href="#cb20-186"></a></span>
<span id="cb20-187"><a href="#cb20-187"></a>Multiple datasets are imputed, each providing a different "guess" at the missing values, based on observed data. We are imputing m = 3 times.</span>
<span id="cb20-188"><a href="#cb20-188"></a></span>
<span id="cb20-189"><a href="#cb20-189"></a><span class="in">```{r imp3, cache=TRUE, warning=FALSE}</span></span>
<span id="cb20-190"><a href="#cb20-190"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, </span>
<span id="cb20-191"><a href="#cb20-191"></a>                   <span class="at">seed =</span> <span class="dv">123</span>, </span>
<span id="cb20-192"><a href="#cb20-192"></a>                   <span class="at">predictorMatrix =</span> pred,</span>
<span id="cb20-193"><a href="#cb20-193"></a>                   <span class="at">method =</span> meth, </span>
<span id="cb20-194"><a href="#cb20-194"></a>                   <span class="at">m =</span> <span class="dv">3</span>, </span>
<span id="cb20-195"><a href="#cb20-195"></a>                   <span class="at">maxit =</span> <span class="dv">5</span>, </span>
<span id="cb20-196"><a href="#cb20-196"></a>                   <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-197"><a href="#cb20-197"></a>impdata <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(imputation, <span class="at">action=</span><span class="st">"long"</span>)</span>
<span id="cb20-198"><a href="#cb20-198"></a>impdata<span class="sc">$</span>.id <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-199"><a href="#cb20-199"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb20-200"><a href="#cb20-200"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb20-201"><a href="#cb20-201"></a>allImputations <span class="ot">&lt;-</span>  <span class="fu">imputationList</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>m, </span>
<span id="cb20-202"><a href="#cb20-202"></a>                                         <span class="cf">function</span>(n)</span>
<span id="cb20-203"><a href="#cb20-203"></a>                                           <span class="fu">subset</span>(impdata, </span>
<span id="cb20-204"><a href="#cb20-204"></a>                                                  <span class="at">subset=</span>.imp<span class="sc">==</span>n)))</span>
<span id="cb20-205"><a href="#cb20-205"></a><span class="fu">str</span>(allImputations)</span>
<span id="cb20-206"><a href="#cb20-206"></a><span class="in">```</span></span>
<span id="cb20-207"><a href="#cb20-207"></a></span>
<span id="cb20-208"><a href="#cb20-208"></a><span class="fu">#### Design</span></span>
<span id="cb20-209"><a href="#cb20-209"></a></span>
<span id="cb20-210"><a href="#cb20-210"></a>A survey design object is created, ensuring that subsequent analyses appropriately account for the survey design.</span>
<span id="cb20-211"><a href="#cb20-211"></a></span>
<span id="cb20-212"><a href="#cb20-212"></a><span class="in">```{r imp4, cache=TRUE}</span></span>
<span id="cb20-213"><a href="#cb20-213"></a>w.design <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">ids =</span> <span class="sc">~</span>psu, <span class="at">weights =</span> <span class="sc">~</span>weight, <span class="at">strata =</span> <span class="sc">~</span>strata,</span>
<span id="cb20-214"><a href="#cb20-214"></a>                      <span class="at">data =</span> allImputations, <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-215"><a href="#cb20-215"></a><span class="in">```</span></span>
<span id="cb20-216"><a href="#cb20-216"></a></span>
<span id="cb20-217"><a href="#cb20-217"></a><span class="fu">#### Survey data analysis</span></span>
<span id="cb20-218"><a href="#cb20-218"></a></span>
<span id="cb20-219"><a href="#cb20-219"></a>A logistic regression model is fitted to each imputed dataset.</span>
<span id="cb20-220"><a href="#cb20-220"></a></span>
<span id="cb20-221"><a href="#cb20-221"></a><span class="in">```{r imp5, cache=TRUE}</span></span>
<span id="cb20-222"><a href="#cb20-222"></a>model.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(diabetes <span class="sc">==</span> <span class="st">'Yes'</span>) <span class="sc">~</span> </span>
<span id="cb20-223"><a href="#cb20-223"></a>                              born <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb20-224"><a href="#cb20-224"></a>                              education <span class="sc">+</span> gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb20-225"><a href="#cb20-225"></a>fit.from.logistic <span class="ot">&lt;-</span> <span class="fu">with</span>(w.design, <span class="fu">svyglm</span>(model.formula, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>)))</span>
<span id="cb20-226"><a href="#cb20-226"></a><span class="in">```</span></span>
<span id="cb20-227"><a href="#cb20-227"></a></span>
<span id="cb20-228"><a href="#cb20-228"></a><span class="fu">#### Pooled estimates</span></span>
<span id="cb20-229"><a href="#cb20-229"></a></span>
<span id="cb20-230"><a href="#cb20-230"></a>Results from models across all imputed datasets are pooled to provide a single estimate, accounting for the uncertainty due to missing data.</span>
<span id="cb20-231"><a href="#cb20-231"></a></span>
<span id="cb20-232"><a href="#cb20-232"></a><span class="in">```{r imp6, cache=TRUE}</span></span>
<span id="cb20-233"><a href="#cb20-233"></a>pooled.estimates <span class="ot">&lt;-</span> <span class="fu">MIcombine</span>(fit.from.logistic)</span>
<span id="cb20-234"><a href="#cb20-234"></a><span class="fu">summary</span>(pooled.estimates, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">logeffect=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-235"><a href="#cb20-235"></a>OR <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(pooled.estimates<span class="sc">$</span>coefficients), <span class="dv">2</span>) </span>
<span id="cb20-236"><a href="#cb20-236"></a>OR <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(OR)</span>
<span id="cb20-237"><a href="#cb20-237"></a>CI <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(pooled.estimates)), <span class="dv">2</span>)</span>
<span id="cb20-238"><a href="#cb20-238"></a>OR <span class="ot">&lt;-</span> <span class="fu">cbind</span>(OR, CI)</span>
<span id="cb20-239"><a href="#cb20-239"></a>OR[<span class="dv">2</span>,]</span>
<span id="cb20-240"><a href="#cb20-240"></a><span class="in">```</span></span>
<span id="cb20-241"><a href="#cb20-241"></a></span>
<span id="cb20-242"><a href="#cb20-242"></a><span class="fu">### Propensity score matching analysis</span></span>
<span id="cb20-243"><a href="#cb20-243"></a></span>
<span id="cb20-244"><a href="#cb20-244"></a><span class="fu">#### Initialization</span></span>
<span id="cb20-245"><a href="#cb20-245"></a></span>
<span id="cb20-246"><a href="#cb20-246"></a>The MI process is re-initialized to facilitate PSM in the context of MI.</span>
<span id="cb20-247"><a href="#cb20-247"></a></span>
<span id="cb20-248"><a href="#cb20-248"></a><span class="in">```{r imp7, cache=TRUE}</span></span>
<span id="cb20-249"><a href="#cb20-249"></a>imputation <span class="ot">&lt;-</span> <span class="fu">mice</span>(<span class="at">data =</span> dat.with.miss, <span class="at">maxit =</span> <span class="dv">0</span>, <span class="at">print =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-250"><a href="#cb20-250"></a>impdata <span class="ot">&lt;-</span> mice<span class="sc">::</span><span class="fu">complete</span>(imputation, <span class="at">action=</span><span class="st">"long"</span>)</span>
<span id="cb20-251"><a href="#cb20-251"></a>m <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb20-252"><a href="#cb20-252"></a>allImputations <span class="ot">&lt;-</span> <span class="fu">imputationList</span>(<span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>m, </span>
<span id="cb20-253"><a href="#cb20-253"></a>                                        <span class="cf">function</span>(n) </span>
<span id="cb20-254"><a href="#cb20-254"></a>                                          <span class="fu">subset</span>(impdata, </span>
<span id="cb20-255"><a href="#cb20-255"></a>                                                 <span class="at">subset=</span>.imp<span class="sc">==</span>n)))</span>
<span id="cb20-256"><a href="#cb20-256"></a><span class="in">```</span></span>
<span id="cb20-257"><a href="#cb20-257"></a></span>
<span id="cb20-258"><a href="#cb20-258"></a><span class="fu">#### Zanutto E. L. (2006) under multiple imputation</span></span>
<span id="cb20-259"><a href="#cb20-259"></a></span>
<span id="cb20-260"><a href="#cb20-260"></a>::: callout-tip</span>
<span id="cb20-261"><a href="#cb20-261"></a>An iterative process is performed within each imputed dataset, which involves:</span>
<span id="cb20-262"><a href="#cb20-262"></a></span>
<span id="cb20-263"><a href="#cb20-263"></a><span class="ss">1. </span>Estimating propensity scores.</span>
<span id="cb20-264"><a href="#cb20-264"></a><span class="ss">2. </span>Matching treated and untreated subjects based on these scores.</span>
<span id="cb20-265"><a href="#cb20-265"></a><span class="ss">3. </span>Extracting matched data and checking the balance of covariates across matched groups.</span>
<span id="cb20-266"><a href="#cb20-266"></a><span class="ss">4. </span>Fitting outcome models to the survey weighted matched data and estimating treatment effects.</span>
<span id="cb20-267"><a href="#cb20-267"></a>::: </span>
<span id="cb20-268"><a href="#cb20-268"></a></span>
<span id="cb20-269"><a href="#cb20-269"></a>Notice that we are performing multi-step process within MI</span>
<span id="cb20-270"><a href="#cb20-270"></a></span>
<span id="cb20-271"><a href="#cb20-271"></a><span class="in">```{r imp8, cache=TRUE}</span></span>
<span id="cb20-272"><a href="#cb20-272"></a>match.statm <span class="ot">&lt;-</span> SMDm <span class="ot">&lt;-</span> tab1m <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, m) </span>
<span id="cb20-273"><a href="#cb20-273"></a>fit.from.PS <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, m)</span>
<span id="cb20-274"><a href="#cb20-274"></a></span>
<span id="cb20-275"><a href="#cb20-275"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m) {</span>
<span id="cb20-276"><a href="#cb20-276"></a>  analytic.i <span class="ot">&lt;-</span> allImputations<span class="sc">$</span>imputations[[i]]</span>
<span id="cb20-277"><a href="#cb20-277"></a>  <span class="co"># Rename the weight variable into survey.weight</span></span>
<span id="cb20-278"><a href="#cb20-278"></a>  <span class="fu">names</span>(analytic.i)[<span class="fu">names</span>(analytic.i) <span class="sc">==</span> <span class="st">"weight"</span>] <span class="ot">&lt;-</span> <span class="st">"survey.weight"</span></span>
<span id="cb20-279"><a href="#cb20-279"></a>  </span>
<span id="cb20-280"><a href="#cb20-280"></a>  <span class="co"># Specify the PS model to estimate propensity scores</span></span>
<span id="cb20-281"><a href="#cb20-281"></a>  ps.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(born<span class="sc">==</span><span class="st">"Others"</span>) <span class="sc">~</span> </span>
<span id="cb20-282"><a href="#cb20-282"></a>                             race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> education <span class="sc">+</span> </span>
<span id="cb20-283"><a href="#cb20-283"></a>                             gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb20-284"><a href="#cb20-284"></a></span>
<span id="cb20-285"><a href="#cb20-285"></a>  <span class="co"># Propensity scores</span></span>
<span id="cb20-286"><a href="#cb20-286"></a>  ps.fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(ps.formula, <span class="at">data =</span> analytic.i, <span class="at">family =</span> <span class="fu">binomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb20-287"><a href="#cb20-287"></a>  analytic.i<span class="sc">$</span>PS <span class="ot">&lt;-</span> <span class="fu">fitted</span>(ps.fit)</span>
<span id="cb20-288"><a href="#cb20-288"></a>  </span>
<span id="cb20-289"><a href="#cb20-289"></a>  <span class="co"># Match exposed and unexposed subjects </span></span>
<span id="cb20-290"><a href="#cb20-290"></a>  <span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb20-291"><a href="#cb20-291"></a>  match.obj <span class="ot">&lt;-</span> <span class="fu">matchit</span>(ps.formula, <span class="at">data =</span> analytic.i, </span>
<span id="cb20-292"><a href="#cb20-292"></a>                       <span class="at">distance =</span> analytic.i<span class="sc">$</span>PS, </span>
<span id="cb20-293"><a href="#cb20-293"></a>                       <span class="at">method =</span> <span class="st">"nearest"</span>, </span>
<span id="cb20-294"><a href="#cb20-294"></a>                       <span class="at">replace =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-295"><a href="#cb20-295"></a>                       <span class="at">caliper =</span> <span class="fl">0.2</span>, </span>
<span id="cb20-296"><a href="#cb20-296"></a>                       <span class="at">ratio =</span> <span class="dv">1</span>)</span>
<span id="cb20-297"><a href="#cb20-297"></a>  match.statm[[i]] <span class="ot">&lt;-</span> match.obj</span>
<span id="cb20-298"><a href="#cb20-298"></a>  analytic.i<span class="sc">$</span>PS <span class="ot">&lt;-</span> match.obj<span class="sc">$</span>distance</span>
<span id="cb20-299"><a href="#cb20-299"></a>  </span>
<span id="cb20-300"><a href="#cb20-300"></a>  <span class="co"># Extract matched data</span></span>
<span id="cb20-301"><a href="#cb20-301"></a>  matched.data <span class="ot">&lt;-</span> <span class="fu">match.data</span>(match.obj) </span>
<span id="cb20-302"><a href="#cb20-302"></a>  </span>
<span id="cb20-303"><a href="#cb20-303"></a>  <span class="co"># Balance checking</span></span>
<span id="cb20-304"><a href="#cb20-304"></a>  cov <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"race"</span>, <span class="st">"age"</span>, <span class="st">"married"</span>, <span class="st">"education"</span>, <span class="st">"gender"</span>, <span class="st">"bmi"</span>, <span class="st">"systolicBP"</span>)</span>
<span id="cb20-305"><a href="#cb20-305"></a>  </span>
<span id="cb20-306"><a href="#cb20-306"></a>  tab1m[[i]] <span class="ot">&lt;-</span> <span class="fu">CreateTableOne</span>(<span class="at">strata =</span> <span class="st">"born"</span>, </span>
<span id="cb20-307"><a href="#cb20-307"></a>                               <span class="at">vars =</span> cov, <span class="at">data =</span> matched.data, </span>
<span id="cb20-308"><a href="#cb20-308"></a>                               <span class="at">test =</span> <span class="cn">FALSE</span>, <span class="at">smd =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-309"><a href="#cb20-309"></a>  SMDm[[i]] <span class="ot">&lt;-</span> <span class="fu">ExtractSmd</span>(tab1m[[i]])</span>
<span id="cb20-310"><a href="#cb20-310"></a>  </span>
<span id="cb20-311"><a href="#cb20-311"></a>  <span class="co"># Setup the design with survey features</span></span>
<span id="cb20-312"><a href="#cb20-312"></a>  analytic.i<span class="sc">$</span>matched <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb20-313"><a href="#cb20-313"></a>  analytic.i<span class="sc">$</span>matched[analytic.i<span class="sc">$</span>ID <span class="sc">%in%</span> matched.data<span class="sc">$</span>ID] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb20-314"><a href="#cb20-314"></a>  </span>
<span id="cb20-315"><a href="#cb20-315"></a>  <span class="co"># Survey setup for full data</span></span>
<span id="cb20-316"><a href="#cb20-316"></a>  w.design0 <span class="ot">&lt;-</span> <span class="fu">svydesign</span>(<span class="at">strata =</span> <span class="sc">~</span>strata, <span class="at">id =</span> <span class="sc">~</span>psu, <span class="at">weights =</span> <span class="sc">~</span>survey.weight, </span>
<span id="cb20-317"><a href="#cb20-317"></a>                         <span class="at">data =</span> analytic.i, <span class="at">nest =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-318"><a href="#cb20-318"></a>  </span>
<span id="cb20-319"><a href="#cb20-319"></a>  <span class="co"># Subset matched data</span></span>
<span id="cb20-320"><a href="#cb20-320"></a>  w.design.m <span class="ot">&lt;-</span> <span class="fu">subset</span>(w.design0, matched <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb20-321"><a href="#cb20-321"></a>  </span>
<span id="cb20-322"><a href="#cb20-322"></a>  <span class="co"># Outcome model (double adjustment)</span></span>
<span id="cb20-323"><a href="#cb20-323"></a>  out.formula <span class="ot">&lt;-</span> <span class="fu">as.formula</span>(<span class="fu">I</span>(diabetes <span class="sc">==</span> <span class="st">"Yes"</span>) <span class="sc">~</span> </span>
<span id="cb20-324"><a href="#cb20-324"></a>                              born <span class="sc">+</span> race <span class="sc">+</span> age <span class="sc">+</span> married <span class="sc">+</span> </span>
<span id="cb20-325"><a href="#cb20-325"></a>                              education <span class="sc">+</span> gender <span class="sc">+</span> bmi <span class="sc">+</span> systolicBP)</span>
<span id="cb20-326"><a href="#cb20-326"></a>  fit.from.PS[[i]] <span class="ot">&lt;-</span> <span class="fu">svyglm</span>(out.formula, <span class="at">design =</span> w.design.m, </span>
<span id="cb20-327"><a href="#cb20-327"></a>                     <span class="at">family =</span> <span class="fu">quasibinomial</span>(<span class="st">"logit"</span>))</span>
<span id="cb20-328"><a href="#cb20-328"></a>}</span>
<span id="cb20-329"><a href="#cb20-329"></a><span class="in">```</span></span>
<span id="cb20-330"><a href="#cb20-330"></a></span>
<span id="cb20-331"><a href="#cb20-331"></a><span class="fu">#### Check matched data</span></span>
<span id="cb20-332"><a href="#cb20-332"></a></span>
<span id="cb20-333"><a href="#cb20-333"></a>The matched data is inspected to ensure that matching was successful and appropriate.</span>
<span id="cb20-334"><a href="#cb20-334"></a></span>
<span id="cb20-335"><a href="#cb20-335"></a><span class="in">```{r imp9, cache=TRUE}</span></span>
<span id="cb20-336"><a href="#cb20-336"></a>match.statm</span>
<span id="cb20-337"><a href="#cb20-337"></a><span class="in">```</span></span>
<span id="cb20-338"><a href="#cb20-338"></a></span>
<span id="cb20-339"><a href="#cb20-339"></a><span class="fu">#### Check balance in matched data</span></span>
<span id="cb20-340"><a href="#cb20-340"></a></span>
<span id="cb20-341"><a href="#cb20-341"></a>The balance of covariates across matched groups is assessed to ensure that matching has successfully reduced bias.</span>
<span id="cb20-342"><a href="#cb20-342"></a></span>
<span id="cb20-343"><a href="#cb20-343"></a><span class="in">```{r imp10, cache=TRUE}</span></span>
<span id="cb20-344"><a href="#cb20-344"></a>SMDm</span>
<span id="cb20-345"><a href="#cb20-345"></a><span class="in">```</span></span>
<span id="cb20-346"><a href="#cb20-346"></a></span>
<span id="cb20-347"><a href="#cb20-347"></a><span class="fu">### Pooled estimate</span></span>
<span id="cb20-348"><a href="#cb20-348"></a></span>
<span id="cb20-349"><a href="#cb20-349"></a>Finally, the treatment effect estimates from the matched analyses across all imputed datasets are pooled to provide a single, overall estimate, ensuring that the final result appropriately accounts for the uncertainty due to both the matching process and the imputation of missing data.</span>
<span id="cb20-350"><a href="#cb20-350"></a></span>
<span id="cb20-351"><a href="#cb20-351"></a><span class="in">```{r imp11, cache=TRUE}</span></span>
<span id="cb20-352"><a href="#cb20-352"></a>pooled.estimates <span class="ot">&lt;-</span> <span class="fu">MIcombine</span>(fit.from.PS)</span>
<span id="cb20-353"><a href="#cb20-353"></a><span class="fu">summary</span>(pooled.estimates, <span class="at">digits =</span> <span class="dv">2</span>, <span class="at">logeffect=</span><span class="cn">TRUE</span>)</span>
<span id="cb20-354"><a href="#cb20-354"></a>OR <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(pooled.estimates<span class="sc">$</span>coefficients), <span class="dv">2</span>) </span>
<span id="cb20-355"><a href="#cb20-355"></a>OR <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(OR)</span>
<span id="cb20-356"><a href="#cb20-356"></a>CI <span class="ot">&lt;-</span> <span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">confint</span>(pooled.estimates)), <span class="dv">2</span>)</span>
<span id="cb20-357"><a href="#cb20-357"></a>OR <span class="ot">&lt;-</span> <span class="fu">cbind</span>(OR, CI)</span>
<span id="cb20-358"><a href="#cb20-358"></a>OR[<span class="dv">2</span>,]</span>
<span id="cb20-359"><a href="#cb20-359"></a><span class="in">```</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>